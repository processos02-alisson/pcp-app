<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema PCP: Controle de Produção e Roteiros (Visualização Interativa)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap");
    :root { color-scheme: light dark; }
    body { font-family: "Inter", sans-serif; }
    .bg-gradient-header { background: linear-gradient(90deg, #1e40af 0%, #3b82f6 100%); }
    .modal-fixed { position: fixed; inset: 0; }
    #instruction-modal-content a { color: #3b82f6; text-decoration: underline; font-weight: 600; }
    .highlight-red { color: #dc2626; font-weight: 600; }

    /* ---------- Mobile tweaks ---------- */
    /* Deixa os modais em fullscreen no mobile, mantendo max-width no desktop */
    .modal-panel { max-height: calc(100dvh - 2rem); }
    @media (max-width: 640px) {
      .modal-panel {
        width: 100vw !important;
        max-width: 100vw !important;
        height: 100dvh !important;
        max-height: 100dvh !important;
        border-radius: 0 !important;
        margin: 0 !important;
        display: flex;
        flex-direction: column;
      }
      .modal-body-scroll {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      .sticky-footer {
        position: sticky;
        bottom: 0;
        background: white;
        padding-top: .5rem;
      }
      .card-tap-big { padding: 1rem; }
    }

    /* Safe areas (notch iOS) */
    body {
      padding-left: max(env(safe-area-inset-left), 0px);
      padding-right: max(env(safe-area-inset-right), 0px);
    }
  </style>
</head>
<body class="min-h-screen bg-gray-100 antialiased">

  <header id="header-container" class="bg-gradient-header shadow-lg p-3 sm:p-4 sticky top-0 z-10">
    <div class="max-w-7xl mx-auto flex justify-between items-center gap-2">
      <h1 class="text-2xl sm:text-3xl font-extrabold text-white flex items-center">
        <i data-lucide="factory" class="w-7 h-7 sm:w-8 sm:h-8 mr-2"></i>
        Controle de Produção e Processos
      </h1>
      <div class="flex gap-2 items-center">
        <button id="btn-profile"
                class="text-white bg-blue-800 hover:bg-blue-700 font-semibold py-2 px-3 rounded-lg shadow-md transition hidden"
                onclick="openUserModal()">
          <i data-lucide="user-cog" class="w-5 h-5 inline-block mr-1"></i>
          <span class="hidden sm:inline">Perfil</span>
        </button>

        <select id="user-view-select"
                onchange="updateView(this.value)"
                class="bg-blue-800 text-white text-xs sm:text-sm font-semibold py-2 px-2 rounded-lg transition hover:bg-blue-700 focus:ring-2 focus:ring-blue-300">
          <option value="PCP">Visão: PCP (Gerencial)</option>
          <option value="Operador">Visão: Operador</option>
          <option value="Relatorio">Visão: Relatório</option>
        </select>

        <button onclick="openModal('create-of-modal')" id="btn-create-of"
                class="text-white bg-green-600 hover:bg-green-700 font-semibold py-2 px-3 rounded-lg shadow-md transition hidden">
          <i data-lucide="plus" class="w-5 h-5 inline-block mr-1"></i>
          <span class="hidden sm:inline">Criar OF</span>
        </button>
        <button onclick="openModal('setup-roteiro-modal')" id="btn-setup-roteiro"
                class="text-white bg-yellow-600 hover:bg-yellow-700 font-semibold py-2 px-3 rounded-lg shadow-md transition hidden">
          <i data-lucide="settings" class="w-5 h-5 inline-block mr-1"></i>
          <span class="hidden sm:inline">Setup Roteiro</span>
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-3 sm:p-6 lg:p-8">
    <div id="loading-indicator" class="flex flex-col items-center justify-center p-6 sm:p-12 bg-white rounded-xl shadow-xl">
      <i data-lucide="loader-circle" class="w-8 h-8 sm:w-10 sm:h-10 text-blue-500 animate-spin"></i>
      <p class="mt-3 sm:mt-4 text-gray-600 font-semibold text-sm sm:text-base">Carregando dados e autenticando...</p>
    </div>

    <div id="pcp-view" class="space-y-4 sm:space-y-6 hidden">
      <h2 class="text-xl sm:text-2xl font-bold text-gray-800 border-b pb-2 mb-2 sm:mb-4 flex items-center">
        <i data-lucide="bar-chart-3" class="w-5 h-5 sm:w-6 sm:h-6 mr-2"></i>
        Painel PCP: Acompanhamento de OFs
      </h2>
      <div id="kpis-container" class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-4"></div>
      <div id="ofs-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-6"></div>
    </div>

    <div id="operator-view" class="space-y-4 sm:space-y-6 hidden">
      <div class="bg-white p-3 sm:p-4 rounded-xl shadow-lg mb-4 sm:mb-6 flex flex-col sm:flex-row items-center justify-between gap-3">
        <h2 class="text-lg sm:text-xl font-bold text-gray-800 flex items-center">
          <i data-lucide="clipboard-list" class="w-5 h-5 sm:w-6 sm:h-6 mr-2 text-blue-600"></i>
          Minhas Tarefas
        </h2>
        
        <div class="flex flex-col sm:flex-row items-center gap-3 w-full sm:w-auto">
          <div class="flex items-center gap-2 w-full sm:w-auto">
            <label for="sector-filter" class="text-xs sm:text-sm font-semibold text-gray-700 flex-shrink-0">Setor:</label>
            <select id="sector-filter" onchange="updateSectorFilter(this.value)"
                    class="p-2 border border-blue-300 rounded-lg bg-blue-50 focus:ring-blue-500 focus:border-blue-500 w-full sm:w-48"></select>
          </div>

          <div class="flex items-center gap-2 w-full sm:w-auto">
            <label for="of-search-filter" class="text-xs sm:text-sm font-semibold text-gray-700 flex-shrink-0">OF:</label>
            <input type="text" id="of-search-filter" oninput="updateSearchFilter(this.value)"
                   class="p-2 border border-blue-300 rounded-lg bg-blue-50 focus:ring-blue-500 focus:border-blue-500 w-full sm:w-48"
                   placeholder="Pesquisar OF">
          </div>
        </div>
        
      </div>
      <div id="tasks-list-container" class="space-y-3 sm:space-y-4"></div>
    </div>

    <div id="report-view" class="space-y-4 sm:space-y-6 hidden">
      <h2 class="text-xl sm:text-2xl font-bold text-gray-800 border-b pb-2 mb-2 sm:mb-4 flex items-center">
        <i data-lucide="file-text" class="w-5 h-5 sm:w-6 sm:h-6 mr-2 text-purple-600"></i>
        Relatório Detalhado de Pausas e Atrasos
      </h2>
      <div class="bg-white p-3 sm:p-4 rounded-xl shadow-lg">
        <div class="flex justify-between items-center mb-3 sm:mb-4">
          <h3 class="text-base sm:text-xl font-semibold text-gray-700">Ocorrências Registradas (Desvios)</h3>
          <button id="btn-export-report" onclick="exportReportCSV()"
                  class="px-3 sm:px-4 py-2 bg-purple-600 text-white text-sm sm:text-base font-semibold rounded-lg hover:bg-purple-700 transition">
            <i data-lucide="download" class="w-4 h-4 sm:w-5 sm:h-5 inline-block mr-1"></i> Exportar (CSV)
          </button>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 text-xs sm:text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">OF</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">CHICOTE</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">ATIVIDADE</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">MOTIVO PAUSA</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">MOTIVO ATRASO</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">T. PAUSA (min)</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">T. ATRASO (min)</th>
              </tr>
            </thead>
            <tbody id="report-table-body" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <div id="action-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal()">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-md modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <h3 id="modal-title" class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2"></h3>
      <div class="modal-body-scroll">
        <p id="modal-message" class="text-gray-600 mb-3 sm:mb-4"></p>
        <div id="modal-content">
          <div id="justification-area" class="space-y-3 sm:space-y-4">
            <label for="justification-select" class="block text-sm font-medium text-gray-700">Selecione o Motivo Principal:</label>
            <select id="justification-select" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500 transition">
              <option value="">-- Selecione uma opção --</option>
            </select>
            <label for="justification-text" class="block text-sm font-medium text-gray-700">Detalhes Adicionais (Opcional):</label>
            <textarea id="justification-text" rows="2" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500 transition" placeholder=""></textarea>
            <p id="justification-required-text" class="text-sm text-red-500 hidden font-semibold">🚨 Campo obrigatório devido ao desvio de tempo!</p>
          </div>
        </div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end gap-2 sm:gap-3 sticky-footer">
        <button onclick="closeModal()" class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition">Cancelar</button>
        <button id="modal-confirm-button" class="px-3 sm:px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition" onclick="handleConfirmedAction()">Confirmar</button>
      </div>
    </div>
  </div>

  <div id="instruction-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal()">
    <div class="bg-white rounded-xl shadow-2xl p-5 sm:p-8 w-full max-w-2xl modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2 flex items-center">
        <i data-lucide="book-open-text" class="w-5 h-5 sm:w-6 sm:h-6 mr-2 text-indigo-600"></i> Instrução de Trabalho
      </h3>
      <div class="max-h-[65vh] sm:max-h-[70vh] overflow-y-auto pr-1 sm:pr-2 modal-body-scroll">
        <p class="text-sm font-semibold text-gray-700 mb-2" id="instruction-modal-header"></p>
        <div id="instruction-modal-content" class="text-gray-700 space-y-3"></div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end">
        <button onclick="closeModal('instruction-modal')" class="px-3 sm:px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition">Fechar</button>
      </div>
    </div>
  </div>

  <div id="create-of-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal()">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-lg modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">Criar Nova Ordem de Fabricação (OF)</h3>
      <div class="space-y-3 sm:space-y-4 modal-body-scroll">
        <div>
          <label for="of-id" class="block text-sm font-medium text-gray-700">Código da OF:</label>
          <input type="text" id="of-id" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: OF-003">
        </div>
        <div>
          <label for="of-quantity" class="block text-sm font-medium text-gray-700">Quantidade de Peças:</label>
          <input type="number" id="of-quantity" min="1" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: 50">
        </div>
        <div>
          <label for="of-chicote" class="block text-sm font-medium text-gray-700">Modelo do Chicote (Roteiro Mestre):</label>
          <select id="of-chicote" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-blue-500 focus:border-blue-500">
            <option value="">Carregando roteiros...</option>
          </select>
        </div>
        <div id="of-creation-message" class="text-sm text-red-500 hidden"></div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end gap-2 sm:gap-3 sticky-footer">
        <button onclick="closeModal('create-of-modal')" class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition">Cancelar</button>
        <button onclick="createOF()" class="px-3 sm:px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">
          <i data-lucide="factory" class="w-5 h-5 inline-block mr-1"></i> Gerar OF
        </button>
      </div>
    </div>
  </div>

  <div id="setup-roteiro-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal()">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-2xl modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">Setup: Cadastro de Roteiros Mestres</h3>
      <div id="roteiro-list" class="space-y-4 h-[50vh] sm:h-64 overflow-y-auto mb-4 p-2 border rounded-lg bg-gray-50 modal-body-scroll"></div>
      <div class="border-t pt-4 space-y-4">
        <h4 class="text-base sm:text-lg font-semibold text-gray-700">Nova Etapa para Roteiro:</h4>
        <div class="flex flex-col gap-3">
          <div class="flex flex-col sm:flex-row gap-3">
            <input type="text" id="roteiro-chicote-name" class="w-full sm:w-1/2 border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Nome do Chicote (Ex: CHICOTE-A)">
            <select id="roteiro-setor" class="w-full sm:w-1/2 border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500"></select>
          </div>
          <input type="text" id="roteiro-activity-name" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Nome da Atividade (Ex: Pré Conexão)">
          <div class="flex flex-col sm:flex-row gap-3">
            <input type="number" id="roteiro-setup-time" min="0" step="0.1" class="w-full sm:w-1/2 border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Setup (min)">
            <input type="number" id="roteiro-cycle-time" min="0" step="0.1" class="w-full sm:w-1/2 border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ciclo (min/pç)">
          </div>
          <div>
            <label for="roteiro-instruction-text" class="block text-sm font-medium text-gray-700 mb-1">Instrução de Trabalho (HTML permitido):</label>
            <textarea id="roteiro-instruction-text" rows="4" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: <b>1. Preparação:</b> ..."></textarea>
          </div>
          <button onclick="addRoteiroActivity()" class="p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
            <i data-lucide="plus" class="w-5 h-5 inline-block mr-1"></i> Adicionar Etapa
          </button>
        </div>
        <div id="roteiro-message" class="text-sm text-red-500"></div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end">
        <button onclick="closeModal('setup-roteiro-modal')" class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition">Fechar</button>
      </div>
    </div>
  </div>

  <div id="of-details-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal('of-details-modal')">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-3xl modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-2">
        <h3 id="of-details-title" class="text-xl sm:text-2xl font-bold text-gray-800"></h3>
        <button class="p-2 rounded-lg hover:bg-gray-100" onclick="closeModal('of-details-modal')">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>
      <div id="of-details-summary" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3 sm:mb-4"></div>
      <div class="w-full bg-gray-200 rounded-full h-2 mb-3 sm:mb-4">
        <div id="of-details-progress" class="h-2 rounded-full bg-blue-500" style="width:0%"></div>
      </div>
      <div id="of-details-content" class="max-h-[60vh] overflow-y-auto space-y-3 sm:space-y-4 modal-body-scroll"></div>
      <div class="mt-4 sm:mt-5 flex justify-end gap-2 sm:gap-3 sticky-footer">
        <button id="btn-export-of" class="px-3 sm:px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition" onclick="exportOFTasksCSV(window.__ofDetailsOpenId)">Exportar CSV</button>
        <button class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition" onclick="closeModal('of-details-modal')">Fechar</button>
      </div>
    </div>
  </div>

  <div id="user-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="event.stopPropagation()">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-md modal-panel mx-0 sm:mx-4">
      <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">Acesso</h3>
      <div class="space-y-3 sm:space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Perfil</label>
          <select id="user-role" class="w-full border border-gray-300 rounded-lg p-2 mt-1">
            <option value="OPERADOR">Operador</option>
            <option value="MASTER">Master</option>
          </select>
        </div>
        <div id="user-sector-wrap">
          <label class="block text-sm font-medium text-gray-700">Setor do Operador</label>
          <select id="user-sector" class="w-full border border-gray-300 rounded-lg p-2 mt-1"></select>
        </div>
        <div id="user-pin-wrap" class="hidden">
          <label class="block text-sm font-medium text-gray-700">PIN do Master</label>
          <input type="password" id="user-pin" class="w-full border border-gray-300 rounded-lg p-2 mt-1" placeholder="****">
          <p class="text-xs text-gray-500 mt-1">PIN padrão: 7889 (altere no código)</p>
        </div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end gap-2 sm:gap-3">
        <button class="px-3 sm:px-4 py-2 bg-gray-200 rounded-lg font-semibold hover:bg-gray-300" onclick="closeModal('user-modal')">Cancelar</button>
        <button class="px-3 sm:px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700" onclick="confirmUser()">Entrar</button>
      </div>
    </div>
  </div>

  <script>
    // =================================================================================================
    // CONFIGURAÇÃO FIREBASE: SUAS CREDENCIAIS CORRETAS ESTÃO AQUI!
    // =================================================================================================
    const firebaseConfig = {
      apiKey: "AIzaSyDIJJIe4WIVj5OKYTtR-HQscrxIzxNK9eY",
      authDomain: "pcp-app-24c56.firebaseapp.com",
      projectId: "pcp-app-24c56",
      storageBucket: "pcp-app-24c56.firebasestorage.app",
      messagingSenderId: "675295958467",
      appId: "1:675295958467:web:9d79700af6fc1c28db5976",
      measurementId: "G-DH06WDCKJY"
    };
    
    // Inicialização do Firebase
    let db;
    if (typeof firebase !== 'undefined') {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
    }
    // ==========================
    //  VARIÁVEIS E DADOS
    // ==========================
    const MASTER_PIN = "7889"; 
    const SECTORS = [
      'Corte','Corte de Revestimentos','Pré-Montagem','Preparação','Pré Conexão',
      'Conexão','Pré Grampeação','Grampeação','Acabamento','Embalagem','Montagem','Cabo de Bateria 1','Cabo de Bateria 2'
    ];
    const PAUSE_REASONS = [
      "Falta de material na bancada","Manutenção/Ajuste de máquina","Instrução de trabalho confusa/ausente",
      "Necessidade de assistência técnica","Troca de turno/intervalo programado","Outro (Detalhar abaixo)"
    ];
    const DELAY_REASONS = [
      "Complexidade inesperada da peça","Problema de qualidade na etapa anterior","Falta de treinamento/experiência",
      "Tempo padrão calculado incorretamente","Quebra/defeito de ferramenta","Outro (Detalhar abaixo)"
    ];
    let allOFs = {};
    let allTasks = {};
    let allRoteiros = {};
    let allOcurrencesLog = [];
    let currentAction = {};
    let currentSectorFilter = SECTORS[0];
    let currentUser = null;
    let currentSearchFilter = ''; // NOVO: Filtro de pesquisa por OF

    // Counters
    let taskCounter = 1;
    let roteiroCounter = 7;

    // Constantes do Firestore
    const OF_COLLECTION = 'ofs';
    const TASK_COLLECTION = 'tasks';
    const ROTEIRO_COLLECTION = 'roteiros';
    const OCURRENCE_COLLECTION = 'ocorrencias';

    // ==========================
    //  PERSISTÊNCIA (localStorage)
    // ==========================
    const STORAGE_KEY = "pcp_state_v2";
    function saveState() {
      const state = {
        allOFs, allTasks, allRoteiros, allOcurrencesLog,
        counters: { taskCounter, roteiroCounter },
        currentUser
      };
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e) { console.warn("Falha ao salvar estado:", e); }
    }

    function restoreState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        const state = JSON.parse(raw);
        allOFs = state.allOFs || {};
        allTasks = state.allTasks || {};
        allRoteiros = state.allRoteiros || {};
        allOcurrencesLog = state.allOcurrencesLog || [];
        taskCounter = state.counters?.taskCounter || taskCounter;
        roteiroCounter = state.counters?.roteiroCounter || roteiroCounter;
        if (state.currentUser) setUser(state.currentUser);
        return true;
      } catch(e) {
        console.warn("Falha ao restaurar estado:", e);
        return false;
      }
    }

    // ==========================
    //  ROTEIROS PRÉ-CARREGADOS (Fallback)
    // ==========================
    const DEFAULT_ROTEIROS = {
      "r1": { id:"r1", chicote_nome:"CHICOTE-001", setor:"Corte", nome_atividade:"Corte dos Fios", tempo_setup:5, tempo_ciclo:0.2,
        instrucao_trabalho:"<b>1. Preparação:</b> Verifique se a faca está calibrada para o fio 1.0mm.<br><b>2. Medição:</b> Corte 50 peças com 150mm cada.<br><b>3. Conferência:</b> Faça uma conferência visual. <a href='https://upload.wikimedia.org/wikipedia/commons/4/4e/Sample_cut.png' target='_blank'>**Ver Imagem de Padrão**</a>."
      },
      "r2": { id:"r2", chicote_nome:"CHICOTE-001", setor:"Pré-Montagem", nome_atividade:"Crimpagem de Terminais", tempo_setup:8, tempo_ciclo:0.5,
        instrucao_trabalho:"<b>1. Fio Preto:</b> ...<br><b>2. Fio Vermelho:</b> ...<br><b>3. Teste:</b> > 10Kgf. <a href='https://www.youtube.com/watch?v=dQw4w9WgXcQ' target='_blank'>**Assistir Vídeo**</a>"
      },
      "r3": { id:"r3", chicote_nome:"CHICOTE-001", setor:"Montagem Final", nome_atividade:"Montagem de Conectores", tempo_setup:15, tempo_ciclo:1.0,
        instrucao_trabalho:"<b>Atenção:</b> Conectar posições 35 e 33. Proibido forçar."
      },
      "r4": { id:"r4", chicote_nome:"CHICOTE-001", setor:"Qualidade", nome_atividade:"Teste de Continuidade", tempo_setup:3, tempo_ciclo:0.1,
        instrucao_trabalho:"Usar jig JIG-10B. 100% devem passar."
      },
      "r5": { id:"r5", chicote_nome:"CHICOTE-B", setor:"Corte", nome_atividade:"Corte Fios Reforçados", tempo_setup:10, tempo_ciclo:0.3, instrucao_trabalho:"Instrução básica B."},
      "r6": { id:"r6", chicote_nome:"CHICOTE-B", setor:"Montagem Final", nome_atividade:"Montagem Simples", tempo_setup:5, tempo_ciclo:0.8, instrucao_trabalho:"Conectar 4 vias."},
    };
    // ==========================
    //  ELEMENTOS UI
    // ==========================
    const pcpView = document.getElementById("pcp-view");
    const operatorView = document.getElementById("operator-view");
    const reportView = document.getElementById("report-view");
    const loadingIndicator = document.getElementById("loading-indicator");
    const ofsListContainer = document.getElementById("ofs-list-container");
    const tasksListContainer = document.getElementById("tasks-list-container");
    const userViewSelect = document.getElementById("user-view-select");
    const btnCreateOF = document.getElementById("btn-create-of");
    const btnSetupRoteiro = document.getElementById("btn-setup-roteiro");
    const btnProfile = document.getElementById("btn-profile");
    const btnExportReport = document.getElementById("btn-export-report");
    // ==========================
    //  HELPERS & PERMISSÕES
    // ==========================
    function msToMinutes(ms){ return parseFloat((ms / (1000*60)).toFixed(2)); }
    function formatMinutes(v){ return `${Number(v||0).toFixed(2)} min`; }
    function setUser(u){ currentUser = u; localStorage.setItem("pcp_current_user", JSON.stringify(u)); }
    function getUser(){ try{ return JSON.parse(localStorage.getItem("pcp_current_user")||"null"); }catch(e){ return null; } }
    function isMaster(){ return currentUser && currentUser.role === "MASTER"; }
    function isOperador(){ return currentUser && currentUser.role === "OPERADOR"; }

    // ==========================
    //  CÁLCULOS DE TEMPO
    // ==========================
    function calculateTempoReal(task){
      let tempoReal = task.tempo_real_acumulado || 0;
      const now = Date.now();
      if (task.status === 'Em Processo' && task.timestamp_inicio){
        let inicioMs = task.timestamp_inicio instanceof Date ? task.timestamp_inicio.getTime() : task.timestamp_inicio;
        let tempoTrabalhadoDesdeInicio = msToMinutes(now - inicioMs);
        tempoReal += tempoTrabalhadoDesdeInicio;
      }
      return parseFloat(tempoReal.toFixed(2));
    }
    function calculateDesvio(task){
      const tempoReal = calculateTempoReal(task);
      const desvio = (task.tempo_planejado||0) - tempoReal;
      return parseFloat(desvio.toFixed(2));
    }
    function calculateTotalPauseMinutes(task){
      let totalMs = task.total_pause_time_ms || 0;
      if (task.status === 'Pausada' && task.pause_start_timestamp){
        totalMs += Date.now() - task.pause_start_timestamp;
      }
      return msToMinutes(totalMs);
    }

    // ==========================
    //  UTILITÁRIOS
    // ==========================
    function openModal(id){ 
      document.getElementById(id).style.display='flex'; 
      if(id === 'setup-roteiro-modal') renderRoteiros();
      if(id === 'action-modal') setupActionModal();
    }
    function closeModal(id){ 
      // Fecha o modal específico ou o modal de ação
      if (id) {
        document.getElementById(id).style.display='none';
      } else {
        document.getElementById('action-modal').style.display='none';
        document.getElementById('instruction-modal').style.display='none';
        document.getElementById('create-of-modal').style.display='none';
        document.getElementById('setup-roteiro-modal').style.display='none';
      }
    }
    window.openModal = openModal;
    window.closeModal = closeModal;

    // ==========================
    //  FILTROS DO OPERADOR (NOVO: Pesquisa)
    // ==========================
    function updateSectorFilter(sector){
        currentSectorFilter = sector;
        renderTasks();
    }
    window.updateSectorFilter = updateSectorFilter;
    
    // NOVO: Função para atualizar o filtro de pesquisa por OF
    function updateSearchFilter(search) {
        currentSearchFilter = search.trim().toUpperCase();
        renderTasks(); // Renderiza tarefas com o novo filtro
    }
    window.updateSearchFilter = updateSearchFilter;

    // ==========================
    //  INICIALIZAÇÃO & DADOS FIREBASE
    // ==========================
    function setupSectorDropdowns(){
      const roteiroSetorSelect = document.getElementById('roteiro-setor');
      const sectorFilterSelect = document.getElementById('sector-filter');
      const userSectorSelect = document.getElementById('user-sector'); // Novo

      if (roteiroSetorSelect) { roteiroSetorSelect.innerHTML = ''; }
      if (sectorFilterSelect) { sectorFilterSelect.innerHTML=''; }
      if (userSectorSelect) { userSectorSelect.innerHTML = '<option value="">-- Selecione --</option>'; }

      // Popula todos os dropdowns de setor
      SECTORS.forEach(sector=>{
          const o1 = document.createElement('option'); o1.value=sector; o1.textContent=sector; roteiroSetorSelect?.appendChild(o1);
          const o3 = document.createElement('option'); o3.value=sector; o3.textContent=sector; userSectorSelect?.appendChild(o3);
      });

      // Configurações do filtro principal de setor (Visão Operador)
      if (sectorFilterSelect){
        if (isOperador()){
          const o = document.createElement('option');
          o.value=currentUser.sector; o.textContent=currentUser.sector; sectorFilterSelect.appendChild(o);
          sectorFilterSelect.value=currentUser.sector;
          sectorFilterSelect.disabled = true;
          currentSectorFilter = currentUser.sector;
        }else{
          SECTORS.forEach(sector=>{
            const o2 = document.createElement('option'); o2.value=sector; o2.textContent=sector; sectorFilterSelect.appendChild(o2);
          });
          currentSectorFilter = SECTORS[0];
          sectorFilterSelect.value = SECTORS[0];
          sectorFilterSelect.disabled = false;
        }
      }
      
      // Define setor do usuário na tela de login
      if (userSectorSelect && currentUser?.sector) {
        userSectorSelect.value = currentUser.sector;
      }
    }

    // Carrega dados do Firestore ou usa dados padrão (Fallback)
    async function loadData(){
      if (!db) {
        // Modo Local/Simulação
        const restored = restoreState();
        if (!restored){ 
          allRoteiros = { ...DEFAULT_ROTEIROS }; 
          createOF('OF-001', 10, 'CHICOTE-001', true);
          createOF('OF-002', 20, 'CHICOTE-B', true); 
          saveState(); 
        }
      } else {
        // Modo Firebase
        try {
          // OFs
          const ofsSnapshot = await db.collection(OF_COLLECTION).get();
          allOFs = {};
          ofsSnapshot.forEach(doc => allOFs[doc.id] = { id: doc.id, ...doc.data() });
          
          // Tasks
          const tasksSnapshot = await db.collection(TASK_COLLECTION).get();
          allTasks = {};
          tasksSnapshot.forEach(doc => allTasks[doc.id] = { id: doc.id, ...doc.data() });

          // Roteiros
          const roteirosSnapshot = await db.collection(ROTEIRO_COLLECTION).get();
          allRoteiros = {};
          roteirosSnapshot.forEach(doc => allRoteiros[doc.id] = { id: doc.id, ...doc.data() });
          if (Object.keys(allRoteiros).length === 0) { allRoteiros = { ...DEFAULT_ROTEIROS }; } // Fallback

          // Ocorrências
          const ocorrenciasSnapshot = await db.collection(OCURRENCE_COLLECTION).get();
          allOcurrencesLog = [];
          ocorrenciasSnapshot.forEach(doc => allOcurrencesLog.push(doc.data()));

        } catch (error) {
          console.error("Erro ao carregar dados do Firebase (Verifique Regras de Segurança):", error);
          // Fallback para dados locais em caso de erro no Firebase
          const restored = restoreState();
          if (!restored){ 
            allRoteiros = { ...DEFAULT_ROTEIROS }; 
            createOF('OF-001', 10, 'CHICOTE-001', true);
            createOF('OF-002', 20, 'CHICOTE-B', true); 
            saveState(); 
          }
          alert("🚨 ERRO FIREBASE: Não foi possível carregar dados. Verifique o console e as regras de segurança.");
        }
      }
    }

    // Inicialização da Aplicação
    async function initializeApp(){
      const isFirebase = typeof firebase !== 'undefined' && firebase.apps.length > 0;
      
      document.getElementById('loading-indicator').innerHTML = `
        <i data-lucide="loader-circle" class="w-8 h-8 sm:w-10 sm:h-10 text-blue-500 animate-spin"></i>
        <p class="mt-3 sm:mt-4 text-gray-600 font-semibold text-sm sm:text-base">Carregando dados e autenticando...</p>
        <div class="p-2 mt-4 bg-${isFirebase ? 'blue' : 'yellow'}-100 border border-${isFirebase ? 'blue' : 'yellow'}-400 text-${isFirebase ? 'blue' : 'yellow'}-700 rounded-lg shadow-md" role="alert">
          <p class="font-bold">Modo de Execução: ${isFirebase ? 'Firebase (Online)' : 'Local (Simulação)'}</p>
          <p class="text-xs sm:text-sm">Seus dados ${isFirebase ? 'estão no Firebase' : 'ficam salvos neste navegador (localStorage)'}.</p>
        </div>`;
      document.getElementById('loading-indicator').classList.remove('hidden');

      await loadData();
      
      const savedUser = getUser();
      if (savedUser){ setUser(savedUser); }

      // NOVO AJUSTE: Força a abertura do modal de login/perfil na inicialização.
      setTimeout(()=>{ 
        loadingIndicator.classList.add('hidden');
        openUserModal(savedUser ? null : undefined); // Chama o modal para o usuário entrar/confirmar
        setupUIRefresh(); 
      }, 300);
    }
    
    // ==========================
    //  AUTENTICAÇÃO / PERFIL
    // ==========================
    function openUserModal(){
      const modal = document.getElementById('user-modal');
      const roleSel = document.getElementById('user-role');
      const sectorSel = document.getElementById('user-sector');
      const pinWrap = document.getElementById('user-pin-wrap');
      const sectorWrap = document.getElementById('user-sector-wrap');
      
      setupSectorDropdowns();

      roleSel.value = (currentUser?.role || 'OPERADOR');
      if (currentUser?.sector) sectorSel.value = currentUser.sector;

      roleSel.onchange = () => {
        const isM = roleSel.value === 'MASTER';
        pinWrap.classList.toggle('hidden', !isM);
        sectorWrap.classList.toggle('hidden', isM);
      };
      roleSel.onchange(); // Executa a função para o estado inicial
      modal.style.display='flex';
    }
    
    function confirmUser(){
      const role = document.getElementById('user-role').value;
      const sector = document.getElementById('user-sector').value;
      const pin = document.getElementById('user-pin').value;

      if (role==='MASTER'){
        if (pin !== MASTER_PIN){ alert('PIN incorreto.'); return; }
        setUser({ role:'MASTER', name:'Master' });
        saveState();
        closeModal('user-modal');
        setupSectorDropdowns();
        updateView('PCP'); // Redireciona para PCP após login
      } else {
        if (!sector){ alert('Selecione um setor.'); return; }
        setUser({ role:'OPERADOR', sector, name:'Operador' });
        saveState();
        closeModal('user-modal');
        setupSectorDropdowns();
        updateView('Operador'); // Redireciona para Operador após login
      }
    }
    window.openUserModal = openUserModal;
    window.confirmUser = confirmUser; // Necessário para o botão
    
    // ... (restante das funções de KPI, Renderização e Ações) ...
    // (As funções que não foram alteradas serão mantidas em sua forma original)

    // ==========================
    //  KPI / RENDER
    // ==========================
    function reloadActiveFilter(){ /* placeholder */ } 
    function renderKPIs(){ 
      const kpisContainer = document.getElementById('kpis-container');
      if (!kpisContainer) return; 
      const totalOFs = Object.keys(allOFs).filter(k=> allOFs[k]?.status !== 'Concluído').length; 
      const concludedTasks = Object.values(allTasks).filter(t=>t.status==='Concluído').length; 
      const totalTasks = Object.values(allTasks).length;
      const totalPause = allOcurrencesLog.reduce((s,l)=> s + (l.TEMPO_PAUSA||0), 0); 
      const kpiData = [ 
        { title:"OFs Ativas", value: totalOFs, icon:"package", color:"bg-blue-600" }, 
        { title:"Tarefas Concluídas", value: `${concludedTasks} / ${totalTasks}`, icon:"check-circle", color:"bg-green-600" }, 
        { title:"Pausas (min)", value: totalPause.toFixed(1), icon:"pause-circle", color:"bg-yellow-600" }, 
        { title:"Ocorrências", value: allOcurrencesLog.length, icon:"alert-triangle", color:"bg-red-600" }, 
      ];
      kpisContainer.innerHTML = kpiData.map(k=>` 
        <div class="${k.color} text-white p-3 sm:p-4 rounded-xl shadow-md flex items-center justify-between"> 
          <div> 
            <p class="text-xs sm:text-sm font-medium opacity-80">${k.title}</p> 
            <p class="text-2xl sm:text-3xl font-bold">${k.value}</p> 
          </div> 
          <i data-lucide="${k.icon}" class="w-7 h-7 sm:w-8 sm:h-8 opacity-70"></i> 
        </div>`).join('');
      lucide.createIcons(); 
    } 
    
    function updateView(view){ 
      if (!currentUser) return openUserModal(); // Se a visualização for chamada sem usuário, força o login
      
      if (isOperador() && view !== 'Operador'){ view = 'Operador'; } 
      const isPCP = view === 'PCP';
      const isReport = view === 'Relatorio'; 
      pcpView.classList.toggle('hidden', !isPCP); 
      operatorView.classList.toggle('hidden', (isPCP || isReport)); 
      reportView.classList.toggle('hidden', !isReport); 
      userViewSelect.value = view; 
      btnCreateOF.classList.toggle('hidden', !isMaster());
      btnSetupRoteiro.classList.toggle('hidden', !isMaster()); 
      btnProfile.classList.remove('hidden'); 
      userViewSelect.disabled = isOperador(); 
      if (btnExportReport) btnExportReport.classList.toggle('hidden', !isMaster()); 
      
      if (isPCP){ 
        renderKPIs(); 
        renderOFs(); 
        reloadActiveFilter();
      } else if (view === 'Operador'){ 
        renderTasks(); 
      } else if (isReport){ 
        renderReport(); 
      } 
      lucide.createIcons(); 
    } 
    window.updateView = updateView;

    function renderReport(){ 
      const body = document.getElementById('report-table-body'); 
      if (allOcurrencesLog.length === 0){ 
        body.innerHTML = `<tr><td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">Nenhuma ocorrência registrada.</td></tr>`;
        return; 
      } 
      const html = allOcurrencesLog.map(log=>{ 
        const atrasoClass = (log.TEMPO_ATRASO||0) > 0 ? 'highlight-red' : 'text-gray-600'; 
        const pausaClass = (log.TEMPO_PAUSA||0) > 0 ? 'text-yellow-700 font-semibold' : 'text-gray-600'; 
        return ` 
          <tr> 
            <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${log.OF}</td> 
            <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-sm text-gray-600">${log.CHICOTE}</td> 
            <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-sm text-gray-600">${log.ATIVIDADE}</td> 
            <td class="px-3 sm:px-6 py-2 text-sm text-gray-700">${log.MOTIVO_PAUSA || '-'}</td> 
            <td class="px-3 sm:px-6 py-2 text-sm text-gray-700">${log.MOTIVO_ATRASO || '-'}</td> 
            <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-sm ${pausaClass}">${(log.TEMPO_PAUSA||0).toFixed(2)}</td> 
            <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-sm ${atrasoClass}">${(log.TEMPO_ATRASO||0).toFixed(2)}</td> 
          </tr>`; 
      }).join('');
      body.innerHTML = html; 
    } 
    
    function renderOFs(){ 
      if (!pcpView.classList.contains('hidden')) { 
        const ofs = Object.values(allOFs).filter(of=> of.status !== 'Concluído');
        const ofsHtml = ofs.map(of=>{ 
          const tasks = Object.values(allTasks).filter(t=> t.id_of === of.id); 
          const completed = tasks.filter(t=> t.status==='Concluído').length; 
          const nextTask = tasks.find(t=> t.status === 'Em Espera'); 
          let statusColor = 'bg-gray-100 border-gray-300'; 
          let progress = 0; 
          if (tasks.length>0){ 
            progress = Math.floor((completed / tasks.length) * 100); 
            if (progress > 0) statusColor = 'bg-blue-100 border-blue-400'; 
            if (progress === 100) statusColor = 'bg-green-100 border-green-500'; 
            if (tasks.some(t=> t.status === 'Em Processo')) statusColor = 'bg-indigo-100 border-indigo-400'; 
            if (tasks.some(t=> calculateDesvio(t) < -10)) statusColor = 'bg-red-100 border-red-500'; 
          } 
          const nextActivity = nextTask ? `<p class="text-sm font-semibold mt-2">Próximo: ${nextTask.nome_atividade} (${nextTask.setor})</p>` : '';
          return ` 
            <div class="${statusColor} p-4 rounded-xl shadow-md border-2 hover:shadow-lg transition cursor-pointer" onclick="openOFDetails('${of.id}')"> 
              <h3 class="text-xl font-bold text-gray-800 mb-1">${of.id}</h3> 
              <p class="text-sm text-gray-600">Chicote: ${of.chicote}</p> 
              <p class="text-sm text-gray-600">Qtd: ${of.quantidade} pçs</p> 
              <div class="w-full bg-gray-300 rounded-full h-2 mt-3"> 
                <div class="h-2 rounded-full bg-blue-600" style="width:${progress}%"></div> 
              </div> 
              <p class="text-sm font-semibold mt-1 text-gray-700">${progress}% Concluído</p> 
              ${nextActivity} 
            </div>`; 
        }).join('');
        ofsListContainer.innerHTML = ofsHtml; 
        lucide.createIcons(); 
      } 
    } 
    
    // Função de Renderização de Tarefas (Operador) - AJUSTADA PARA O FILTRO
    function renderTasks(){ 
      if (!operatorView.classList.contains('hidden')) { 
        const container = document.getElementById('tasks-list-container');
        
        // Aplica todos os filtros
        const tasks = Object.values(allTasks)
          .filter(t => 
            t.setor === currentSectorFilter && 
            (t.status === 'Em Espera' || t.status === 'Em Processo' || t.status === 'Pausada') &&
            (currentSearchFilter === '' || t.id_of.toUpperCase().includes(currentSearchFilter)) // NOVO FILTRO APLICADO
          )
          .sort((a,b) => (a.status === 'Em Processo' ? -1 : 1) || a.ordem - b.ordem);
          
        if (tasks.length === 0){ 
          container.innerHTML = `
            <div class="p-6 bg-white rounded-xl shadow-md text-center text-gray-500">
              Nenhuma tarefa ${currentSearchFilter ? `para a OF "${currentSearchFilter}"` : ''} encontrada para o setor ${currentSectorFilter}.
            </div>`;
          return; 
        } 
        
        // ... (resto da lógica de renderização de cards) ...
        const html = tasks.map(t=>{ 
          let statusClass, statusText, actionButton, disableAction = false;
          const tempoReal = calculateTempoReal(t);
          const desvio = calculateDesvio(t);
          const totalPause = calculateTotalPauseMinutes(t);
          
          if(t.status === 'Em Esperha') statusClass = 'bg-yellow-500';
          else if(t.status === 'Em Processo') statusClass = 'bg-indigo-500';
          else if(t.status === 'Pausada') statusClass = 'bg-red-500';
          else if(t.status === 'Bloqueada') { statusClass = 'bg-gray-400'; disableAction = true; } // Bloqueada
          else if(t.status === 'Concluído') statusClass = 'bg-green-500';
          
          if(t.status === 'Em Espera'){ 
            statusText = 'Pronta para Iniciar';
            actionButton = `<button class="w-full py-2 px-4 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition" onclick="prepareAction('${t.id}', 'start')">INICIAR</button>`;
          }else if(t.status === 'Em Processo'){ 
            statusText = 'Em Processo';
            actionButton = `
              <div class="flex gap-2">
                <button class="w-1/2 py-2 px-4 bg-yellow-600 text-white rounded-lg font-semibold hover:bg-yellow-700 transition" onclick="prepareAction('${t.id}', 'pause')">PAUSAR</button>
                <button class="w-1/2 py-2 px-4 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition" onclick="prepareAction('${t.id}', 'finish')">FINALIZAR</button>
              </div>`;
          }else if(t.status === 'Pausada'){ 
            statusText = 'Pausada';
            actionButton = `<button class="w-full py-2 px-4 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition" onclick="prepareAction('${t.id}', 'resume')">RETOMAR</button>`;
          }else if(t.status === 'Bloqueada'){ 
            statusText = 'Bloqueada (Aguardando setor anterior)';
            actionButton = `<button class="w-full py-2 px-4 bg-gray-500 text-white rounded-lg font-semibold opacity-50 cursor-not-allowed">BLOQUEADA</button>`;
          }
          
          let desvioClass = desvio < 0 ? 'highlight-red' : 'text-green-600';
          if (t.status !== 'Em Processo' && t.status !== 'Pausada') desvioClass = 'text-gray-500';

          return `
            <div class="bg-white rounded-xl shadow-lg border-l-8 ${statusClass.replace('bg-', 'border-')} card-tap-big space-y-3">
              <div class="flex justify-between items-start">
                <div>
                  <h3 class="text-xl font-bold text-gray-800">${t.id_of} - ${t.nome_atividade}</h3>
                  <p class="text-sm text-gray-600">Chicote: ${t.chicote_nome} | Ordem: ${t.ordem}</p>
                  <p class="text-sm text-gray-600">Qtd: ${t.quantidade} pçs</p>
                </div>
                <div class="${statusClass} text-white text-xs font-semibold px-3 py-1 rounded-full shadow-md">${statusText}</div>
              </div>
              
              <div class="grid grid-cols-2 gap-3 text-sm border-t pt-3">
                <p class="text-gray-700">T. Planejado: <span class="font-semibold">${formatMinutes(t.tempo_planejado)}</span></p>
                <p class="text-gray-700">T. Real Acumulado: <span class="font-semibold text-indigo-600">${formatMinutes(tempoReal)}</span></p>
                <p class="text-gray-700">Desvio: <span class="font-bold ${desvioClass}">${desvio > 0 ? '+' : ''}${formatMinutes(desvio * -1)}</span></p>
                <p class="text-gray-700">T. Pausado: <span class="font-semibold text-yellow-700">${formatMinutes(totalPause)}</span></p>
              </div>

              <div class="flex gap-2 pt-2">
                  <button class="flex-1 py-2 px-3 bg-blue-100 text-blue-800 rounded-lg font-semibold hover:bg-blue-200 transition text-sm" onclick="openInstructionModal('${t.roteiro_id}')">
                      <i data-lucide="book-open-text" class="w-4 h-4 inline-block mr-1"></i> Instrução
                  </button>
                  <div class="flex-1">
                      ${actionButton}
                  </div>
              </div>
            </div>`;
        }).join('');

        container.innerHTML = html;
        lucide.createIcons();
      }
    }
    
    // ... (restante das funções que não foram alteradas) ...

    // ==========================
    //  CRIAÇÃO DE OF / TAREFAS
    // ==========================
    async function createOF(ofId, quantity, chicote, isFallback = false){
      const id = isFallback ? ofId : document.getElementById('of-id').value.trim().toUpperCase();
      const qtd = isFallback ? quantity : parseInt(document.getElementById('of-quantity').value);
      const chicoteName = isFallback ? chicote : document.getElementById('of-chicote').value;
      const msgElement = document.getElementById('of-creation-message');

      if (!id || !qtd || !chicoteName || qtd <= 0){
        if (!isFallback) { msgElement.textContent = "Preencha todos os campos corretamente."; msgElement.classList.remove('hidden'); }
        return;
      }

      if (!isFallback && allOFs[id]){
        msgElement.textContent = `A OF "${id}" já existe.`; msgElement.classList.remove('hidden');
        return;
      }
      if (!isFallback) msgElement.classList.add('hidden');

      const roteiroSteps = Object.values(allRoteiros).filter(r => r.chicote_nome === chicoteName).sort((a, b) => a.id.localeCompare(b.id));

      if (roteiroSteps.length === 0){
        if (!isFallback) { msgElement.textContent = `Nenhum roteiro encontrado para o chicote "${chicoteName}".`; msgElement.classList.remove('hidden'); }
        return;
      }

      const newOF = {
        id: id,
        chicote: chicoteName,
        quantidade: qtd,
        status: 'Pendente',
        timestamp_criacao: Date.now(),
        creator: currentUser?.name || 'Sistema',
      };

      const tasksToCreate = [];
      let order = 1;
      let totalPlannedTime = 0;

      for (const step of roteiroSteps) {
        const plannedTime = step.tempo_setup + (step.tempo_ciclo * qtd);
        totalPlannedTime += plannedTime;

        const taskId = `${id}-T${taskCounter++}`;
        const newTask = {
          id: taskId,
          id_of: id,
          roteiro_id: step.id,
          chicote_nome: chicoteName,
          nome_atividade: step.nome_atividade,
          setor: step.setor,
          quantidade: qtd,
          tempo_setup: step.tempo_setup,
          tempo_ciclo: step.tempo_ciclo,
          tempo_planejado: parseFloat(plannedTime.toFixed(2)),
          
          // NOVO AJUSTE: TODAS COMEÇAM COMO 'Em Espera' para permitir paralelismo
          status: 'Em Espera', 
          
          ordem: order++,
          // Campos de rastreamento de tempo
          timestamp_criacao: newOF.timestamp_criacao,
          timestamp_inicio: null,
          timestamp_fim: null,
          tempo_real_acumulado: 0,
          total_pause_time_ms: 0,
          pause_start_timestamp: null,
          last_pauser: null,
          last_worker: null,
        };
        tasksToCreate.push(newTask);
      }
      
      newOF.status = 'Em Andamento'; // Muda o status da OF

      if (!db) {
        // Modo Local
        allOFs[newOF.id] = newOF;
        tasksToCreate.forEach(t => allTasks[t.id] = t);
        saveState();
        if (!isFallback) { closeModal('create-of-modal'); updateView(userViewSelect.value); }
      } else {
        // Modo Firebase
        const batch = db.batch();
        const ofRef = db.collection(OF_COLLECTION).doc(newOF.id);
        batch.set(ofRef, newOF);
        
        tasksToCreate.forEach(t => {
          const taskRef = db.collection(TASK_COLLECTION).doc(t.id);
          batch.set(taskRef, t);
        });

        try {
          await batch.commit();
          if (!isFallback) { closeModal('create-of-modal'); await loadData(); updateView(userViewSelect.value); }
        } catch (error) {
          if (!isFallback) { msgElement.textContent = `Erro ao salvar no Firebase: ${error.message}`; msgElement.classList.remove('hidden'); }
          console.error("Erro ao salvar OF no Firebase:", error);
        }
      }
    }
    window.createOF = createOF; // Torna global

    // ... (restante das funções de roteiro, ações de operador e detalhes de OF) ...

    // ==========================
    //  EVENTOS DE INICIALIZAÇÃO
    // ==========================
    document.addEventListener('DOMContentLoaded', ()=>{
      initializeApp();
    });

    // Função para rodar o Lucide e atualizar os dados a cada 10s
    function setupUIRefresh(){
      lucide.createIcons();
      // Atualiza a visualização a cada 10 segundos para refletir mudanças de tempo
      setInterval(() => {
        if (!loadingIndicator.classList.contains('hidden')) return;
        if (pcpView.classList.contains('hidden') && reportView.classList.contains('hidden')) {
          renderTasks(); // Renderiza tarefas apenas no modo Operador
        } else if (!pcpView.classList.contains('hidden')) {
          renderKPIs();
          renderOFs(); // Renderiza OFs no modo PCP
        }
      }, 10000); // 10 segundos
    }
  </script>
</body>
</html>
