<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PCP ‚Äì Controle de Produ√ß√£o</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap");
:root {
      color-scheme: light dark;
      --app-bg-color: #f3f4f6;
/* default */
      --app-bg-image: none;
}
    body {
      font-family: "Inter", sans-serif;
      background: var(--app-bg-color) fixed no-repeat center/cover;
background-image: var(--app-bg-image);

      padding-left: max(env(safe-area-inset-left), 0px);
      padding-right: max(env(safe-area-inset-right), 0px);
    }
    .bg-gradient-header { background: linear-gradient(90deg, #1e40af 0%, #3b82f6 100%);
}
    .modal-fixed { position: fixed; inset: 0; }
    .modal-panel { max-height: calc(100dvh - 2rem);
}
    .modal-body-scroll { overflow-y: auto; -webkit-overflow-scrolling: touch; }
    .sticky-footer { position: sticky; bottom: 0;
background: white; padding-top: .5rem; }
    .highlight-red { color: #dc2626; font-weight: 600;
}
    @media (max-width: 640px){
      .modal-panel{ width:100vw!important; max-width:100vw!important; height:100dvh!important; max-height:100dvh!important; border-radius:0!important; margin:0!important; display:flex;
flex-direction:column; }
      .card-tap-big{ padding:1rem; }
    }
  </style>
</head>
<body class="min-h-screen bg-gray-100/0 antialiased">

  <header class="bg-gradient-header shadow-lg p-3 sm:p-4 sticky top-0 z-10">
    <div class="max-w-7xl mx-auto flex justify-between items-center gap-2">
      <h1 class="text-2xl sm:text-3xl font-extrabold text-white flex items-center">
        <i data-lucide="factory" class="w-7 h-7 sm:w-8 sm:h-8 mr-2"></i>
        Controle de Produ√ß√£o
      </h1>
      <div class="flex gap-2 items-center">
        
<button id="btn-profile"
                class="text-white bg-blue-800 hover:bg-blue-700 font-semibold py-2 px-3 rounded-lg shadow-md transition hidden"
                onclick="openUserModal()">
          <i data-lucide="user-cog" class="w-5 h-5 inline-block mr-1"></i>
          <span class="hidden sm:inline">Perfil</span>
        </button>

        <select id="user-view-select" onchange="updateView(this.value)"
             
   class="bg-blue-800 text-white text-xs sm:text-sm font-semibold py-2 px-2 rounded-lg transition hover:bg-blue-700 focus:ring-2 focus:ring-blue-300">
          <option value="PCP">Vis√£o: PCP</option>
          <option value="Operador">Vis√£o: Operador</option>
          <option value="Relatorio">Vis√£o: Relat√≥rio</option>
        </select>

        <button onclick="openModal('create-of-modal')" id="btn-create-of"
                class="text-white bg-green-600 hover:bg-green-700 
font-semibold py-2 px-3 rounded-lg shadow-md transition hidden">
          <i data-lucide="plus" class="w-5 h-5 inline-block mr-1"></i>
          <span class="hidden sm:inline">Criar OF</span>
        </button>
        <button onclick="openModal('setup-roteiro-modal')" id="btn-setup-roteiro"
                class="text-white bg-yellow-600 hover:bg-yellow-700 font-semibold py-2 px-3 rounded-lg shadow-md transition hidden">
          <i data-lucide="settings" class="w-5 h-5 inline-block mr-1"></i>
        
  <span class="hidden sm:inline">Setup Roteiro</span>
        </button>

        <button id="btn-theme-master"
                class="text-white bg-indigo-600 hover:bg-indigo-700 font-semibold py-2 px-3 rounded-lg shadow-md transition hidden"
                onclick="openThemeModal()">
          <i data-lucide="palette" class="w-5 h-5 inline-block mr-1"></i>
    
      <span class="hidden sm:inline">Configurar design</span>
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-3 sm:p-6 lg:p-8">
    <div id="loading-indicator" class="flex flex-col items-center justify-center p-6 sm:p-12 bg-white rounded-xl shadow-xl">
      <i data-lucide="loader-circle" class="w-8 h-8 sm:w-10 sm:h-10 text-blue-500 animate-spin"></i>
      <p class="mt-3 sm:mt-4 text-gray-600 font-semibold text-sm sm:text-base">Carregando dados e autenticando...</p>
    </div>

    <div id="pcp-view" class="space-y-4 sm:space-y-6 
hidden">
      <h2 class="text-xl sm:text-2xl font-bold text-gray-800 border-b pb-2 mb-2 sm:mb-4 flex items-center">
        <i data-lucide="bar-chart-3" class="w-5 h-5 sm:w-6 sm:h-6 mr-2"></i>
        Painel PCP
      </h2>
      <div id="pcp-of-search-wrap" class="mb-2 hidden">
        <input id="pcp-of-search" type="text" placeholder="Pesquisar OF..."
               class="w-full sm:w-64 border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
 
     </div>
      <div id="kpis-container" class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-4"></div>
      <div id="ofs-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-6"></div>
    </div>

    <div id="operator-view" class="space-y-4 sm:space-y-6 hidden">
      <div class="bg-white p-3 sm:p-4 rounded-xl shadow-lg mb-4 sm:mb-6 flex flex-col sm:flex-row items-center justify-between gap-3">
        <h2 class="text-lg sm:text-xl font-bold text-gray-800 flex items-center">
          <i data-lucide="clipboard-list" class="w-5 h-5 sm:w-6 sm:h-6 mr-2 
text-blue-600"></i>
          Minhas Tarefas
        </h2>
        <div class="flex items-center gap-2 w-full sm:w-auto">
          <label for="sector-filter" class="text-xs sm:text-sm font-semibold text-gray-700 flex-shrink-0">Setor:</label>
          <select id="sector-filter" onchange="updateSectorFilter(this.value)"
                  class="p-2 border border-blue-300 rounded-lg bg-blue-50 focus:ring-blue-500 focus:border-blue-500 w-full sm:w-48"></select>
        </div>
      
  <div id="operator-of-search-wrap" class="flex items-center gap-2 w-full sm:w-auto hidden">
          <label class="text-xs sm:text-sm font-semibold text-gray-700 flex-shrink-0">OF:</label>
          <input id="operator-of-search" type="text" placeholder="Filtrar por OF..."
                 class="p-2 border border-blue-300 rounded-lg bg-blue-50 focus:ring-blue-500 focus:border-blue-500 w-full sm:w-48">
        </div>
      </div>
      <div id="tasks-list-container" class="space-y-3 
sm:space-y-4"></div>
    </div>

    <div id="report-view" class="space-y-4 sm:space-y-6 hidden">
      <h2 class="text-xl sm:text-2xl font-bold text-gray-800 border-b pb-2 mb-2 sm:mb-4 flex items-center">
        <i data-lucide="file-text" class="w-5 h-5 sm:w-6 sm:h-6 mr-2 text-purple-600"></i>
        Relat√≥rio de Ocorr√™ncias
      </h2>
      <div class="bg-white p-3 sm:p-4 rounded-xl shadow-lg">
        <div class="flex justify-between items-center mb-3 sm:mb-4">
          <h3 
class="text-base sm:text-xl font-semibold text-gray-700">Pausas & Atrasos</h3>
          
          <div class="flex gap-2">
            <button id="btn-delete-report" onclick="deleteSelectedOcorrencias()"
                    class="px-3 sm:px-4 py-2 bg-red-600 text-white text-sm sm:text-base font-semibold rounded-lg hover:bg-red-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled> <i data-lucide="trash-2" class="w-4 h-4 sm:w-5 sm:h-5 inline-block mr-1"></i> 
              <span class="hidden sm:inline">Excluir Selecionados</span>
            </button>
            <button id="btn-export-report" onclick="exportReportCSV()"
                    class="px-3 sm:px-4 py-2 bg-purple-600 text-white text-sm sm:text-base font-semibold rounded-lg hover:bg-purple-700 transition">
              <i data-lucide="download" class="w-4 h-4 sm:w-5 sm:h-5 inline-block mr-1"></i> Exportar (CSV)
            </button>
          </div>
          </div>
        <div class="overflow-x-auto">
       
   <table class="min-w-full divide-y divide-gray-200 text-xs sm:text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-2 sm:px-4 py-2 sm:py-3 text-center w-12">
                  <input type="checkbox" id="report-select-all" 
                         onclick="toggleSelectAllOcorrencias(this)"
                         class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                </th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">OF</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">CHICOTE</th>
               
 <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">ATIVIDADE</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">MOTIVO PAUSA</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">MOTIVO ATRASO</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">T.
PAUSA (min)</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">T.
ATRASO (min)</th>
              </tr>
            </thead>
            <tbody id="report-table-body" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <div id="action-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal()">
    <div class="bg-white rounded-xl shadow-2xl p-4 
sm:p-6 w-full max-w-md modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <h3 id="modal-title" class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2"></h3>
      <div class="modal-body-scroll">
        <p id="modal-message" class="text-gray-600 mb-3 sm:mb-4"></p>
        <div id="modal-content">
          <div id="justification-area" class="space-y-3 sm:space-y-4">
            <label for="justification-select" class="block text-sm font-medium text-gray-700">Selecione o Motivo Principal:</label>
            <select id="justification-select" class="w-full border border-gray-300 rounded-lg 
p-3 focus:ring-blue-500 focus:border-blue-500 transition">
              <option value="">-- Selecione uma op√ß√£o --</option>
            </select>
            <label for="justification-text" class="block text-sm font-medium text-gray-700">Detalhes Adicionais (Opcional):</label>
            <textarea id="justification-text" rows="2" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500 transition" placeholder=""></textarea>
            <p id="justification-required-text" class="text-sm text-red-500 hidden font-semibold">üö® Campo obrigat√≥rio devido ao desvio de 
tempo!</p>
          </div>
        </div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end gap-2 sm:gap-3 sticky-footer">
        <button onclick="closeModal()" class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition">Cancelar</button>
        <button id="modal-confirm-button" class="px-3 sm:px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition" onclick="handleConfirmedAction()">Confirmar</button>
      </div>
    </div>
  </div>

  <div id="instruction-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 
items-center justify-center hidden" onclick="closeModal('instruction-modal')">
    <div class="bg-white rounded-xl shadow-2xl p-5 sm:p-8 w-full max-w-2xl modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2 flex items-center">
        <i data-lucide="book-open-text" class="w-5 h-5 sm:w-6 sm:h-6 mr-2 text-indigo-600"></i> Instru√ß√£o de Trabalho
      </h3>
      <div class="max-h-[65vh] sm:max-h-[70vh] overflow-y-auto pr-1 sm:pr-2 modal-body-scroll">
        <p class="text-sm font-semibold text-gray-700 mb-2" id="instruction-modal-header"></p>
        <div id="instruction-modal-content" class="text-gray-700 space-y-3"></div>
      
</div>
      <div class="mt-4 sm:mt-6 flex justify-end">
        <button onclick="closeModal('instruction-modal')" class="px-3 sm:px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition">Fechar</button>
      </div>
    </div>
  </div>

  <div id="create-of-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal()">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-lg modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">Criar Nova Ordem de Fabrica√ß√£o (OF)</h3>
      <div class="space-y-3 sm:space-y-4 
modal-body-scroll">
        <div>
          <label for="of-id" class="block text-sm font-medium text-gray-700">C√≥digo da OF:</label>
          <input type="text" id="of-id" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: OF-003">
        </div>
        <div>
          <label for="of-quantity" class="block text-sm font-medium text-gray-700">Quantidade de Pe√ßas:</label>
          <input type="number" id="of-quantity" min="1" class="w-full border border-gray-300 rounded-lg p-2 mt-1 
focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: 50">
        </div>
        <div>
          <label for="of-chicote" class="block text-sm font-medium text-gray-700">Modelo do Chicote (Roteiro Mestre):</label>
          <select id="of-chicote" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-blue-500 focus:border-blue-500">
            <option value="">Carregando roteiros...</option>
          </select>
        </div>
        <div id="of-creation-message" class="text-sm 
text-red-500 hidden"></div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end gap-2 sm:gap-3 sticky-footer">
        <button onclick="closeModal('create-of-modal')" class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition">Cancelar</button>
        <button onclick="createOF()" class="px-3 sm:px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700">
          <i data-lucide="factory" class="w-5 h-5 inline-block mr-1"></i> Gerar OF
        </button>
      </div>
    </div>
  </div>

  <div id="setup-roteiro-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal()">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-2xl modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">Setup: Cadastro de Roteiros Mestres</h3>
      <div id="roteiro-list" class="space-y-4 h-[50vh] sm:h-64 overflow-y-auto mb-4 p-2 border rounded-lg bg-gray-50 modal-body-scroll"></div>
      <div class="border-t pt-4 space-y-4">
        <h4 class="text-base sm:text-lg font-semibold text-gray-700">Nova Etapa para Roteiro:</h4>
        <div class="flex flex-col gap-3">
      
    <div class="flex flex-col sm:flex-row gap-3">
            <input type="text" id="roteiro-chicote-name" class="w-full sm:w-1/2 border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Nome do Chicote (Ex: CHICOTE-A)">
            <select id="roteiro-setor" class="w-full sm:w-1/2 border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500"></select>
          </div>
          <input type="text" id="roteiro-activity-name" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Nome da Atividade (Ex: Pr√© Conex√£o)">
         
 <div class="flex flex-col sm:flex-row gap-3">
            <input type="number" id="roteiro-setup-time" min="0" step="0.1" class="w-full sm:w-1/2 border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Setup (min)">
            <input type="number" id="roteiro-cycle-time" min="0" step="0.1" class="w-full sm:w-1/2 border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ciclo (min/p√ß)">
          </div>
          <div>
            <label for="roteiro-instruction-text" class="block text-sm font-medium text-gray-700 mb-1">Instru√ß√£o de Trabalho (HTML permitido):</label>
 
           <textarea id="roteiro-instruction-text" rows="4" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: <b>1.
Prepara√ß√£o:</b> ..."></textarea>
          </div>
          <button onclick="addRoteiroActivity()" class="p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
            <i data-lucide="plus" class="w-5 h-5 inline-block mr-1"></i> Adicionar Etapa
          </button>
        </div>
        <div id="roteiro-message" class="text-sm text-red-500"></div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end">
        
<button onclick="closeModal('setup-roteiro-modal')" class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition">Fechar</button>
      </div>
    </div>
  </div>

  <div id="of-details-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal('of-details-modal')">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-3xl modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-2">
        <h3 id="of-details-title" class="text-xl sm:text-2xl font-bold text-gray-800"></h3>
        <button class="p-2 rounded-lg hover:bg-gray-100" onclick="closeModal('of-details-modal')"><i data-lucide="x" class="w-6 h-6"></i></button>
      </div>
  
    <div id="of-details-summary" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3 sm:mb-4"></div>
      <div class="w-full bg-gray-200 rounded-full h-2 mb-3 sm:mb-4"><div id="of-details-progress" class="h-2 rounded-full bg-blue-500" style="width:0%"></div></div>
      <div id="of-details-content" class="max-h-[60vh] overflow-y-auto space-y-3 sm:space-y-4 modal-body-scroll"></div>
      <div class="mt-4 sm:mt-5 flex justify-between gap-3 sticky-footer">
        <button id="btn-delete-of" class="px-3 sm:px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition hidden" onclick="deleteOF(window.__ofDetailsOpenId)">
          <i data-lucide="trash-2" class="w-4 h-4 sm:w-5 sm:h-5 inline-block mr-1"></i> Excluir OF
        </button>
 
       <div class="flex gap-2 sm:gap-3">
          <button id="btn-export-of" class="px-3 sm:px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition" onclick="exportOFTasksCSV(window.__ofDetailsOpenId)">Exportar CSV</button>
          <button class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition" onclick="closeModal('of-details-modal')">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <div id="user-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="event.stopPropagation()">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-md 
modal-panel mx-0 sm:mx-4">
      <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">Acesso</h3>
      <div class="space-y-3 sm:space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Perfil</label>
          <select id="user-role" class="w-full border border-gray-300 rounded-lg p-2 mt-1">
            <option value="OPERADOR">Operador</option>
            <option value="MASTER">Master</option>
          </select>
 
       </div>
        <div id="user-sector-wrap">
          <label class="block text-sm font-medium text-gray-700">Setor do Operador</label>
          <select id="user-sector" class="w-full border border-gray-300 rounded-lg p-2 mt-1"></select>
        </div>
        <div id="user-pin-wrap" class="hidden">
          <label class="block text-sm font-medium text-gray-700">PIN do Master</label>
          <input type="password" id="user-pin" class="w-full border border-gray-300 rounded-lg 
p-2 mt-1" placeholder="****">
          <p class="text-xs text-gray-500 mt-1">Apenas numeros</p>
        </div>
        </div>
      <div class="mt-4 sm:mt-6 flex justify-end gap-2 sm:gap-3">
        <button class="px-3 sm:px-4 py-2 bg-gray-200 rounded-lg font-semibold hover:bg-gray-300" onclick="closeModal('user-modal')">Cancelar</button>
        <button class="px-3 sm:px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700" onclick="confirmUser()">Entrar</button>
      </div>
    </div>
  </div>

  <div id="theme-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal('theme-modal')">
    <div class="bg-white rounded-xl 
shadow-2xl p-4 w-full max-w-md" onclick="event.stopPropagation()">
      <h3 class="text-lg font-bold text-gray-800 mb-3">Configurar design</h3>
      <div class="space-y-3">
        <div>
          <label class="font-semibold text-sm">Modo</label>
          <select id="theme-mode" class="w-full border rounded-lg p-2 mt-1">
            <option value="color">Cor fixa</option>
            <option value="image">Imagem</option>
          </select>
     
   </div>

        <div id="theme-color-wrap">
          <label class="font-semibold text-sm">Cor</label>
          <div class="flex gap-2 mt-1">
            <input id="theme-color" type="color" value="#0ea5e9" class="h-10 w-16 border rounded"/>
            <select id="theme-palette" class="border rounded p-2">
              <option value="#0ea5e9">Azul</option>
             
 <option value="#111827">Preto</option>
              <option value="#10b981">Verde</option>
              <option value="#f59e0b">Laranja</option>
              <option value="#6b7280">Cinza</option>
              <option value="#3b82f6">Azul Claro</option>
              <option value="#1f2937">Grafite</option>
            </select>
          
</div>
        </div>

        <div id="theme-image-wrap" class="hidden">
          <label class="font-semibold text-sm">Imagem (upload)</label>
          <input id="theme-image-file" type="file" accept="image/*" class="mt-1"/>
        </div>
      </div>

      <div class="mt-4 flex justify-end gap-2">
        <button class="px-3 py-2 bg-gray-200 rounded" onclick="closeModal('theme-modal')">Cancelar</button>
        <button class="px-3 py-2 bg-indigo-600 text-white rounded" onclick="saveTheme()">Salvar</button>
    
  </div>
    </div>
  </div>

<script>
/* ============================
   FIREBASE CONFIG
   ============================ */
const firebaseConfig = {
  apiKey: "AIzaSyDIJJIe4WIVj5OKYTtR-HQscrxIzxNK9eY",
  authDomain: "pcp-app-24c56.firebaseapp.com",
  projectId: "pcp-app-24c56",
  storageBucket: "pcp-app-24c56.firebasestorage.app",
  messagingSenderId: "675295958467",
  appId: "1:675295958467:web:9d79700af6fc1c28db5976",
  measurementId: "G-DH06WDCKJY"
};
// Inicializa√ß√£o Firebase
if (firebaseConfig && firebaseConfig.projectId && firebaseConfig.projectId !== "SEU_PROJECT_ID") {
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
const storage = firebase.storage();
  window.db = db;
  window.storage = storage;

  // Cole√ß√µes
  const OF_COLLECTION = 'ofs';
const TASK_COLLECTION = 'tasks';
  const ROTEIRO_COLLECTION = 'roteiros';
  const OCORRENCIA_COLLECTION = 'ocorrencias';
  window.OF_COLLECTION = OF_COLLECTION;
  window.TASK_COLLECTION = TASK_COLLECTION;
window.ROTEIRO_COLLECTION = ROTEIRO_COLLECTION;
  window.OCORRENCIA_COLLECTION = OCORRENCIA_COLLECTION;
} else {
  console.warn("Firebase n√£o configurado ‚Äî rodando em modo simulado.");
window.db = null;
  window.storage = null;
}

/* ============================
   CONSTANTES & ESTADO
   ============================ */
const MASTER_PIN = "7889";
const SECTORS = [
  'Corte','Corte de Revestimentos','Pr√©-Montagem','Prepara√ß√£o','Pr√© Conex√£o',
  'Conex√£o','Pr√© Grampea√ß√£o','Grampea√ß√£o','Acabamento','Embalagem','Montagem','Cabo de Bateria 1','Cabo de Bateria 2'
];
const PAUSE_REASONS = [
  "Falta de material na bancada","Manuten√ß√£o/Ajuste de m√°quina","Instru√ß√£o de trabalho confusa/ausente",
  "Necessidade de assist√™ncia t√©cnica","Troca de turno/intervalo programado","Outro (Detalhar abaixo)"
];
const DELAY_REASONS = [
  "Complexidade inesperada da pe√ßa","Problema de qualidade na etapa anterior","Falta de treinamento/experi√™ncia",
  "Tempo padr√£o calculado incorretamente","Quebra/defeito de ferramenta","Outro (Detalhar abaixo)"
];
let allOFs = {};
let allTasks = {};
let allRoteiros = {};
let allOcurrencesLog = [];
let currentAction = {};
let currentSectorFilter = SECTORS[0];
let currentUser = null;

// Busca por OF nas telas
let pcpSearchOF = "";
let operatorSearchOF = "";

// Simula√ß√£o
let taskCounter = 1;
let roteiroCounter = 7;
const DEFAULT_ROTEIROS = {
  "r1": { id:"r1", chicote_nome:"CHICOTE-001", setor:"Corte", nome_atividade:"Corte dos Fios", tempo_setup:5, tempo_ciclo:0.2,
    instrucao_trabalho:"<b>1. Prepara√ß√£o:</b> Verifique a faca...<br><b>2. Medi√ß√£o:</b> Corte 50 pe√ßas de 150mm.<br><b>3. Confer√™ncia:</b> Visual."
},
  "r2": { id:"r2", chicote_nome:"CHICOTE-001", setor:"Pr√©-Montagem", nome_atividade:"Crimpagem de Terminais", tempo_setup:8, tempo_ciclo:0.5,
    instrucao_trabalho:"<b>Fio Preto:</b> ...<br><b>Fio Vermelho:</b> ...<br><b>Teste:</b> > 10Kgf."
},
  "r3": { id:"r3", chicote_nome:"CHICOTE-001", setor:"Montagem Final", nome_atividade:"Montagem de Conectores", tempo_setup:15, tempo_ciclo:1.0,
    instrucao_trabalho:"Conectar posi√ß√µes 35 e 33. Proibido for√ßar."
},
  "r4": { id:"r4", chicote_nome:"CHICOTE-001", setor:"Qualidade", nome_atividade:"Teste de Continuidade", tempo_setup:3, tempo_ciclo:0.1,
    instrucao_trabalho:"Usar jig JIG-10B. 100% devem passar."
},
  "r5": { id:"r5", chicote_nome:"CHICOTE-B", setor:"Corte", nome_atividade:"Corte Refor√ßado", tempo_setup:10, tempo_ciclo:0.3, instrucao_trabalho:"Instru√ß√£o b√°sica B."},
  "r6": { id:"r6", chicote_nome:"CHICOTE-B", setor:"Montagem Final", nome_atividade:"Montagem Simples", tempo_setup:5, tempo_ciclo:0.8, instrucao_trabalho:"Conectar 4 vias."},
};
/* ============================
   ELEMENTOS UI
   ============================ */
const pcpView = document.getElementById("pcp-view");
const operatorView = document.getElementById("operator-view");
const reportView = document.getElementById("report-view");
const loadingIndicator = document.getElementById("loading-indicator");
const ofsListContainer = document.getElementById("ofs-list-container");
const tasksListContainer = document.getElementById("tasks-list-container");
const userViewSelect = document.getElementById("user-view-select");
const btnCreateOF = document.getElementById("btn-create-of");
const btnSetupRoteiro = document.getElementById("btn-setup-roteiro");
const btnProfile = document.getElementById("btn-profile");
const btnThemeMaster = document.getElementById("btn-theme-master");
const btnExportReport = document.getElementById("btn-export-report");
const btnDeleteOF = document.getElementById("btn-delete-of");

/* ============================
   HELPERS & PERMISS√ïES
   ============================ */
function msToMinutes(ms){ if (typeof ms !== 'number' || ms < 0) return 0;
return parseFloat((ms / (1000*60)).toFixed(2)); }
function formatMinutes(v){ return `${Number(v||0).toFixed(2)} min`; }

function setUser(u){
  currentUser = u;
  try { sessionStorage.setItem("pcp_current_user", JSON.stringify(u));
} catch(_){}
}
function getUser(){
  try { return JSON.parse(sessionStorage.getItem("pcp_current_user") || "null"); }
  catch(e){ return null; }
}
function clearUser(){ try{ sessionStorage.removeItem("pcp_current_user");
}catch(_){} currentUser=null; }

function isMaster(){ return currentUser && currentUser.role === "MASTER"; }
function isOperador(){ return currentUser && currentUser.role === "OPERADOR";
}

function getDBTimestamp(ts) {
  if (!ts) return null;
  if (typeof ts.toDate === 'function') return ts.toDate().getTime();
if (ts instanceof Date) return ts.getTime();
  return ts;
}

/* ============================
   THEME (Global via Firestore)
   ============================ */
function listenTheme(){
  if (!window.db) return;
db.collection('settings').doc('ui').onSnapshot(doc=>{
    const s = doc.exists ? doc.data() : null;
    applyTheme(s);
  });
}
function applyTheme(s){
  const r = document.documentElement.style;
  if (!s || s.mode === 'color'){
    r.setProperty('--app-bg-color', s?.color || '#f3f4f6');
r.setProperty('--app-bg-image', 'none');
  } else {
    r.setProperty('--app-bg-color', '#000000');
    r.setProperty('--app-bg-image', `url("${s.imageUrl}")`);
  }
}

function openThemeModal(){ document.getElementById('theme-modal').style.display = 'flex';
}
function saveTheme(){
  if (!window.db) { alert('Configure o Firebase para salvar o tema.'); return; }
  const mode = document.getElementById('theme-mode').value;
if (mode === 'color'){
    const color = document.getElementById('theme-color').value || document.getElementById('theme-palette').value;
db.collection('settings').doc('ui').set({ mode:'color', color }, { merge:true }).then(()=> closeModal('theme-modal'));
  } else {
    const file = document.getElementById('theme-image-file').files[0];
if (!file) { alert('Escolha uma imagem.'); return; }
    const ref = storage.ref().child(`ui/${Date.now()}_${file.name}`);
ref.put(file).then(()=> ref.getDownloadURL()).then(url=>{
      return db.collection('settings').doc('ui').set({ mode:'image', imageUrl:url }, { merge:true });
    }).then(()=> closeModal('theme-modal'))
      .catch(e=> alert('Erro ao enviar imagem: ' + e.message));
}
}

/* ============================
   C√ÅLCULOS DE TEMPO
   ============================ */
function calculateTempoReal(task){
  let tempoReal = task.tempo_real_acumulado || 0;
const now = Date.now();
  if (task.status === 'Em Processo' && task.timestamp_inicio){
    let inicioMs = getDBTimestamp(task.timestamp_inicio);
if (inicioMs) tempoReal += msToMinutes(now - inicioMs);
  }
  return parseFloat(tempoReal.toFixed(2));
}
function calculateDesvio(task){
  const tempoReal = calculateTempoReal(task);
const desvio = (task.tempo_planejado||0) - tempoReal; // negativo = atraso
  return parseFloat(desvio.toFixed(2));
}
function calculateTotalPauseMinutes(task){
  let totalMs = task.total_pause_time_ms || 0;
  if (task.status === 'Pausada' && task.pause_start_timestamp){
    let pauseStartMs = getDBTimestamp(task.pause_start_timestamp);
if (pauseStartMs) totalMs += Date.now() - pauseStartMs;
  }
  return msToMinutes(totalMs);
}
function calculateTotalPauseMinutesFinal(task){ return msToMinutes(task.total_pause_time_ms || 0);
}

/* ============================
   INICIALIZA√á√ÉO & LISTENERS
   ============================ */
function setupSectorDropdowns(){
  const roteiroSetorSelect = document.getElementById('roteiro-setor');
const sectorFilterSelect = document.getElementById('sector-filter');
  const userSectorSelect = document.getElementById('user-sector');
  [roteiroSetorSelect, sectorFilterSelect, userSectorSelect].forEach(sel => { if (sel) sel.innerHTML = ''; });
SECTORS.forEach(sector=>{
    const o1 = document.createElement('option'); o1.value=sector; o1.textContent=sector;
    const o2 = o1.cloneNode(true);
    if (roteiroSetorSelect) roteiroSetorSelect.appendChild(o1);
    if (userSectorSelect) userSectorSelect.appendChild(o2);
  });
if (sectorFilterSelect){
    if (isOperador()){
      const o = document.createElement('option');
      o.value=currentUser.sector; o.textContent=currentUser.sector; sectorFilterSelect.appendChild(o);
      sectorFilterSelect.value=currentUser.sector;
sectorFilterSelect.disabled = true;
      currentSectorFilter = currentUser.sector;
    } else {
      SECTORS.forEach(sector=>{
        const o2 = document.createElement('option'); o2.value=sector; o2.textContent=sector; sectorFilterSelect.appendChild(o2);
      });
currentSectorFilter = SECTORS[0];
      sectorFilterSelect.value = SECTORS[0];
      sectorFilterSelect.disabled = false;
    }
  }
}
function updateSectorFilter(sector){ currentSectorFilter = sector; renderTasks();
}

function loadRoteiroDropdowns() {
  const select = document.getElementById('of-chicote');
  if (!select) return;
  const roteiros = Object.values(allRoteiros);
const chicotes = [...new Set(roteiros.map(r => r.chicote_nome))];
  select.innerHTML = '<option value="">-- Selecione um Modelo --</option>';
chicotes.forEach(chicote => {
    const option = document.createElement('option');
    option.value = chicote;
    option.textContent = chicote;
    select.appendChild(option);
  });
if (chicotes.length === 0) {
    select.innerHTML = '<option value="">Nenhum roteiro mestre cadastrado.</option>';
  }
}

async function initializeApp(){
  loadingIndicator.classList.remove('hidden');
// Esconde tudo enquanto n√£o loga
  pcpView.classList.add('hidden');
  operatorView.classList.add('hidden');
  reportView.classList.add('hidden');

  // Tema global (escuta sempre)
  listenTheme();
// Restaura sess√£o (sessionStorage)
  const savedUser = getUser();
  if (savedUser){ setUser(savedUser);
}

  if (window.db) {
    setupFirebaseListeners();
  } else {
    // SIMULA√á√ÉO
    allRoteiros = { ...DEFAULT_ROTEIROS };
if (!localStorage.getItem('sim_data_initialized')) {
      await createOF('OF-001', 10, 'CHICOTE-001', true);
      await createOF('OF-002', 20, 'CHICOTE-B', true);
      localStorage.setItem('sim_data_initialized', 'true');
} else {
      allOFs = JSON.parse(localStorage.getItem('sim_ofs') || '{}');
      allTasks = JSON.parse(localStorage.getItem('sim_tasks') || '{}');
allOcurrencesLog = JSON.parse(localStorage.getItem('sim_ocorrencias') || '[]');
    }
    setTimeout(()=>{
      loadingIndicator.classList.add('hidden');
      openUserModal(savedUser ? null : undefined);
      setupUIRefresh();
      loadRoteiroDropdowns();
      injectSearchInputs();
    }, 300);
}

  setupSectorDropdowns();
  if (!savedUser) {
    openUserModal();
  } else {
    updateView(userViewSelect.value);
    injectSearchInputs();
}
}

function setupFirebaseListeners() {
  if (!window.db) return;

  db.collection(OF_COLLECTION).onSnapshot(snapshot => {
    snapshot.docChanges().forEach(change => {
      const ofData = { id: change.doc.id, ...change.doc.data() };
      if (change.type === 'removed') delete allOFs[ofData.id];
      else allOFs[ofData.id] = ofData;
    });
    updateView(userViewSelect.value);
    loadRoteiroDropdowns();
  });
db.collection(TASK_COLLECTION).onSnapshot(snapshot => {
    snapshot.docChanges().forEach(change => {
      const taskData = { id: change.doc.id, ...change.doc.data() };
      if (change.type === 'removed') delete allTasks[taskData.id];
      else allTasks[taskData.id] = taskData;
    });
    updateView(userViewSelect.value);
  });
db.collection(ROTEIRO_COLLECTION).onSnapshot(snapshot => {
    allRoteiros = {};
    snapshot.forEach(doc => {
      const roteiroData = { id: doc.id, ...doc.data() };
      allRoteiros[roteiroData.id] = roteiroData;
    });
    loadRoteiroDropdowns();
    renderRoteiros();
  });
db.collection(OCORRENCIA_COLLECTION).onSnapshot(snapshot => {
    allOcurrencesLog = [];
    snapshot.forEach(doc => { allOcurrencesLog.push({ id: doc.id, ...doc.data() }); });
    allOcurrencesLog.sort((a,b) => getDBTimestamp(b.timestamp) - getDBTimestamp(a.timestamp));
    updateView(userViewSelect.value);
    
    // Apenas esconde o loading principal *depois* de carregar as ocorr√™ncias (que s√£o as √∫ltimas)
    if (!loadingIndicator.classList.contains('hidden')){
      loadingIndicator.classList.add('hidden');
      injectSearchInputs();
    }
  });
}

/* ============================
   CRUD
   ============================ */
async function addRoteiroActivity(){
  const chicote_name = document.getElementById('roteiro-chicote-name').value.trim().toUpperCase();
  const setor = document.getElementById('roteiro-setor').value;
const activity_name = document.getElementById('roteiro-activity-name').value.trim();
  const setup_time = parseFloat(document.getElementById('roteiro-setup-time').value);
  const cycle_time = parseFloat(document.getElementById('roteiro-cycle-time').value);
  const instruction_text = document.getElementById('roteiro-instruction-text').value.trim();
  const messageEl = document.getElementById('roteiro-message');
messageEl.textContent = '';
  if (!chicote_name || !activity_name || isNaN(setup_time) || isNaN(cycle_time) || !setor){
    messageEl.textContent = "Preencha todos os campos obrigat√≥rios e use n√∫meros para tempo.";
return;
  }
  if (window.db) {
    try {
      const newRoteiro = {
        chicote_nome: chicote_name,
        setor: setor,
        nome_atividade: activity_name,
        tempo_setup: setup_time,
        tempo_ciclo: cycle_time,
        instrucao_trabalho: instruction_text,
        created_at: firebase.firestore.FieldValue.serverTimestamp()
      };
await db.collection(ROTEIRO_COLLECTION).add(newRoteiro);
      messageEl.textContent = `Etapa "${activity_name}" adicionada ao roteiro mestre ${chicote_name}.`;
      messageEl.classList.remove('text-red-500');
      messageEl.classList.add('text-green-600');
} catch(e) {
      messageEl.textContent = "Erro ao salvar no Firebase: " + e.message;
      messageEl.classList.add('text-red-500');
}
  } else {
    const newId = `r${roteiroCounter++}`;
allRoteiros[newId] = {
      id: newId, chicote_nome: chicote_name, setor,
      nome_atividade: activity_name, tempo_setup: setup_time, tempo_ciclo: cycle_time,
      instrucao_trabalho: instruction_text
    };
messageEl.textContent = `Etapa "${activity_name}" adicionada (Simula√ß√£o).`;
    messageEl.classList.remove('text-red-500');
    messageEl.classList.add('text-green-600');
    renderRoteiros();
    loadRoteiroDropdowns();
  }
  document.getElementById('roteiro-activity-name').value = '';
  document.getElementById('roteiro-setup-time').value = '';
document.getElementById('roteiro-cycle-time').value = '';
  document.getElementById('roteiro-instruction-text').value = '';
}

async function createOF(ofIdOverride, quantityOverride, chicoteOverride, isSimulated = false){
  const of_id = ofIdOverride ||
document.getElementById('of-id').value.trim().toUpperCase();
  const quantity = quantityOverride || parseInt(document.getElementById('of-quantity').value);
  const chicote_name = chicoteOverride || document.getElementById('of-chicote').value;
  const messageEl = document.getElementById('of-creation-message');
  messageEl.textContent = '';
messageEl.classList.add('hidden');

  if (!of_id || isNaN(quantity) || quantity <= 0 || !chicote_name){
    messageEl.textContent = "Preencha todos os campos corretamente.";
messageEl.classList.remove('hidden');
    return;
  }
  if (Object.values(allOFs).find(of => of.id === of_id)) {
    messageEl.textContent = `OF "${of_id}" j√° existe.`;
messageEl.classList.remove('hidden');
    return;
  }

  const roteiroEtapas = Object.values(allRoteiros).filter(r => r.chicote_nome === chicote_name);
if (roteiroEtapas.length === 0){
    messageEl.textContent = `Nenhuma etapa encontrada para "${chicote_name}".`;
    messageEl.classList.remove('hidden');
    return;
}

  const newOF = {
    id: of_id, chicote: chicote_name, quantidade: quantity,
    status: 'Pendente',
    data_criacao: window.db ?
firebase.firestore.FieldValue.serverTimestamp() : new Date(),
    task_count: roteiroEtapas.length,
    concluded_tasks: 0,
  };
try {
    if (window.db) { await db.collection(OF_COLLECTION).doc(of_id).set(newOF); }
    else { allOFs[of_id] = newOF;
}

    const batch = window.db ? db.batch() : null;
    let order = 1;
for (const etapa of roteiroEtapas) {
      const tempo_planejado = etapa.tempo_setup + (etapa.tempo_ciclo * quantity);
const newTask = {
        id_of: of_id, id_roteiro: etapa.id, chicote: chicote_name,
        nome_atividade: etapa.nome_atividade, setor: etapa.setor,
        tempo_setup: etapa.tempo_setup, tempo_ciclo: etapa.tempo_ciclo,
        tempo_planejado: parseFloat(tempo_planejado.toFixed(2)),
        instrucao_trabalho: etapa.instrucao_trabalho,
        quantidade_pecas: quantity,
        // Paralelo: todas Em Espera
        status: 'Em Espera',
        ordem: order++,
    
    timestamp_inicio: null, timestamp_fim: null,
        tempo_real_acumulado: 0,
        total_pause_time_ms: 0,
        pause_start_timestamp: null,
        search_index: of_id.toLowerCase()+'-'+etapa.nome_atividade.toLowerCase()+'-'+etapa.setor.toLowerCase()
      };
if (window.db) {
        const newTaskRef = db.collection(TASK_COLLECTION).doc();
        batch.set(newTaskRef, newTask);
} else {
        const simTaskId = `t${taskCounter++}`;
        newTask.id = simTaskId;
        allTasks[simTaskId] = newTask;
}
    }
    if (batch) await batch.commit();
if (!isSimulated) {
      closeModal('create-of-modal');
      alert(`OF ${of_id} criada com sucesso!`);
if (!window.db) {
        localStorage.setItem('sim_ofs', JSON.stringify(allOFs));
        localStorage.setItem('sim_tasks', JSON.stringify(allTasks));
}
    }
  } catch(e) {
    messageEl.textContent = "Erro ao criar OF: " + (e.message || e);
messageEl.classList.remove('hidden');
  }
}

async function updateTaskStatus(taskId, newStatus, logType = null, justification = null, justificationText = null) {
  const task = allTasks[taskId];
if (!task) return;

  const updateData = { status: newStatus };
  const now = window.db ? firebase.firestore.FieldValue.serverTimestamp() : new Date();
if (newStatus === 'Em Processo') {
    if (task.status === 'Pausada' && task.pause_start_timestamp) {
      const pauseStartMs = getDBTimestamp(task.pause_start_timestamp);
const currentPauseTimeMs = Date.now() - pauseStartMs;
      updateData.total_pause_time_ms = (task.total_pause_time_ms || 0) + currentPauseTimeMs;
      updateData.pause_start_timestamp = null;
}
    if (task.status === 'Em Espera') updateData.timestamp_inicio = now;
} 
  else if (newStatus === 'Pausada') {
    const currentTempoReal = calculateTempoReal(task);
    updateData.tempo_real_acumulado = currentTempoReal;
updateData.pause_start_timestamp = now;
    if (logType === 'PAUSA' && (justification || justificationText)) {
      await createOcorrenciaLog(task, 'PAUSA', justification, justificationText);
}
  } 
  else if (newStatus === 'Conclu√≠do') {
    const finalTempoReal = calculateTempoReal(task);
const desvio = calculateDesvio(task);
    updateData.tempo_real_acumulado = finalTempoReal;
    updateData.timestamp_fim = now;
    updateData.pause_start_timestamp = null;
if (desvio < 0 || logType === 'FIM_ATRASO') {
      await createOcorrenciaLog(task, 'FIM_ATRASO', justification, justificationText);
}

    if (window.db) {
      const ofRef = db.collection(OF_COLLECTION).doc(task.id_of);
const tasksDaOF = Object.values(allTasks).filter(t => t.id_of === task.id_of);
      const totalConcluidas = tasksDaOF.filter(t => (t.id === taskId) ? true : t.status === 'Conclu√≠do').length;
const ofConcluida = totalConcluidas >= tasksDaOF.length;

      const batch = db.batch();
      batch.update(db.collection(TASK_COLLECTION).doc(taskId), updateData);
batch.update(ofRef, {
        concluded_tasks: firebase.firestore.FieldValue.increment(1),
        status: ofConcluida ? 'Conclu√≠do' : 'Em Andamento'
      });
await batch.commit();
    } else {
      const of = allOFs[task.id_of];
of.concluded_tasks = (of.concluded_tasks || 0) + 1;
      Object.assign(task, updateData);
      const tasksDaOF = Object.values(allTasks).filter(t => t.id_of === task.id_of);
const totalConcluidas = tasksDaOF.filter(t => t.status === 'Conclu√≠do').length;
      of.status = (totalConcluidas >= tasksDaOF.length) ? 'Conclu√≠do' : 'Em Andamento';
      localStorage.setItem('sim_ofs', JSON.stringify(allOFs));
localStorage.setItem('sim_tasks', JSON.stringify(allTasks));
    }
    renderTasks();
    return;
  }

  if (window.db) {
    await db.collection(TASK_COLLECTION).doc(taskId).update(updateData);
} else {
    Object.assign(task, updateData);
    localStorage.setItem('sim_tasks', JSON.stringify(allTasks));
  }
  renderTasks();
}

async function createOcorrenciaLog(task, type, justification, justificationText) {
  const logData = {
    ID_TASK: task.id, OF: task.id_of, CHICOTE: task.chicote, ATIVIDADE: task.nome_atividade,
    OPERADOR: currentUser?.name ||
currentUser?.sector || '', SECTOR: task.setor,
    MOTIVO_PRINCIPAL: justification, MOTIVO_DETALHES: justificationText,
    timestamp: window.db ?
firebase.firestore.FieldValue.serverTimestamp() : new Date()
  };

  // === IN√çCIO DA ALTERA√á√ÉO (Corre√ß√£o do Bug T. PAUSA) ===
  if (type === 'PAUSA') {
    // const pauseTimeMs = Date.now() - getDBTimestamp(task.pause_start_timestamp); // Linha original com BUG
logData.TIPO = 'PAUSA';
    logData.TEMPO_PAUSA = 0; // CORRE√á√ÉO: A pausa est√° apenas come√ßando, a dura√ß√£o √© 0.
    logData.TEMPO_ATRASO = 0;
    logData.MOTIVO_PAUSA = justification;
    logData.MOTIVO_ATRASO = null;
} else if (type === 'FIM_ATRASO') {
    const desvio = calculateDesvio(task);
    logData.TIPO = 'ATRASO';
    logData.TEMPO_PAUSA = calculateTotalPauseMinutesFinal(task);
logData.TEMPO_ATRASO = parseFloat(Math.abs(desvio).toFixed(2));
    logData.MOTIVO_PAUSA = null;
    logData.MOTIVO_ATRASO = justification;
  }
  // === FIM DA ALTERA√á√ÉO ===

  if (window.db) await db.collection(OCORRENCIA_COLLECTION).add(logData);
else {
    logData.id = `log${allOcurrencesLog.length + 1}`;
    allOcurrencesLog.push(logData);
    localStorage.setItem('sim_ocorrencias', JSON.stringify(allOcurrencesLog));
}
}

/* ============================
   A√á√ïES
   ============================ */
function startTask(taskId){ updateTaskStatus(taskId, 'Em Processo'); }
function finishTask(taskId){ showActionModal(taskId, 'Finalizar', DELAY_REASONS);
}
function pauseTask(taskId){ showActionModal(taskId, 'Pausar', PAUSE_REASONS); }

async function deleteRoteiroActivity(roteiroId) {
  if (!isMaster() || !confirm("Excluir esta etapa de roteiro?")) return;
if (window.db) {
    try { await db.collection(ROTEIRO_COLLECTION).doc(roteiroId).delete(); alert("Etapa exclu√≠da.");
}
    catch(e) { alert("Erro ao excluir: " + e.message);
}
  } else {
    delete allRoteiros[roteiroId];
    renderRoteiros();
    loadRoteiroDropdowns();
}
}

async function deleteOF(ofId) {
  if (!isMaster() || !ofId) return;
if (!confirm(`Excluir OF ${ofId} e TODAS as suas tarefas e logs?`)) return;
try {
    if (window.db) {
      const batch = db.batch();
      batch.delete(db.collection(OF_COLLECTION).doc(ofId));
const tasksSnapshot = await db.collection(TASK_COLLECTION).where('id_of', '==', ofId).get();
      tasksSnapshot.docs.forEach(doc => batch.delete(doc.ref));
      const ocorrenciasSnapshot = await db.collection(OCORRENCIA_COLLECTION).where('OF', '==', ofId).get();
      ocorrenciasSnapshot.docs.forEach(doc => batch.delete(doc.ref));
await batch.commit();
    } else {
      delete allOFs[ofId];
Object.keys(allTasks).forEach(id => { if (allTasks[id].id_of === ofId) delete allTasks[id]; });
      allOcurrencesLog = allOcurrencesLog.filter(l => l.OF !== ofId);
      localStorage.setItem('sim_ofs', JSON.stringify(allOFs));
localStorage.setItem('sim_tasks', JSON.stringify(allTasks));
      localStorage.setItem('sim_ocorrencias', JSON.stringify(allOcurrencesLog));
    }
    closeModal('of-details-modal');
    alert(`OF ${ofId} exclu√≠da.`);
    renderOFs();
} catch(e) {
    alert("Erro ao excluir OF: " + (e.message || e));
}
}

/* ============================
   MODAIS
   ============================ */
function openModal(id){
  const modal = document.getElementById(id);
  if(modal) modal.style.display = 'flex';
if(id === 'setup-roteiro-modal') renderRoteiros();
}
function closeModal(id){
  const modalId = id || 'action-modal';
  const modal = document.getElementById(modalId);
if(modal) {
    modal.style.display = 'none';
    if (modalId === 'action-modal') {
      currentAction = {};
const jsSel = document.getElementById('justification-select');
      const jsTxt = document.getElementById('justification-text');
      const jsReq = document.getElementById('justification-required-text');
      if (jsSel) jsSel.value = '';
if (jsTxt) jsTxt.value = '';
      if (jsReq) jsReq.classList.add('hidden');
    }
  }
}
function showActionModal(taskId, type, reasons){
  const task = allTasks[taskId];
if (!task) return;
  currentAction = { taskId, type };
  const title = document.getElementById('modal-title');
  const message = document.getElementById('modal-message');
const justificationSelect = document.getElementById('justification-select');
  const justificationRequired = document.getElementById('justification-required-text');

  title.textContent = `${type} Atividade: ${task.nome_atividade}`;
  message.textContent = `OF ${task.id_of} - Chicote ${task.chicote}`;
justificationSelect.innerHTML = '<option value="">-- Selecione uma op√ß√£o --</option>';
  reasons.forEach(reason => {
    const option = document.createElement('option');
    option.value = reason;
    option.textContent = reason;
    justificationSelect.appendChild(option);
  });
let isRequired = false;
  if (type === 'Finalizar') {
    const desvio = calculateDesvio(task);
if (desvio < 0) {
      justificationRequired.textContent = `üö® Justificativa obrigat√≥ria devido ao ATRASO de ${formatMinutes(Math.abs(desvio))}!`;
isRequired = true;
    } else {
      justificationRequired.textContent = `‚úÖ Conclu√≠do dentro/antes do tempo.
Nenhuma justificativa necess√°ria.`;
      isRequired = false;
    }
  } else if (type === 'Pausar') {
    justificationRequired.textContent = `Motivo da pausa √© altamente recomendado.`;
}
  justificationRequired.classList.toggle('hidden', !isRequired && type !== 'Pausar');
  currentAction.isRequired = isRequired;

  openModal('action-modal');
}
async function handleConfirmedAction(){
  const { taskId, type, isRequired } = currentAction;
  const justificationSelect = document.getElementById('justification-select');
  const justificationText = document.getElementById('justification-text').value.trim();
const justification = justificationSelect.value;
  const justificationRequired = document.getElementById('justification-required-text');
  if (isRequired && !justification) {
    justificationRequired.textContent = "üö® Voc√™ deve selecionar um motivo principal!";
justificationRequired.classList.remove('hidden');
    return;
  }
  justificationRequired.classList.add('hidden');

  if (type === 'Finalizar') {
    await updateTaskStatus(taskId, 'Conclu√≠do', null, justification, justificationText);
    updateView(userViewSelect.value);
} else if (type === 'Pausar') {
    await updateTaskStatus(taskId, 'Pausada', 'PAUSA', justification, justificationText);
  }
  closeModal();
}
function openInstructionModal(taskId) {
  const task = allTasks[taskId];
  if (!task) return;
document.getElementById('instruction-modal-header').textContent =
    `OF ${task.id_of} - Chicote ${task.chicote} - Setor: ${task.setor}`;
  document.getElementById('instruction-modal-content').innerHTML =
    task.instrucao_trabalho ||
'Nenhuma instru√ß√£o de trabalho cadastrada para esta etapa.';
  openModal('instruction-modal');
  lucide.createIcons();
}

function openUserModal() {
  const modal = document.getElementById('user-modal');
if(modal) modal.style.display = 'flex';
  setTimeout(()=>{
    const roleSel = document.getElementById('user-role');
    const pinWrap = document.getElementById('user-pin-wrap');
    const sectorWrap = document.getElementById('user-sector-wrap');
    roleSel.onchange = () => {
      const isM = roleSel.value === 'MASTER';
      pinWrap.classList.toggle('hidden', !isM);
      sectorWrap.classList.toggle('hidden', isM);
    };
    roleSel.dispatchEvent(new Event('change'));
  }, 50);
}
function confirmUser(){
  const role = document.getElementById('user-role').value;
  const sector = document.getElementById('user-sector').value;
if (role === 'MASTER') {
    const pin = document.getElementById('user-pin').value;
    if (pin !== MASTER_PIN) { alert("PIN incorreto."); return;
}
    setUser({ role: 'MASTER', name: 'Master' });
} else {
    if (!sector) { alert("Selecione o setor."); return;
}
    setUser({ role: 'OPERADOR', sector, name: 'Operador' });
  }
  document.getElementById('user-modal').style.display = 'none';
  setupSectorDropdowns();
  updateView(userViewSelect.value);
  injectSearchInputs();
}

/* ============================
   RENDERIZA√á√ÉO
   ============================ */
function setupUIRefresh(){
  setInterval(()=>{
    if (!pcpView.classList.contains('hidden')) { renderOFs(); renderKPIs(); }
    if (!operatorView.classList.contains('hidden')) renderTasks();
  }, 10000);
}
function injectSearchInputs(){
  // PCP search
  const wrap = document.getElementById('pcp-of-search-wrap');
  if (wrap && !wrap.dataset.ready){
    wrap.classList.remove('hidden');
wrap.dataset.ready = "1";
    const input = document.getElementById('pcp-of-search');
    if (input) input.addEventListener('input', (e)=>{ pcpSearchOF = (e.target.value||"").trim().toUpperCase(); renderOFs(); });
}
  // Operator search
  const opWrap = document.getElementById('operator-of-search-wrap');
  if (opWrap && !opWrap.dataset.ready){
    opWrap.classList.remove('hidden');
opWrap.dataset.ready = "1";
    const input = document.getElementById('operator-of-search');
    if (input) input.addEventListener('input', (e)=>{ operatorSearchOF = (e.target.value||"").trim().toUpperCase(); renderTasks(); });
}
}

function renderKPIs(){
  const kpisContainer = document.getElementById('kpis-container');
  if (!kpisContainer) return;

  const totalOFs = Object.keys(allOFs).filter(k=> allOFs[k]?.status !== 'Conclu√≠do').length;
const concludedTasks = Object.values(allTasks).filter(t=>t.status==='Conclu√≠do').length;
  const totalTasks = Object.values(allTasks).length;

  const logsAtraso = allOcurrencesLog.filter(l => l.TIPO === 'ATRASO');
const totalPause = allOcurrencesLog.reduce((s,l)=> s + (l.TEMPO_PAUSA||0), 0);
  const totalAtraso = logsAtraso.reduce((s,l)=> s + (l.TEMPO_ATRASO||0), 0);
const kpiData = [
    { title:"OFs Ativas", value: totalOFs, icon:"package", color:"bg-blue-600" },
    { title:"Tarefas Conclu√≠das", value: `${concludedTasks} / ${totalTasks}`, icon:"check-circle", color:"bg-green-600" },
    { title:"Pausas Totais (min)", value: totalPause.toFixed(1), icon:"pause-circle", color:"bg-yellow-600" },
    { title:"Atraso Total (min)", value: totalAtraso.toFixed(1), icon:"alert-triangle", color:"bg-red-600" },
  ];
kpisContainer.innerHTML = kpiData.map(k=>`
    <div class="${k.color} text-white p-3 sm:p-4 rounded-xl shadow-md flex items-center justify-between">
      <div>
        <p class="text-xs sm:text-sm font-medium opacity-80">${k.title}</p>
        <p class="text-2xl sm:text-3xl font-bold">${k.value}</p>
      </div>
      <i data-lucide="${k.icon}" class="w-7 h-7 sm:w-8 sm:h-8 opacity-70"></i>
    </div>`).join('');
lucide.createIcons();
}

function updateView(view){
  // üîí Se n√£o houver usu√°rio, for√ßa login
  if (!currentUser) {
    pcpView.classList.add('hidden');
operatorView.classList.add('hidden'); reportView.classList.add('hidden');
    openUserModal(); return;
  }

  // Operador n√£o pode trocar para PCP/Relat√≥rio
  if (isOperador() && view !== 'Operador'){ view = 'Operador';
}

  const isPCP = view === 'PCP';
  const isReport = view === 'Relatorio';

  pcpView.classList.toggle('hidden', !isPCP);
  operatorView.classList.toggle('hidden', (isPCP || isReport));
reportView.classList.toggle('hidden', !isReport);
  userViewSelect.value = view;

  // Bot√µes por permiss√£o
  btnCreateOF.classList.toggle('hidden', !isMaster());
  btnSetupRoteiro.classList.toggle('hidden', !isMaster());
  btnThemeMaster.classList.toggle('hidden', !isMaster());
  btnProfile.classList.remove('hidden');
  userViewSelect.disabled = isOperador();
// Mostra/Esconde os bot√µes de a√ß√£o do Relat√≥rio
  const btnExport = document.getElementById('btn-export-report');
  const btnDelete = document.getElementById('btn-delete-report');
  if(btnExport) btnExport.classList.toggle('hidden', !isMaster());
  if(btnDelete) btnDelete.classList.toggle('hidden', !isMaster());


  if (isPCP){ renderKPIs(); renderOFs(); }
  else if (view === 'Operador'){ renderTasks();
}
  else if (isReport){ renderReport(); }

  injectSearchInputs();
  lucide.createIcons();
}
window.updateView = updateView;

// === IN√çCIO DA ALTERA√á√ÉO (Fun√ß√£o renderReport Atualizada) ===
function renderReport(){
  const body = document.getElementById('report-table-body');
if (!body) return; // Garante que o elemento exista

  if (allOcurrencesLog.length === 0){
    // Atualiza o colspan para 8 (considerando a nova coluna de checkbox)
    body.innerHTML = `<tr><td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500">Nenhuma ocorr√™ncia registrada.</td></tr>`;
    
    // Garante que o bot√£o de deletar desabilite se a lista ficar vazia
    const selectAllCheckbox = document.getElementById('report-select-all');
    if (selectAllCheckbox) selectAllCheckbox.checked = false;
    updateDeleteButtonState();
    return;
}
  
  const html = allOcurrencesLog.map(log=>{
    const atrasoClass = (log.TEMPO_ATRASO||0) > 0 ? 'highlight-red' : 'text-gray-600';
    const pausaClass = (log.TEMPO_PAUSA||0) > 0 ? 'text-yellow-700 font-semibold' : 'text-gray-600';
    
    return `
      <tr class="hover:bg-gray-50">
        <td class="px-2 sm:px-4 py-2 text-center">
          <input type="checkbox" name="report_checkbox" value="${log.id}" 
                 onclick="updateDeleteButtonState()"
                 class="report-item-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500">
        </td>
        <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${log.OF}</td>
        <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-sm text-gray-600">${log.CHICOTE}</td>
        <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-sm text-gray-600">${log.ATIVIDADE}</td>
        <td class="px-3 sm:px-6 py-2 text-sm text-gray-700">${log.MOTIVO_PAUSA 
|| '-'}</td>
        <td class="px-3 sm:px-6 py-2 text-sm text-gray-700">${log.MOTIVO_ATRASO || '-'}</td>
        <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-sm ${pausaClass}">${(log.TEMPO_PAUSA||0).toFixed(2)}</td>
        <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-sm ${atrasoClass}">${(log.TEMPO_ATRASO||0).toFixed(2)}</td>
      </tr>`;
}).join('');
  body.innerHTML = html;

  // Reseta o "select all" e atualiza o estado do bot√£o
  const selectAllCheckbox = document.getElementById('report-select-all');
  if (selectAllCheckbox) selectAllCheckbox.checked = false;
  updateDeleteButtonState();
}
// === FIM DA ALTERA√á√ÉO ===

function renderOFs(){
  if (!pcpView.classList.contains('hidden')) {
    let ofs = Object.values(allOFs).filter(of => of.status !== 'Conclu√≠do');
// üîé filtro por OF na tela PCP
    if (pcpSearchOF) ofs = ofs.filter(of => (of.id || "").toUpperCase().includes(pcpSearchOF));
const ofsHtml = ofs.map(of=>{
      const tasks = Object.values(allTasks).filter(t=> t.id_of === of.id);
      const completed = tasks.filter(t => t.status === 'Conclu√≠do').length; // contagem real
      const nextTask = tasks.find(t=> t.status === 'Em Espera' || t.status === 'Em Processo' || t.status === 'Pausada');

      let statusColor = 'bg-gray-100 border-gray-300';
      let progress = 0;

      if (tasks.length > 0){
        progress = Math.floor((completed / tasks.length) * 100);
     
   if (progress === 0) statusColor = 'bg-gray-200 border-gray-400';
        else if (progress < 100) statusColor = 'bg-blue-100 border-blue-400';
        const anyTaskDelayed = tasks.some(t => calculateDesvio(t) < -5);
        if (anyTaskDelayed) statusColor = 'bg-red-100 border-red-500';
      }

      return `
        <div class="${statusColor} p-4 rounded-xl shadow-lg border-l-4 ${statusColor.replace('bg-', 'border-')}"
             onclick="openOFDetails('${of.id}')">
     
     <h3 class="text-lg font-bold text-gray-800 mb-1 flex justify-between items-center">
            ${of.id}
            ${of.status === 'Conclu√≠do' ?
'<i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>' : (nextTask ? '<i data-lucide="play-circle" class="w-5 h-5 text-blue-600"></i>' : '<i data-lucide="pause-circle" class="w-5 h-5 text-yellow-600"></i>')}
          </h3>
          <p class="text-sm text-gray-600 mb-3">${of.chicote} |
Qtd: ${of.quantidade}</p>

          <div class="flex justify-between items-center mb-1">
            <span class="text-xs font-semibold text-gray-600">${progress}% Conclu√≠do</span>
            <span class="text-xs font-medium text-gray-500">${completed} / ${tasks.length} etapas</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-1.5">
            <div class="h-1.5 rounded-full bg-blue-500" style="width:${progress}%"></div>
          </div>
 
         <p class="text-xs mt-2 text-gray-700 font-medium">Pr√≥xima Etapa: ${nextTask ?
nextTask.nome_atividade : (of.status === 'Conclu√≠do' ? 'Finalizada' : 'N/A')}</p>
        </div>
      `;
}).join('');

    ofsListContainer.innerHTML = ofsHtml.length > 0 ? ofsHtml : '<div class="col-span-3 p-6 text-center text-gray-500 bg-white rounded-xl shadow-lg">Nenhuma OF ativa.</div>';
    lucide.createIcons();
}
}

function renderTasks(){
  if (!operatorView.classList.contains('hidden')) {
    const tasks = Object.values(allTasks)
      .filter(t =>
        t.setor === currentSectorFilter &&
        (t.status === 'Em Espera' || t.status === 'Em Processo' || t.status === 'Pausada') &&
        (!operatorSearchOF || (t.id_of || "").toUpperCase().includes(operatorSearchOF))
      )
      .sort((a,b) => (a.status === 'Em Processo' ? -1 : 1) || a.ordem - b.ordem);
const tasksHtml = tasks.map(task=>{
      const tempoReal = calculateTempoReal(task);
      const desvio = calculateDesvio(task);
      const totalPauseMinutes = calculateTotalPauseMinutes(task);

      let statusColor = 'bg-gray-100 border-gray-300';
      let statusText = task.status;
      let actions = '';
      if (task.status === 'Em Espera'){
        statusColor = 'bg-green-100 border-green-500';
        statusText = 'Aguardando In√≠cio';
        actions = 
`<button onclick="startTask('${task.id}')" class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">Iniciar</button>`;
      } else if (task.status === 'Em Processo'){
        statusColor = 'bg-blue-100 border-blue-500';
        statusText = 'Em Processo';
        actions = `
          <button onclick="pauseTask('${task.id}')" class="px-3 py-1.5 text-sm bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">Pausar</button>
          <button onclick="finishTask('${task.id}')" class="px-3 py-1.5 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700">Concluir</button>`;
} else if (task.status === 'Pausada'){
        statusColor = 'bg-yellow-100 border-yellow-500';
        statusText = 'Pausada';
actions = `
          <button onclick="startTask('${task.id}')" class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">Retomar</button>
          <button onclick="finishTask('${task.id}')" class="px-3 py-1.5 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700">Concluir</button>`;
}

      return `
        <div class="${statusColor} border p-3 sm:p-4 rounded-xl shadow">
          <div class="flex justify-between items-center mb-2">
            <div>
              <p class="text-sm font-bold text-gray-800">${task.nome_atividade}</p>
              <p class="text-xs text-gray-600">OF <span class="font-semibold">${task.id_of}</span> ‚Ä¢ Setor ${task.setor}</p>
            </div>
   
         <button class="p-2 rounded-lg hover:bg-gray-100" title="Instru√ß√£o de Trabalho" onclick="openInstructionModal('${task.id}')">
              <i data-lucide="book" class="w-5 h-5"></i>
            </button>
          </div>
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs sm:text-sm">
            <div><span class="text-gray-500">Setup:</span> <span class="font-semibold">${formatMinutes(task.tempo_setup)}</span></div>
            <div><span class="text-gray-500">Ciclo 
(min/p√ß):</span> <span class="font-semibold">${Number(task.tempo_ciclo).toFixed(2)}</span></div>
            <div><span class="text-gray-500">Planejado:</span> <span class="font-semibold">${formatMinutes(task.tempo_planejado)}</span></div>
            <div><span class="text-gray-500">Pausa:</span> <span class="font-semibold">${formatMinutes(totalPauseMinutes)}</span></div>
          </div>
          <div class="mt-2 flex justify-between items-center">
            <span class="text-xs font-semibold ${desvio < 0 ?
'text-red-600' : 'text-gray-700'}">Desvio: ${desvio < 0 ? '-' : ''}${formatMinutes(Math.abs(desvio))}</span>
            <span class="text-xs font-medium text-gray-600">${statusText}</span>
          </div>
          <div class="mt-3 flex gap-2">${actions}</div>
        </div>
      `;
    }).join('');

    tasksListContainer.innerHTML = tasksHtml || '<div class="p-6 text-center text-gray-500 bg-white rounded-xl shadow-lg">Sem tarefas para este setor/OF.</div>';
    lucide.createIcons();
  }
}

/* ============================
   DETALHES / EXPORTS
   ============================ */
function 
openOFDetails(ofId){
  window.__ofDetailsOpenId = ofId;
  const of = allOFs[ofId];
  const tasks = Object.values(allTasks).filter(t=> t.id_of === ofId);
  const completed = tasks.filter(t => t.status === 'Conclu√≠do').length;
  const progress = tasks.length ? Math.floor((completed / tasks.length) * 100) : 0;

  document.getElementById('of-details-title').textContent = `OF ${ofId} ‚Äî ${of.chicote}`;
document.getElementById('of-details-summary').innerHTML = `
    <div class="bg-gray-50 p-2 rounded-lg"><p class="text-xs text-gray-500">Quantidade</p><p class="font-semibold">${of.quantidade}</p></div>
    <div class="bg-gray-50 p-2 rounded-lg"><p class="text-xs text-gray-500">Etapas</p><p class="font-semibold">${tasks.length}</p></div>
    <div class="bg-gray-50 p-2 rounded-lg"><p class="text-xs text-gray-500">Conclu√≠das</p><p class="font-semibold">${completed}</p></div>
    <div class="bg-gray-50 p-2 rounded-lg"><p class="text-xs text-gray-500">Status</p><p class="font-semibold">${of.status ||
'-'}</p></div>
  `;
  document.getElementById('of-details-progress').style.width = `${progress}%`;

  const content = tasks.sort((a,b)=> a.ordem - b.ordem).map(task=>{
    const tempoReal = calculateTempoReal(task);
    const desvio = calculateDesvio(task);
    return `
      <div class="border rounded-lg p-3">
        <div class="flex justify-between">
          <p class="font-semibold">${task.ordem}. ${task.nome_atividade}</p>
          <span class="text-xs ${task.status==='Conclu√≠do'?'text-green-700':'text-gray-600'}">${task.status}</span>
        </div>
        <p class="text-xs text-gray-600">Setor: ${task.setor}</p>
       
 <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs sm:text-sm mt-2">
          <div><span class="text-gray-500">Setup:</span> <span class="font-semibold">${formatMinutes(task.tempo_setup)}</span></div>
          <div><span class="text-gray-500">Ciclo:</span> <span class="font-semibold">${Number(task.tempo_ciclo).toFixed(2)}</span></div>
          <div><span class="text-gray-500">Planejado:</span> <span class="font-semibold">${formatMinutes(task.tempo_planejado)}</span></div>
          <div><span class="text-gray-500">Real:</span> <span class="font-semibold">${formatMinutes(tempoReal)}</span></div>
        </div>
        <p class="mt-1 text-xs ${desvio<0?'text-red-600':'text-gray-700'}">Desvio: ${desvio<0?'-':''}${formatMinutes(Math.abs(desvio))}</p>
      </div>
    `;
}).join('');
  document.getElementById('of-details-content').innerHTML = content;

  btnDeleteOF.classList.toggle('hidden', !isMaster());
  openModal('of-details-modal');
}

function exportReportCSV(){
  const rows = [["OF","CHICOTE","ATIVIDADE","MOTIVO_PAUSA","MOTIVO_ATRASO","T. PAUSA (min)","T. ATRASO (min)"]];
allOcurrencesLog.forEach(l => {
    rows.push([l.OF, l.CHICOTE, l.ATIVIDADE, l.MOTIVO_PAUSA||"", l.MOTIVO_ATRASO||"", (l.TEMPO_PAUSA||0).toFixed(2), (l.TEMPO_ATRASO||0).toFixed(2)]);
  });
  downloadCSV(rows, `relatorio_ocorrencias_${new Date().toISOString().slice(0,10)}.csv`);
}

// === IN√çCIO DA ALTERA√á√ÉO (Novas fun√ß√µes de Exclus√£o em Massa) ===
function updateDeleteButtonState() {
  const btn = document.getElementById('btn-delete-report');
  if (!btn) return;
  const anyChecked = document.querySelectorAll('#report-table-body .report-item-checkbox:checked').length > 0;
  btn.disabled = !anyChecked;

  // Desmarca o "Select All" se algum item for desmarcado individualmente
  if (!anyChecked) {
    const selectAllCheckbox = document.getElementById('report-select-all');
    if (selectAllCheckbox) selectAllCheckbox.checked = false;
  }
}

function toggleSelectAllOcorrencias(checkbox) {
  const checkboxes = document.querySelectorAll('#report-table-body .report-item-checkbox');
  checkboxes.forEach(cb => {
    cb.checked = checkbox.checked;
  });
  updateDeleteButtonState();
}

async function deleteSelectedOcorrencias() {
  const selectedIds = Array.from(document.querySelectorAll('#report-table-body .report-item-checkbox:checked')).map(cb => cb.value);
  
  if (selectedIds.length === 0) {
    alert("Nenhuma ocorr√™ncia selecionada.");
    return;
  }

  if (!confirm(`Tem certeza que deseja excluir ${selectedIds.length} ocorr√™ncia(s)? Esta a√ß√£o n√£o pode ser desfeita.`)) {
    return;
  }
  
  // Desabilitar bot√£o para evitar cliques duplos
  const btn = document.getElementById('btn-delete-report');
  if (btn) btn.disabled = true;

  try {
    if (window.db) {
      // Modo Firebase: Exclui em lote
      const batch = db.batch();
      selectedIds.forEach(id => {
        batch.delete(db.collection(OCORRENCIA_COLLECTION).doc(id));
      });
      await batch.commit();
      // O listener do Firebase (onSnapshot) vai atualizar a tela automaticamente.
    } else {
      // Modo Simula√ß√£o (localStorage)
      allOcurrencesLog = allOcurrencesLog.filter(log => !selectedIds.includes(log.id));
      localStorage.setItem('sim_ocorrencias', JSON.stringify(allOcurrencesLog));
      // No modo simula√ß√£o, precisamos renderizar manualmente
      renderReport();
    }
    
  } catch (e) {
    alert("Erro ao excluir ocorr√™ncias: " + e.message);
    if (btn) btn.disabled = false; // Re-abilita se der erro
  }
}
// === FIM DA ALTERA√á√ÉO ===


function exportOFTasksCSV(ofId){
  const tasks = Object.values(allTasks).filter(t => t.id_of === ofId);
  const rows = [["OF","ATIVIDADE","SETOR","STATUS","SETUP(min)","CICLO(min/p√ß)","PLANEJADO(min)","REAL(min)","DESVIO(min)"]];
tasks.forEach(t => {
    rows.push([
      t.id_of, t.nome_atividade, t.setor, t.status,
      Number(t.tempo_setup).toFixed(2), Number(t.tempo_ciclo).toFixed(2),
      Number(t.tempo_planejado).toFixed(2), calculateTempoReal(t).toFixed(2), calculateDesvio(t).toFixed(2),
    ]);
  });
downloadCSV(rows, `of_${ofId}_tasks_${new Date().toISOString().slice(0,10)}.csv`);
}
function downloadCSV(rows, filename){
  const csvContent = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csvContent], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

/* ============================
   ROTEIROS (lista no modal)
   ============================ */
function renderRoteiros(){
  const list = document.getElementById('roteiro-list');
  if (!list) return;
  const items = Object.values(allRoteiros).sort((a,b)=> (a.chicote_nome||'').localeCompare(b.chicote_nome||'')).map(r=>`
    <div class="bg-white border rounded-lg p-3 flex justify-between items-start gap-3">
      <div>
        <p class="text-sm font-semibold">${r.chicote_nome} ‚Äî <span class="text-gray-700">${r.setor}</span></p>
  
      <p class="text-xs text-gray-600">Atividade: ${r.nome_atividade}</p>
        <p class="text-xs text-gray-600">Setup: ${Number(r.tempo_setup).toFixed(2)} |
Ciclo: ${Number(r.tempo_ciclo).toFixed(2)}</p>
      </div>
      <button class="px-2 py-1 text-xs bg-red-600 text-white rounded-lg hover:bg-red-700" onclick="deleteRoteiroActivity('${r.id}')">Excluir</button>
    </div>
  `).join('');
list.innerHTML = items || '<div class="p-4 text-center text-gray-500 bg-white rounded-lg">Nenhum roteiro cadastrado.</div>';
}

/* ============================
   BOOTSTRAP
   ============================ */
document.addEventListener('DOMContentLoaded', () => {
  initializeApp();
  lucide.createIcons();
});
// Exposi√ß√£o global
window.startTask = startTask;
window.pauseTask = pauseTask;
window.finishTask = finishTask;
window.openOFDetails = openOFDetails;
window.openInstructionModal = openInstructionModal;
window.handleConfirmedAction = handleConfirmedAction;
window.openModal = openModal;
window.closeModal = closeModal;
window.createOF = createOF;
window.addRoteiroActivity = addRoteiroActivity;
window.deleteRoteiroActivity = deleteRoteiroActivity;
window.deleteOF = deleteOF;
window.exportReportCSV = exportReportCSV;
window.exportOFTasksCSV = exportOFTasksCSV;
window.openUserModal = openUserModal;
window.confirmUser = confirmUser;
window.updateSectorFilter = updateSectorFilter;
window.openThemeModal = openThemeModal;
window.saveTheme = saveTheme;

// === IN√çCIO DA ALTERA√á√ÉO (Exposi√ß√£o global das novas fun√ß√µes) ===
window.deleteSelectedOcorrencias = deleteSelectedOcorrencias;
window.toggleSelectAllOcorrencias = toggleSelectAllOcorrencias;
window.updateDeleteButtonState = updateDeleteButtonState;
// === FIM DA ALTERA√á√ÉO ===
</script>
</body>
</html>
