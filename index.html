<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PCP ‚Äì Controle de Produ√ß√£o</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap");
    :root {
      color-scheme: light dark;
      --app-bg-color: #f3f4f6;  /* default */
      --app-bg-image: none;

      /* === NOVO DESIGN ENTERPRISE: PALETA CARMIM & CINZA === */
      
      --cor-primaria: #960018;    /* CARMIM (Header, Foco Principal) */
      --cor-primaria-hover: #700012;
      --cor-secundaria: #4F4F4F; /* CINZA ESCURO (Complemento do gradiente e neutros) */
      
      --cor-sucesso: #1E8449;    /* Verde (Criar OF, Concluir) */
      --cor-sucesso-hover: #176739;
      
      --cor-alerta: #B7791F;     /* Amarelo/Dourado (Setup Roteiro, Pausas) */
      --cor-alerta-hover: #966118;
      
      --cor-perigo: #A93226;     /* Vermelho (Excluir) */
      --cor-perigo-hover: #86281E;

      --cor-info: #6A2C91;       /* Roxo (Relat√≥rio, Instru√ß√£o) */
      --cor-info-hover: #552374;

      --cor-fundo-card: #FFFFFF;
      --cor-texto-principal: #1F2937; /* Quase preto */
      --cor-texto-secundario: #4B5563; /* Cinza escuro */

      /* AJUSTE ENTERPRISE: BORDAS E FOCO */
      --border-radius-sm: 0.4rem; /* Reduz arredondamento */
    }
    
    body {
      font-family: "Inter", sans-serif;
      background: var(--app-bg-color) fixed no-repeat center/cover;
      background-image: var(--app-bg-image);

      padding-left: max(env(safe-area-inset-left), 0px);
      padding-right: max(env(safe-area-inset-right), 0px);
    }
    
    /* Gradiente Carmim -> Cinza Escuro */
    .bg-gradient-header { 
        background: linear-gradient(90deg, var(--cor-primaria) 0%, var(--cor-secundaria) 100%); 
    }

    /* CLASSES DE FOCO PERSONALIZADAS COM CARMIM (Focus Ring) */
    .focus-ring-primary:focus {
        border-color: var(--cor-primaria);
        box-shadow: 0 0 0 2px var(--cor-primaria-hover), 0 0 0 4px rgba(150, 0, 24, 0.3);
        outline: none; 
    }

    /* SOBRESCREVE TAILWIND PARA BORDAS MAIS PROFISSIONAIS */
    .rounded-lg, .rounded-xl, .rounded-md {
        border-radius: var(--border-radius-sm) !important;
    }
    .rounded-full { /* Mant√©m o padr√£o do full para elementos circulares (ex: o logo) */
        border-radius: 9999px !important;
    }
    .btn {
        border-radius: var(--border-radius-sm);
    }

    /* AJUSTE ZEBRA TABLE */
    #report-table-body tr:nth-child(even) {
        background-color: #f9fafb; /* Cinza bem claro para as linhas pares */
    }

    .modal-fixed { position: fixed; inset: 0; }
    .modal-panel { max-height: calc(100dvh - 2rem);
    }
    .modal-body-scroll { overflow-y: auto; -webkit-overflow-scrolling: touch; }
    .sticky-footer { position: sticky; bottom: 0;
    background: white; padding-top: .5rem; }
    .highlight-red { color: #dc2626; font-weight: 600;
    }
    @media (max-width: 640px){
      .modal-panel{ width:100vw!important; max-width:100vw!important; height:100dvh!important; max-height:100dvh!important; border-radius:0!important; margin:0!important; display:flex;
    flex-direction:column; }
      .card-tap-big{ padding:1rem; }
    }
  </style>
</head>
<body class="min-h-screen bg-gray-100/0 antialiased">

  <header class="bg-gradient-header shadow-lg p-3 sm:p-4 sticky top-0 z-10">
    <div class="max-w-7xl mx-auto flex justify-between items-center gap-2">
      <h1 class="text-2xl sm:text-3xl font-extrabold text-white flex items-center">
        <img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QAiRXhpZgAATU0AKgAAAAgAAQESAAMAAAABAAEAAAAAAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAgACADASIAAhEBAEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAD/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAD/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwCuAoAKICgIoAKICgAKICg//9k=" 
          alt="Logo ATS" class="h-8 sm:h-10 mr-2 rounded-lg border border-white/50 shadow-md">
        Controle de Produ√ß√£o
      </h1>
      <div class="flex gap-2 items-center">
        
        <button id="btn-profile"
                class="text-white bg-[var(--cor-secundaria)] hover:bg-[var(--cor-secundaria)]/90 font-semibold py-2 px-3 rounded-lg shadow-md transition hidden"
                onclick="openUserModal()">
          <i data-lucide="user-cog" class="w-5 h-5 inline-block mr-1"></i>
          <span class="hidden sm:inline">Perfil</span>
        </button>

        <select id="user-view-select" onchange="updateView(this.value)"
                class="bg-[var(--cor-secundaria)] text-white text-xs sm:text-sm font-semibold py-2 px-2 rounded-lg transition hover:bg-[var(--cor-secundaria)]/90 focus-ring-primary">
          <option value="PCP">Vis√£o: PCP</option>
          <option value="Operador">Vis√£o: Operador</option>
          <option value="Relatorio">Vis√£o: Relat√≥rio</option>
        </select>

        <button onclick="openModal('create-of-modal')" id="btn-create-of"
                class="text-white bg-[var(--cor-sucesso)] hover:bg-[var(--cor-sucesso-hover)] font-semibold py-2 px-3 rounded-lg shadow-md transition hidden">
          <i data-lucide="plus" class="w-5 h-5 inline-block mr-1"></i>
          <span class="hidden sm:inline">Criar OF</span>
        </button>
        <button onclick="openModal('setup-roteiro-modal')" id="btn-setup-roteiro"
                class="text-white bg-[var(--cor-alerta)] hover:bg-[var(--cor-alerta-hover)] font-semibold py-2 px-3 rounded-lg shadow-md transition hidden">
          <i data-lucide="settings" class="w-5 h-5 inline-block mr-1"></i>
          <span class="hidden sm:inline">Setup Roteiro</span>
        </button>
        </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-3 sm:p-6 lg:p-8">
    <div id="loading-indicator" class="flex flex-col items-center justify-center p-6 sm:p-12 bg-white rounded-xl shadow-xl">
      <i data-lucide="loader-circle" class="w-8 h-8 sm:w-10 sm:h-10 text-[var(--cor-primaria)] animate-spin"></i>
      <p class="mt-3 sm:mt-4 text-gray-600 font-semibold text-sm sm:text-base">Carregando dados e autenticando...</p>
    </div>

    <div id="pcp-view" class="space-y-4 sm:space-y-6 
    hidden">
      <h2 class="text-xl sm:text-2xl font-bold text-gray-800 border-b pb-2 mb-2 sm:mb-4 flex items-center">
        <i data-lucide="bar-chart-3" class="w-5 h-5 sm:w-6 sm:h-6 mr-2"></i>
        Painel PCP
      </h2>
      <div id="pcp-of-search-wrap" class="mb-2 hidden">
        <input id="pcp-of-search" type="text" placeholder="Pesquisar OF..."
               class="w-full sm:w-64 border border-gray-300 rounded-lg p-2 focus-ring-primary">
      </div>
      <div id="kpis-container" class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-4"></div>
      <div id="ofs-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-6"></div>
    </div>

    <div id="operator-view" class="space-y-4 sm:space-y-6 hidden">
      <div class="bg-white p-3 sm:p-4 rounded-xl shadow-lg mb-4 sm:mb-6 flex flex-col sm:flex-row items-center justify-between gap-3">
        <h2 class="text-lg sm:text-xl font-bold text-gray-800 flex items-center">
          <i data-lucide="clipboard-list" class="w-5 h-5 sm:w-6 sm:h-6 mr-2 
    text-[var(--cor-primaria)]"></i>
          Minhas Tarefas
        </h2>
        <div class="flex items-center gap-2 w-full sm:w-auto">
          <label for="sector-filter" class="text-xs sm:text-sm font-semibold text-gray-700 flex-shrink-0">Setor:</label>
          <select id="sector-filter" onchange="updateSectorFilter(this.value)"
                  class="p-2 border border-gray-300 rounded-lg bg-white focus-ring-primary w-full sm:w-48"></select>
        </div>
      
        <div id="operator-of-search-wrap" class="flex items-center gap-2 w-full sm:w-auto hidden">
          <label class="text-xs sm:text-sm font-semibold text-gray-700 flex-shrink-0">OF:</label>
          <input id="operator-of-search" type="text" placeholder="Filtrar por OF..."
                 class="p-2 border border-gray-300 rounded-lg bg-white focus-ring-primary w-full sm:w-48">
        </div>
      </div>
      <div id="tasks-list-container" class="space-y-3 
    sm:space-y-4"></div>
    </div>

    <div id="report-view" class="space-y-4 sm:space-y-6 hidden">
      <h2 class="text-xl sm:text-2xl font-bold text-gray-800 border-b pb-2 mb-2 sm:mb-4 flex items-center">
        <i data-lucide="file-text" class="w-5 h-5 sm:w-6 sm:h-6 mr-2 text-[var(--cor-info)]"></i>
        Relat√≥rio de Ocorr√™ncias
      </h2>
      <div class="bg-white p-3 sm:p-4 rounded-xl shadow-lg">
        <div class="flex justify-between items-center mb-3 sm:mb-4">
          <h3 
    class="text-base sm:text-xl font-semibold text-gray-700">Pausas & Atrasos</h3>
          <div class="flex gap-2">
            <button id="btn-clear-report" onclick="clearReportLogs()"
                    class="px-3 sm:px-4 py-2 bg-[var(--cor-perigo)] text-white text-sm sm:text-base font-semibold rounded-lg hover:bg-[var(--cor-perigo-hover)] transition hidden">
              <i data-lucide="trash-2" class="w-4 h-4 sm:w-5 sm:h-5 inline-block mr-1"></i> Limpar Logs (Master)
            </button>
            
            <button id="btn-export-report" onclick="exportReportCSV()"
                    class="px-3 sm:px-4 py-2 bg-[var(--cor-info)] text-white text-sm sm:text-base font-semibold rounded-lg hover:bg-[var(--cor-info-hover)] transition">
              <i data-lucide="download" class="w-4 h-4 sm:w-5 sm:h-5 inline-block mr-1"></i> Exportar (CSV)
            </button>
          </div>
        </div>
        <div class="overflow-x-auto">
       
          <table class="min-w-full divide-y divide-gray-200 text-xs sm:text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">OF</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">CHICOTE</th>
               
    <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">ATIVIDADE</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">MOTIVO PAUSA</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">MOTIVO ATRASO</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">T.
    PAUSA (min)</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">T.
    ATRASO (min)</th>
              </tr>
            </thead>
            <tbody id="report-table-body" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <div id="action-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal()">
    <div class="bg-white rounded-xl shadow-2xl p-4 
    sm:p-6 w-full max-w-md modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <h3 id="modal-title" class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2"></h3>
      <div class="modal-body-scroll">
        <p id="modal-message" class="text-gray-600 mb-3 sm:mb-4"></p>
        <div id="modal-content">
          <div id="justification-area" class="space-y-3 sm:space-y-4">
            <label for="justification-select" class="block text-sm font-medium text-gray-700">Selecione o Motivo Principal:</label>
            <select id="justification-select" class="w-full border border-gray-300 rounded-lg 
    p-3 focus-ring-primary transition">
              <option value="">-- Selecione uma op√ß√£o --</option>
            </select>
            <label for="justification-text" class="block text-sm font-medium text-gray-700">Detalhes Adicionais (Opcional):</label>
            <textarea id="justification-text" rows="2" class="w-full border border-gray-300 rounded-lg p-3 focus-ring-primary transition" placeholder=""></textarea>
            <p id="justification-required-text" class="text-sm text-red-500 hidden font-semibold">üö® Campo obrigat√≥rio devido ao desvio de 
    tempo!</p>
          </div>
        </div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end gap-2 sm:gap-3 sticky-footer">
        <button onclick="closeModal()" class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition">Cancelar</button>
        <button id="modal-confirm-button" class="px-3 sm:px-4 py-2 bg-[var(--cor-primaria)] text-white font-semibold rounded-lg hover:bg-[var(--cor-primaria-hover)] transition" onclick="handleConfirmedAction()">Confirmar</button>
      </div>
    </div>
  </div>

  <div id="instruction-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 
    items-center justify-center hidden" onclick="closeModal('instruction-modal')">
    <div class="bg-white rounded-xl shadow-2xl p-5 sm:p-8 w-full max-w-2xl modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2 flex items-center">
        <i data-lucide="book-open-text" class="w-5 h-5 sm:w-6 sm:h-6 mr-2 text-[var(--cor-info)]"></i> Instru√ß√£o de Trabalho
      </h3>
      <div class="max-h-[65vh] sm:max-h-[70vh] overflow-y-auto pr-1 sm:pr-2 modal-body-scroll">
        <p class="text-sm font-semibold text-gray-700 mb-2" id="instruction-modal-header"></p>
        <div id="instruction-modal-content" class="text-gray-700 space-y-3"></div>
      
    </div>
      <div class="mt-4 sm:mt-6 flex justify-end">
        <button onclick="closeModal('instruction-modal')" class="px-3 sm:px-4 py-2 bg-[var(--cor-info)] text-white font-semibold rounded-lg hover:bg-[var(--cor-info-hover)] transition">Fechar</button>
      </div>
    </div>
  </div>

  <div id="create-of-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal()">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-lg modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">Criar Nova Ordem de Fabrica√ß√£o (OF)</h3>
      <div class="space-y-3 sm:space-y-4 
    modal-body-scroll">
        <div>
          <label for="of-id" class="block text-sm font-medium text-gray-700">C√≥digo da OF:</label>
          <input type="text" id="of-id" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus-ring-primary" placeholder="Ex: OF-003">
        </div>
        <div>
          <label for="of-quantity" class="block text-sm font-medium text-gray-700">Quantidade de Pe√ßas:</label>
          <input type="number" id="of-quantity" min="1" class="w-full border border-gray-300 rounded-lg p-2 mt-1 
    focus-ring-primary" placeholder="Ex: 50">
        </div>
        <div>
          <label for="of-chicote" class="block text-sm font-medium text-gray-700">Modelo do Chicote (Roteiro Mestre):</label>
          <select id="of-chicote" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus-ring-primary">
            <option value="">Carregando roteiros...</option>
          </select>
        </div>
        <div id="of-creation-message" class="text-sm 
    text-red-500 hidden"></div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end gap-2 sm:gap-3 sticky-footer">
        <button onclick="closeModal('create-of-modal')" class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition">Cancelar</button>
        <button onclick="createOF()" class="px-3 sm:px-4 py-2 bg-[var(--cor-sucesso)] text-white font-semibold rounded-lg hover:bg-[var(--cor-sucesso-hover)]">
          <i data-lucide="factory" class="w-5 h-5 inline-block mr-1"></i> Gerar OF
        </button>
      </div>
    </div>
  </div>

  <div id="setup-roteiro-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal()">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-2xl modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">Setup: Cadastro de Roteiros Mestres</h3>
      <div id="roteiro-list" class="space-y-4 h-[50vh] sm:h-64 overflow-y-auto mb-4 p-2 border rounded-lg bg-gray-50 modal-body-scroll"></div>
      <div class="border-t pt-4 space-y-4">
        <h4 class="text-base sm:text-lg font-semibold text-gray-700">Nova Etapa para Roteiro:</h4>
        <div class="flex flex-col gap-3">
      
        <div class="flex flex-col sm:flex-row gap-3">
            <input type="text" id="roteiro-chicote-name" class="w-full sm:w-1/2 border border-gray-300 rounded-lg p-2 focus-ring-primary" placeholder="Nome do Chicote (Ex: CHICOTE-A)">
            <select id="roteiro-setor" class="w-full sm:w-1/2 border border-gray-300 rounded-lg p-2 focus-ring-primary"></select>
          </div>
          <input type="text" id="roteiro-activity-name" class="w-full border border-gray-300 rounded-lg p-2 focus-ring-primary" placeholder="Nome da Atividade (Ex: Pr√© Conex√£o)">
         
        <div class="flex flex-col sm:flex-row gap-3">
            <input type="number" id="roteiro-setup-time" min="0" step="0.1" class="w-full sm:w-1/2 border border-gray-300 rounded-lg p-2 focus-ring-primary" placeholder="Setup (min)">
            <input type="number" id="roteiro-cycle-time" min="0" step="0.1" class="w-full sm:w-1/2 border border-gray-300 rounded-lg p-2 focus-ring-primary" placeholder="Ciclo (min/p√ß)">
          </div>
          <div>
            <label for="roteiro-instruction-text" class="block text-sm font-medium text-gray-700 mb-1">Instru√ß√£o de Trabalho (HTML permitido):</label>
 
            <textarea id="roteiro-instruction-text" rows="4" class="w-full border border-gray-300 rounded-lg p-2 focus-ring-primary" placeholder="Ex: <b>1.
    Prepara√ß√£o:</b> ..."></textarea>
          </div>
          <button onclick="addRoteiroActivity()" class="p-2 bg-[var(--cor-info)] text-white rounded-lg hover:bg-[var(--cor-info-hover)] transition">
            <i data-lucide="plus" class="w-5 h-5 inline-block mr-1"></i> Adicionar Etapa
          </button>
        </div>
        <div id="roteiro-message" class="text-sm text-red-500"></div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end">
        
    <button onclick="closeModal('setup-roteiro-modal')" class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition">Fechar</button>
      </div>
    </div>
  </div>

  <div id="of-details-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal('of-details-modal')">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-3xl modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-2">
        <h3 id="of-details-title" class="text-xl sm:text-2xl font-bold text-gray-800"></h3>
        <button class="p-2 rounded-lg hover:bg-gray-100" onclick="closeModal('of-details-modal')"><i data-lucide="x" class="w-6 h-6"></i></button>
      </div>
  
        <div id="of-details-summary" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3 sm:mb-4"></div>
      <div class="w-full bg-gray-200 rounded-full h-2 mb-3 sm:mb-4"><div id="of-details-progress" class="h-2 rounded-full bg-[var(--cor-primaria)]" style="width:0%"></div></div>
      <div id="of-details-content" class="max-h-[60vh] overflow-y-auto space-y-3 sm:space-y-4 modal-body-scroll"></div>
      <div class="mt-4 sm:mt-5 flex justify-between gap-3 sticky-footer">
        <button id="btn-delete-of" class="px-3 sm:px-4 py-2 bg-[var(--cor-perigo)] text-white font-semibold rounded-lg hover:bg-[var(--cor-perigo-hover)] transition hidden" onclick="deleteOF(window.__ofDetailsOpenId)">
          <i data-lucide="trash-2" class="w-4 h-4 sm:w-5 sm:h-5 inline-block mr-1"></i> Excluir OF
        </button>
 
        <div class="flex gap-2 sm:gap-3">
          <button id="btn-export-of" class="px-3 sm:px-4 py-2 bg-[var(--cor-info)] text-white font-semibold rounded-lg hover:bg-[var(--cor-info-hover)] transition" onclick="exportOFTasksCSV(window.__ofDetailsOpenId)">Exportar CSV</button>
          <button class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition" onclick="closeModal('of-details-modal')">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <div id="user-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="event.stopPropagation()">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-md 
    modal-panel mx-0 sm:mx-4">
      <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">Acesso</h3>
      <div class="space-y-3 sm:space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Perfil</label>
          <select id="user-role" class="w-full border border-gray-300 rounded-lg p-2 mt-1">
            <option value="OPERADOR">Operador</option>
            <option value="MASTER">Master</option>
          </select>
 
        </div>
        <div id="user-sector-wrap">
          <label class="block text-sm font-medium text-gray-700">Setor do Operador</label>
          <select id="user-sector" class="w-full border border-gray-300 rounded-lg p-2 mt-1"></select>
        </div>
        <div id="user-pin-wrap" class="hidden">
          <label class="block text-sm font-medium text-gray-700">PIN do Master</label>
          <input type="password" id="user-pin" class="w-full border border-gray-300 rounded-lg 
    p-2 mt-1 focus-ring-primary" placeholder="****">
          <p class="text-xs text-gray-500 mt-1">Apenas numeros</p>
        </div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end gap-2 sm:gap-3">
        <button class="px-3 sm:px-4 py-2 bg-gray-200 rounded-lg font-semibold hover:bg-gray-300" onclick="closeModal('user-modal')">Cancelar</button>
        <button class="px-3 sm:px-4 py-2 bg-[var(--cor-primaria)] text-white rounded-lg font-semibold hover:bg-[var(--cor-primaria-hover)]" onclick="confirmUser()">Entrar</button>
      </div>
    </div>
  </div>
  
  <script>
/* ============================
   FIREBASE CONFIG
   ============================ */
const firebaseConfig = {
  apiKey: "AIzaSyDIJJIe4WIVj5OKYTtR-HQscrxIzxNK9eY",
  authDomain: "pcp-app-24c56.firebaseapp.com",
  projectId: "pcp-app-24c56",
  storageBucket: "pcp-app-24c56.firebasestorage.app",
  messagingSenderId: "675295958467",
  appId: "1:675295958467:web:9d79700af6fc1c28db5976",
  measurementId: "G-DH06WDCKJY"
};
// Inicializa√ß√£o Firebase
if (firebaseConfig && firebaseConfig.projectId && firebaseConfig.projectId !== "SEU_PROJECT_ID") {
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();
  window.db = db;
  window.storage = storage;

  // Cole√ß√µes
  const OF_COLLECTION = 'ofs';
  const TASK_COLLECTION = 'tasks';
  const ROTEIRO_COLLECTION = 'roteiros';
  const OCORRENCIA_COLLECTION = 'ocorrencias';
  window.OF_COLLECTION = OF_COLLECTION;
  window.TASK_COLLECTION = TASK_COLLECTION;
  window.ROTEIRO_COLLECTION = ROTEIRO_COLLECTION;
  window.OCORRENCIA_COLLECTION = OCORRENCIA_COLLECTION;
} else {
  console.warn("Firebase n√£o configurado ‚Äî rodando em modo simulado.");
  window.db = null;
  window.storage = null;
}

/* ============================
   CONSTANTES & ESTADO
   ============================ */
const MASTER_PIN = "7889";
const SECTORS = [
  'Corte','Corte de Revestimentos','Pr√©-Montagem','Prepara√ß√£o','Pr√© Conex√£o',
  'Conex√£o','Pr√© Grampea√ß√£o','Grampea√ß√£o','Acabamento','Embalagem','Montagem','Cabo de Bateria 1','Cabo de Bateria 2'
];
const PAUSE_REASONS = [
  "Falta de material na bancada","Manuten√ß√£o/Ajuste de m√°quina","Instru√ß√£o de trabalho confusa/ausente",
  "Necessidade de assist√™ncia t√©cnica","Troca de turno/intervalo programado","Outro (Detalhar abaixo)"
];
const DELAY_REASONS = [
  "Complexidade inesperada da pe√ßa","Problema de qualidade na etapa anterior","Falta de treinamento/experi√™ncia",
  "Tempo padr√£o calculado incorretamente","Quebra/defeito de ferramenta","Outro (Detalhar abaixo)"
];
let allOFs = {};
let allTasks = {};
let allRoteiros = {};
let allOcurrencesLog = [];
let currentAction = {};
let currentSectorFilter = SECTORS[0];

// Guarda a refer√™ncia ao usu√°rio logado
let currentUser = null;

// Busca por OF nas telas
let pcpSearchOF = "";
let operatorSearchOF = "";

// Simula√ß√£o
let taskCounter = 1;
let roteiroCounter = 7;
const DEFAULT_ROTEIROS = {
  "r1": { id:"r1", chicote_nome:"CHICOTE-001", setor:"Corte", nome_atividade:"Corte dos Fios", tempo_setup:5, tempo_ciclo:0.2,
    instrucao_trabalho:"<b>1. Prepara√ß√£o:</b> Verifique a faca...<br><b>2. Medi√ß√£o:</b> Corte 50 pe√ßas de 150mm.<br><b>3. Confer√™ncia:</b> Visual."
  },
  "r2": { id:"r2", chicote_nome:"CHICOTE-001", setor:"Pr√©-Montagem", nome_atividade:"Crimpagem de Terminais", tempo_setup:8, tempo_ciclo:0.5,
    instrucao_trabalho:"<b>Fio Preto:</b> ...<br><b>Fio Vermelho:</b> ...<br><b>Teste:</b> > 10Kgf."
  },
  "r3": { id:"r3", chicote_nome:"CHICOTE-001", setor:"Montagem Final", nome_atividade:"Montagem de Conectores", tempo_setup:15, tempo_ciclo:1.0,
    instrucao_trabalho:"Conectar posi√ß√µes 35 e 33. Proibido for√ßar."
  },
  "r4": { id:"r4", chicote_nome:"CHICOTE-001", setor:"Qualidade", nome_atividade:"Teste de Continuidade", tempo_setup:3, tempo_ciclo:0.1,
    instrucao_trabalho:"Usar jig JIG-10B. 100% devem passar."
  },
  "r5": { id:"r5", chicote_nome:"CHICOTE-B", setor:"Corte", nome_atividade:"Corte Refor√ßado", tempo_setup:10, tempo_ciclo:0.3, instrucao_trabalho:"Instru√ß√£o b√°sica B."},
  "r6": { id:"r6", chicote_nome:"CHICOTE-B", setor:"Montagem Final", nome_atividade:"Montagem Simples", tempo_setup:5, tempo_ciclo:0.8, instrucao_trabalho:"Conectar 4 vias."},
};
/* ============================
   ELEMENTOS UI
   ============================ */
const pcpView = document.getElementById("pcp-view");
const operatorView = document.getElementById("operator-view");
const reportView = document.getElementById("report-view");
const loadingIndicator = document.getElementById("loading-indicator");
const ofsListContainer = document.getElementById("ofs-list-container");
const tasksListContainer = document.getElementById("tasks-list-container");
const userViewSelect = document.getElementById("user-view-select");
const btnCreateOF = document.getElementById("btn-create-of");
const btnSetupRoteiro = document.getElementById("btn-setup-roteiro");
const btnProfile = document.getElementById("btn-profile");
// const btnThemeMaster = document.getElementById("btn-theme-master"); // REMOVIDO
const btnExportReport = document.getElementById("btn-export-report");
const btnDeleteOF = document.getElementById("btn-delete-of");

/* ============================
   HELPERS & PERMISS√ïES
   ============================ */
// CORRE√á√ÉO: Fun√ß√£o msToMinutes agora √© o √∫nico ponto de convers√£o
function msToMinutes(ms){ 
  if (typeof ms !== 'number' || ms < 0) return 0;
  return parseFloat((ms / (1000*60)).toFixed(2)); 
}
function formatMinutes(v){ return `${Number(v||0).toFixed(2)} min`; }

function setUser(u){
  currentUser = u;
  try { sessionStorage.setItem("pcp_current_user", JSON.stringify(u));
  } catch(_){}
}

function getUser(){
  try { return JSON.parse(sessionStorage.getItem("pcp_current_user") || "null"); } catch(e){ return null;
  }
}

function clearUser(){
  try{ sessionStorage.removeItem("pcp_current_user"); }catch(_){}
  currentUser=null;
}

function isMaster(){
  return currentUser && currentUser.role === "MASTER";
}

function isOperador(){
  return currentUser && currentUser.role === "OPERADOR";
}

function getDBTimestamp(ts) {
  if (!ts) return null;
  if (typeof ts.toDate === 'function') return ts.toDate().getTime();
  if (ts instanceof Date) return ts.getTime();
  return ts; // Retorna o valor direto se for um n√∫mero (timestamp em milissegundos)
}

/* ============================
   THEME (Global via Firestore)
   ============================ */
// Fun√ß√µes de Theme removidas ou simplificadas, mantendo apenas a estrutura

function listenTheme(){
  if (!window.db) return;
  db.collection('settings').doc('ui').onSnapshot(doc=>{
    const s = doc.exists ? doc.data() : null;
    applyTheme(s);
  });
}

function applyTheme(s){
  const r = document.documentElement.style;
  if (!s || s.mode === 'color'){
    r.setProperty('--app-bg-color', s?.color || '#f3f4f6');
    r.setProperty('--app-bg-image', 'none');
  } else {
    r.setProperty('--app-bg-color', '#000000');
    r.setProperty('--app-bg-image', `url("${s.imageUrl}")`);
  }
}

/* ============================
   INIT & LISTENERS
   ============================ */
function setupFirebaseListeners(){
  if (!window.db) return;

  // Listener OFs
  db.collection(OF_COLLECTION).onSnapshot(snapshot => {
    snapshot.docChanges().forEach(change => {
      const ofData = change.doc.data();
      ofData.id = change.doc.id;
      allOFs[ofData.id] = ofData;
    });
    renderPCP();
  });

  // Listener Tasks
  db.collection(TASK_COLLECTION).onSnapshot(snapshot => {
    snapshot.docChanges().forEach(change => {
      const taskData = change.doc.data();
      taskData.id = change.doc.id;
      allTasks[taskData.id] = taskData;
    });
    renderTasks();
    renderPCP();
  });

  // Listener Roteiros
  db.collection(ROTEIRO_COLLECTION).onSnapshot(snapshot => {
    allRoteiros = {};
    snapshot.docs.forEach(doc => {
      const roteiroData = doc.data();
      roteiroData.id = doc.id;
      allRoteiros[roteiroData.id] = roteiroData;
    });
    renderRoteiros();
    loadRoteiroDropdowns();
  });

  // Listener Ocorr√™ncias
  db.collection(OCORRENCIA_COLLECTION).onSnapshot(snapshot => {
    allOcurrencesLog = [];
    snapshot.docs.forEach(doc => {
      allOcurrencesLog.push(doc.data());
    });
    renderReport();
  });
}

function loadSectorDropdowns(){
  const roteiroSetorSelect = document.getElementById('roteiro-setor');
  const userSectorSelect = document.getElementById('user-sector');
  const sectorFilterSelect = document.getElementById('sector-filter');

  SECTORS.forEach(sector=>{
    const o1 = document.createElement('option');
    o1.value=sector;
    o1.textContent=sector;
    const o2 = o1.cloneNode(true);
    if (roteiroSetorSelect) roteiroSetorSelect.appendChild(o1);
    if (userSectorSelect) userSectorSelect.appendChild(o2);
  });

  if (sectorFilterSelect){
    if (isOperador()){
      const o = document.createElement('option');
      o.value=currentUser.sector;
      o.textContent=currentUser.sector;
      sectorFilterSelect.appendChild(o);
      sectorFilterSelect.value=currentUser.sector;
      sectorFilterSelect.disabled = true;
      currentSectorFilter = currentUser.sector;
    } else {
      SECTORS.forEach(sector=>{
        const o2 = document.createElement('option');
        o2.value=sector;
        o2.textContent=sector;
        sectorFilterSelect.appendChild(o2);
      });
      currentSectorFilter = SECTORS[0];
      sectorFilterSelect.value = SECTORS[0];
      sectorFilterSelect.disabled = false;
    }
  }
}

function updateSectorFilter(sector){
  currentSectorFilter = sector;
  renderTasks();
}

function loadRoteiroDropdowns() {
  const select = document.getElementById('of-chicote');
  if (!select) return;
  const roteiros = Object.values(allRoteiros);
  const chicotes = [...new Set(roteiros.map(r => r.chicote_nome))];

  select.innerHTML = '<option value="">-- Selecione um Modelo --</option>';
  chicotes.forEach(chicote => {
    const option = document.createElement('option');
    option.value = chicote;
    option.textContent = chicote;
    select.appendChild(option);
  });
  if (chicotes.length === 0) {
    select.innerHTML = '<option value="">Nenhum roteiro mestre cadastrado.</option>';
  }
}

async function initializeApp(){
  loadingIndicator.classList.remove('hidden');
  // Esconde tudo enquanto n√£o loga
  pcpView.classList.add('hidden');
  operatorView.classList.add('hidden');
  reportView.classList.add('hidden');
  
  // Tema global (escuta sempre)
  listenTheme();

  // Restaura sess√£o (sessionStorage)
  const savedUser = getUser();
  if (savedUser){
    setUser(savedUser);
  }

  if (window.db) {
    setupFirebaseListeners();
  } else {
    // SIMULA√á√ÉO
    allRoteiros = { ...DEFAULT_ROTEIROS };
    if (!localStorage.getItem('sim_data_initialized')) {
      // Simula√ß√£o: Adiciona um pequeno atraso para simular a cria√ß√£o ass√≠ncrona
      await createOF('OF-001', 10, 'CHICOTE-001', true);
      await createOF('OF-002', 20, 'CHICOTE-B', true);
      localStorage.setItem('sim_data_initialized', 'true');
    } else {
      allOFs = JSON.parse(localStorage.getItem('sim_ofs') || "{}");
      allTasks = JSON.parse(localStorage.getItem('sim_tasks') || "{}");
      allOcurrencesLog = JSON.parse(localStorage.getItem('sim_ocorrencias') || "[]");
    }
    renderPCP();
    renderTasks();
    renderReport();
    renderRoteiros();
    loadRoteiroDropdowns();
  }

  loadSectorDropdowns();
  
  // Exibe a tela de login/usu√°rio se n√£o estiver logado
  if (!currentUser){
    openUserModal();
  } else {
    // CORRE√á√ÉO: For√ßa a view correta ao iniciar
    if (isOperador()) {
      updateView('Operador');
    } else {
      updateView('PCP');
    }
  }

  loadingIndicator.classList.add('hidden');
}

/* ============================
   CRUDs
   ============================ */
async function addRoteiroActivity(){
  if (!isMaster()) return;
  const chicote_name = document.getElementById('roteiro-chicote-name').value.trim().toUpperCase();
  const setor = document.getElementById('roteiro-setor').value;
  const activity_name = document.getElementById('roteiro-activity-name').value.trim();
  const setup_time = parseFloat(document.getElementById('roteiro-setup-time').value);
  const cycle_time = parseFloat(document.getElementById('roteiro-cycle-time').value);
  const instruction_text = document.getElementById('roteiro-instruction-text').value.trim();
  const messageEl = document.getElementById('roteiro-message');
  messageEl.textContent = '';

  if (!chicote_name || !activity_name || isNaN(setup_time) || isNaN(cycle_time) || !setor){
    messageEl.textContent = "Preencha todos os campos obrigat√≥rios e use n√∫meros para tempo.";
    return;
  }

  if (window.db) {
    try {
      const newRoteiro = {
        chicote_nome: chicote_name,
        setor: setor,
        nome_atividade: activity_name,
        tempo_setup: setup_time,
        tempo_ciclo: cycle_time,
        instrucao_trabalho: instruction_text,
        created_at: firebase.firestore.FieldValue.serverTimestamp()
      };
      await db.collection(ROTEIRO_COLLECTION).add(newRoteiro);
      messageEl.textContent = `Etapa "${activity_name}" adicionada ao roteiro mestre ${chicote_name}.`;
      messageEl.classList.remove('text-red-500');
      messageEl.classList.add('text-green-600');
    } catch(e) {
      messageEl.textContent = "Erro ao salvar no Firebase: " + e.message;
      messageEl.classList.add('text-red-500');
    }
  } else {
    const newId = `r${roteiroCounter++}`;
    allRoteiros[newId] = { 
      id: newId, 
      chicote_nome: chicote_name, 
      setor, 
      nome_atividade: activity_name, 
      tempo_setup: setup_time, 
      tempo_ciclo: cycle_time, 
      instrucao_trabalho: instruction_text 
    };
    messageEl.textContent = `Etapa "${activity_name}" adicionada (Simula√ß√£o).`;
    messageEl.classList.remove('text-red-500');
    messageEl.classList.add('text-green-600');
    renderRoteiros();
    loadRoteiroDropdowns();
  }

  document.getElementById('roteiro-activity-name').value = '';
  document.getElementById('roteiro-setup-time').value = '';
  document.getElementById('roteiro-cycle-time').value = '';
  document.getElementById('roteiro-instruction-text').value = '';
}

async function createOF(ofIdOverride, quantityOverride, chicoteOverride, isSimulated = false){
  const of_id = ofIdOverride || document.getElementById('of-id').value.trim().toUpperCase();
  const quantity = quantityOverride || parseInt(document.getElementById('of-quantity').value);
  const chicote = chicoteOverride || document.getElementById('of-chicote').value;
  const messageEl = document.getElementById('of-creation-message');
  messageEl.textContent = '';
  messageEl.classList.add('hidden');

  if (!of_id || isNaN(quantity) || quantity < 1 || !chicote){
    messageEl.textContent = "Preencha todos os campos corretamente (C√≥digo OF, Quantidade > 0 e Modelo Chicote).";
    messageEl.classList.remove('hidden');
    return;
  }
  if (allOFs[of_id]){
    messageEl.textContent = `A OF ${of_id} j√° existe.`;
    messageEl.classList.remove('hidden');
    return;
  }

  try {
    const roteirosDoChicote = Object.values(allRoteiros).filter(r => r.chicote_nome === chicote);
    if (roteirosDoChicote.length === 0) {
      messageEl.textContent = `Nenhum roteiro mestre encontrado para o modelo ${chicote}.`;
      messageEl.classList.remove('hidden');
      return;
    }

    const newOF = {
      id: of_id,
      chicote: chicote,
      quantidade: quantity,
      status: 'Em Produ√ß√£o',
      created_at: window.db ? firebase.firestore.FieldValue.serverTimestamp() : new Date(),
    };
    allOFs[of_id] = newOF;

    let batch = window.db ? db.batch() : null;
    if (batch) batch.set(db.collection(OF_COLLECTION).doc(of_id), newOF);

    let nextEtapa = 1;

    roteirosDoChicote.sort((a,b) => (a.nome_atividade > b.nome_atividade) ? 1 : -1) // Simplesmente ordena alfabeticamente
      .forEach(roteiro => {
        const tempo_planejado = roteiro.tempo_setup + (roteiro.tempo_ciclo * quantity);
        const newTask = {
          id_of: of_id,
          chicote: chicote,
          nome_atividade: roteiro.nome_atividade,
          setor: roteiro.setor,
          tempo_setup: roteiro.tempo_setup,
          tempo_ciclo: roteiro.tempo_ciclo,
          tempo_planejado: tempo_planejado, // Valor em Minutos
          instrucao_trabalho: roteiro.instrucao_trabalho,
          status: nextEtapa === 1 ? 'Em Espera' : 'Bloqueada', // Primeira tarefa fica Em Espera
          tempo_real_acumulado: 0, // VALOR SEMPRE EM MILISSEGUNDOS
          total_pause_time_ms: 0,  // VALOR SEMPRE EM MILISSEGUNDOS
          timestamp_inicio: null,
          timestamp_fim: null,
          etapa: nextEtapa++,
          created_at: new Date()
        };
        
        if (batch) {
          const newTaskRef = db.collection(TASK_COLLECTION).doc();
          batch.set(newTaskRef, newTask);
        } else {
          const simTaskId = `t${taskCounter++}`;
          newTask.id = simTaskId;
          allTasks[simTaskId] = newTask;
        }
      });

    if (batch) await batch.commit();

    if (!isSimulated) {
      closeModal('create-of-modal');
      alert(`OF ${of_id} criada com sucesso!`);
      if (!window.db) {
        localStorage.setItem('sim_ofs', JSON.stringify(allOFs));
        localStorage.setItem('sim_tasks', JSON.stringify(allTasks));
      }
    }
  } catch(e) {
    messageEl.textContent = "Erro ao criar OF: " + (e.message || e);
    messageEl.classList.remove('hidden');
  }
}

// NOVO: Fun√ß√£o para obter o valor acumulado em milissegundos
function calculateTempoRealMs(task){
  // Se conclu√≠do ou bloqueado/espera, retorna o valor salvo em MS
  if (task.status === 'Conclu√≠do' || task.status === 'Bloqueada' || task.status === 'Em Espera') return task.tempo_real_acumulado || 0;
  
  // Se estiver em processo ou pausado, calcula o tempo corrido
  const now = Date.now();
  let tempoAcumulado = task.tempo_real_acumulado || 0;
  let ultimaAtividade = getDBTimestamp(task.timestamp_inicio);

  if (!ultimaAtividade) return tempoAcumulado;

  if (task.status === 'Em Processo'){
    // Adiciona o tempo desde o √∫ltimo in√≠cio
    tempoAcumulado += (now - ultimaAtividade);
  }
  // Se Pausada, tempoAcumulado √© o tempo_real_acumulado salvo no momento da pausa.
  
  return tempoAcumulado; // Retorna o valor em milissegundos
}

// CORRE√á√ÉO: Fun√ß√µes que retornam minutos (usando a nova calculateTempoRealMs)
function calculateTempoRealMinutes(task){
  return msToMinutes(calculateTempoRealMs(task));
}

function calculateTempoPlanejado(task, ofQuantity){
  return task.tempo_setup + (task.tempo_ciclo * ofQuantity);
}

function calculateDesvio(task){
  const of = allOFs[task.id_of];
  if (!of) return 0;
  const realMinutes = calculateTempoRealMinutes(task); // Tempo real em minutos
  const planned = calculateTempoPlanejado(task, of.quantidade); // Tempo planejado em minutos
  
  // Desvio (min): Planejado - Real. Positivo = Adiantado/Dentro. Negativo = Atrasado.
  return parseFloat((planned - realMinutes).toFixed(2));
}

function calculateTotalPauseMinutes(task){
  let totalMs = task.total_pause_time_ms || 0;
  if (task.status === 'Pausada' && task.pause_start_timestamp){
    // Se est√° pausada, inclui o tempo da pausa atual
    totalMs += (Date.now() - getDBTimestamp(task.pause_start_timestamp));
  }
  return msToMinutes(totalMs);
}

function calculateTotalPauseMinutesFinal(task){
  return msToMinutes(task.total_pause_time_ms || 0);
}

async function updateTaskStatus(taskId, newStatus, logType = null, justification = null, justificationText = null) {
  const task = allTasks[taskId];
  if (!task) return;

  const updateData = { status: newStatus };
  const now = window.db ? firebase.firestore.FieldValue.serverTimestamp() : new Date();

  if (newStatus === 'Em Processo') {
    if (task.status === 'Pausada' && task.pause_start_timestamp) {
      const pauseStartMs = getDBTimestamp(task.pause_start_timestamp);
      const currentPauseTimeMs = Date.now() - pauseStartMs;
      updateData.total_pause_time_ms = (task.total_pause_time_ms || 0) + currentPauseTimeMs; // Acumula pausa em MS
      updateData.pause_start_timestamp = null;
    }
    // Se saiu de Em Espera, registra o primeiro in√≠cio
    if (task.status === 'Em Espera') updateData.timestamp_inicio = now; 

  } else if (newStatus === 'Pausada') {
    // CORRE√á√ÉO: Salva o tempo real *acumulado em milissegundos* antes da pausa
    const currentTempoRealMs = calculateTempoRealMs(task); 
    updateData.tempo_real_acumulado = currentTempoRealMs; // Armazena em MS
    updateData.pause_start_timestamp = now; // Inicia a contagem da pausa

    if (logType === 'PAUSA' && (justification || justificationText)) {
      // O log de ocorr√™ncia ser√° criado, mas o tempo de pausa s√≥ √© calculado na retomada ou no fim
      // No log de pausa, vamos registrar o motivo. O tempo ser√° ajustado (log de pausa usa o tempo entre start e stop).
      // Para manter a simplicidade: o log de PAUSA registra o motivo no *in√≠cio da pausa*.
      await createOcorrenciaLog(task, 'PAUSA', justification, justificationText);
    }

  } else if (newStatus === 'Conclu√≠do') {
    // CORRE√á√ÉO: Salva o tempo real *final em milissegundos*
    const finalTempoRealMs = calculateTempoRealMs(task); 
    const desvio = calculateDesvio(task);
    
    updateData.tempo_real_acumulado = finalTempoRealMs; // Armazena em MS
    updateData.timestamp_fim = now;
    updateData.pause_start_timestamp = null;

    if (desvio < 0 || logType === 'FIM_ATRASO') {
      await createOcorrenciaLog(task, 'FIM_ATRASO', justification, justificationText);
    }
    
    // Libera a pr√≥xima tarefa
    const tasksOfOF = Object.values(allTasks).filter(t => t.id_of === task.id_of);
    const nextTask = tasksOfOF.find(t => t.etapa === task.etapa + 1);
    if (nextTask && nextTask.status === 'Bloqueada'){
      if (window.db) {
        await db.collection(TASK_COLLECTION).doc(nextTask.id).update({status: 'Em Espera'});
      } else {
        nextTask.status = 'Em Espera';
      }
    }
  }

  // Persist√™ncia
  if (window.db) {
    if (task.id) await db.collection(TASK_COLLECTION).doc(task.id).update(updateData);
  } else {
    // SIMULA√á√ÉO
    const oldTask = allTasks[taskId];
    allTasks[taskId] = { ...oldTask, ...updateData };
    if (updateData.timestamp_inicio && !oldTask.timestamp_inicio) allTasks[taskId].timestamp_inicio = updateData.timestamp_inicio;
    if (updateData.timestamp_fim && !oldTask.timestamp_fim) allTasks[taskId].timestamp_fim = updateData.timestamp_fim;
    if (updateData.tempo_real_acumulado) allTasks[taskId].tempo_real_acumulado = updateData.tempo_real_acumulado;
    if (updateData.total_pause_time_ms) allTasks[taskId].total_pause_time_ms = updateData.total_pause_time_ms;
    if (updateData.pause_start_timestamp) allTasks[taskId].pause_start_timestamp = updateData.pause_start_timestamp;

    localStorage.setItem('sim_tasks', JSON.stringify(allTasks));
    renderTasks();
    renderPCP();
  }
}

async function createOcorrenciaLog(task, type, justification, justificationText){
  const of = allOFs[task.id_of];
  if (!of) return;

  const logData = {
    id_of: task.id_of,
    chicote: task.chicote,
    setor: task.setor,
    nome_atividade: task.nome_atividade,
    justificativa_principal: justification,
    justificativa_detalhe: justificationText,
    timestamp: window.db ? firebase.firestore.FieldValue.serverTimestamp() : new Date(),
    TIPO: type,
    TEMPO_PAUSA: 0,
    TEMPO_ATRASO: 0,
    MOTIVO_PAUSA: null,
    MOTIVO_ATRASO: null,
  };

  if (type === 'PAUSA'){
    // O log de PAUSA registra o momento e motivo que a pausa foi acionada. 
    // O TEMPO_PAUSA real √© registrado quando a pausa √© encerrada (retomada/fim da task)
    logData.MOTIVO_PAUSA = justification;
  } else if (type === 'FIM_ATRASO') {
    const desvio = calculateDesvio(task);
    logData.TEMPO_PAUSA = calculateTotalPauseMinutesFinal(task); // Tempo total de pausa final
    logData.TEMPO_ATRASO = parseFloat(Math.abs(desvio).toFixed(2)); // Atraso (desvio negativo)
    logData.MOTIVO_ATRASO = justification;
  }

  if (window.db) await db.collection(OCORRENCIA_COLLECTION).add(logData);
  else {
    logData.id = `log${allOcurrencesLog.length + 1}`;
    allOcurrencesLog.push(logData);
    localStorage.setItem('sim_ocorrencias', JSON.stringify(allOcurrencesLog));
  }
}

/* ============================
   A√á√ïES
   ============================ */
function startTask(taskId){
  updateTaskStatus(taskId, 'Em Processo');
}

function finishTask(taskId){
  showActionModal(taskId, 'Finalizar', DELAY_REASONS);
}

function pauseTask(taskId){
  showActionModal(taskId, 'Pausar', PAUSE_REASONS);
}

// NOVO: Fun√ß√£o para limpar os logs de ocorr√™ncia (Relat√≥rios)
async function clearReportLogs(){
  if (!isMaster() || !confirm("Tem certeza que deseja EXCLUIR TODOS os logs de ocorr√™ncia? Esta a√ß√£o √© irrevers√≠vel.")) return;

  try {
    if (window.db) {
      const collectionRef = db.collection(OCORRENCIA_COLLECTION);
      // Limpeza eficiente (requer que a seguran√ßa do Firebase permita dele√ß√£o)
      const snapshot = await collectionRef.get();
      if (snapshot.size === 0) return alert("Nenhum log para excluir.");
      
      const batch = db.batch();
      snapshot.docs.forEach(doc => batch.delete(doc.ref));
      await batch.commit();
      alert(`Logs de ocorr√™ncia (${snapshot.size} itens) exclu√≠dos com sucesso do Firebase!`);
    } else {
      // Simula√ß√£o
      allOcurrencesLog = [];
      localStorage.setItem('sim_ocorrencias', "[]");
      alert("Logs de ocorr√™ncia exclu√≠dos em modo simula√ß√£o.");
    }
    renderReport();
  } catch(e) {
    alert("Erro ao excluir logs: " + e.message);
  }
}


async function deleteRoteiroActivity(roteiroId) {
  if (!isMaster() || !confirm("Excluir esta etapa de roteiro?")) return;
  if (window.db) {
    try {
      await db.collection(ROTEIRO_COLLECTION).doc(roteiroId).delete();
      alert("Etapa exclu√≠da.");
    } catch(e) {
      alert("Erro ao excluir: " + e.message);
    }
  } else {
    delete allRoteiros[roteiroId];
    renderRoteiros();
    loadRoteiroDropdowns();
  }
}

async function deleteOF(ofId) {
  if (!isMaster() || !ofId) return;
  if (!confirm(`Excluir OF ${ofId} e TODAS as suas tarefas e logs?`)) return;

  try {
    if (window.db) {
      const batch = db.batch();
      batch.delete(db.collection(OF_COLLECTION).doc(ofId));

      const tasksSnapshot = await db.collection(TASK_COLLECTION).where('id_of', '==', ofId).get();
      tasksSnapshot.docs.forEach(doc => batch.delete(doc.ref));

      // Deleta logs de ocorr√™ncia (opcional, mas bom para limpeza)
      const ocorrenciasSnapshot = await db.collection(OCORRENCIA_COLLECTION).where('id_of', '==', ofId).get();
      ocorrenciasSnapshot.docs.forEach(doc => batch.delete(doc.ref));

      await batch.commit();
    } else {
      // Simula√ß√£o
      delete allOFs[ofId];
      Object.keys(allTasks).forEach(taskId => {
        if (allTasks[taskId].id_of === ofId) delete allTasks[taskId];
      });
      allOcurrencesLog = allOcurrencesLog.filter(l => l.id_of !== ofId);

      localStorage.setItem('sim_ofs', JSON.stringify(allOFs));
      localStorage.setItem('sim_tasks', JSON.stringify(allTasks));
      localStorage.setItem('sim_ocorrencias', JSON.stringify(allOcurrencesLog));
      renderPCP();
      renderTasks();
      renderReport();
    }
    closeModal('of-details-modal');
    alert(`OF ${ofId} exclu√≠da com sucesso.`);
  } catch(e) {
    alert("Erro ao excluir OF: " + e.message);
  }
}


/* ============================
   MODAIS DE A√á√ÉO E UX
   ============================ */
function openModal(id){
  const modal = document.getElementById(id);
  if(modal) modal.style.display = 'flex';
}

function closeModal(id = 'action-modal'){
  const modal = document.getElementById(id);
  if(modal) modal.style.display = 'none';
}

function showActionModal(taskId, type, reasons){
  const task = allTasks[taskId];
  if (!task) return;

  currentAction = { taskId, type };

  const modalTitle = document.getElementById('modal-title');
  const modalMessage = document.getElementById('modal-message');
  const justificationSelect = document.getElementById('justification-select');
  const justificationText = document.getElementById('justification-text');
  const justificationRequired = document.getElementById('justification-required-text');

  modalTitle.textContent = `${type} Tarefa: OF ${task.id_of} - ${task.nome_atividade}`;
  modalMessage.textContent = `Voc√™ est√° prestes a ${type.toLowerCase()} a tarefa. Por favor, justifique, se necess√°rio.`;
  justificationText.value = '';
  justificationSelect.innerHTML = '<option value="">-- Selecione uma op√ß√£o --</option>';

  reasons.forEach(reason => {
    const option = document.createElement('option');
    option.value = reason;
    option.textContent = reason;
    justificationSelect.appendChild(option);
  });

  let isRequired = false;
  if (type === 'Finalizar') {
    const desvio = calculateDesvio(task);
    if (desvio < 0) {
      justificationRequired.textContent = `üö® Justificativa obrigat√≥ria devido ao ATRASO de ${formatMinutes(Math.abs(desvio))}!`;
      isRequired = true;
    } else {
      justificationRequired.textContent = `‚úÖ Conclu√≠do dentro/antes do tempo. Nenhuma justificativa necess√°ria.`;
      isRequired = false;
    }
  } else if (type === 'Pausar') {
    justificationRequired.textContent = `Motivo da pausa √© altamente recomendado.`;
  }
  
  justificationRequired.classList.toggle('hidden', !isRequired && type !== 'Pausar');
  currentAction.isRequired = isRequired;
  openModal('action-modal');
}

async function handleConfirmedAction(){
  const { taskId, type, isRequired } = currentAction;
  const justificationSelect = document.getElementById('justification-select');
  const justificationText = document.getElementById('justification-text').value.trim();
  const justification = justificationSelect.value;
  const justificationRequired = document.getElementById('justification-required-text');

  if (isRequired && !justification) {
    justificationRequired.textContent = "üö® Voc√™ deve selecionar um motivo principal!";
    justificationRequired.classList.remove('hidden');
    return;
  }
  justificationRequired.classList.add('hidden');

  if (type === 'Finalizar') {
    // LogType 'FIM_ATRASO' s√≥ √© usado dentro de updateTaskStatus se houver atraso.
    await updateTaskStatus(taskId, 'Conclu√≠do', null, justification, justificationText);
    updateView(userViewSelect.value);
  } else if (type === 'Pausar') {
    await updateTaskStatus(taskId, 'Pausada', 'PAUSA', justification, justificationText);
  }
  closeModal();
}

function openInstructionModal(taskId) {
  const task = allTasks[taskId];
  if (!task) return;

  document.getElementById('instruction-modal-header').textContent = `OF ${task.id_of} - Chicote ${task.chicote} - Setor: ${task.setor}`;
  document.getElementById('instruction-modal-content').innerHTML = task.instrucao_trabalho ||
  'Nenhuma instru√ß√£o de trabalho cadastrada para esta etapa.';
  openModal('instruction-modal');
  lucide.createIcons();
}

function openUserModal() {
  const modal = document.getElementById('user-modal');
  if(modal) modal.style.display = 'flex';
  setTimeout(()=>{
    const roleSel = document.getElementById('user-role');
    const pinWrap = document.getElementById('user-pin-wrap');
    const sectorWrap = document.getElementById('user-sector-wrap');
    if (roleSel.value === 'MASTER'){
      pinWrap.classList.remove('hidden');
      sectorWrap.classList.add('hidden');
    } else {
      pinWrap.classList.add('hidden');
      sectorWrap.classList.remove('hidden');
    }
    // Habilita/desabilita inputs no modal de login (somente para controle visual)
    roleSel.addEventListener('change', (e) => {
      if (e.target.value === 'MASTER') {
        pinWrap.classList.remove('hidden');
        sectorWrap.classList.add('hidden');
      } else {
        pinWrap.classList.add('hidden');
        sectorWrap.classList.remove('hidden');
      }
    });
  }, 100);
}

function confirmUser() {
  const role = document.getElementById('user-role').value;
  const pin = document.getElementById('user-pin').value;
  const sector = document.getElementById('user-sector').value;
  const viewSelect = document.getElementById('user-view-select');

  if (role === 'MASTER') {
    if (pin === MASTER_PIN) {
      setUser({ role: 'MASTER', name: 'Master' });
      closeModal('user-modal');
      // MASTER: Exibe o seletor de vis√£o
      viewSelect.classList.remove('hidden');
      updateView('PCP');
    } else {
      alert("PIN Master incorreto.");
    }
  } else if (role === 'OPERADOR') {
    if (!sector) {
      alert("Selecione um setor.");
      return;
    }
    setUser({ role: 'OPERADOR', name: `Op. ${sector}`, sector: sector });
    closeModal('user-modal');
    // OPERADOR: Esconde o seletor de vis√£o e for√ßa a tela de Operador
    viewSelect.classList.add('hidden');
    updateView('Operador');
  }
}

/* ============================
   RENDERS & EXPORT
   ============================ */

function renderRoteiros(){
  if (!isMaster()) return;
  const list = document.getElementById('roteiro-list');
  if (!list) return;

  const roteiros = Object.values(allRoteiros).sort((a,b) => (a.chicote_nome + a.nome_atividade) > (b.chicote_nome + b.nome_atividade) ? 1 : -1);
  
  const items = roteiros.map(r => `
    <div class="flex justify-between items-center bg-white p-3 border-l-4 border-indigo-500 rounded-lg shadow-sm">
      <div>
        <p class="font-semibold text-sm text-gray-800">${r.chicote_nome} | ${r.setor}</p>
        <p class="text-xs text-gray-600">Atividade: ${r.nome_atividade}</p>
        <p class="text-xs text-gray-600">Setup: ${Number(r.tempo_setup).toFixed(2)} | Ciclo: ${Number(r.tempo_ciclo).toFixed(2)}</p>
      </div>
      <button class="px-2 py-1 text-xs bg-red-600 text-white rounded-lg hover:bg-red-700" onclick="deleteRoteiroActivity('${r.id}')">Excluir</button>
    </div>
  `).join('');
  list.innerHTML = items || '<div class="p-4 text-center text-gray-500 bg-white rounded-lg">Nenhum roteiro cadastrado.</div>';
}

function setupSearchListeners(){
  const inputPCP = document.getElementById('pcp-of-search');
  if (inputPCP) inputPCP.addEventListener('input', (e)=>{
    pcpSearchOF = (e.target.value||"").trim().toUpperCase();
    renderOFs();
  });

  const input = document.getElementById('operator-of-search');
  if (input) input.addEventListener('input', (e)=>{
    operatorSearchOF = (e.target.value||"").trim().toUpperCase();
    renderTasks();
  });
}

function renderKPIs(){
  const kpisContainer = document.getElementById('kpis-container');
  if (!kpisContainer) return;
  
  const totalOFs = Object.keys(allOFs).filter(k=> allOFs[k]?.status !== 'Conclu√≠do').length;
  const concludedTasks = Object.values(allTasks).filter(t=>t.status==='Conclu√≠do').length;
  const totalTasks = Object.values(allTasks).length;
  const logsAtraso = allOcurrencesLog.filter(l => l.TIPO === 'ATRASO');
  const totalPause = allOcurrencesLog.reduce((s,l)=> s + (l.TEMPO_PAUSA||0), 0);
  const totalAtraso = logsAtraso.reduce((s,l)=> s + (l.TEMPO_ATRASO||0), 0);

  const kpiData = [
    { title:"OFs Ativas", value: totalOFs, icon:"package", color:"bg-[var(--cor-primaria)]" },
    { title:"Tarefas Conclu√≠das", value: `${concludedTasks} / ${totalTasks}`, icon:"check-circle", color:"bg-[var(--cor-sucesso)]" },
    { title:"Pausas Totais (min)", value: totalPause.toFixed(1), icon:"pause-circle", color:"bg-[var(--cor-alerta)]" },
    { title:"Atraso Total (min)", value: totalAtraso.toFixed(1), icon:"alert-triangle", color:"bg-[var(--cor-perigo)]" },
  ];

  kpisContainer.innerHTML = kpiData.map(k=>`
    <div class="${k.color} text-white p-3 sm:p-4 rounded-xl shadow-md flex items-center justify-between">
      <div>
        <p class="text-xs sm:text-sm font-medium opacity-80">${k.title}</p>
        <p class="text-2xl sm:text-3xl font-bold">${k.value}</p>
      </div>
      <i data-lucide="${k.icon}" class="w-7 h-7 sm:w-8 sm:h-8 opacity-70"></i>
    </div>`).join('');
  lucide.createIcons();
}

function updateView(view){
  // üîí Se n√£o houver usu√°rio, for√ßa o modal de login
  if (!currentUser) { openUserModal(); return; }

  // üîí RESTRI√á√ÉO DE ACESSO: Operador s√≥ pode ver 'Operador'
  if (isOperador() && view !== 'Operador') {
    alert("Acesso negado. Operadores s√≥ podem ver a vis√£o de 'Operador'.");
    view = 'Operador';
    userViewSelect.value = 'Operador';
  }

  // Restaura o estado dos bot√µes do Header
  btnCreateOF.classList.add('hidden');
  btnSetupRoteiro.classList.add('hidden');
  btnProfile.classList.remove('hidden');
  userViewSelect.classList.toggle('hidden', isOperador()); // Esconde o seletor para Operador

  // Ajusta a visibilidade das views
  pcpView.classList.add('hidden');
  operatorView.classList.add('hidden');
  reportView.classList.add('hidden');
  
  // Ajusta a visibilidade da busca
  document.getElementById('pcp-of-search-wrap').classList.add('hidden');
  document.getElementById('operator-of-search-wrap').classList.add('hidden');
  
  // Esconde o bot√£o de Limpeza
  document.getElementById('btn-clear-report').classList.add('hidden');

  // Muda a view
  if (view === 'PCP'){
    pcpView.classList.remove('hidden');
    document.getElementById('pcp-of-search-wrap').classList.remove('hidden');
    renderOFs();
  } else if (view === 'Operador'){
    operatorView.classList.remove('hidden');
    document.getElementById('operator-of-search-wrap').classList.remove('hidden');
    renderTasks();
  } else if (view === 'Relatorio'){
    reportView.classList.remove('hidden');
    renderReport();
    // PERMISS√ÉO: Exibe o bot√£o Limpar Logs se for Master
    document.getElementById('btn-clear-report').classList.toggle('hidden', !isMaster()); 
  }
  
  // Exibe bot√µes master se for o caso
  if (isMaster()){
    btnCreateOF.classList.remove('hidden');
    btnSetupRoteiro.classList.remove('hidden');
  }

  // Se o operador tiver o filtro fixo, re-renderiza as tarefas
  if (isOperador() && view === 'Operador'){
    updateSectorFilter(currentUser.sector);
  }

  // Atualiza o select para refletir a view atual
  userViewSelect.value = view;
  lucide.createIcons();
  renderKPIs();
}

function renderOFs(){
  if (operatorView.classList.contains('hidden')) renderKPIs(); // Recalcula KPIs (que s√≥ s√£o exibidos no PCP)
  
  const container = document.getElementById('ofs-list-container');
  if (!container) return;
  
  let ofs = Object.values(allOFs).filter(of => of.status !== 'Conclu√≠do');
  // üîé filtro por OF na tela PCP
  if (pcpSearchOF) ofs = ofs.filter(of => (of.id || "").toUpperCase().includes(pcpSearchOF));

  const ofsHtml = ofs.map(of=>{
    const tasks = Object.values(allTasks).filter(t=> t.id_of === of.id);
    const completed = tasks.filter(t => t.status === 'Conclu√≠do').length;
    // contagem real
    const nextTask = tasks.find(t=> t.status === 'Em Espera' || t.status === 'Em Processo' || t.status === 'Pausada');
    
    let statusColor = 'bg-gray-100 border-gray-300';
    let progress = 0;
    
    if (tasks.length > 0){
      progress = Math.floor((completed / tasks.length) * 100);
      if (progress === 0) statusColor = 'bg-gray-200 border-gray-400';
      else if (progress < 100) statusColor = 'bg-blue-100 border-blue-400';
      
      const anyTaskDelayed = tasks.some(t => calculateDesvio(t) < -5);
      if (anyTaskDelayed) statusColor = 'bg-red-100 border-red-500';
    }

    return `
      <div class="${statusColor} p-4 rounded-xl shadow-lg border-l-4 ${statusColor.replace('bg-', 
    'border-')}" onclick="openOFDetails('${of.id}')">
        <h3 class="text-lg font-bold text-gray-800 mb-1 flex justify-between items-center">
          ${of.id}
          ${of.status === 'Conclu√≠do' ? '<i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>' : (nextTask ?
    '<i data-lucide="play-circle" class="w-5 h-5 text-blue-600"></i>' : '<i data-lucide="pause-circle" class="w-5 h-5 text-yellow-600"></i>')}
        </h3>
        <p class="text-sm text-gray-600 mb-3">${of.chicote} |
    Qtd: ${of.quantidade}</p>
        <div class="flex justify-between items-center mb-1">
          <span class="text-xs font-semibold text-gray-600">${progress}% Conclu√≠do</span>
          <span class="text-xs font-medium text-gray-500">${completed} / ${tasks.length} etapas</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-1.5">
          <div class="h-1.5 rounded-full bg-[var(--cor-primaria)]" style="width:${progress}%"></div>
        </div>
        <p class="text-xs mt-2 text-gray-700 font-medium">Pr√≥xima Etapa: ${nextTask ?
    nextTask.nome_atividade : (progress === 100 ? 'Finalizada (Aguardando Fechamento)' : 'N/A')}</p>
      </div>
    `;
  }).join('');

  container.innerHTML = ofsHtml || '<div class="p-4 text-center text-gray-500 bg-white rounded-lg shadow-md">Nenhuma OF ativa encontrada.</div>';
  lucide.createIcons();
}


function openOFDetails(ofId){
  const of = allOFs[ofId];
  if (!of) return;
  window.__ofDetailsOpenId = ofId;

  document.getElementById('of-details-title').textContent = `Detalhes OF ${of.id}`;
  document.getElementById('btn-delete-of').classList.toggle('hidden', !isMaster());
  
  const tasks = Object.values(allTasks).filter(t=> t.id_of === of.id).sort((a,b) => a.etapa - b.etapa);
  const completed = tasks.filter(t => t.status === 'Conclu√≠do').length;
  const progress = tasks.length > 0 ? Math.floor((completed / tasks.length) * 100) : 0;
  
  document.getElementById('of-details-progress').style.width = `${progress}%`;

  // C√°lculos de KPI de detalhe
  const tempoTotalPlanejado = tasks.reduce((s, t) => s + t.tempo_planejado, 0);
  const tempoTotalReal = tasks.reduce((s, t) => s + calculateTempoRealMinutes(t), 0);
  const totalDesvio = tempoTotalPlanejado - tempoTotalReal;

  const summaryData = [
    { title: "Chicote", value: of.chicote },
    { title: "Quantidade", value: of.quantidade },
    { title: "T. Planejado", value: formatMinutes(tempoTotalPlanejado) },
    { title: "Desvio", value: formatMinutes(totalDesvio), color: totalDesvio < 0 ? 'text-red-600' : 'text-green-600' },
  ];
  
  document.getElementById('of-details-summary').innerHTML = summaryData.map(d=> `
    <div class="bg-gray-50 p-3 rounded-lg border">
      <p class="text-xs text-gray-500 font-medium">${d.title}</p>
      <p class="text-base font-semibold ${d.color || 'text-gray-800'}">${d.value}</p>
    </div>
  `).join('');

  // Lista de tarefas
  const tasksHtml = tasks.map(task => {
    let statusColor = 'border-gray-300 bg-gray-50';
    let statusText = task.status;
    if (task.status === 'Em Espera') statusColor = 'border-blue-400 bg-blue-50';
    else if (task.status === 'Em Processo') statusColor = 'border-green-500 bg-green-100';
    else if (task.status === 'Pausada') statusColor = 'border-yellow-500 bg-yellow-100';
    else if (task.status === 'Conclu√≠do') statusColor = 'border-gray-500 bg-white';
    else if (task.status === 'Bloqueada') statusColor = 'border-red-500 bg-red-50';

    const real = calculateTempoRealMinutes(task);
    const desvio = calculateDesvio(task);
    
    return `
      <div class="border-l-4 ${statusColor} p-4 rounded-lg shadow-sm">
        <div class="flex justify-between items-center mb-1">
          <p class="font-bold text-gray-800 text-base">${task.etapa}. ${task.nome_atividade}</p>
          <span class="text-xs font-semibold px-2 py-1 rounded-full ${statusColor.replace('border-', 'bg-')}">${statusText}</span>
        </div>
        <p class="text-sm text-gray-600 mb-2">Setor: ${task.setor} | T. Planejado: ${formatMinutes(task.tempo_planejado)}</p>
        <div class="grid grid-cols-2 text-sm gap-y-1">
            <p>T. Real: <span class="font-semibold">${formatMinutes(real)}</span></p>
            <p>Desvio: <span class="font-semibold ${desvio < 0 ? 'text-red-600' : 'text-green-600'}">${formatMinutes(desvio)}</span></p>
            <p>Pausa: <span class="font-semibold">${formatMinutes(calculateTotalPauseMinutes(task))}</span></p>
        </div>
      </div>
    `;
  }).join('');
  
  document.getElementById('of-details-content').innerHTML = tasksHtml;
  openModal('of-details-modal');
  lucide.createIcons();
}

function renderTasks(){
  if (pcpView.classList.contains('hidden')) renderKPIs(); // Recalcula KPIs (que s√≥ s√£o exibidos no PCP)
  
  const container = document.getElementById('tasks-list-container');
  if (!container || !currentUser) return;

  let tasks = Object.values(allTasks).filter(t => 
    t.setor === currentSectorFilter && 
    t.status !== 'Conclu√≠do'
  ).sort((a,b) => (a.id_of + a.etapa) > (b.id_of + b.etapa) ? 1 : -1);

  // üîé filtro por OF na tela Operador
  if (operatorSearchOF) tasks = tasks.filter(t => (t.id_of || "").toUpperCase().includes(operatorSearchOF));
  
  const tasksHtml = tasks.map(task => {
    let statusColor = 'bg-gray-50 border-gray-300';
    let statusText = task.status;
    let actions = '';
    const totalPauseMinutes = calculateTotalPauseMinutes(task);
    const desvio = calculateDesvio(task);
    let desvioClass = desvio < 0 ? 'text-red-600' : 'text-green-600';
    
    if (task.status === 'Bloqueada'){
      statusColor = 'bg-red-50 border-red-500';
      statusText = 'Bloqueada (Etapa anterior pendente)';
      desvioClass = 'text-gray-500';
      actions = `<button disabled class="px-3 py-1.5 text-sm bg-red-400 text-white rounded-lg opacity-50">Bloqueada</button>`;
    } else if (task.status === 'Em Espera') {
      statusColor = 'bg-blue-50 border-blue-500';
      statusText = 'Em Espera';
      actions = `
        <button onclick="startTask('${task.id}')" class="px-3 py-1.5 text-sm bg-[var(--cor-primaria)] text-white rounded-lg hover:bg-[var(--cor-primaria-hover)]">Iniciar</button>
      `;
    } else if (task.status === 'Em Processo'){
      statusColor = 'bg-green-100 border-green-600';
      statusText = 'Em Processo';
      actions = `
        <button onclick="pauseTask('${task.id}')" class="px-3 py-1.5 text-sm bg-[var(--cor-alerta)] text-white rounded-lg hover:bg-[var(--cor-alerta-hover)]">Pausar</button>
        <button onclick="finishTask('${task.id}')" class="px-3 py-1.5 text-sm bg-[var(--cor-sucesso)] text-white rounded-lg hover:bg-[var(--cor-sucesso-hover)]">Concluir</button>`;
    } else if (task.status === 'Pausada'){
      statusColor = 'bg-yellow-100 border-yellow-500';
      statusText = 'Pausada';
      actions = `
        <button onclick="startTask('${task.id}')" class="px-3 py-1.5 text-sm bg-[var(--cor-primaria)] text-white rounded-lg hover:bg-[var(--cor-primaria-hover)]">Retomar</button>
        <button onclick="finishTask('${task.id}')" class="px-3 py-1.5 text-sm bg-[var(--cor-sucesso)] text-white rounded-lg hover:bg-[var(--cor-sucesso-hover)]">Concluir</button>`;
    }
    
    return `
      <div class="${statusColor} border p-3 sm:p-4 rounded-xl shadow">
        <div class="flex justify-between items-center mb-2">
          <div>
            <p class="text-sm font-bold text-gray-800">${task.nome_atividade} (${task.etapa})</p>
            <p class="text-xs text-gray-600">OF <span class="font-semibold">${task.id_of}</span> ‚Ä¢ Chicote ${task.chicote}</p>
          </div>
          <button class="p-2 rounded-lg hover:bg-gray-100" title="Instru√ß√£o de Trabalho" onclick="openInstructionModal('${task.id}')">
            <i data-lucide="book" class="w-5 h-5"></i>
          </button>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs sm:text-sm">
          <div><span class="text-gray-500">Setup:</span> <span class="font-semibold">${formatMinutes(task.tempo_setup)}</span></div>
          <div><span class="text-gray-500">Ciclo (min/p√ß):</span> <span class="font-semibold">${Number(task.tempo_ciclo).toFixed(2)}</span></div>
          <div><span class="text-gray-500">Planejado:</span> <span class="font-semibold">${formatMinutes(task.tempo_planejado)}</span></div>
          <div><span class="text-gray-500">Pausa:</span> <span class="font-semibold">${formatMinutes(totalPauseMinutes)}</span></div>
        </div>
        <div class="mt-2 flex justify-between items-center">
          <span class="text-xs font-semibold ${desvioClass}">Desvio: ${formatMinutes(desvio)}</span>
          <div class="flex gap-2">
            ${actions}
          </div>
        </div>
      </div>
    `;
  }).join('');

  container.innerHTML = tasksHtml || `<div class="p-4 text-center text-gray-500 bg-white rounded-lg shadow-md">Nenhuma tarefa ${operatorSearchOF ? `para OF ${operatorSearchOF}` : ''} encontrada no setor ${currentSectorFilter} ou voc√™ n√£o est√° logado como Operador.</div>`;
  lucide.createIcons();
}

function renderReport(){
  const tbody = document.getElementById('report-table-body');
  if (!tbody) return;

  // Filtra logs de pausa que n√£o t√™m tempo (Pausas rec√©m-criadas sem fim)
  const logsParaExibir = allOcurrencesLog.filter(l => l.TIPO === 'ATRASO' || (l.TIPO === 'PAUSA' && l.TEMPO_PAUSA > 0));

  const logs = logsParaExibir.map(l => `
    <tr>
      <td class="px-3 sm:px-6 py-2 sm:py-3 whitespace-nowrap">${l.id_of}</td>
      <td class="px-3 sm:px-6 py-2 sm:py-3 whitespace-nowrap">${l.chicote}</td>
      <td class="px-3 sm:px-6 py-2 sm:py-3 whitespace-nowrap">${l.nome_atividade}</td>
      <td class="px-3 sm:px-6 py-2 sm:py-3 whitespace-nowrap text-xs">${l.MOTIVO_PAUSA || '-'}</td>
      <td class="px-3 sm:px-6 py-2 sm:py-3 whitespace-nowrap text-xs">${l.MOTIVO_ATRASO || '-'}</td>
      <td class="px-3 sm:px-6 py-2 sm:py-3 whitespace-nowrap ${l.TEMPO_PAUSA > 0 ? 'font-semibold text-gray-800' : 'text-gray-500'}">${Number(l.TEMPO_PAUSA).toFixed(2)}</td>
      <td class="px-3 sm:px-6 py-2 sm:py-3 whitespace-nowrap ${l.TEMPO_ATRASO > 0 ? 'font-semibold text-red-600' : 'text-gray-500'}">${Number(l.TEMPO_ATRASO).toFixed(2)}</td>
    </tr>
  `).join('');

  tbody.innerHTML = logs || `<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Nenhum log de ocorr√™ncia encontrado.</td></tr>`;
}

function exportReportCSV(){
  const rows = [["OF","CHICOTE","ATIVIDADE","SETOR","TIPO","MOTIVO_PRINCIPAL","MOTIVO_DETALHE","T. PAUSA (min)","T. ATRASO (min)","TIMESTAMP"]];
  allOcurrencesLog.forEach(l => {
    // Garante que a data seja formatada corretamente
    const timestamp = l.timestamp ? (l.timestamp.toDate ? l.timestamp.toDate().toISOString() : new Date(l.timestamp).toISOString()) : '';

    rows.push([
      l.id_of, 
      l.chicote, 
      l.nome_atividade, 
      l.setor, 
      l.TIPO,
      l.justificativa_principal,
      l.justificativa_detalhe,
      Number(l.TEMPO_PAUSA).toFixed(2),
      Number(l.TEMPO_ATRASO).toFixed(2),
      timestamp
    ]);
  });
  downloadCSV(rows, `pcp_ocorrencias_${new Date().toISOString().slice(0,10)}.csv`);
}

function exportOFTasksCSV(ofId){
  const tasks = Object.values(allTasks).filter(t => t.id_of === ofId).sort((a,b) => a.etapa - b.etapa);
  const rows = [["OF","ATIVIDADE","SETOR","STATUS","SETUP(min)","CICLO(min/p√ß)","PLANEJADO(min)","REAL(min)","DESVIO(min)"]];
  tasks.forEach(t => {
    rows.push([
      t.id_of, 
      t.nome_atividade, 
      t.setor, 
      t.status, 
      Number(t.tempo_setup).toFixed(2), 
      Number(t.tempo_ciclo).toFixed(2), 
      Number(t.tempo_planejado).toFixed(2), 
      calculateTempoRealMinutes(t).toFixed(2), // CORRE√á√ÉO: Usa a fun√ß√£o que retorna minutos
      calculateDesvio(t).toFixed(2), 
    ]);
  });
  downloadCSV(rows, `of_${ofId}_tasks_${new Date().toISOString().slice(0,10)}.csv`);
}

function downloadCSV(rows, filename){
  const csvContent = rows.map(r => r.map(c=>`"${c}"`).join(",")).join("\n");
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  if (link.download !== undefined) { 
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
}

/* ============================
   BOOTSTRAP
   ============================ */
document.addEventListener('DOMContentLoaded', () => {
  initializeApp();
  setupSearchListeners();
  lucide.createIcons();
});

// Exposi√ß√£o global
window.startTask = startTask;
window.pauseTask = pauseTask;
window.finishTask = finishTask;
window.openOFDetails = openOFDetails;
window.openInstructionModal = openInstructionModal;
window.handleConfirmedAction = handleConfirmedAction;
window.openModal = openModal;
window.closeModal = closeModal;
window.createOF = createOF;
window.addRoteiroActivity = addRoteiroActivity;
window.deleteRoteiroActivity = deleteRoteiroActivity;
window.deleteOF = deleteOF;
window.updateView = updateView;
window.openUserModal = openUserModal;
window.confirmUser = confirmUser;
window.exportReportCSV = exportReportCSV;
window.exportOFTasksCSV = exportOFTasksCSV;
window.updateSectorFilter = updateSectorFilter;
window.clearReportLogs = clearReportLogs; // NOVO
</script>
</body>
</html>
