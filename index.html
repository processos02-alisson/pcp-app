<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PCP ‚Äì Controle de Produ√ß√£o (com Monte Carlo)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap");
    :root {
      color-scheme: light dark;
      --app-bg-color: #f3f4f6;
      --app-bg-image: none;
      /* Cores de Prioridade (Mantidas) */
      --cor-perigo: #dc2626;
      /* Vermelho */
      --cor-neutra: #3b82f6;
      /* Azul */
    }
    body {
      font-family: "Inter", sans-serif;
      background: var(--app-bg-color) fixed no-repeat center/cover;
      background-image: var(--app-bg-image);

      padding-left: max(env(safe-area-inset-left), 0px);
      padding-right: max(env(safe-area-inset-right), 0px);
    }
    
    /* CLASSES DE PRIORIDADE VISUAL (Operador) */
    .priority-high {
      border-left-width: 6px;
      border-left-color: var(--cor-perigo);
      background-color: #fef2f2; /* Fundo Vermelho Claro */
    }
    .priority-medium {
      border-left-width: 6px;
      border-left-color: var(--cor-neutra);
      background-color: #eff6ff; /* Fundo Azul Claro */
    }
    .priority-low {
      border-left-width: 6px;
      border-left-color: #d1d5db; /* Cinza */
    }
    
    /* Cor de fundo para OFs Conclu√≠das no Hist√≥rico */
    .of-concluida-card {
        background-color: #f0fdf4;
        /* Verde bem clarinho */
        border-left-color: #10b981;
        /* Verde esmeralda */
    }

    /* Estilo do Modal de IT (Melhoria Visual) */
    #instruction-modal .modal-panel {
        border-top: 8px solid #4f46e5;
        /* √çndigo */
    }

    .modal-fixed { position: fixed; inset: 0;
    }
    /* ATUALIZA√á√ÉO DO MODAL PANEL (CORRE√á√ÉO DE CLIQUE) */
    .modal-panel { 
        max-height: calc(100dvh - 2rem); 
        position: relative; /* Necess√°rio para o z-index funcionar */
        z-index: 100;       /* Garante que o painel fique acima de tudo */
    }
    .modal-body-scroll { overflow-y: auto; -webkit-overflow-scrolling: touch;
    }
    .sticky-footer { position: sticky; bottom: 0; background: white; padding-top: .5rem;
    }
    .highlight-red { color: #dc2626; font-weight: 600;
    }
    
    /* ===== IN√çCIO DA EDI√á√ÉO MONTE CARLO (CSS) ===== */
    /* Estilo para o Log de Auditoria do Master */
    .audit-log {
        background-color: #fdfdfd;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 16px;
        margin-top: 15px;
        font-family: monospace;
        font-size: 0.9em;
        line-height: 1.6;
        display: none;
        /* Come√ßa oculto */
    }
    .audit-log h4 {
        margin-top: 0;
        color: #9D2235;
        font-family: "Inter", sans-serif;
        font-size: 1.1em;
        font-weight: 600;
    }
    .audit-log strong, .audit-log pre strong {
        color: #000;
        background-color: #fff8e1;
        padding: 2px 4px;
        border-radius: 3px;
    }
    .audit-log pre {
        background-color: #f9f9f9;
        border: 1px dashed #ccc;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        white-space: pre-wrap;
    }
    /* ===== FIM DA EDI√á√ÉO MONTE CARLO (CSS) ===== */
    
    /* ===== IN√çCIO DA EDI√á√ÉO PRODU√á√ÉO PARCIAL (CSS) ===== */
    .task-progress-bar-container {
      width: 100%;
      background-color: #e5e7eb;
      border-radius: 9999px;
      height: 6px;
      overflow: hidden;
      margin-top: 4px;
    }
    .task-progress-bar-ok {
      background-color: #22c55e;
      /* Verde */
      height: 100%;
    }
    .task-progress-bar-nok {
      background-color: #ef4444;
      /* Vermelho */
      height: 100%;
    }
    /* ===== FIM DA EDI√á√ÉO PRODU√á√ÉO PARCIAL (CSS) ===== */

    @media (max-width: 640px){
      .modal-panel{ width:100vw!important;
        max-width:100vw!important; height:100dvh!important; max-height:100dvh!important; border-radius:0!important; margin:0!important; display:flex; flex-direction:column; }
      .card-tap-big{ padding:1rem;
      }
    }
  </style>
  <body class="min-h-screen bg-gray-100 antialiased">

  <header class="bg-gray-800 shadow-md p-3 sm:p-4 sticky top-0 z-10">
    <div class="max-w-7xl mx-auto flex justify-between items-center gap-2">
      <h1 class="text-2xl sm:text-3xl font-extrabold text-white flex items-center">
        <i data-lucide="factory" class="w-7 h-7 sm:w-8 sm:h-8 mr-2"></i>
        Controle de Produ√ß√£o
      </h1>
      <div class="flex gap-2 items-center">
        
        <button id="btn-profile"
                class="text-white bg-gray-700 hover:bg-gray-600 font-semibold py-2 px-3 rounded-lg shadow-md transition hidden"
                onclick="openUserModal()">
          <i data-lucide="user-cog" class="w-5 h-5 inline-block mr-1"></i>
          <span class="hidden sm:inline">Perfil</span>
        </button>

        <select id="user-view-select" onchange="updateView(this.value)"
                class="bg-gray-700 text-white text-xs sm:text-sm font-semibold py-2 px-2 rounded-lg transition hover:bg-gray-600 focus:ring-2 focus:ring-indigo-300">
          <option value="PCP">Vis√£o: PCP</option>
          <option value="Operador">Vis√£o: Operador</option>
          <option value="Relatorio">Vis√£o: Relat√≥rio</option>
          </select>

        <button onclick="openModal('create-of-modal')" id="btn-create-of"
                class="text-white bg-emerald-600 hover:bg-emerald-700 font-semibold py-2 px-3 rounded-lg shadow-md transition hidden">
          <i data-lucide="plus" class="w-5 h-5 inline-block mr-1"></i>
          <span class="hidden sm:inline">Criar OF</span>
        </button>
        
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-3 sm:p-6 lg:p-8">
    <div id="loading-indicator" class="flex flex-col items-center justify-center p-6 sm:p-12 bg-white rounded-xl border border-gray-300">
      <i data-lucide="loader-circle" class="w-8 h-8 sm:w-10 sm:h-10 text-gray-500 animate-spin"></i>
      <p class="mt-3 sm:mt-4 text-gray-600 font-semibold text-sm sm:text-base">Carregando dados e autenticando...</p>
    </div>

    <div id="pcp-view" class="space-y-4 sm:space-y-6 hidden">
      <h2 class="text-xl sm:text-2xl font-bold text-gray-800 border-b pb-2 mb-2 sm:mb-4 flex items-center">
        <i data-lucide="bar-chart-3" class="w-5 h-5 sm:w-6 sm:h-6 mr-2"></i>
        Painel PCP
      </h2>
      <div id="pcp-of-search-wrap" class="mb-2 hidden">
        <input id="pcp-of-search" type="text" placeholder="Pesquisar OF Ativa..."
               class="w-full sm:w-64 border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500">
      </div>
      
      <div id="kpis-container" class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-4"></div>

      <div id="workload-chart-container" class="bg-white p-4 sm:p-6 rounded-xl border border-gray-300 mb-4">
          <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-bold text-gray-800 flex items-center">
                  <i data-lucide="gauge" class="w-5 h-5 mr-2 text-indigo-600"></i> 
                  Carga de Trabalho (Top 5 Setores - P95)
              </h3>
              <button onclick="openChartModal()" class="px-3 py-1.5 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                   <i data-lucide="maximize-2" class="w-4 h-4 inline-block mr-1"></i>
                   Ver Todos
              </button>
          </div>
          
          <div class="h-64 sm:h-80 relative">
            <canvas id="workload-chart"></canvas>
          </div>
      </div>

      <div id="ofs-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-6"></div>
    </div>
    <div id="operator-view" class="space-y-4 sm:space-y-6 hidden">
      <div class="bg-white p-3 sm:p-4 rounded-xl border border-gray-300 mb-4 sm:mb-6 flex flex-col sm:flex-row items-center justify-between gap-3">
        <h2 class="text-lg sm:text-xl font-bold text-gray-800 flex items-center">
          <i data-lucide="clipboard-list" class="w-5 h-5 sm:w-6 sm:h-6 mr-2 text-gray-600"></i>
          Minhas Tarefas
        </h2>
        <div class="flex items-center gap-2 w-full sm:w-auto">
          <label for="sector-filter" class="text-xs sm:text-sm font-semibold text-gray-700 flex-shrink-0">Setor:</label>
          <select id="sector-filter" onchange="updateSectorFilter(this.value)"
                  class="p-2 border border-gray-300 rounded-lg bg-gray-50 focus:ring-indigo-500 focus:border-indigo-500 w-full sm:w-48"></select>
        </div>
        <div id="operator-of-search-wrap" class="flex items-center gap-2 w-full sm:w-auto hidden">
          <label class="text-xs sm:text-sm font-semibold text-gray-700 flex-shrink-0">OF:</label>
          <input id="operator-of-search" type="text" placeholder="Filtrar por OF..."
                 class="p-2 border border-gray-300 rounded-lg bg-gray-50 focus:ring-indigo-500 focus:border-indigo-500 w-full sm:w-48">
        </div>
      </div>
      <div id="tasks-list-container" class="space-y-3 sm:space-y-4"></div>
    </div>

    <div id="report-view" class="space-y-4 sm:space-y-6 hidden">
      <h2 class="text-xl sm:text-2xl font-bold text-gray-800 border-b pb-2 mb-2 sm:mb-4 flex items-center">
        <i data-lucide="file-text" class="w-5 h-5 sm:w-6 sm:h-6 mr-2 text-purple-600"></i>
        Relat√≥rio de Ocorr√™ncias (OFS Ativas)
      </h2>
      <div class="bg-white p-3 sm:p-4 rounded-xl border border-gray-300">
        <div class="flex justify-between items-center mb-3 sm:mb-4">
          <h3 class="text-base sm:text-xl font-semibold text-gray-700">Pausas & Atrasos</h3>
          <div class="flex gap-2">
            <button id="btn-delete-report" onclick="deleteSelectedOcorrencias()"
                    class="px-3 sm:px-4 py-2 bg-red-600 text-white text-sm sm:text-base font-semibold rounded-lg hover:bg-red-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled> 
              <i data-lucide="trash-2" class="w-4 h-4 sm:w-5 sm:h-5 inline-block mr-1"></i> 
              <span class="hidden sm:inline">Excluir Selecionados</span>
            </button>
            <button id="btn-export-report" onclick="exportReportCSV()"
                    class="px-3 sm:px-4 py-2 bg-indigo-600 text-white text-sm sm:text-base font-semibold rounded-lg hover:bg-indigo-700 transition">
              <i data-lucide="download" class="w-4 h-4 sm:w-5 sm:h-5 inline-block mr-1"></i> Exportar (CSV)
            </button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 text-xs sm:text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-2 sm:px-4 py-2 sm:py-3 text-center w-12">
                   <input type="checkbox" id="report-select-all" 
                         onclick="toggleSelectAllOcorrencias(this)"
                         class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                </th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">OF</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">CHICOTE</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">ATIVIDADE</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">MOTIVO PAUSA</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">MOTIVO ATRASO</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">T. PAUSA (min)</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">T. ATRASO (min)</th>
              </tr>
            </thead>
            <tbody id="report-table-body" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <div id="historico-view" class="space-y-4 sm:space-y-6 hidden">
        <h2 class="text-xl sm:text-2xl font-bold text-gray-800 border-b pb-2 mb-2 sm:mb-4 flex items-center">
            <i data-lucide="archive" class="w-5 h-5 sm:w-6 sm:h-6 mr-2 text-green-600"></i>
            Hist√≥rico de Ordens de Fabrica√ß√£o Conclu√≠das
        </h2>
        <div id="historico-search-wrap" class="mb-2 hidden">
            <input id="historico-of-search" type="text" placeholder="Pesquisar OF Conclu√≠da..."
                   class="w-full sm:w-64 border border-gray-300 rounded-lg p-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <div id="historico-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-6">
        </div>
    </div>
    
    <div id="admin-view" class="space-y-4 sm:space-y-6 hidden">
      <h2 class="text-xl sm:text-2xl font-bold text-gray-800 border-b pb-2 mb-2 sm:mb-4 flex items-center">
        <i data-lucide="shield-check" class="w-5 h-5 sm:w-6 sm:h-6 mr-2"></i>
        Painel de Administra√ß√£o (Master)
      </h2>

      <div class="bg-white p-4 sm:p-6 rounded-xl border border-gray-300">
        <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">Setup: Cadastro de Roteiros Mestres</h3>
        
        <div class="flex flex-col lg:flex-row gap-4">
            
            <div class="w-full lg:w-1/2">
                 <input type="text" id="roteiro-search-admin" placeholder="Buscar Roteiro por ID Base ou Nome..."
                       class="w-full border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500 mb-3">
                 <div id="roteiro-list-admin" class="space-y-4 h-[50vh] lg:h-[70vh] overflow-y-auto mb-4 p-2 border rounded-lg bg-gray-50 modal-body-scroll">
                    </div>
            </div>

            <div class="border-t lg:border-t-0 lg:border-l lg:pl-4 pt-4 lg:pt-0 space-y-4 lg:w-1/2">
                
                <h4 class="text-base sm:text-lg font-semibold text-gray-700 border-b pb-2">Nova Etapa (Rascunho):</h4>
                
                <div class="flex flex-col gap-3">
                    <input type="text" id="roteiro-id-base-admin" onchange="updateDraftInfo()" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="ID Base do Roteiro (Ex: 62.100.092)">
                    <input type="text" id="roteiro-chicote-name-admin" onchange="updateDraftInfo()" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Nome da Revis√£o (Ex: 62.100.092-REV1)">
                </div>

                <div class="bg-gray-100 p-4 rounded-lg space-y-3">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input type="text" id="roteiro-activity-name-admin" class="w-full sm:w-1/2 border border-gray-300 rounded-lg p-2" placeholder="Nome da Atividade">
                        <select id="roteiro-setor-admin" class="w-full sm:w-1/2 border border-gray-300 rounded-lg p-2"></select>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <input id="roteiro-is-setup-admin" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <label for="roteiro-is-setup-admin" class="text-sm font-medium text-gray-900">Esta √© uma tarefa de Setup / Prepara√ß√£o</label>
                    </div>
                    
                    <div>
                        <label for="roteiro-fadiga-perc" class="block text-sm font-medium text-gray-700 mb-1">Percentual de Toler√¢ncia/Fadiga (%)</label>
                        <input type="number" id="roteiro-fadiga-perc" min="0" step="0.1" value="15" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-red-500 focus:border-red-500" placeholder="Ex: 15 (para 15%)">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Par√¢metros de Tempo (em MINUTOS):</label>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" id="roteiro-media-ciclo-min" min="0" step="0.01" class="w-full border border-gray-300 rounded-lg p-2" placeholder="M√©dia Ciclo (min/p√ß)">
                            <input type="number" id="roteiro-desvio-ciclo-min" min="0" step="0.01" class="w-full border border-gray-300 rounded-lg p-2" placeholder="Desvio Padr√£o Ciclo (min)">
                            <input type="number" id="roteiro-media-setup-min" min="0" step="0.1" class="w-full border border-gray-300 rounded-lg p-2" placeholder="M√©dia Setup (min)">
                            <input type="number" id="roteiro-desvio-setup-min" min="0" step="0.1" class="w-full border border-gray-300 rounded-lg p-2" placeholder="Desvio Padr√£o Setup (min)">
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Use ponto (.) para decimais. Ex: 0.5 para 30 segundos.</p>
                    </div>
                    
                    <div>
                        <label for="roteiro-instruction-text-admin" class="block text-sm font-medium text-gray-700 mb-1">Instru√ß√£o de Trabalho:</label>
                        <textarea id="roteiro-instruction-text-admin" rows="4" class="w-full border border-gray-300 rounded-lg p-2" placeholder="Instru√ß√µes. Use URLs diretas (terminadas em .jpg, .png, etc.) ou links do YouTube para inserir m√≠dia."></textarea>
                    </div>
                    
                    <button onclick="addEtapaToDraft()" class="p-2 w-full bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        <i data-lucide="list-plus" class="w-5 h-5 inline-block mr-1"></i> Adicionar √† Lista (Rascunho)
                    </button>
                    <div id="draft-etapa-message" class="text-sm text-red-500 mt-2"></div>
                </div>


                <div id="roteiro-draft-container" class="border border-dashed border-gray-400 p-3 rounded-lg bg-yellow-50">
                    <h5 class="font-bold text-gray-800 mb-2">Rascunho Atual: <span id="draft-info">Nenhum produto selecionado</span></h5>
                    <div id="roteiro-draft-list" class="space-y-2 max-h-40 overflow-y-auto">
                        <p class="text-sm text-gray-500 text-center">Adicione etapas acima para iniciar o roteiro.</p>
                    </div>
                    
                    <div class="mt-4 flex justify-between gap-2">
                        <button onclick="clearDraft()" class="px-3 py-1.5 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition">
                            Limpar Rascunho
                        </button>
                        <button onclick="saveRoteiroFromDraft()" id="btn-save-roteiro-draft" class="p-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition" disabled>
                            <i data-lucide="save" class="w-5 h-5 inline-block mr-1"></i> Salvar Roteiro (Gerar NOVA REV)
                        </button>
                    </div>
                    <div id="roteiro-message-admin" class="text-sm text-red-500 mt-2"></div>
                </div>

            </div>
        </div>
      </div>
      
      <div id="user-management-container" class="bg-white p-4 sm:p-6 rounded-xl border border-gray-300 hidden">
         <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">Gerenciamento de Usu√°rios (Fase 2)</h3>
         <p>A interface de cria√ß√£o de usu√°rios (Firebase Auth) aparecer√° aqui.</p>
      </div>
    </div>
  </main>
<div id="of-details-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal('of-details-modal')">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-3xl modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-2">
        <h3 id="of-details-title" class="text-xl sm:text-2xl font-bold text-gray-800"></h3>
        <button class="p-2 rounded-lg hover:bg-gray-100" onclick="closeModal('of-details-modal')"><i data-lucide="x" class="w-6 h-6"></i></button>
      </div>
      <div id="of-details-summary" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3 sm:mb-4"></div>
      <div class="w-full bg-gray-200 rounded-full h-2 mb-3 sm:mb-4"><div id="of-details-progress" class="h-2 rounded-full bg-blue-500" style="width:0%"></div></div>
      <div id="of-details-content" class="max-h-[60vh] overflow-y-auto space-y-3 sm:space-y-4 modal-body-scroll">
        </div>
      <div class="mt-4 sm:mt-5 flex justify-between gap-3 sticky-footer">
        
         <button id="btn-delete-of" class="px-3 sm:px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition hidden" onclick="deleteOF(window.__ofDetailsOpenId)">
          <i data-lucide="trash-2" class="w-4 h-4 sm:w-5 sm:h-5 inline-block mr-1"></i> Excluir OF
        </button>
        <div class="flex gap-2 sm:gap-3">
          <button id="btn-export-of" class="px-3 sm:px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition" onclick="exportOFTasksCSV(window.__ofDetailsOpenId)">Exportar CSV</button>
          <button class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition" onclick="closeModal('of-details-modal')">Fechar</button>
        </div>
      </div>
    </div>
  </div>
  
  <div id="chart-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal('chart-modal')">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-5xl modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">Carga de Trabalho Completa</h3>
      <div class="max-h-[75vh] overflow-y-auto pr-2">
        <div class="h-[60vh] sm:h-[70vh] relative">
          <canvas id="workload-chart-full"></canvas>
        </div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end">
        <button onclick="closeModal('chart-modal')" class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition">Fechar</button>
      </div>
    </div>
  </div>

  
  <div id="action-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal()">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-md modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <h3 id="modal-title" class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2"></h3>
      <div class="modal-body-scroll">
        <p id="modal-message" class="text-gray-600 mb-3 sm:mb-4"></p>
        <div id="modal-content">
          <div id="justification-area" class="space-y-3 sm:space-y-4">
            <label for="justification-select" class="block text-sm font-medium text-gray-700">Selecione o Motivo Principal:</label>
            <select id="justification-select" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-indigo-500 focus:border-indigo-500 transition">
              <option value="">-- Selecione uma op√ß√£o --</option>
            </select>
            <label for="justification-text" class="block text-sm font-medium text-gray-700">Detalhes Adicionais (Opcional):</label>
            <textarea id="justification-text" rows="2" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder=""></textarea>
            <p id="justification-required-text" class="text-sm text-red-500 hidden font-semibold">üö® Campo obrigat√≥rio!</p>
          </div>
        </div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end gap-2 sm:gap-3 sticky-footer">
        <button onclick="closeModal()" class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition">Cancelar</button>
        <button id="modal-confirm-button" class="px-3 sm:px-4 py-2 bg-gray-700 text-white font-semibold rounded-lg hover:bg-gray-600 transition" onclick="handleConfirmedAction()">Confirmar</button>
      </div>
    </div>
  </div>
 
  
  <div id="report-production-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal('report-production-modal')">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-lg modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <h3 id="report-modal-title" class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">Reportar Produ√ß√£o</h3>
      <div class="modal-body-scroll">
        <p id="report-modal-message" class="text-gray-600 mb-3 sm:mb-4"></p>
        
        <div class="space-y-4">
          <div>
           
            <label for="report-qty-ok" class="block text-sm font-medium text-gray-700">Pe√ßas Boas (OK) *desta sess√£o*:</label>
            <input type="number" id="report-qty-ok" min="0" value="0" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          <div>
            <label for="report-qty-nok" class="block text-sm font-medium text-gray-700">Pe√ßas com Defeito (NOK) *desta sess√£o*:</label>
            <input type="number" id="report-qty-nok" min="0" value="0" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-red-500 focus:border-red-500">
          </div>
          
          <fieldset>
            <legend class="block text-sm font-medium text-gray-700">Pr√≥ximo Status:</legend>
            <div class="mt-2 space-y-2">
              <div class="flex items-center">
                <input id="report-status-pause" name="report-status" type="radio" value="Pausada" checked class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                <label for="report-status-pause" class="ml-3 block text-sm font-medium text-gray-700">Pausar (Ex: Fim de Turno, Parcial)</label>
              </div>
              <div class="flex items-center">
                <input id="report-status-finish" name="report-status" type="radio" value="Conclu√≠do" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                <label for="report-status-finish" class="ml-3 block text-sm font-medium text-gray-700">Finalizar Tarefa (Esta etapa acabou)</label>
              </div>
            </div>
          </fieldset>
          
          <div id="report-modal-error" class="text-sm text-red-500 hidden"></div>
        </div>
        
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end gap-2 sm:gap-3 sticky-footer">
        <button onclick="closeModal('report-production-modal')" class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition">Cancelar</button>
        <button id="modal-report-confirm-button" class="px-3 sm:px-4 py-2 bg-emerald-600 text-white font-semibold rounded-lg hover:bg-emerald-700 transition" onclick="handleReportProduction()">
          <i data-lucide="save" class="w-5 h-5 inline-block mr-1"></i>
          Salvar Reporte
        </button>
      </div>
    </div>
  </div>
  
  <div id="instruction-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal('instruction-modal')">
    <div class="bg-white rounded-xl shadow-2xl p-5 sm:p-8 w-full max-w-2xl modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2 flex items-center">
        <i data-lucide="book-open-text" class="w-5 h-5 sm:w-6 sm:h-6 mr-2 text-indigo-600"></i> Instru√ß√£o de Trabalho
      </h3>
      <div class="max-h-[65vh] sm:max-h-[70vh] overflow-y-auto pr-1 sm:pr-2 modal-body-scroll">
        <p class="text-sm font-semibold text-gray-700 mb-2" id="instruction-modal-header"></p>
        <div id="instruction-modal-content" class="text-gray-700 space-y-3"></div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end">
        <button onclick="closeModal('instruction-modal')" class="px-3 sm:px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition">Fechar</button>
      </div>
    </div>
  </div>

  <div id="create-of-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal()">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-lg modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">Criar Nova Ordem de Fabrica√ß√£o (OF)</h3>
      <div class="space-y-3 sm:space-y-4 modal-body-scroll">
       
        <div>
          <label for="of-id" class="block text-sm font-medium text-gray-700">C√≥digo da OF:</label>
          <input type="text" id="of-id" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: OF-003">
        </div>
        <div>
          <label for="of-quantity" class="block text-sm font-medium text-gray-700">Quantidade de Pe√ßas:</label>
          <input type="number" id="of-quantity" min="1" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: 50">
        </div>
        <div>
          <label for="of-chicote" class="block text-sm font-medium text-gray-700">Modelo do Chicote (√öltima Revis√£o Ativa):</label>
          <select id="of-chicote" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-indigo-500 focus:border-indigo-500">
            <option value="">Carregando roteiros...</option>
          </select>
        </div>
        
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label for="of-priority" class="block text-sm font-medium text-gray-700">Prioridade:</label>
            <select id="of-priority" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-indigo-500 focus:border-indigo-500">
              <option value="Media">M√©dia (Padr√£o)</option>
              <option value="Alta">Alta (Urgente)</option>
              <option value="Baixa">Baixa</option>
            </select>
          </div>
          <div>
             <label for="of-percentil" class="block text-sm font-medium text-gray-700">N√≠vel Confian√ßa (MC):</label>
             <select id="of-percentil" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-indigo-500 focus:border-indigo-500">
                <option value="0.95">95% (Conservador)</option>
                <option value="0.90">90%</option>
                <option value="0.85">85%</option>
             </select>
          </div>
        </div>
        
        <div id="of-creation-message" class="text-sm text-red-500 hidden"></div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end gap-2 sm:gap-3 sticky-footer">
        <button onclick="closeModal('create-of-modal')" class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition">Cancelar</button>
        <button onclick="createOF()" class="px-3 sm:px-4 py-2 bg-emerald-600 text-white font-semibold rounded-lg hover:bg-emerald-700">
          <i data-lucide="factory" class="w-5 h-5 inline-block mr-1"></i> Gerar OF
        </button>
      </div>
    </div>
  </div>

  <div id="user-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="event.stopPropagation()">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-md modal-panel mx-0 sm:mx-4">
      <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">Acesso</h3>
      <div class="space-y-3 sm:space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Perfil</label>
          <select id="user-role" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-indigo-500 focus:border-indigo-500">
            <option value="OPERADOR">Operador</option>
            <option value="MASTER">Master</option>
          </select>
        </div>
        <div id="user-sector-wrap">
          <label class="block text-sm font-medium text-gray-700">Setor do Operador</label>
          <select id="user-sector" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-indigo-500 focus:border-indigo-500"></select>
        </div>
        <div id="user-pin-wrap" class="hidden">
          <label class="block text-sm font-medium text-gray-700">PIN do Master</label>
          <input type="password" id="user-pin" class="w-full border border-gray-300 rounded-lg p-2 mt-1" placeholder="****">
          <p class="text-xs text-gray-500 mt-1">Apenas numeros</p>
        </div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end gap-2 sm:gap-3">
        <button class="px-3 sm:px-4 py-2 bg-gray-200 rounded-lg font-semibold hover:bg-gray-300" onclick="closeModal('user-modal')">Cancelar</button>
        <button class="px-3 sm:px-4 py-2 bg-gray-700 text-white rounded-lg font-semibold hover:bg-gray-600" onclick="confirmUser()">Entrar</button>
      </div>
    </div>
  </div>
    <script>
/* ============================
  FIREBASE CONFIG
  ============================ */
const firebaseConfig = {
  apiKey: "AIzaSyDIJJIe4WIVj5OKYTtR-HQscrxIzxNK9eY",
  authDomain: "pcp-app-24c56.firebaseapp.com",
  projectId: "pcp-app-24c56",
  storageBucket: "pcp-app-24c56.firebasestorage.app",
  messagingSenderId: "675295958467",
  appId: "1:675295958467:web:9d79700af6fc1c28db5976",
  measurementId: "G-DH06WDCKJY"
};
// Inicializa√ß√£o Firebase
if (firebaseConfig && firebaseConfig.projectId && firebaseConfig.projectId !== "SEU_PROJECT_ID") {
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();
  window.db = db;
  window.storage = storage;

  // Cole√ß√µes
  const OF_COLLECTION = 'ofs';
  const TASK_COLLECTION = 'tasks';
  const ROTEIRO_COLLECTION = 'roteiros';
  const OCORRENCIA_COLLECTION = 'ocorrencias';
  window.OF_COLLECTION = OF_COLLECTION;
  window.TASK_COLLECTION = TASK_COLLECTION;
  window.ROTEIRO_COLLECTION = ROTEIRO_COLLECTION;
  window.OCORRENCIA_COLLECTION = OCORRENCIA_COLLECTION;
} else {
  console.warn("Firebase n√£o configurado ‚Äî rodando em modo simulado.");
  window.db = null;
  window.storage = null;
}

/* ============================
  CONSTANTES & ESTADO
  ============================ */
const MASTER_PIN = "7889";
const SECTORS = [
  'Corte','Corte de Revestimentos','Pr√©-Montagem','Prepara√ß√£o','Pr√© Conex√£o','Solda',
  'Conex√£o','Pr√© Grampea√ß√£o','Grampea√ß√£o','Acabamento','Embalagem','Montagem','Cabo de Bateria 1','Cabo de Bateria 2'
];
// ===== IN√çCIO DA EDI√á√ÉO PRODU√á√ÉO PARCIAL (Motivos Pausa) =====
const PAUSE_REASONS = [
  "Fim de Turno / Salvar Parcial", 
  "Falta de material na bancada",
  "Manuten√ß√£o/Ajuste de m√°quina",
  "Instru√ß√£o de trabalho confusa/ausente",
  "Necessidade de assist√™ncia t√©cnica",
  "Troca de turno/intervalo programado",
  "Retrabalho / Ajuste de Qualidade", 
  "Almo√ßo / Pausa Programada", 
  "Outro (Detalhar abaixo)"
];
const DELAY_REASONS = [
  "Complexidade inesperada da pe√ßa",
  "Problema de qualidade na etapa anterior",
  "Falta de treinamento/experi√™ncia",
  "Tempo padr√£o calculado incorretamente",
  "Quebra/defeito de ferramenta",
  "Outro (Detalhar abaixo)"
];
// ===== FIM DA EDI√á√ÉO PRODU√á√ÉO PARCIAL =====

let allOFs = {};
let allTasks = {};
let allRoteiros = {};
let allOcurrencesLog = [];
let currentAction = {};
let currentSectorFilter = SECTORS[0];
let currentUser = null;
// Refer√™ncia do Gr√°fico
let workloadChart = null;
let workloadChartFull = null; // NOVO: Gr√°fico Completo

// Busca por OF nas telas
let pcpSearchOF = "";
let operatorSearchOF = "";
let historicoSearchOF = "";
let roteiroSearchTerm = ""; // <-- NOVO: Filtro Roteiro

// Vari√°veis de Rascunho do Roteiro (NOVO FLUXO)
let roteiroDraftTasks = []; 
let roteiroDraftIdBase = "";
let roteiroDraftChicoteName = "";

// Simula√ß√£o
let taskCounter = 1;
let roteiroCounter = 7;
// ===== MUDAN√áA MONTE CARLO (Defaults com REV e Fadiga) =====
const DEFAULT_ROTEIROS = {
  // Roteiro CHICOTE-001 (REV 1)
  "r1": { id:"r1", chicote_nome:"CHICOTE-001-REV1", roteiro_id_base: "CHICOTE-001", revisao_number: 1, setor:"Corte", nome_atividade:"Setup Corte", is_setup_task: true,
    media_setup_min: 5.0, desvio_setup_min: 1.0, 
    media_ciclo_min: 0, desvio_ciclo_min: 0, fator_fadiga_perc: 15,
    instrucao_trabalho:"<b>1. Prepara√ß√£o:</b> Verifique a faca..."
  },
  "r2": { id:"r2", chicote_nome:"CHICOTE-001-REV1", roteiro_id_base: "CHICOTE-001", revisao_number: 1, setor:"Corte", nome_atividade:"Corte dos Fios", is_setup_task: false,
    media_setup_min: 0, desvio_setup_min: 0, 
    media_ciclo_min: 0.2, desvio_ciclo_min: 0.05, fator_fadiga_perc: 15, // 12s ¬± 3s
    instrucao_trabalho:"<b>1. Medi√ß√£o:</b> Corte 50 pe√ßas de 150mm.<br><b>2. Confer√™ncia:</b> Visual."
  },
  "r3": { id:"r3", chicote_nome:"CHICOTE-001-REV1", roteiro_id_base: "CHICOTE-001", revisao_number: 1, setor:"Pr√©-Montagem", nome_atividade:"Crimpagem de Terminais", is_setup_task: false,
    media_setup_min: 8.0, desvio_setup_min: 2.0, // Setup da Crimpagem (incluso na tarefa)
    media_ciclo_min: 0.5, desvio_ciclo_min: 0.1, fator_fadiga_perc: 15,
    instrucao_trabalho:"<b>Fio Preto:</b> ...<br><b>Fio Vermelho:</b> ...<br><b>Teste:</b> > 10Kgf."
  },
  // Roteiro CHICOTE-B (REV 1)
  "r4": { id:"r4", chicote_nome:"CHICOTE-B-REV1", roteiro_id_base: "CHICOTE-B", revisao_number: 1, setor:"Corte", nome_atividade:"Corte Refor√ßado", is_setup_task: false,
    media_setup_min: 10.0, desvio_setup_min: 1.5,
    media_ciclo_min: 0.3, desvio_ciclo_min: 0.05, fator_fadiga_perc: 15,
    instrucao_trabalho:"Instru√ß√£o b√°sica B."
  },
};
/* ============================
  ELEMENTOS UI
  ============================ */
const pcpView = document.getElementById("pcp-view");
const operatorView = document.getElementById("operator-view");
const reportView = document.getElementById("report-view");
const adminView = document.getElementById("admin-view"); 
const historicoView = document.getElementById("historico-view");
const loadingIndicator = document.getElementById("loading-indicator");
const ofsListContainer = document.getElementById("ofs-list-container");
const tasksListContainer = document.getElementById("tasks-list-container");
const userViewSelect = document.getElementById("user-view-select");
const btnCreateOF = document.getElementById("btn-create-of");
const btnProfile = document.getElementById("btn-profile");
const btnExportReport = document.getElementById("btn-export-report");
const btnDeleteOF = document.getElementById("btn-delete-of");

/* ============================
  HELPERS & PERMISS√ïES
  ============================ */
function msToMinutes(ms){ if (typeof ms !== 'number' || ms < 0) return 0;
  return parseFloat((ms / (1000*60)).toFixed(2)); }
function formatMinutes(v){ return `${Number(v||0).toFixed(2)} min`; }
function formatDate(d) {
    if (!d) return '-';
    const date = d instanceof Date ? d : new Date(getDBTimestamp(d));
    return date.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
}

function formatSecondsToHMS(totalSegundos) {
    const horas = Math.floor(totalSegundos / 3600);
    const restoHoras = totalSegundos % 3600;
    const minutos = Math.floor(restoHoras / 60);
    const segundos = restoHoras % 60;
    const hFormat = String(horas).padStart(2, '0');
    const mFormat = String(minutos).padStart(2, '0');
    const sFormat = segundos.toFixed(0).padStart(2, '0');
    return `${hFormat}:${mFormat}:${sFormat}`;
}


function setUser(u){
  currentUser = u;
  try { sessionStorage.setItem("pcp_current_user", JSON.stringify(u));
  } catch(_){}
}
function getUser(){
  try { return JSON.parse(sessionStorage.getItem("pcp_current_user") || "null");
  }
  catch(e){ return null;
  }
}
function clearUser(){ try{ sessionStorage.removeItem("pcp_current_user");
}catch(_){} currentUser=null; }

function isMaster(){ return currentUser && currentUser.role === "MASTER";
}
function isOperador(){ return currentUser && currentUser.role === "OPERADOR";
}

function getDBTimestamp(ts) {
  if (!ts) return null;
  if (typeof ts.toDate === 'function') return ts.toDate().getTime();
  if (ts instanceof Date) return ts.getTime();
  return ts;
}

/* Helper visual de Prioridade */
function getPriorityClass(priority) {
  if (priority === 'Alta') return 'priority-high';
  if (priority === 'Baixa') return 'priority-low';
  return 'priority-medium'; // Padr√£o √© M√©dia
}

/* Helper para ordenar setores baseados na lista mestre */
function getSortedSectors(sectors) {
    const sorted = [];
    // Garante que a ordem segue o SECTORS global
    SECTORS.forEach(s => {
        if (sectors.includes(s)) sorted.push(s);
    });
    // Adiciona quaisquer setores n√£o padr√£o no final (para roteiros legados)
    sectors.forEach(s => {
        if (!sorted.includes(s) && s !== 'N√ÉO_DEFINIDO') sorted.push(s);
    });
    return sorted;
}


/* ============================
  THEME (Simplificado)
  ============================ */
function listenTheme(){
  if (!window.db) return;
  db.collection('settings').doc('ui').onSnapshot(doc=>{
    const s = doc.exists ? doc.data() : null;
    applyTheme(s);
  });
}
function applyTheme(s){
  const r = document.documentElement.style;
  const defaultColor = '#f3f4f6';
  if (!s || s.mode === 'color'){
    r.setProperty('--app-bg-color', s?.color || defaultColor);
    r.setProperty('--app-bg-image', 'none');
  } else {
    r.setProperty('--app-bg-color', '#000000');
    r.setProperty('--app-bg-image', `url("${s.imageUrl}")`);
  }
}

/* ============================
  FUN√á√ïES DE SIMULA√á√ÉO MONTE CARLO
  ============================ */
let __mc_z1 = null;
let __mc_useLast = false;
function gaussianRandom() {
    if (__mc_useLast) { __mc_useLast = false; return __mc_z1;
    }
    let u = 0, v = 0;
    while (u === 0) u = Math.random();
    while (v === 0) v = Math.random();
    const z0 = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
    __mc_z1 = Math.sqrt(-2.0 * Math.log(u)) * Math.sin(2.0 * Math.PI * v);
    __mc_useLast = true;
    return z0;
}

function rodarSimulacao(media, desvio, nSimulacoes, percentil) {
    const resultadosSimulacao = [];
    for (let i = 0; i < nSimulacoes; i++) {
        const tempoSimulado = (gaussianRandom() * desvio) + media;
        resultadosSimulacao.push(Math.max(0.0, tempoSimulado));
    }
    resultadosSimulacao.sort((a, b) => a - b);
    const indice = Math.ceil(percentil * nSimulacoes) - 1;
    return resultadosSimulacao[indice];
}

class MonteCarloCalculator {
    constructor() {
        this.etapas = [];
        this.numeroSimulacoes = 50000;
        this.auditLog = "";
    }

    addEtapa(etapa) {
        // Aplica o Fator de Fadiga no C√°lculo de Tempo Padr√£o
        const fatorFadiga = 1 + ((etapa.fator_fadiga_perc || 0) / 100); 
        
        const etapaSeg = {
            nome: etapa.nome_atividade,
            // Ciclo: Aplica Fadiga na M√©dia e Desvio
            mediaCicloSeg: (etapa.media_ciclo_min || 0) * 60 * fatorFadiga,
            desvioCicloSeg: (etapa.desvio_ciclo_min || 0) * 60 * fatorFadiga,
            
            // Setup: Aplica Fadiga na M√©dia e Desvio
            mediaSetupSeg: (etapa.media_setup_min || 0) * 60 * fatorFadiga,
            desvioSetupSeg: (etapa.desvio_setup_min || 0) * 60 * fatorFadiga,
            
            is_setup_task: etapa.is_setup_task || false 
        };
        this.etapas.push(etapaSeg);
    }

    runSimulation(quantidade, percentil) {
        if (this.etapas.length === 0) {
            return { totalMediaSeg: 0, totalConfiavelSeg: 0, totalDesvioSeg: 0, auditLog: "" };
        }
        
        __mc_z1 = null;
        __mc_useLast = false;

        let totalMediaOF_Seg = 0;
        let totalVarianciaOF_Seg = 0;
        this.auditLog = `<h3>1. Consolida√ß√£o por Etapa (Lote de ${quantidade})</h3>`;
        for (const etapa of this.etapas) {
            
            // Se for tarefa de setup, a quantidade √© ignorada no c√°lculo do ciclo (√© 0)
            const mediaCicloEtapa = etapa.is_setup_task ? 0 : (etapa.mediaCicloSeg * quantidade);
            const varianciaCicloEtapa = etapa.is_setup_task ? 0 : (Math.pow(etapa.desvioCicloSeg, 2) * quantidade);

            const mediaEtapaLoteSeg = mediaCicloEtapa + etapa.mediaSetupSeg;
            const varianciaSetupSeg = Math.pow(etapa.desvioSetupSeg, 2);
            const varianciaEtapaLoteSeg = varianciaCicloEtapa + varianciaSetupSeg;
            
            totalMediaOF_Seg += mediaEtapaLoteSeg;
            totalVarianciaOF_Seg += varianciaEtapaLoteSeg;
            this.auditLog += `
                <pre><strong>Etapa: ${etapa.nome}</strong> ${etapa.is_setup_task ? '(SETUP)' : ''}
Media = (${(etapa.mediaCicloSeg/(quantidade>0?quantidade:1)/60).toFixed(2)} min * ${etapa.is_setup_task ? 0 : quantidade}) + ${(etapa.mediaSetupSeg/60).toFixed(2)} min = <strong>${(mediaEtapaLoteSeg/60).toFixed(2)} min</strong>
Var. = (${(etapa.desvioCicloSeg/(Math.sqrt(quantidade>0?quantidade:1))).toFixed(1)}s¬≤ * ${etapa.is_setup_task ? 0 : quantidade}) + ${etapa.desvioSetupSeg.toFixed(1)}s¬≤ = <strong>${varianciaEtapaLoteSeg.toFixed(2)}</strong></pre>
            `;
        }

        const totalDesvioOF_Seg = Math.sqrt(totalVarianciaOF_Seg);
        if (isNaN(totalDesvioOF_Seg) || totalDesvioOF_Seg === 0) {
            this.auditLog += "<h3>2. Par√¢metros Totais</h3><p>Nenhuma variabilidade detectada (Desvio Padr√£o = 0).</p>";
            return {
                totalMediaSeg: totalMediaOF_Seg,
                totalConfiavelSeg: totalMediaOF_Seg,
                totalDesvioSeg: 0,
                auditLog: this.auditLog
            };
        }

        const tempoConfiavelTotalSeg = rodarSimulacao(totalMediaOF_Seg, totalDesvioOF_Seg, this.numeroSimulacoes, percentil);
        this.auditLog += `
            <h3>2. Par√¢metros Totais da OF</h3>
            <p>M√©dia Total (P50) = <strong>${totalMediaOF_Seg.toFixed(3)} seg</strong></p>
            <p>Vari√¢ncia Total = <strong>${totalVarianciaOF_Seg.toFixed(3)}</strong></p>
            <p>Desvio Padr√£o Total = &radic;Vari√¢ncia = <strong>${totalDesvioOF_Seg.toFixed(3)} seg</strong></p>
            <br>
            <h3>3. Resultado da Simula√ß√£o (P${percentil * 100})</h3>
            <p>Tempo Confi√°vel (P${percentil * 100}) = <strong>${tempoConfiavelTotalSeg.toFixed(3)} seg</strong></p>
        `;
        return {
            totalMediaSeg: totalMediaOF_Seg,
            totalConfiavelSeg: tempoConfiavelTotalSeg,
            totalDesvioSeg: totalDesvioOF_Seg,
            auditLog: this.auditLog
        };
    }
}

/* ============================
  C√ÅLCULOS DE TEMPO
  ============================ */
  
// Fun√ß√£o para obter o valor acumulado em milissegundos
function calculateTempoRealMs(task){
  if (task.status === 'Conclu√≠do' || task.status === 'Em Espera' || 
      task.status === 'Pausada' || task.status === 'Setup Pausado' || task.status === 'Produ√ß√£o Pausada') { // <-- NOVOS STATUS
    return task.tempo_real_acumulado_ms || 0;
  }
  
  const now = Date.now();
  let tempoAcumulado = task.tempo_real_acumulado_ms || 0; 
  let ultimaAtividade = getDBTimestamp(task.timestamp_inicio);
  // timestamp_inicio √© o "play" mais recente

  if (!ultimaAtividade) return tempoAcumulado;
  // <-- NOVOS STATUS
  if (task.status === 'Em Processo' || task.status === 'Em Setup' || task.status === 'Em Produ√ß√£o'){
    tempoAcumulado += (now - ultimaAtividade);
  }
  
  return tempoAcumulado;
}

// Fun√ß√µes que retornam minutos
function calculateTempoRealMinutes(task){
  if (task.status === 'Conclu√≠do') {
      return msToMinutes(task.tempo_real_acumulado_ms || 0);
  }
  return msToMinutes(calculateTempoRealMs(task));
}

// O desvio agora √© calculado contra o tempo CONFI√ÅVEL (P95), que √© a nova "meta".
function calculateDesvio(task){
  const realMinutes = calculateTempoRealMinutes(task); 
  const planned = task.tempo_planejado_p95_min || task.tempo_planejado_p50_min || 0;
  
  // Para tarefas de produ√ß√£o n√£o conclu√≠das, o desvio √© (Planejado - Pace Realizado)
  return parseFloat((planned - realMinutes).toFixed(2));
}

function calculateTotalPauseMinutes(task){
  let totalMs = task.total_pause_time_ms || 0;
  // <-- NOVOS STATUS
  if ((task.status === 'Pausada' || task.status === 'Setup Pausado' || task.status === 'Produ√ß√£o Pausada') && task.pause_start_timestamp){
    totalMs += (Date.now() - getDBTimestamp(task.pause_start_timestamp));
  }
  return msToMinutes(totalMs);
}

function calculateTotalPauseMinutesFinal(task){ 
  return msToMinutes(task.total_pause_time_ms || 0);
}


/* ============================
  INICIALIZA√á√ÉO & LISTENERS
  ============================ */
function setupSectorDropdowns(){
  const roteiroSetorSelect = document.getElementById('roteiro-setor-admin');
  const userSectorSelect = document.getElementById('user-sector');
  const sectorFilterSelect = document.getElementById('sector-filter');
  
  [roteiroSetorSelect, sectorFilterSelect, userSectorSelect].forEach(sel => { if (sel) sel.innerHTML = ''; });
  SECTORS.forEach(sector=>{
    const o1 = document.createElement('option'); o1.value=sector; o1.textContent=sector;
    const o2 = o1.cloneNode(true);
    const o3 = o1.cloneNode(true);
    if (roteiroSetorSelect) roteiroSetorSelect.appendChild(o1);
    if (userSectorSelect) userSectorSelect.appendChild(o2);
  });
  if (sectorFilterSelect){
    if (isOperador()){
      const o = document.createElement('option');
      o.value=currentUser.sector; o.textContent=currentUser.sector; sectorFilterSelect.appendChild(o);
      sectorFilterSelect.value=currentUser.sector;
      sectorFilterSelect.disabled = true;
      currentSectorFilter = currentUser.sector;
    } else {
      SECTORS.forEach(sector=>{
        const o2 = document.createElement('option'); o2.value=sector; o2.textContent=sector; sectorFilterSelect.appendChild(o2);
      });
      currentSectorFilter = SECTORS[0];
      sectorFilterSelect.value = SECTORS[0];
      sectorFilterSelect.disabled = false;
    }
  }
}
function updateSectorFilter(sector){ currentSectorFilter = sector; renderTasks();
}

function loadRoteiroDropdowns() {
  const select = document.getElementById('of-chicote');
  if (!select) return;
  const roteiros = Object.values(allRoteiros);
  
  // 1. Agrupa pelo ID Base e encontra a revis√£o mais alta
  const latestRevisions = roteiros.reduce((acc, r) => {
      // Ignora roteiros inv√°lidos para evitar o erro toUpperCase
      if (!r || typeof r !== 'object' || !r.chicote_nome) return acc;

      const idBase = r.roteiro_id_base || r.chicote_nome;
      if (!acc[idBase] || (r.revisao_number || 1) > (acc[idBase].revisao_number || 1)) {
          acc[idBase] = r;
      }
      return acc;
  }, {});

  const roteirosParaOF = Object.values(latestRevisions);
  const chicotes = roteirosParaOF.map(r => r.chicote_nome);
  
  select.innerHTML = '<option value="">-- Selecione um Modelo/Revis√£o (√öltima REV) --</option>';
  chicotes.sort().forEach(chicote => { // Ordena alfabeticamente
    const option = document.createElement('option');
    option.value = chicote;
    const revInfo = roteirosParaOF.find(r => r.chicote_nome === chicote);
    option.textContent = `${chicote} (REV ${revInfo.revisao_number || 1})`;
    select.appendChild(option);
  });
  if (chicotes.length === 0) {
    select.innerHTML = '<option value="">Nenhum roteiro mestre cadastrado.</option>';
  }
}

async function initializeApp(){
  loadingIndicator.classList.remove('hidden');
  pcpView.classList.add('hidden');
  operatorView.classList.add('hidden');
  reportView.classList.add('hidden');
  adminView.classList.add('hidden'); 
  historicoView.classList.add('hidden');

  listenTheme();
  const savedUser = getUser();
  if (savedUser){ setUser(savedUser);
  }

  if (window.db) {
    setupFirebaseListeners();
  } else {
    // SIMULA√á√ÉO
    allRoteiros = { ...DEFAULT_ROTEIROS };
    if (!localStorage.getItem('sim_data_initialized_v7')) { // Nova flag para a vers√£o final com REV e Fadiga
      await createOF('OF-001', 10, 'CHICOTE-001-REV1', 'Media', 0.95, true);
      await createOF('OF-002', 20, 'CHICOTE-B-REV1', 'Alta', 0.95, true);
      localStorage.setItem('sim_data_initialized_v7', 'true');
    } else {
      allOFs = JSON.parse(localStorage.getItem('sim_ofs') || '{}');
      allTasks = JSON.parse(localStorage.getItem('sim_tasks') || '{}');
      allOcurrencesLog = JSON.parse(localStorage.getItem('sim_ocorrencias') || '[]');
      allRoteiros = JSON.parse(localStorage.getItem('sim_roteiros') || '{}');
    }
    setTimeout(()=>{
      if (!savedUser) {
        openUserModal();
      } else {
        if (isOperador()) { updateView('Operador'); }
        else { updateView('PCP'); }
      }
      loadingIndicator.classList.add('hidden');
      loadRoteiroDropdowns();
      injectSearchInputs();
      renderRoteiros();
      // Inicializa o estado do rascunho
      updateDraftInfo();
    }, 300);
  }

  setupSectorDropdowns();
  if (!savedUser) {
    setTimeout(openUserModal, 100);
  } else {
    if (isOperador()) {
      updateView('Operador');
    } else {
      updateView('PCP');
    }
    injectSearchInputs();
  }
  // Listener do Filtro de Roteiro
  const roteiroSearchInput = document.getElementById('roteiro-search-admin');
  if (roteiroSearchInput) {
      roteiroSearchInput.addEventListener('input', (e) => {
          roteiroSearchTerm = (e.target.value || "").trim().toUpperCase();
          renderRoteiros();
      });
  }
}

function setupFirebaseListeners() {
  if (!window.db) return;

  let collectionsLoaded = { ofs: false, tasks: false, roteiros: false, ocorrencias: false };
  const forceUpdateView = () => {
     if (!loadingIndicator.classList.contains('hidden')) return;
     updateView(userViewSelect.value);
  }
  
  const checkAllLoaded = () => {
    if (Object.values(collectionsLoaded).every(Boolean)) {
      if (!loadingIndicator.classList.contains('hidden')){
        loadingIndicator.classList.add('hidden');
        if (!currentUser) { openUserModal(); }
      }
      updateView(userViewSelect.value || (isMaster() ? 'PCP' : 'Operador'));
      injectSearchInputs();
    }
  };


  db.collection(OF_COLLECTION).onSnapshot(snapshot => {
    snapshot.docChanges().forEach(change => {
      const ofData = { id: change.doc.id, ...change.doc.data() };
      if (change.type === 'removed') delete allOFs[ofData.id];
      else allOFs[ofData.id] = ofData;
    });
    collectionsLoaded.ofs = true;
    checkAllLoaded();
    forceUpdateView(); 
  });
  db.collection(TASK_COLLECTION).onSnapshot(snapshot => {
    snapshot.docChanges().forEach(change => {
      const taskData = { id: change.doc.id, ...change.doc.data() };
      if (change.type === 'removed') delete allTasks[taskData.id];
      else allTasks[taskData.id] = taskData;
    });
    collectionsLoaded.tasks = true;
    checkAllLoaded();
    forceUpdateView(); 
  });
  db.collection(ROTEIRO_COLLECTION).onSnapshot(snapshot => {
    allRoteiros = {};
    snapshot.forEach(doc => {
      const roteiroData = { id: doc.id, ...doc.data() };
      allRoteiros[roteiroData.id] = roteiroData;
    });
    loadRoteiroDropdowns();
    renderRoteiros(); 
    collectionsLoaded.roteiros = true;
    checkAllLoaded();
  });
  db.collection(OCORRENCIA_COLLECTION).onSnapshot(snapshot => {
    allOcurrencesLog = [];
    snapshot.forEach(doc => { allOcurrencesLog.push({ id: doc.id, ...doc.data() }); });
    allOcurrencesLog.sort((a,b) => getDBTimestamp(b.timestamp) - getDBTimestamp(a.timestamp));
    collectionsLoaded.ocorrencias = true;
    checkAllLoaded();
    forceUpdateView();
  });
}
/* ============================
  CRUD - ROTEIROS (NOVO FLUXO DE RASCUNHO/REV)
  ============================ */
function updateDraftInfo() {
    roteiroDraftIdBase = document.getElementById('roteiro-id-base-admin').value.trim().toUpperCase();
    roteiroDraftChicoteName = document.getElementById('roteiro-chicote-name-admin').value.trim().toUpperCase();
    const infoEl = document.getElementById('draft-info');
    const saveBtn = document.getElementById('btn-save-roteiro-draft');

    if (roteiroDraftIdBase && roteiroDraftChicoteName) {
        infoEl.textContent = `${roteiroDraftIdBase} - ${roteiroDraftChicoteName} (${roteiroDraftTasks.length} etapas)`;
        saveBtn.disabled = roteiroDraftTasks.length === 0;
    } else {
        infoEl.textContent = "Preencha ID Base e Nome da Revis√£o";
        saveBtn.disabled = true;
    }
}

function renderDraftTasks() {
    const listEl = document.getElementById('roteiro-draft-list');
    if (roteiroDraftTasks.length === 0) {
        listEl.innerHTML = '<p class="text-sm text-gray-500 text-center">Adicione etapas acima para iniciar o roteiro.</p>';
        document.getElementById('btn-save-roteiro-draft').disabled = true;
        updateDraftInfo();
        return;
    }
    
    // Renderiza a lista de rascunho, agrupada por setor
    const grouped = roteiroDraftTasks.reduce((acc, task) => {
        if (!acc[task.setor]) acc[task.setor] = [];
        acc[task.setor].push(task);
        return acc;
    }, {});

    let html = '';
    // Garante que as tarefas de rascunho s√£o ordenadas por setor e depois por ordem
    const sortedSectors = getSortedSectors(Object.keys(grouped)); 

    sortedSectors.forEach((setor) => {
        html += `<h6 class="text-xs font-semibold text-gray-700 mt-2 first:mt-0">${setor} (${grouped[setor].length})</h6>`;
        // Ordena as tarefas dentro do setor
        grouped[setor].sort((a,b) => a.ordem - b.ordem).forEach((task) => {
            html += `
                <div class="flex justify-between items-center text-xs bg-white p-2 rounded border border-gray-300">
                    <span class="font-medium">${task.ordem}. ${task.nome_atividade} (${task.is_setup_task ? 'SETUP' : 'PROD'})</span>
                    <button onclick="removeDraftTask(${task.ordem - 1})" class="text-red-600 hover:text-red-800">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
        });
    });

    listEl.innerHTML = html;
    updateDraftInfo();
    lucide.createIcons();
}

function removeDraftTask(index) {
    roteiroDraftTasks.splice(index, 1);
    // Reajusta a ordem
    roteiroDraftTasks.forEach((task, i) => task.ordem = i + 1);
    renderDraftTasks();
}

function clearDraft() {
    if (!confirm("Tem certeza que deseja limpar todo o rascunho de roteiro?")) return;
    roteiroDraftTasks = [];
    document.getElementById('roteiro-id-base-admin').value = '';
    document.getElementById('roteiro-chicote-name-admin').value = '';
    document.getElementById('roteiro-fadiga-perc').value = '15'; // Volta para o default
    renderDraftTasks();
    updateDraftInfo();
    document.getElementById('roteiro-message-admin').textContent = '';
}

function addEtapaToDraft() {
    const activity_name = document.getElementById('roteiro-activity-name-admin').value.trim();
    const setor = document.getElementById('roteiro-setor-admin').value;
    const is_setup_task = document.getElementById('roteiro-is-setup-admin').checked;
    const fator_fadiga_perc = parseFloat(document.getElementById('roteiro-fadiga-perc').value) || 0;
    const media_ciclo_min = parseFloat(document.getElementById('roteiro-media-ciclo-min').value) || 0;
    const desvio_ciclo_min = parseFloat(document.getElementById('roteiro-desvio-ciclo-min').value) || 0;
    const media_setup_min = parseFloat(document.getElementById('roteiro-media-setup-min').value) || 0;
    const desvio_setup_min = parseFloat(document.getElementById('roteiro-desvio-setup-min').value) || 0;
    const instruction_text = document.getElementById('roteiro-instruction-text-admin').value.trim();
    
    const messageEl = document.getElementById('draft-etapa-message');
    messageEl.textContent = '';
    messageEl.classList.remove('text-green-600');
    messageEl.classList.add('text-red-500');

    if (!roteiroDraftIdBase || !roteiroDraftChicoteName) {
        messageEl.textContent = "Preencha o ID Base e o Nome da Revis√£o primeiro.";
        return;
    }
    if (!activity_name || !setor) {
        messageEl.textContent = "Preencha Nome da Atividade e Setor.";
        return;
    }
    if (is_setup_task && (media_setup_min <= 0)) {
        messageEl.textContent = "Tarefas de Setup devem ter M√©dia de Setup > 0.";
        return;
    }
    if (!is_setup_task && (media_ciclo_min <= 0)) {
        messageEl.textContent = "Tarefas de Produ√ß√£o devem ter M√©dia de Ciclo > 0.";
        return;
    }

    // Valida√ß√£o de Etapa Duplicada (dentro do RASCUNHO)
    const isDuplicateInDraft = roteiroDraftTasks.some(r => r.nome_atividade === activity_name && r.setor === setor);
    if (isDuplicateInDraft) {
        messageEl.textContent = `üö® Etapa "${activity_name}" (Setor ${setor}) j√° est√° no rascunho.`;
        return;
    }

    const newTask = {
        chicote_nome: roteiroDraftChicoteName,
        setor: setor,
        nome_atividade: activity_name,
        instrucao_trabalho: instruction_text,
        is_setup_task: is_setup_task, 
        fator_fadiga_perc: fator_fadiga_perc,
        media_ciclo_min: is_setup_task ? 0 : media_ciclo_min, 
        desvio_ciclo_min: is_setup_task ? 0 : desvio_ciclo_min, 
        media_setup_min: media_setup_min, 
        desvio_setup_min: desvio_setup_min, 
        ordem: roteiroDraftTasks.length + 1 // Ordem tempor√°ria
    };

    roteiroDraftTasks.push(newTask);
    renderDraftTasks();
    
    // Feedback e limpeza do formul√°rio de etapa
    messageEl.textContent = `Etapa "${activity_name}" adicionada ao rascunho.`;
    messageEl.classList.remove('text-red-500');
    messageEl.classList.add('text-green-600');
    
    document.getElementById('roteiro-activity-name-admin').value = '';
    document.getElementById('roteiro-instruction-text-admin').value = '';
    // Manter valores de tempo/fadiga/setup para agilizar a pr√≥xima etapa se forem iguais
}

async function saveRoteiroFromDraft() {
    const messageEl = document.getElementById('roteiro-message-admin');
    messageEl.textContent = '';
    messageEl.classList.remove('text-green-600');
    messageEl.classList.add('text-red-500');

    if (roteiroDraftTasks.length === 0) {
        messageEl.textContent = "O rascunho est√° vazio.";
        return;
    }
    
    // 1. L√ìGICA DE INTEGRIDADE (Garantir o Pr√≥ximo N√∫mero de REV)
    const idBase = roteiroDraftIdBase;
    const chicoteName = roteiroDraftChicoteName;
    
    // Calcula o pr√≥ximo n√∫mero de revis√£o com base no ID Base.
    const existingRoteirosByBase = Object.values(allRoteiros).filter(r => r.roteiro_id_base === idBase);
    const maxRevision = existingRoteirosByBase.reduce((max, r) => Math.max(max, r.revisao_number || 0), 0);
    const newRevisionNumber = maxRevision + 1; // FOR√áA o n√∫mero correto (1, 2, 3...)

    // Valida√ß√£o de Duplica√ß√£o Cr√≠tica: Impede que REV1 e REV2 tenham o mesmo NOME
    const isNameDuplicate = existingRoteirosByBase.some(r => r.chicote_nome === chicoteName);
    if (isNameDuplicate) {
        messageEl.textContent = `üö® Nome da Revis√£o ("${chicoteName}") j√° est√° em uso. Pr√≥xima REV correta sugerida: ${idBase}-REV${newRevisionNumber}.`;
        return;
    }

    // 2. SALVAMENTO (Copiar o Rascunho para a Cole√ß√£o)
    try {
        const batch = window.db ? db.batch() : null;
        const savePromises = [];

        roteiroDraftTasks.forEach(task => {
            const finalTask = {
                ...task, // Copia todos os dados do rascunho
                roteiro_id_base: idBase,
                revisao_number: newRevisionNumber,
                created_at: window.db ? firebase.firestore.FieldValue.serverTimestamp() : new Date()
            };

            if (window.db) {
                const newRoteiroRef = db.collection(ROTEIRO_COLLECTION).doc();
                batch.set(newRoteiroRef, finalTask);
            } else {
                const newId = `r${roteiroCounter++}`;
                finalTask.id = newId;
                allRoteiros[newId] = finalTask;
                savePromises.push(Promise.resolve()); // Simula√ß√£o
            }
        });

        if (batch) await batch.commit();
        else { 
            await Promise.all(savePromises);
            // Salva os roteiros na simula√ß√£o
            localStorage.setItem('sim_roteiros', JSON.stringify(allRoteiros));
        }
        
        // 3. Sucesso e Limpeza
        messageEl.textContent = `Roteiro ${chicoteName} (REV ${newRevisionNumber}) salvo com sucesso!`;
        messageEl.classList.remove('text-red-500');
        messageEl.classList.add('text-green-600');
        
        clearDraft(); // Limpa o rascunho
        renderRoteiros(); // Atualiza a lista hier√°rquica
        loadRoteiroDropdowns(); // Atualiza a lista para a cria√ß√£o de OF

    } catch(e) {
        console.error("Erro ao salvar roteiro:", e);
        messageEl.textContent = "Erro ao salvar roteiro: " + (e.message || e);
    }
}


/* ============================
  CRUD - OFS
  ============================ */
async function createOF(ofIdOverride, quantityOverride, chicoteOverride, priorityOverride, percentilOverride, isSimulated = false){
  const of_id = ofIdOverride || document.getElementById('of-id').value.trim().toUpperCase();
  const quantity = quantityOverride || parseInt(document.getElementById('of-quantity').value);
  const chicote_name = chicoteOverride || document.getElementById('of-chicote').value;
  const priority = priorityOverride || document.getElementById('of-priority').value || 'Media';
  const percentil = percentilOverride || parseFloat(document.getElementById('of-percentil').value) || 0.95;
  
  const messageEl = document.getElementById('of-creation-message');
  messageEl.textContent = '';
  messageEl.classList.add('hidden');
  if (!of_id || isNaN(quantity) || quantity <= 0 || !chicote_name){
    messageEl.textContent = "Preencha todos os campos corretamente.";
    messageEl.classList.remove('hidden');
    return;
  }
  if (Object.values(allOFs).find(of => of.id === of_id)) {
    messageEl.textContent = `OF "${of_id}" j√° existe.`;
    messageEl.classList.remove('hidden');
    return;
  }

  // Busca APENAS as etapas daquela Revis√£o espec√≠fica (chicote_name)
  const roteiroEtapas = Object.values(allRoteiros).filter(r => r.chicote_nome === chicote_name);
  if (roteiroEtapas.length === 0){
    messageEl.textContent = `Nenhuma etapa encontrada para "${chicote_name}".`;
    messageEl.classList.remove('hidden');
    return;
  }

  // --- Recupera dados da REV --- (Garantia do Snapshot)
  const roteiroBase = roteiroEtapas[0]; 
  const roteiro_id_base = roteiroBase.roteiro_id_base || chicote_name;
  const revisao_number = roteiroBase.revisao_number || 1;

  // ---- In√≠cio da Simula√ß√£o Monte Carlo (OF) ----
  const calculator = new MonteCarloCalculator();
  roteiroEtapas.forEach(etapa => calculator.addEtapa(etapa));
  const simResult = calculator.runSimulation(quantity, percentil);
  const totalP50_Min = simResult.totalMediaSeg / 60;
  const totalP95_Min = simResult.totalConfiavelSeg / 60;
  // ---- Fim da Simula√ß√£o ----

  const newOF = {
    id: of_id, chicote: chicote_name, quantidade: quantity,
    status: 'Pendente',
    priority: priority, 
    data_criacao: window.db ? firebase.firestore.FieldValue.serverTimestamp() : new Date(),
    task_count: roteiroEtapas.length,
    concluded_tasks: 0,
    tempo_planejado_p50_min: parseFloat(totalP50_Min.toFixed(2)),
    tempo_planejado_p95_min: parseFloat(totalP95_Min.toFixed(2)),
    percentil_confianca: percentil,
    audit_log_html: simResult.auditLog,
    
    // Campos de Rastreabilidade (Snapshot)
    roteiro_id_base: roteiro_id_base,
    revisao_number: revisao_number,
    
    // Novos campos de progresso parcial
    pecas_concluidas_ok: 0,
    pecas_concluidas_nok: 0
  };
  try {
    if (window.db) { await db.collection(OF_COLLECTION).doc(of_id).set(newOF); }
    else { allOFs[of_id] = newOF; }

    const batch = window.db ? db.batch() : null;
    let order = 1;
    for (const etapa of roteiroEtapas.sort((a,b) => (a.ordem || 0) - (b.ordem || 0))) {
      
      const taskCalc = new MonteCarloCalculator();
      taskCalc.addEtapa(etapa);
      // Roda a simula√ß√£o individual da tarefa (usa 'quantity' para produ√ß√£o, ignora para setup)
      const taskSim = taskCalc.runSimulation(etapa.is_setup_task ? 1 : quantity, percentil);
      const taskP50_Min = taskSim.totalMediaSeg / 60;
      const taskP95_Min = taskSim.totalConfiavelSeg / 60;
      
      const newTask = {
        id_of: of_id, id_roteiro: etapa.id, chicote: chicote_name,
        nome_atividade: etapa.nome_atividade, setor: etapa.setor,
        instrucao_trabalho: etapa.instrucao_trabalho,
        quantidade_pecas: quantity,
        is_setup_task: etapa.is_setup_task || false, 
        status: 'Em Espera',
        ordem: etapa.ordem || order++, // Usa a ordem do roteiro se existir
        priority: priority, 
        
        // Dados de tempo do Roteiro Mestre (para rastreabilidade/export)
        fator_fadiga_perc: etapa.fator_fadiga_perc,
        media_ciclo_min: etapa.media_ciclo_min,
        desvio_ciclo_min: etapa.desvio_ciclo_min,
        media_setup_min: etapa.media_setup_min,
        desvio_setup_min: etapa.desvio_setup_min,
        
        // Tempos Calculados (O Snapshot da Meta)
        tempo_planejado_p50_min: parseFloat(taskP50_Min.toFixed(2)),
        tempo_planejado_p95_min: parseFloat(taskP95_Min.toFixed(2)),
        
        timestamp_inicio: null, timestamp_fim: null,
        tempo_real_acumulado_ms: 0, 
        total_pause_time_ms: 0,      
        pause_start_timestamp: null,
        
        // Novos campos de produ√ß√£o parcial
        pecas_concluidas_ok: 0,
        pecas_concluidas_nok: 0,
        
        search_index: of_id.toLowerCase()+'-'+etapa.nome_atividade.toLowerCase()+'-'+etapa.setor.toLowerCase()
      };
      if (window.db) {
        const newTaskRef = db.collection(TASK_COLLECTION).doc();
        batch.set(newTaskRef, newTask);
      } else {
        const simTaskId = `t${taskCounter++}`;
        newTask.id = simTaskId;
        allTasks[simTaskId] = newTask;
      }
    }
    
    if (batch) await batch.commit();
    if (!isSimulated) {
      closeModal('create-of-modal');
      alert(`OF ${of_id} criada com sucesso! Tempo Confi√°vel (P${percentil*100}): ${formatMinutes(totalP95_Min)}`);
      if (!window.db) {
        localStorage.setItem('sim_ofs', JSON.stringify(allOFs));
        localStorage.setItem('sim_tasks', JSON.stringify(allTasks));
      }
    }
  } catch(e) {
    console.error("Erro ao criar OF:", e);
    messageEl.textContent = "Erro ao criar OF: " + (e.message || e);
    messageEl.classList.remove('hidden');
  }
}

// esta fun√ß√£o agora lida com os novos status (Setup, Produ√ß√£o) e delega o reporte
async function updateTaskStatus(taskId, newStatus, logType = null, justification = null, justificationText = null) {
  const task = allTasks[taskId];
  if (!task) return;

  const updateData = { status: newStatus };
  const now = window.db ? firebase.firestore.FieldValue.serverTimestamp() : new Date();
  // Calcula o tempo real acumulado AT√â ESTE PONTO
  const currentTempoRealMs = calculateTempoRealMs(task);
  // --- L√≥gica de IN√çCIO / RETOMADA ---
  if (newStatus === 'Em Setup' || newStatus === 'Em Produ√ß√£o' || newStatus === 'Em Processo') {
    // Se estava Pausada, calcula o tempo de pausa
    if ((task.status === 'Pausada' || task.status === 'Setup Pausado' || task.status === 'Produ√ß√£o Pausada') && task.pause_start_timestamp) {
      const pauseStartMs = getDBTimestamp(task.pause_start_timestamp);
      const currentPauseTimeMs = Date.now() - pauseStartMs;
      updateData.total_pause_time_ms = (task.total_pause_time_ms || 0) + currentPauseTimeMs;
      updateData.pause_start_timestamp = null;
    }
    // Define o timestamp_inicio como "agora", que √© usado para o pr√≥ximo c√°lculo de tempo real
    updateData.timestamp_inicio = now;
  } 
  
  // --- L√≥gica de PAUSA ---
  else if (newStatus === 'Pausada' || newStatus === 'Setup Pausado' || newStatus === 'Produ√ß√£o Pausada') {
    updateData.tempo_real_acumulado_ms = currentTempoRealMs;
    // Salva o tempo acumulado
    updateData.pause_start_timestamp = now;
    // Inicia o cron√¥metro da pausa
    if (logType === 'PAUSA' && (justification || justificationText)) {
      await createOcorrenciaLog(task, 'PAUSA', justification, justificationText);
    }
  } 
  
  // --- L√≥gica de CONCLUS√ÉO (Apenas para tarefas de SETUP) ---
  else if (newStatus === 'Conclu√≠do' && task.is_setup_task) {
    const desvio = calculateDesvio(task);
    updateData.tempo_real_acumulado_ms = currentTempoRealMs;
    updateData.timestamp_fim = now;
    updateData.pause_start_timestamp = null; // Garante que n√£o est√° pausada
    
    // Se houve atraso, registra a ocorr√™ncia
    if (desvio < 0 || logType === 'FIM_ATRASO') {
      await createOcorrenciaLog(task, 'FIM_ATRASO', justification, justificationText);
    }
    
    // Atualiza o contador da OF
    await updateOFProgress(task.id_of, task.id, 0, 0);
  }

  // A l√≥gica de conclus√£o de tarefas de PRODU√á√ÉO √© tratada em handleReportProduction()

  if (window.db) {
    await db.collection(TASK_COLLECTION).doc(taskId).update(updateData);
  } else {
    Object.assign(task, updateData);
    localStorage.setItem('sim_tasks', JSON.stringify(allTasks));
  }
  renderTasks();
}

// NOVA FUN√á√ÉO: Lida com o reporte de produ√ß√£o OK/NOK
async function handleReportProduction() {
  const { taskId, newStatus } = currentAction;
  const task = allTasks[taskId];
  if (!task) return;
  
  const qtyOK = parseInt(document.getElementById('report-qty-ok').value) || 0;
  const qtyNOK = parseInt(document.getElementById('report-qty-nok').value) || 0;
  const errorEl = document.getElementById('report-modal-error');
  errorEl.classList.add('hidden');
  
  if (qtyOK < 0 || qtyNOK < 0) {
    errorEl.textContent = "Valores n√£o podem ser negativos.";
    errorEl.classList.remove('hidden');
    return;
  }
  
  const now = window.db ? firebase.firestore.FieldValue.serverTimestamp() : new Date();
  const currentTempoRealMs = calculateTempoRealMs(task);
  const updateData = {
    status: newStatus,
    tempo_real_acumulado_ms: currentTempoRealMs,
    pecas_concluidas_ok: (task.pecas_concluidas_ok || 0) + qtyOK,
    pecas_concluidas_nok: (task.pecas_concluidas_nok || 0) + qtyNOK,
    pause_start_timestamp: null, // Garante que n√£o est√° pausada
  };
  if (newStatus === 'Pausada') {
    // Se pausou, salva o tempo acumulado e inicia o cron√¥metro da pausa
    updateData.pause_start_timestamp = now;
  } else if (newStatus === 'Conclu√≠do') {
    // Se concluiu, salva o tempo final
    updateData.timestamp_fim = now;
    // Atualiza o progresso da OF (tarefa e pe√ßas)
    await updateOFProgress(task.id_of, task.id, qtyOK, qtyNOK);
  } else {
    // Apenas salvou parcial, atualiza s√≥ as pe√ßas da OF
    await updateOFProgress(task.id_of, null, qtyOK, qtyNOK);
  }
  
  if (window.db) {
    await db.collection(TASK_COLLECTION).doc(taskId).update(updateData);
  } else {
    Object.assign(task, updateData);
    localStorage.setItem('sim_tasks', JSON.stringify(allTasks));
  }
  
  closeModal('report-production-modal');
  renderTasks();
}

// NOVA FUN√á√ÉO: Atualiza o progresso da OF (centralizado)
async function updateOFProgress(ofId, concludedTaskId, addedOk, addedNok) {
    const ofRef = window.db ? db.collection(OF_COLLECTION).doc(ofId) : null;
    const updateData = {
      pecas_concluidas_ok: (window.db ? firebase.firestore.FieldValue.increment(addedOk) : (allOFs[ofId].pecas_concluidas_ok || 0) + addedOk),
      pecas_concluidas_nok: (window.db ? firebase.firestore.FieldValue.increment(addedNok) : (allOFs[ofId].pecas_concluidas_nok || 0) + addedNok)
    };
    let isOfConcluida = false;
    
    if (concludedTaskId) {
      // Tarefa foi conclu√≠da
      updateData.concluded_tasks = (window.db ? firebase.firestore.FieldValue.increment(1) : (allOFs[ofId].concluded_tasks || 0) + 1);
      const tasksDaOF = Object.values(allTasks).filter(t => t.id_of === ofId);
      const totalConcluidas = tasksDaOF.filter(t => (t.id === concludedTaskId) ? true : t.status === 'Conclu√≠do').length;
      isOfConcluida = totalConcluidas >= tasksDaOF.length;
      
      if (isOfConcluida) {
        updateData.status = 'Conclu√≠do';
      } else if (allOFs[ofId].status === 'Pendente') {
         updateData.status = 'Em Andamento';
      }
    }
    
    if (window.db) {
      await ofRef.update(updateData);
    } else {
       const of = allOFs[ofId];
       of.pecas_concluidas_ok = (of.pecas_concluidas_ok || 0) + addedOk;
       of.pecas_concluidas_nok = (of.pecas_concluidas_nok || 0) + addedNok;
       if (concludedTaskId) {
         of.concluded_tasks = (of.concluded_tasks || 0) + 1;
         if (isOfConcluida) of.status = 'Conclu√≠do';
         else if (of.status === 'Pendente') of.status = 'Em Andamento';
       }
       localStorage.setItem('sim_ofs', JSON.stringify(allOFs));
    }
}


async function createOcorrenciaLog(task, type, justification, justificationText) {
  const logData = {
    ID_TASK: task.id, OF: task.id_of, CHICOTE: task.chicote, ATIVIDADE: task.nome_atividade,
    OPERADOR: currentUser?.name || currentUser?.sector || '', SECTOR: task.setor,
    MOTIVO_PRINCIPAL: justification, MOTIVO_DETALLES: justificationText,
    timestamp: window.db ? firebase.firestore.FieldValue.serverTimestamp() : new Date()
  };

  if (type === 'PAUSA') {
    logData.TIPO = 'PAUSA';
    logData.TEMPO_PAUSA = 0;
    logData.TEMPO_ATRASO = 0;
    logData.MOTIVO_PAUSA = justification;
    logData.MOTIVO_ATRASO = null;
  } else if (type === 'FIM_ATRASO') {
    const desvio = calculateDesvio(task);
    logData.TIPO = 'ATRASO';
    logData.TEMPO_PAUSA = calculateTotalPauseMinutesFinal(task); 
    logData.TEMPO_ATRASO = parseFloat(Math.abs(desvio).toFixed(2));
    logData.MOTIVO_PAUSA = null;
    logData.MOTIVO_ATRASO = justification;
  }

  if (window.db) await db.collection(OCORRENCIA_COLLECTION).add(logData);
  else {
    logData.id = `log${allOcurrencesLog.length + 1}`;
    allOcurrencesLog.push(logData);
    localStorage.setItem('sim_ocorrencias', JSON.stringify(allOcurrencesLog));
  }
}
/* ============================
  A√á√ïES
  ============================ */
function startTask(taskId){
  const task = allTasks[taskId];
  if (!task) return;
  
  // Decide se √© In√≠cio de Setup ou In√≠cio de Produ√ß√£o
  const newStatus = task.is_setup_task ? 'Em Setup' : 'Em Produ√ß√£o';
  updateTaskStatus(taskId, newStatus); 
}

function finishTask(taskId){ 
  // Esta fun√ß√£o agora s√≥ √© chamada por tarefas de SETUP
  showActionModal(taskId, 'Finalizar', DELAY_REASONS, false);
}

function pauseTask(taskId){ 
  // Esta fun√ß√£o agora √© chamada por Setup (Pausar Setup) e Produ√ß√£o (Pausar Produ√ß√£o)
  showActionModal(taskId, 'Pausar', PAUSE_REASONS, true);
}

function reportProduction(taskId) {
  // Esta fun√ß√£o S√ì √© chamada por tarefas de PRODU√á√ÉO
  showReportModal(taskId);
}


async function deleteRoteiroActivity(roteiroId) {
  if (!isMaster() || !confirm("Excluir esta etapa de roteiro?")) return;
  if (window.db) {
    try { await db.collection(ROTEIRO_COLLECTION).doc(roteiroId).delete(); alert("Etapa exclu√≠da.");
    }
    catch(e) { alert("Erro ao excluir: " + e.message);
    }
  } else {
    delete allRoteiros[roteiroId];
    // CORRE√á√ÉO CR√çTICA: Salvar no localStorage ap√≥s a exclus√£o de uma atividade de roteiro.
    localStorage.setItem('sim_roteiros', JSON.stringify(allRoteiros));
    renderRoteiros();
    loadRoteiroDropdowns(); // Recarrega o dropdown de cria√ß√£o de OF com a lista atualizada
  }
}

async function deleteOF(ofId) {
  if (!isMaster() || !ofId) return;
  if (!confirm(`Excluir OF ${ofId} e TODAS as suas tarefas e logs? Esta a√ß√£o √© IRREVERS√çVEL.`)) return;
  try {
    if (window.db) {
      const batch = db.batch();
      batch.delete(db.collection(OF_COLLECTION).doc(ofId));
      const tasksSnapshot = await db.collection(TASK_COLLECTION).where('id_of', '==', ofId).get();
      tasksSnapshot.docs.forEach(doc => batch.delete(doc.ref));
      const ocorrenciasSnapshot = await db.collection(OCORRENCIA_COLLECTION).where('OF', '==', ofId).get();
      ocorrenciasSnapshot.docs.forEach(doc => batch.delete(doc.ref));
      await batch.commit();
    } else {
      delete allOFs[ofId];
      Object.keys(allTasks).forEach(id => { if (allTasks[id].id_of === ofId) delete allTasks[id]; });
      allOcurrencesLog = allOcurrencesLog.filter(l => l.OF !== ofId);
      localStorage.setItem('sim_ofs', JSON.stringify(allOFs));
      localStorage.setItem('sim_tasks', JSON.stringify(allTasks));
      localStorage.setItem('sim_ocorrencias', JSON.stringify(allOcurrencesLog));
    }
    closeModal('of-details-modal');
    alert(`OF ${ofId} exclu√≠da.`);
    updateView(userViewSelect.value);
  } catch(e) {
    alert("Erro ao excluir OF: " + (e.message || e));
  }
}

/* ============================
  MODAIS
  ============================ */
function openModal(id){
  const modal = document.getElementById(id);
  if(modal) modal.style.display = 'flex';
}
function closeModal(id){
  const modalId = id || 'action-modal';
  const modal = document.getElementById(modalId);
  if(modal) {
    modal.style.display = 'none';
    
    // Limpa os modais ao fechar
    if (modalId === 'action-modal') {
      currentAction = {};
      document.getElementById('justification-select').value = '';
      document.getElementById('justification-text').value = '';
      document.getElementById('justification-required-text').classList.add('hidden');
    }
    if (modalId === 'report-production-modal') {
      currentAction = {};
      document.getElementById('report-qty-ok').value = '0';
      document.getElementById('report-qty-nok').value = '0';
      document.getElementById('report-status-pause').checked = true;
      document.getElementById('report-modal-error').classList.add('hidden');
    }
  }
}

// Modal 1: Justificativas (Pausa ou Atraso de Setup)
function showActionModal(taskId, type, reasons, isPauseAction){
  const task = allTasks[taskId];
  if (!task) return;
  
  // Define o novo status com base na a√ß√£o e tipo de tarefa
  let newStatus = '';
  if (isPauseAction) {
    newStatus = task.is_setup_task ? 'Setup Pausado' : 'Produ√ß√£o Pausada';
  } else {
    newStatus = 'Conclu√≠do'; // A√ß√£o de Finalizar (s√≥ para setup)
  }
  
  currentAction = { taskId, type, newStatus, isPauseAction };
  const title = document.getElementById('modal-title');
  const message = document.getElementById('modal-message');
  const justificationSelect = document.getElementById('justification-select');
  const justificationRequired = document.getElementById('justification-required-text');
  title.textContent = `${type} Atividade: ${task.nome_atividade}`;
  message.textContent = `OF ${task.id_of} - Chicote ${task.chicote}`;
  justificationSelect.innerHTML = '<option value="">-- Selecione uma op√ß√£o --</option>';
  reasons.forEach(reason => {
    const option = document.createElement('option');
    option.value = reason;
    option.textContent = reason;
    justificationSelect.appendChild(option);
  });
  let isRequired = false;
  
  if (isPauseAction) {
    // A√ß√£o de Pausar (Setup ou Produ√ß√£o)
    justificationRequired.textContent = `üö® O motivo da pausa √© obrigat√≥rio.`;
    isRequired = true;
  } else {
    // A√ß√£o de Finalizar (Setup)
    const desvio = calculateDesvio(task);
    if (desvio < 0) {
      justificationRequired.textContent = `üö® Justificativa obrigat√≥ria! Atraso de ${formatMinutes(Math.abs(desvio))} (Meta P95: ${formatMinutes(task.tempo_planejado_p95_min)})`;
      isRequired = true;
    } else {
      justificationRequired.textContent = `‚úÖ Conclu√≠do dentro da meta P95.`;
      isRequired = false;
    }
  }
  
  justificationRequired.classList.toggle('hidden', !isRequired);
  currentAction.isRequired = isRequired;

  openModal('action-modal');
}

// Modal 2: Reporte de Produ√ß√£o (OK/NOK)
function showReportModal(taskId) {
    const task = allTasks[taskId];
    if (!task) return;
    // Define os status que ser√£o usados no handleReportProduction
    currentAction = { 
        taskId: taskId, 
        newStatus: document.querySelector('input[name="report-status"]:checked')?.value || 'Pausada' 
    };
    
    document.getElementById('report-modal-title').textContent = `Reportar: ${task.nome_atividade}`;
    document.getElementById('report-modal-message').textContent = `OF ${task.id_of} - Pe√ßas Totais: ${task.quantidade_pecas}`;
    // Adiciona listener para atualizar o newStatus
    const radios = document.querySelectorAll('input[name="report-status"]');
    radios.forEach(radio => radio.onchange = (e) => {
        currentAction.newStatus = e.target.value;
    });
    openModal('report-production-modal');
}

// Fun√ß√£o de confirma√ß√£o do Modal 1 (Pausa / Fim de Setup)
async function handleConfirmedAction(){
  const { taskId, type, newStatus, isPauseAction, isRequired } = currentAction;
  const justificationSelect = document.getElementById('justification-select');
  const justificationText = document.getElementById('justification-text').value.trim();
  const justification = justificationSelect.value;
  const justificationRequired = document.getElementById('justification-required-text');
  if (isRequired && !justification) {
    justificationRequired.textContent = "üö® Voc√™ deve selecionar um motivo principal!";
    justificationRequired.classList.remove('hidden');
    return;
  }
  justificationRequired.classList.add('hidden');

  const logType = isPauseAction ? 'PAUSA' : (calculateDesvio(allTasks[taskId]) < 0 ? 'FIM_ATRASO' : null);
  await updateTaskStatus(taskId, newStatus, logType, justification, justificationText);
  
  closeModal();
}

// ================================================================
// NOVA FUN√á√ÉO INTELIGENTE (V4 - COM HASHTAGS #img, #pdf, #vid)
// ================================================================
// ================================================================
// FUN√á√ÉO INTELIGENTE V5 (VERS√ÉO BLINDADA - CORRE√á√ÉO DE CLIQUE E IMAGEM)
// ================================================================
function renderInstructionContent(text) {
    if (!text || text.trim() === '') {
        return '<p class="text-gray-500 italic">Nenhuma instru√ß√£o de trabalho cadastrada.</p>';
    }
    
    let processed = text.replace(/\n/g, '<br>');

    // 1. YOUTUBE
    const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})(?:[^\s]*)?/g;
    processed = processed.replace(youtubeRegex, (match, videoId) => {
        return `
        <div class="my-4 rounded-xl overflow-hidden shadow-lg border border-gray-200 bg-black" style="position: relative; z-index: 20;">
            <div style="position: relative; padding-bottom: 56.25%; height: 0;">
                <iframe src="https://www.youtube.com/embed/${videoId}" 
                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" 
                    frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
                </iframe>
            </div>
        </div>`;
    });

    // 2. GOOGLE DRIVE (L√≥gica Robusta V5)
    const driveRegex = /https?:\/\/(?:drive|docs)\.google\.com\/(?:file\/d\/|open\?id=|uc\?id=)([a-zA-Z0-9_-]+)(?:[^\s<]*)/g;

    processed = processed.replace(driveRegex, (fullUrl, fileId) => {
        
        const cleanUrl = fullUrl.replace(/<br>$/, '');
        
        // Tags de Controle
        const isForceImg = cleanUrl.includes('#img');
        const isForcePdf = cleanUrl.includes('#pdf');
        const isForceVid = cleanUrl.includes('#vid');

        // LINKS (M√©todo Oficial Est√°vel)
        const imgSource = `https://drive.google.com/uc?export=view&id=${fileId}`; 
        const openLink = `https://drive.google.com/file/d/${fileId}/view?usp=sharing`;

        // ESTILO DO BOT√ÉO (Com corre√ß√£o de z-index e pointer-events)
        const renderButton = (type) => `
            <div style="position: relative; z-index: 50; margin-top: 10px; margin-bottom: 10px;">
                <a href="${openLink}" target="_blank" onclick="event.stopPropagation();"
                   class="w-full p-4 bg-${type==='video'?'purple':'blue'}-50 hover:bg-${type==='video'?'purple':'blue'}-100 border border-${type==='video'?'purple':'blue'}-200 rounded-lg flex items-center gap-3 transition group text-decoration-none cursor-pointer shadow-sm hover:shadow-md">
                    <div class="bg-${type==='video'?'purple':'blue'}-600 text-white p-2 rounded-full group-hover:scale-110 transition shrink-0">
                         <i data-lucide="${type==='video'?'play-circle':'file-text'}" class="w-6 h-6"></i>
                    </div>
                    <div class="text-left overflow-hidden">
                        <p class="font-bold text-${type==='video'?'purple':'blue'}-900 text-sm truncate">${type==='video'?'Assistir V√≠deo Externo':'Abrir Documento Anexado'}</p>
                        <p class="text-xs text-${type==='video'?'purple':'blue'}-600 truncate">Clique para acessar via Google Drive</p>
                    </div>
                    <div class="ml-auto text-${type==='video'?'purple':'blue'}-400 shrink-0">
                        <i data-lucide="external-link" class="w-5 h-5"></i>
                    </div>
                </a>
            </div>`;

        // L√ìGICA DE EXIBI√á√ÉO
        if (isForcePdf) return renderButton('pdf');
        if (isForceVid) return renderButton('video');

        // Padr√£o ou #img
        return `
        <div class="my-3" style="position: relative;">
            <img src="${imgSource}" 
                 class="rounded-lg shadow-md max-w-full h-auto mx-auto border border-gray-200" 
                 loading="lazy"
                 style="display: block;"
                 alt="Anexo"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" 
            />
            
            <div style="display: none; position: relative; z-index: 50;">
                <a href="${openLink}" target="_blank" onclick="event.stopPropagation();"
                   class="w-full p-4 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-lg flex items-center gap-3 transition group cursor-pointer text-decoration-none shadow-sm">
                    <div class="bg-blue-600 text-white p-2 rounded-full group-hover:scale-110 transition shrink-0">
                         <i data-lucide="file-text" class="w-6 h-6"></i>
                    </div>
                    <div class="text-left overflow-hidden">
                        <p class="font-bold text-blue-900 text-sm truncate">Abrir Arquivo</p>
                        <p class="text-xs text-blue-600 truncate">Clique para visualizar</p>
                    </div>
                    <div class="ml-auto text-blue-400 shrink-0">
                        <i data-lucide="external-link" class="w-5 h-5"></i>
                    </div>
                </a>
            </div>
        </div>
        `;
    });

    // 3. Links Gen√©ricos de Imagem
    const imgRegex = /(https?:\/\/[^\s<]+?\.(?:jpe?g|png|gif|webp|svg|bmp))(\s|<br>|$)/gi;
    processed = processed.replace(imgRegex, (match, url) => {
        if (url.includes('google.com') || url.includes('youtube')) return match;
        return `<img src="${url}" class="rounded-lg shadow-md max-w-full h-auto my-2" loading="lazy">`;
    });

    // 4. Links de Texto (Linkify)
    const genericUrlRegex = /(https?:\/\/[^\s<]+)/g;
    processed = processed.replace(genericUrlRegex, (url) => {
        if (url.includes('<img') || url.includes('<iframe') || url.includes('class="w-full') || url.includes('onclick=')) return url;
        return `<a href="${url}" target="_blank" onclick="event.stopPropagation();" class="text-indigo-600 hover:text-indigo-800 font-medium underline break-all" style="position:relative; z-index:50;">${url}</a>`;
    });
    
    return processed;
}
function openInstructionModal(taskId) {
  const task = allTasks[taskId];
  if (!task) return;
  document.getElementById('instruction-modal-header').textContent =
    `OF ${task.id_of} - Chicote ${task.chicote} - Setor: ${task.setor}`;
  
  const contentEl = document.getElementById('instruction-modal-content');
  contentEl.innerHTML = renderInstructionContent(task.instrucao_trabalho);
  openModal('instruction-modal');
  lucide.createIcons();
}

function openUserModal() {
  const modal = document.getElementById('user-modal');
  if(modal) modal.style.display = 'flex';
  setTimeout(()=>{
    const roleSel = document.getElementById('user-role');
    const pinWrap = document.getElementById('user-pin-wrap');
    const sectorWrap = document.getElementById('user-sector-wrap');
    roleSel.onchange = () => {
      const isM = roleSel.value === 'MASTER';
      pinWrap.classList.toggle('hidden', !isM);
      sectorWrap.classList.toggle('hidden', isM);
    };
    roleSel.dispatchEvent(new Event('change'));
  }, 50);
}
function confirmUser(){
  const role = document.getElementById('user-role').value;
  const sector = document.getElementById('user-sector').value;
  if (role === 'MASTER') {
    const pin = document.getElementById('user-pin').value;
    if (pin !== MASTER_PIN) { alert("PIN incorreto."); return;
    }
    setUser({ role: 'MASTER', name: 'Master' });
  } else {
    if (!sector) { alert("Selecione o setor."); return;
    }
    setUser({ role: 'OPERADOR', sector, name: 'Operador' });
  }
  document.getElementById('user-modal').style.display = 'none';
  loadingIndicator.classList.add('hidden');
  setupSectorDropdowns();
  updateView(isMaster() ? 'PCP' : 'Operador');
  injectSearchInputs();
}

/* ============================
  RENDERIZA√á√ÉO
  ============================ */
function injectSearchInputs(){
  // PCP search
  const pcpWrap = document.getElementById('pcp-of-search-wrap');
  if (pcpWrap && !pcpWrap.dataset.ready){
    pcpWrap.classList.remove('hidden');
    pcpWrap.dataset.ready = "1";
    const input = document.getElementById('pcp-of-search');
    if (input) input.addEventListener('input', (e)=>{ pcpSearchOF = (e.target.value||"").trim().toUpperCase(); renderOFs(); });
  }
  // Operator search
  const opWrap = document.getElementById('operator-of-search-wrap');
  if (opWrap && !opWrap.dataset.ready){
    opWrap.classList.remove('hidden');
    opWrap.dataset.ready = "1";
    const input = document.getElementById('operator-of-search');
    if (input) input.addEventListener('input', (e)=>{ operatorSearchOF = (e.target.value||"").trim().toUpperCase(); renderTasks(); });
  }
  // Hist√≥rico search
  const histWrap = document.getElementById('historico-search-wrap');
  if (histWrap && !histWrap.dataset.ready){
    histWrap.classList.remove('hidden');
    histWrap.dataset.ready = "1";
    const input = document.getElementById('historico-of-search');
    if (input) input.addEventListener('input', (e)=>{ historicoSearchOF = (e.target.value||"").trim().toUpperCase(); renderHistory(); });
  }
}

function renderKPIs(){
  const kpisContainer = document.getElementById('kpis-container');
  if (!kpisContainer) return;
  
  const activeOFs = Object.values(allOFs).filter(of => of.status !== 'Conclu√≠do');
  const totalOFs = activeOFs.length;
  // Progresso por pe√ßas
  const totalPecasOK = activeOFs.reduce((sum, of) => sum + (of.pecas_concluidas_ok || 0), 0);
  const totalPecasPrevistas = activeOFs.reduce((sum, of) => sum + (of.quantidade || 0), 0);
  
  const activeLogs = allOcurrencesLog.filter(l => activeOFs.map(of=>of.id).includes(l.OF));
  const logsAtraso = activeLogs.filter(l => l.TIPO === 'ATRASO');
  const totalPause = activeLogs.reduce((s,l)=> s + (l.TEMPO_PAUSA||0), 0);
  const totalAtraso = logsAtraso.reduce((s,l)=> s + (l.TEMPO_ATRASO||0), 0);
  
  const kpiData = [
    { title:"OFs Ativas", value: totalOFs, icon:"package", color:"bg-blue-600" },
    { title:"Pe√ßas Conclu√≠das (OK)", value: `${totalPecasOK} / ${totalPecasPrevistas}`, icon:"check-circle", color:"bg-green-600" },
    { title:"Pausas Totais (min)", value: totalPause.toFixed(1), icon:"pause-circle", color:"bg-yellow-600" },
    { title:"Atraso Total (min)", value: totalAtraso.toFixed(1), icon:"alert-triangle", color:"bg-red-600" },
  ];
  kpisContainer.innerHTML = kpiData.map(k=>`
    <div class="${k.color} text-white p-3 sm:p-4 rounded-xl shadow-md flex items-center justify-between">
      <div>
        <p class="text-xs sm:text-sm font-medium opacity-80">${k.title}</p>
        <p class="text-2xl sm:text-3xl font-bold">${k.value}</p>
      </div>
      <i data-lucide="${k.icon}" class="w-7 h-7 sm:w-8 sm:h-8 opacity-70"></i>
    </div>`).join('');
  lucide.createIcons();
}

// ===== NOVO GR√ÅFICO DE CARGA DE TRABALHO (TOP 5 / FULL) =====
function getCargaDeTrabalho() {
    const tasksNaoConcluidas = Object.values(allTasks).filter(t => allOFs[t.id_of]?.status !== 'Conclu√≠do' && t.status !== 'Conclu√≠do');
    const cargaPorSetor = {};
    SECTORS.forEach(setor => { 
        cargaPorSetor[setor] = { planoP95: 0, projecaoReal: 0 }; 
    });

    tasksNaoConcluidas.forEach(task => {
        if (cargaPorSetor.hasOwnProperty(task.setor)) {
            
            let cargaPendenteMin = 0;
            const tempoGastoMin = calculateTempoRealMinutes(task);
            const pecasOK = task.pecas_concluidas_ok || 0;
            const pecasProcessadas = pecasOK + (task.pecas_concluidas_nok || 0);
            const pecasTotais = task.quantidade_pecas || 1; 
            const pecasRestantes = Math.max(0, pecasTotais - pecasOK);
            const p95Planejado = task.tempo_planejado_p95_min || 0;
            const p95PacePlanejado = (pecasTotais > 0) ? (p95Planejado / pecasTotais) : 0;

            if (task.is_setup_task) {
                // Setup: Carga pendente = (Plano Total) - (Tempo Real Gasto)
                cargaPendenteMin = Math.max(0, p95Planejado - tempoGastoMin);
            } else if (pecasProcessadas > 0 && tempoGastoMin > 0) {
                // Produ√ß√£o: Projeta o restante com base no PACE REAL ATUAL
                const paceRealMin = tempoGastoMin / pecasProcessadas;
                cargaPendenteMin = pecasRestantes * paceRealMin;
            } else {
                // Produ√ß√£o: Projeta o restante com base no PACE PLANEJADO (P95)
                const cargaEstimadaRestante = pecasRestantes * p95PacePlanejado;
                cargaPendenteMin = cargaEstimadaRestante; 
            }
            
            cargaPorSetor[task.setor].planoP95 += p95Planejado;
            cargaPorSetor[task.setor].projecaoReal += cargaPendenteMin;
        }
    });
    
    // Converte para array, filtra os vazios, e ordena pelo plano P95
    return Object.keys(cargaPorSetor)
        .filter(setor => cargaPorSetor[setor].planoP95 > 0 || cargaPorSetor[setor].projecaoReal > 0)
        .map(setor => ({
            setor,
            planoP95: cargaPorSetor[setor].planoP95,
            projecaoReal: cargaPorSetor[setor].projecaoReal,
        }))
        .sort((a, b) => b.planoP95 - a.planoP95);
}

function renderWorkloadChart() {
    const ctxEl = document.getElementById('workload-chart');
    if (!ctxEl) return;
    
    const cargaData = getCargaDeTrabalho();
    const top5Data = cargaData.slice(0, 5); // Pega apenas os Top 5

    const labels = top5Data.map(d => d.setor);
    const dataPlanoP95 = top5Data.map(d => d.planoP95.toFixed(2));
    const dataProjecaoReal = top5Data.map(d => d.projecaoReal.toFixed(2));
    
    const backgroundColorsProjecao = top5Data.map(d => d.projecaoReal > d.planoP95 ? 'rgba(239, 68, 68, 0.7)' : 'rgba(59, 130, 246, 0.7)');
    const borderColorsProjecao = top5Data.map(d => d.projecaoReal > d.planoP95 ? 'rgba(239, 68, 68, 1)' : 'rgba(59, 130, 246, 1)');

    if (workloadChart) { workloadChart.destroy(); }

    workloadChart = new Chart(ctxEl, {
        type: 'bar', 
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Plano P95 (Meta)',
                    data: dataPlanoP95,
                    backgroundColor: 'rgba(229, 231, 235, 1)', 
                    borderColor: 'rgba(209, 213, 219, 1)',
                    borderWidth: 1,
                    order: 1 
                },
                {
                    label: 'Proje√ß√£o Real (Pace)',
                    data: dataProjecaoReal,
                    backgroundColor: backgroundColorsProjecao, 
                    borderColor: borderColorsProjecao,
                    borderWidth: 1,
                    order: 2, 
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y', 
            scales: { 
                x: { 
                    beginAtZero: true, 
                    title: { display: true, text: 'Minutos' } 
                },
                y: { grid: { display: false }, stacked: false }
            },
            plugins: { 
                legend: { display: true, position: 'top' },
                tooltip: { callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) { label += ': '; }
                        if (context.parsed.x !== null) { label += context.parsed.x.toFixed(2) + ' min'; }
                        return label;
                    }
                }}
            }
        }
    });
}

function openChartModal() {
    const modalId = 'chart-modal';
    openModal(modalId);
    
    // Renderiza o gr√°fico completo no modal
    const ctxElFull = document.getElementById('workload-chart-full');
    if (!ctxElFull) return;

    const cargaData = getCargaDeTrabalho();
    const labels = cargaData.map(d => d.setor);
    const dataPlanoP95 = cargaData.map(d => d.planoP95.toFixed(2));
    const dataProjecaoReal = cargaData.map(d => d.projecaoReal.toFixed(2));
    
    const backgroundColorsProjecao = cargaData.map(d => d.projecaoReal > d.planoP95 ? 'rgba(239, 68, 68, 0.7)' : 'rgba(59, 130, 246, 0.7)');
    const borderColorsProjecao = cargaData.map(d => d.projecaoReal > d.planoP95 ? 'rgba(239, 68, 68, 1)' : 'rgba(59, 130, 246, 1)');

    if (workloadChartFull) { workloadChartFull.destroy(); }

    workloadChartFull = new Chart(ctxElFull, {
        type: 'bar', 
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Plano P95 (Meta)',
                    data: dataPlanoP95,
                    backgroundColor: 'rgba(229, 231, 235, 1)', 
                    borderColor: 'rgba(209, 213, 219, 1)',
                    borderWidth: 1,
                    order: 1 
                },
                {
                    label: 'Proje√ß√£o Real (Pace)',
                    data: dataProjecaoReal,
                    backgroundColor: backgroundColorsProjecao, 
                    borderColor: borderColorsProjecao,
                    borderWidth: 1,
                    order: 2, 
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y', 
            scales: { 
                x: { 
                    beginAtZero: true, 
                    title: { display: true, text: 'Minutos' } 
                },
                y: { grid: { display: false }, stacked: false }
            },
            plugins: { 
                legend: { display: true, position: 'top' },
                tooltip: { callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) { label += ': '; }
                        if (context.parsed.x !== null) { label += context.parsed.x.toFixed(2) + ' min'; }
                        return label;
                    }
                }}
            }
        }
    });
    // Ajusta a altura do container do gr√°fico no modal para caber todos os itens
    const chartContainer = document.querySelector('#chart-modal .max-h-[75vh] > div');
    const totalHeight = labels.length * 40 + 100; // 40px por item + 100px para margem/t√≠tulo
    chartContainer.style.height = `${Math.min(totalHeight, 800)}px`;
}
// ===== FIM NOVO GR√ÅFICO DE CARGA DE TRABALHO (TOP 5 / FULL) =====


function updateView(view){
  if (!currentUser) {
    pcpView.classList.add('hidden');
    operatorView.classList.add('hidden'); 
    reportView.classList.add('hidden');
    adminView.classList.add('hidden'); 
    historicoView.classList.add('hidden');
    openUserModal();
    return;
  }

  if (isOperador() && view !== 'Operador'){ 
    view = 'Operador';
  }
  
  const adminOption = userViewSelect.querySelector('option[value="Admin"]');
  const histOption = userViewSelect.querySelector('option[value="Historico"]');
  if (isMaster()) {
    if (!adminOption) {
      userViewSelect.innerHTML += '<option value="Admin">Vis√£o: Administra√ß√£o</option>';
    }
    if (!histOption) {
      const adminOptEl = userViewSelect.querySelector('option[value="Admin"]');
      const newHistOpt = document.createElement('option');
      newHistOpt.value = 'Historico';
      newHistOpt.textContent = 'Vis√£o: Hist√≥rico';
      if (adminOptEl) {
        userViewSelect.insertBefore(newHistOpt, adminOptEl);
      } else {
         userViewSelect.appendChild(newHistOpt);
      }
    }
  } else {
    if (adminOption) adminOption.remove();
    if (histOption) histOption.remove();
  }

  const isPCP = view === 'PCP';
  const isOperadorView = view === 'Operador';
  const isReport = view === 'Relatorio';
  const isAdmin = view === 'Admin'; 
  const isHistorico = view === 'Historico';

  pcpView.classList.toggle('hidden', !isPCP);
  operatorView.classList.toggle('hidden', !isOperadorView);
  reportView.classList.toggle('hidden', !isReport);
  adminView.classList.toggle('hidden', !isAdmin);
  historicoView.classList.toggle('hidden', !isHistorico);
  
  userViewSelect.value = view;
  userViewSelect.disabled = isOperador(); 
  
  btnCreateOF.classList.toggle('hidden', !isMaster());
  btnProfile.classList.remove('hidden');

  const btnExport = document.getElementById('btn-export-report');
  const btnDelete = document.getElementById('btn-delete-report');
  if(btnExport) btnExport.classList.toggle('hidden', !isMaster());
  if(btnDelete) btnDelete.classList.toggle('hidden', !isMaster());

  if (isPCP){ 
    renderKPIs(); 
    renderOFs(); 
    renderWorkloadChart();
  }
  else if (isOperadorView){ 
    renderTasks();
  }
  else if (isReport){ 
    renderReport();
  }
  else if (isAdmin) {
    renderRoteiros();
  }
  else if (isHistorico) {
    renderHistory();
  }

  injectSearchInputs();
  lucide.createIcons();
}
window.updateView = updateView;

function renderReport(){
  const body = document.getElementById('report-table-body');
  if (!body) return;
  const activeOFIds = Object.keys(allOFs).filter(k => allOFs[k]?.status !== 'Conclu√≠do');
  const activeLogs = allOcurrencesLog.filter(log => activeOFIds.includes(log.OF));
  if (activeLogs.length === 0){
    body.innerHTML = `<tr><td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500">Nenhuma ocorr√™ncia registrada em OFs ativas.</td></tr>`;
    const selectAllCheckbox = document.getElementById('report-select-all');
    if (selectAllCheckbox) selectAllCheckbox.checked = false;
    updateDeleteButtonState();
    return;
  }
  
  const html = activeLogs.map(log=>{
    const atrasoClass = (log.TEMPO_ATRASO||0) > 0 ? 'highlight-red' : 'text-gray-600';
    const pausaClass = (log.TEMPO_PAUSA||0) > 0 ? 'text-yellow-700 font-semibold' : 'text-gray-600';
    
    return `
      <tr class="hover:bg-gray-50">
        <td class="px-2 sm:px-4 py-2 text-center">
          <input type="checkbox" name="report_checkbox" value="${log.id}" 
               onclick="updateDeleteButtonState()"
               class="report-item-checkbox rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
        </td>
        <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${log.OF}</td>
        <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-sm text-gray-600">${log.CHICOTE}</td>
        <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-sm text-gray-600">${log.ATIVIDADE}</td>
        <td class="px-3 sm:px-6 py-2 text-sm text-gray-700">${log.MOTIVO_PAUSA || '-'}</td>
        <td class="px-3 sm:px-6 py-2 text-sm text-gray-700">${log.MOTIVO_ATRASO || '-'}</td>
        <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-sm ${pausaClass}">${(log.TEMPO_PAUSA||0).toFixed(2)}</td>
        <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-sm ${atrasoClass}">${(log.TEMPO_ATRASO||0).toFixed(2)}</td>
      </tr>`;
  }).join('');
  body.innerHTML = html;

  const selectAllCheckbox = document.getElementById('report-select-all');
  if (selectAllCheckbox) selectAllCheckbox.checked = false;
  updateDeleteButtonState();
}

function renderOFs(){
  if (pcpView.classList.contains('hidden')) return;
  let ofs = Object.values(allOFs).filter(of => of.status !== 'Conclu√≠do');
  if (pcpSearchOF) ofs = ofs.filter(of => (of.id || "").toUpperCase().includes(pcpSearchOF));
  const ofsHtml = ofs.map(of=>{
    const tasks = Object.values(allTasks).filter(t=> t.id_of === of.id);
    const completedTasks = tasks.filter(t => t.status === 'Conclu√≠do').length;
    const nextTask = tasks.find(t=> t.status !== 'Conclu√≠do' && t.status !== 'Bloqueada');

    let statusColor = 'bg-gray-100 border-gray-300';
    
    // Calcula o progresso com base nas pe√ßas OK
    const pecasOK = of.pecas_concluidas_ok || 0;
    const pecasTotais = of.quantidade || 1;
    const progress = Math.floor((pecasOK / pecasTotais) * 100);

    if (progress === 0 && of.status === 'Pendente') statusColor = 'bg-gray-200 border-gray-400';
    else if (progress < 100) statusColor = 'bg-blue-100 border-blue-400';
    
    if (of.priority === 'Alta') {
      statusColor = 'bg-red-100 border-red-500';
    } else {
       // A l√≥gica de atraso (amarelo) agora √© mais complexa (baseada no pace)
       // Vamos simplificar: se houver pe√ßas NOK, fica amarelo
       if ((of.pecas_concluidas_nok || 0) > 0) {
          statusColor = 'bg-yellow-100 border-yellow-500';
       }
    }
    
    const p50_min = of.tempo_planejado_p50_min || 0;
    const p95_min = of.tempo_planejado_p95_min || 0;
    const pLabel = (of.percentil_confianca || 0.95) * 100;
    return `
      <div class="${statusColor} p-4 rounded-xl border border-gray-300 ${statusColor.replace('bg-', 'border-')}"
           onclick="openOFDetails('${of.id}')">
        <h3 class="text-lg font-bold text-gray-800 mb-1 flex justify-between items-center">
          ${of.id} - REV ${of.revisao_number || 1}
          ${of.status === 'Conclu√≠do' ? '<i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>' : (nextTask ? '<i data-lucide="play-circle" class="w-5 h-5 text-blue-600"></i>' : '<i data-lucide="pause-circle" class="w-5 h-5 text-yellow-600"></i>')}
        </h3>
        <p class="text-sm text-gray-600 mb-3">${of.chicote} | Qtd: ${of.quantidade}</p>
        
        <div class="grid grid-cols-2 gap-2 text-xs mb-2">
           <div class="bg-white/50 p-2 rounded">
              <span class="text-gray-500">Esperado (P50)</span>
              <span class="font-bold text-gray-800 block">${formatMinutes(p50_min)}</span>
           </div>
           <div class="bg-white/50 p-2 rounded">
             <span class="text-gray-500">Confi√°vel (P${pLabel})</span>
              <span class="font-bold text-blue-700 block">${formatMinutes(p95_min)}</span>
           </div>
        </div>

        <div class="flex justify-between items-center mb-1">
          <span class="text-xs font-semibold text-gray-600">${progress}% Conclu√≠do (Pe√ßas OK)</span>
          <span class="text-xs font-medium text-gray-500">${completedTasks} / ${tasks.length} etapas</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-1.5">
          <div class="h-1.5 rounded-full bg-blue-500" style="width:${progress}%"></div>
        </div>
        <p class="text-xs mt-2 text-gray-700 font-medium">Pr√≥xima Etapa: ${nextTask ? nextTask.nome_atividade : (of.status === 'Conclu√≠do' ? 'Finalizada' : 'N/A')}</p>
      </div>
    `;
  }).join('');
  ofsListContainer.innerHTML = ofsHtml.length > 0 ? ofsHtml : '<div class="col-span-3 p-6 text-center text-gray-500 bg-white rounded-xl border border-gray-300">Nenhuma OF ativa.</div>';
  lucide.createIcons();
}
// ===== FIM DA EDI√á√ÉO PRODU√á√ÉO PARCIAL (renderOFs) =====

// ===== IN√çCIO DA CORRE√á√ÉO DEFINITIVA (renderTasks) =====
function renderTasks(){
  if (operatorView.classList.contains('hidden')) return;
  // [NOVA VERIFICA√á√ÉO PARA O MASTER] Se for Master e nenhum setor foi selecionado
  if (!currentSectorFilter && isMaster()) {
    tasksListContainer.innerHTML = `
      <div class="p-6 text-center text-gray-500 bg-white rounded-xl border border-gray-300">
        <i data-lucide="info" class="w-8 h-8 mx-auto mb-2 text-blue-500"></i>
        <p class="font-semibold">Vis√£o de Master</p>
        <p class="text-sm">Por favor, selecione um setor no filtro acima para ver as tarefas.</p>
      </div>`;
    lucide.createIcons();
    return;
  }
  
  const tasks = Object.values(allTasks)
    .filter(t => {
      // FILTRO ROBUSTO (Grampea√ß√£o fix)
      const setorTarefa = (t.setor || '').trim().toLowerCase();
      const filtroSetor = (currentSectorFilter || '').trim().toLowerCase();
      
      return setorTarefa === filtroSetor &&
             (t.status !== 'Conclu√≠do' && t.status !== 'Bloqueada') && 
             (!operatorSearchOF || (t.id_of || "").toUpperCase().includes(operatorSearchOF));
    })
    .sort((a,b) => {
      // ORDENA√á√ÉO CORRIGIDA
      const priorityA = a.priority === 'Alta' ? 1 : (a.priority === 'Media' ? 2 : 3);
      const priorityB = b.priority === 'Alta' ? 1 : (b.priority === 'Media' ? 2 : 3);
      if (priorityA !== priorityB) return priorityA - priorityB;
      
      // Prioriza tarefas ativas (Em Setup ou Em Produ√ß√£o)
      
      const aIsActive = a.status === 'Em Setup' || a.status === 'Em Produ√ß√£o';
      const bIsActive = b.status === 'Em Setup' || b.status === 'Em Produ√ß√£o';

      if (aIsActive && !bIsActive) return -1;
      if (!aIsActive && bIsActive) return 1;
      
      return a.ordem - b.ordem;
    });
  const tasksHtml = tasks.map(task=>{
    const tempoReal = calculateTempoRealMinutes(task); 
    
    // O desvio √© SEMPRE contra a meta ORIGINAL total
    const desvio = calculateDesvio(task);
    
    const totalPauseMinutes = calculateTotalPauseMinutes(task);

    let statusText = task.status;
    let actions = '';
    
    // Define os bot√µes com base no Status e Tipo de Tarefa
    switch(task.status) {
        case 'Em Espera':
            statusText = 'Aguardando In√≠cio';
            actions = `<button onclick="startTask('${task.id}')" class="px-3 py-1.5 text-sm bg-gray-700 text-white rounded-lg hover:bg-gray-600">
                         <i data-lucide="play" class="w-4 h-4 inline-block mr-1"></i>
                         ${task.is_setup_task ? 'Iniciar Setup' : 'Iniciar Produ√ß√£o'}
                       </button>`;
            break;
        
        case 'Em Setup':
            statusText = 'Em Setup';
            actions = `<button onclick="pauseTask('${task.id}')" class="px-3 py-1.5 text-sm bg-amber-500 text-white rounded-lg hover:bg-amber-600">
                         <i data-lucide="pause" class="w-4 h-4 inline-block mr-1"></i>Pausar
                       </button>
                       <button onclick="finishTask('${task.id}')" class="px-3 py-1.5 text-sm bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">
                         <i data-lucide="check" class="w-4 h-4 inline-block mr-1"></i>Concluir Setup
                       </button>`;
            break;
            
        case 'Em Produ√ß√£o':
            statusText = 'Em Produ√ß√£o';
            actions = `<button onclick="pauseTask('${task.id}')" class="px-3 py-1.5 text-sm bg-amber-500 text-white rounded-lg hover:bg-amber-600">
                         <i data-lucide="pause" class="w-4 h-4 inline-block mr-1"></i>Pausar
                       </button>
                       <button onclick="reportProduction('${task.id}')" class="px-3 py-1.5 text-sm bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">
                         <i data-lucide="save" class="w-4 h-4 inline-block mr-1"></i>Reportar
                       </button>`;
            break;
            
        case 'Setup Pausado':
            statusText = 'Setup Pausado';
            actions = `<button onclick="startTask('${task.id}')" class="px-3 py-1.5 text-sm bg-gray-700 text-white rounded-lg hover:bg-gray-600">
                         <i data-lucide="play" class="w-4 h-4 inline-block mr-1"></i>Retomar Setup
                       </button>`;
            break;
            
        case 'Produ√ß√£o Pausada':
            statusText = 'Produ√ß√£o Pausada';
            actions = `<button onclick="startTask('${task.id}')" class="px-3 py-1.5 text-sm bg-gray-700 text-white rounded-lg hover:bg-gray-600">
                         <i data-lucide="play" class="w-4 h-4 inline-block mr-1"></i>Retomar Produ√ß√£o
                       </button>`;
            break;
            
        case 'Pausada':
            statusText = 'Pausada';
            actions = `<button onclick="startTask('${task.id}')" class="px-3 py-1.5 text-sm bg-gray-700 text-white rounded-lg hover:bg-gray-600">
                         <i data-lucide="play" class="w-4 h-4 inline-block mr-1"></i>${task.is_setup_task ? 'Retomar Setup' : 'Retomar Produ√ß√£o'}
                       </button>`;
            break;
    }

    const priorityClass = getPriorityClass(task.priority);

    // --- L√ìGICA DE TEMPO RESTANTE ---
    const p50_total_original = task.tempo_planejado_p50_min || 0;
    const p95_total_original = task.tempo_planejado_p95_min || 0;
    
    let p50_exibido = p50_total_original;
    let p95_exibido = p95_total_original;

    const pecasOK = task.pecas_concluidas_ok || 0;
    const pecasTotais = task.quantidade_pecas || 1;
    
    if (!task.is_setup_task && pecasOK > 0 && pecasOK < pecasTotais) {
        const pecasRestantes = Math.max(0, pecasTotais - pecasOK);
        const setup_p50 = task.media_setup_min || 0; 
        const p50_ciclo_total = p50_total_original - setup_p50;
        const p50_por_peca = (p50_ciclo_total > 0 && pecasTotais > 0) ? (p50_ciclo_total / pecasTotais) : 0;
        p50_exibido = p50_por_peca * pecasRestantes;

        const setup_p95_aprox = setup_p50;
        const p95_ciclo_total = p95_total_original - setup_p95_aprox;
        const p95_por_peca = (p95_ciclo_total > 0 && pecasTotais > 0) ? (p95_ciclo_total / pecasTotais) : 0;
        p95_exibido = p95_por_peca * pecasRestantes;
    }
    // --- FIM DA L√ìGICA DE TEMPO RESTANTE ---
    
    // Barra de Progresso Parcial (s√≥ para tarefas de produ√ß√£o)
    let progressBar = '';
    if (!task.is_setup_task) {
        const pecasNOK = task.pecas_concluidas_nok || 0;
        const percOK = (pecasOK / pecasTotais) * 100;
        const percNOK = (pecasNOK / pecasTotais) * 100;
        progressBar = `
          <div class="mt-2">
            <p class="text-xs text-gray-600">Progresso: 
                <span class="font-semibold text-green-600">${pecasOK} OK</span> |
                <span class="font-semibold text-red-600">${pecasNOK} NOK</span>
                (${Math.floor(percOK + percNOK)}%)
            </p>
            <div class="task-progress-bar-container">
              <div class="flex h-full">
                <div class="task-progress-bar-ok" style="width:${percOK}%"></div>
                <div class="task-progress-bar-nok" style="width:${percNOK}%"></div>
              </div>
            </div>
          </div>
        `;
    }

    return `
      <div class="${priorityClass} border border-gray-300 p-3 sm:p-4 rounded-xl">
        <div class="flex justify-between items-center mb-2">
          <div>
            <p class="text-sm font-bold text-gray-800">${task.nome_atividade} ${task.is_setup_task ? '(SETUP)' : ''}</p>
            <p class="text-xs text-gray-600">OF <span class="font-semibold">${task.id_of}</span> ‚Ä¢ Qtd: ${task.quantidade_pecas}</p>
          </div>
          <button class="p-2 rounded-lg hover:bg-gray-100" title="Instru√ß√£o de Trabalho" onclick="openInstructionModal('${task.id}')">
            <i data-lucide="book" class="w-5 h-5"></i>
          </button>
        </div>
        
        <div class="grid grid-cols-2 gap-2 text-xs sm:text-sm mb-2">
          <div class="bg-white/50 p-2 rounded">
             <span class="text-gray-500">Tempo Esperado (P50)</span>
             <span class="font-semibold text-gray-800 block">${formatMinutes(p50_exibido)}</span>
          </div>
          <div class="bg-white/50 p-2 rounded border border-blue-300">
             <span class="text-gray-500">Meta Confi√°vel (P95)</span>
             <span class="font-bold text-blue-700 block">${formatMinutes(p95_exibido)}</span>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2 text-xs sm:text-sm">
          <div><span class="text-gray-500">Pausa:</span> <span class="font-semibold">${formatMinutes(totalPauseMinutes)}</span></div>
        </div>
        
        ${progressBar}
        
        <div class="mt-2 flex justify-between items-center">
          <span class="text-xs font-semibold ${desvio < 0 ? 'text-red-600' : 'text-gray-700'}">Desvio (vs Meta P95): ${desvio < 0 ? '-' : ''}${formatMinutes(Math.abs(desvio))}</span>
          <span class="text-xs font-medium text-gray-600">${statusText}</span>
        </div>
        <div class="mt-3 flex gap-2">${actions}</div>
      </div>
    `;
  }).join('');

  tasksListContainer.innerHTML = tasksHtml.length > 0 ? tasksHtml : '<div class="p-6 text-center text-gray-500 bg-white rounded-xl border border-gray-300">Sem tarefas para este setor/OF.</div>';
  lucide.createIcons();
}
// ===== FIM DA CORRE√á√ÉO DEFINITIVA (renderTasks) =====

function renderHistory() {
    if (historicoView.classList.contains('hidden')) return;

    let historyOFs = Object.values(allOFs).filter(of => of.status === 'Conclu√≠do');
    
    if (historicoSearchOF) historyOFs = historyOFs.filter(of => (of.id || "").toUpperCase().includes(historicoSearchOF));
    
    historyOFs.sort((a, b) => {
        const dateA = getDBTimestamp(a.data_criacao); 
        const dateB = getDBTimestamp(b.data_criacao);
        return dateB - dateA;
    });

    const historyHtml = historyOFs.map(of => {
        const tasks = Object.values(allTasks).filter(t => t.id_of === of.id);
        const totalTempoReal = tasks.reduce((sum, t) => sum + calculateTempoRealMinutes(t), 0);
        
        const p50_min = of.tempo_planejado_p50_min || 0;
        const p95_min = of.tempo_planejado_p95_min || 0;
        const desvioTotal = p95_min - totalTempoReal;

        const desvioClass = desvioTotal < 0 ? 'text-red-600' : 'text-green-600';
        const desvioText = desvioTotal < 0 ? `-${formatMinutes(Math.abs(desvioTotal))}` : `+${formatMinutes(desvioTotal)}`;
        
        const pecasOK = of.pecas_concluidas_ok || 0;
        const pecasNOK = of.pecas_concluidas_nok || 0;

        return `
            <div class="of-concluida-card p-4 rounded-xl border border-gray-300"
                 onclick="openOFDetails('${of.id}', true)">
                <h3 class="text-lg font-bold text-gray-800 mb-1 flex justify-between items-center">
                    ${of.id} - REV ${of.revisao_number || 1}
                    <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                </h3>
                
                <p class="text-sm text-gray-600 mb-2">${of.chicote} | Qtd: ${of.quantidade}</p>
                <p class="text-sm font-semibold mb-2">
                   <span class="text-green-600">Pe√ßas OK: ${pecasOK}</span> |
                   <span class="text-red-600">Pe√ßas NOK: ${pecasNOK}</span>
                </p>

                <div class="space-y-1 text-sm">
                    <p class="text-gray-700">Criado em: <span class="font-semibold">${formatDate(of.data_criacao)}</span></p>
                    <p class="text-gray-700">Tempo Real: <span class="font-semibold">${formatMinutes(totalTempoReal)}</span></p>
                    <p class="text-gray-700">Meta Confi√°vel (P95): <span class="font-semibold">${formatMinutes(p95_min)}</span></p>
                    <p class="font-bold ${desvioClass}">Desvio Total (vs Meta P95): ${desvioText}</p>
                </div>
            </div>
        `;
    }).join('');

    const container = document.getElementById('historico-list-container');
    container.innerHTML = historyHtml.length > 0 ?
    historyHtml : '<div class="col-span-3 p-6 text-center text-gray-500 bg-white rounded-xl border border-gray-300">Nenhuma OF conclu√≠da no hist√≥rico.</div>';
    lucide.createIcons();
}


/* ============================
  DETALHES / EXPORTS
  ============================ */
// Helper para agrupar tarefas por setor
function groupTasksBySector(tasks) {
    const grouped = tasks.reduce((acc, task) => {
        const setor = task.setor || 'Setor N√£o Definido';
        if (!acc[setor]) {
            acc[setor] = [];
        }
        acc[setor].push(task);
        return acc;
    }, {});
    
    // Ordena os grupos pela ordem dos setores
    const orderedGroups = {};
    const sortedSectorNames = getSortedSectors(Object.keys(grouped));

    sortedSectorNames.forEach(sector => {
        if (grouped[sector]) {
            // Ordena as tarefas dentro do setor
            orderedGroups[sector] = grouped[sector].sort((a, b) => (a.ordem || 0) - (b.ordem || 0));
            delete grouped[sector]; 
        }
    });
    
    return orderedGroups;
}

// openOFDetails com Agrupamento por Setor
function openOFDetails(ofId, isHistory = false){
  window.__ofDetailsOpenId = ofId;
  const of = allOFs[ofId];
  const tasks = Object.values(allTasks).filter(t=> t.id_of === ofId);
  
  const pecasOK = of.pecas_concluidas_ok || 0;
  const pecasNOK = of.pecas_concluidas_nok || 0;
  const pecasTotais = of.quantidade || 1;
  const progress = Math.floor((pecasOK / pecasTotais) * 100);
  const p50_min = of.tempo_planejado_p50_min || 0;
  const p95_min = of.tempo_planejado_p95_min || 0;
  const pLabel = (of.percentil_confianca || 0.95) * 100;
  
  document.getElementById('of-details-title').textContent = `OF ${ofId} ‚Äî ${of.chicote} (REV ${of.revisao_number || 1})`;
  document.getElementById('of-details-summary').innerHTML = `
    <div class="bg-gray-50 p-2 rounded-lg"><p class="text-xs text-gray-500">Qtd Prevista</p><p class="font-semibold">${of.quantidade}</p></div>
    <div class="bg-gray-50 p-2 rounded-lg"><p class="text-xs text-gray-500">Pe√ßas OK</p><p class="font-bold text-green-600">${pecasOK}</p></div>
    <div class="bg-gray-50 p-2 rounded-lg"><p class="text-xs text-gray-500">Pe√ßas NOK</p><p class="font-bold text-red-600">${pecasNOK}</p></div>
    <div class="bg-gray-50 p-2 rounded-lg"><p class="text-xs text-gray-500">Meta (P${pLabel})</p><p class="font-bold text-blue-700">${formatMinutes(p95_min)}</p></div>
  `;
  document.getElementById('of-details-progress').style.width = `${progress}%`;
  
  // --- NOVO AGRUPAMENTO POR SETOR ---
  const groupedTasks = groupTasksBySector(tasks);
  
  let content = '';
  const totalTempoReal = tasks.reduce((sum, t) => sum + calculateTempoRealMinutes(t), 0);
  
  // Renderiza o resumo por setor
  for (const setor in groupedTasks) {
    const setorTasks = groupedTasks[setor];
    const setorTotalTime = setorTasks.reduce((sum, t) => sum + calculateTempoRealMinutes(t), 0);
    const setorTotalP95 = setorTasks.reduce((sum, t) => sum + (t.tempo_planejado_p95_min || 0), 0);
    
    // Header do Setor
    content += `
      <div class="mt-4 border-b border-gray-300 pb-1 flex justify-between items-center bg-gray-50 p-2 rounded-t-lg">
        <h4 class="text-base font-bold text-gray-800 flex items-center">
            <i data-lucide="layers" class="w-4 h-4 mr-2 text-indigo-600"></i> ${setor} 
        </h4>
        <span class="text-xs text-gray-600">Total Setor: ${formatMinutes(setorTotalTime)} (Meta: ${formatMinutes(setorTotalP95)})</span>
      </div>
    `;
    
    // Lista de Tarefas do Setor
    setorTasks.forEach(task => {
        const tempoReal = calculateTempoRealMinutes(task); 
        const desvio = (task.tempo_planejado_p95_min || 0) - tempoReal;
        
        let partialInfo = '';
        if (!task.is_setup_task) {
            partialInfo = `
              <div class="grid grid-cols-2 sm:grid-cols-2 gap-2 text-xs sm:text-sm mt-2">
                <div><span class="text-gray-500">Pe√ßas OK:</span> <span class="font-semibold text-green-600">${task.pecas_concluidas_ok || 0}</span></div>
                <div><span class="text-gray-500">Pe√ßas NOK:</span> <span class="font-semibold text-red-600">${task.pecas_concluidas_nok || 0}</span></div>
              </div>`;
        }
        
        content += `
          <div class="border rounded-lg p-3 mt-1">
            <div class="flex justify-between">
              <p class="font-semibold">${task.ordem}. ${task.nome_atividade} ${task.is_setup_task ? '(SETUP)' : ''}</p>
              <span class="text-xs ${task.status==='Conclu√≠do'?'text-green-700':'text-gray-600'}">${task.status}</span>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs sm:text-sm mt-2">
              <div><span class="text-gray-500">Esperado (P50):</span> <span class="font-semibold">${formatMinutes(task.tempo_planejado_p50_min)}</span></div>
              <div><span class="text-gray-500">Meta (P95):</span> <span class="font-bold text-blue-700">${formatMinutes(task.tempo_planejado_p95_min)}</span></div>
              <div><span class="text-gray-500">Real:</span> <span class="font-semibold">${formatMinutes(tempoReal)}</span></div>
              <div><span class="text-gray-500">Pausa:</span> <span class="font-semibold">${formatMinutes(calculateTotalPauseMinutesFinal(task))}</span></div>
            </div>
            ${partialInfo}
            <p class="mt-1 text-xs ${desvio<0?'text-red-600':'text-gray-700'}">Desvio (vs Meta P95): ${desvio<0?'-':''}${formatMinutes(Math.abs(desvio))}</p>
          </div>
        `;
    });
  }
  
  // --- AUDITORIA E BOT√ïES ---
  let auditLogHtml = "";
  if (isMaster()) {
      auditLogHtml = `
      <a id="audit-log-toggle" href="#" class="text-sm text-blue-600 hover:underline mt-4 block" onclick="toggleAuditLog(); return false;">
          Ver Detalhes do C√°lculo (Master)
      </a>
      <div id="audit-log-details" class="audit-log">
          <h4>Auditoria de C√°lculo Monte Carlo (P${pLabel})</h4>
          ${of.audit_log_html || "<p>Log de auditoria n√£o encontrado.</p>"}
      </div>
      `;
  }
  
  document.getElementById('of-details-content').innerHTML = content + auditLogHtml;

  // Gerencia a visibilidade do bot√£o de Excluir
  const btnDelete = document.getElementById('btn-delete-of');
  btnDelete.classList.toggle('hidden', !isMaster() || isHistory);
  
  openModal('of-details-modal');
  lucide.createIcons();
}

// Helper para o toggle do log de auditoria
function toggleAuditLog() {
    const logDiv = document.getElementById('audit-log-details');
    if (logDiv) {
        logDiv.style.display = logDiv.style.display === 'none' ? 'block' : 'none';
    }
}
window.toggleAuditLog = toggleAuditLog;

function exportReportCSV(){
  const rows = [["OF","CHICOTE","ATIVIDADE","MOTIVO_PAUSA","MOTIVO_ATRASO","T. PAUSA (min)","T. ATRASO (min)"]];
  allOcurrencesLog.forEach(l => {
    rows.push([l.OF, l.CHICOTE, l.ATIVIDADE, l.MOTIVO_PAUSA||"", l.MOTIVO_ATRASO||"", (l.TEMPO_PAUSA||0).toFixed(2), (l.TEMPO_ATRASO||0).toFixed(2)]);
  });
  downloadCSV(rows, `relatorio_ocorrencias_${new Date().toISOString().slice(0,10)}.csv`);
}

function updateDeleteButtonState() {
  const btn = document.getElementById('btn-delete-report');
  if (!btn) return;
  const anyChecked = document.querySelectorAll('#report-table-body .report-item-checkbox:checked').length > 0;
  btn.disabled = !anyChecked;
  if (!anyChecked) {
    const selectAllCheckbox = document.getElementById('report-select-all');
    if (selectAllCheckbox) selectAllCheckbox.checked = false;
  }
}

function toggleSelectAllOcorrencias(checkbox) {
  const checkboxes = document.querySelectorAll('#report-table-body .report-item-checkbox');
  checkboxes.forEach(cb => {
    cb.checked = checkbox.checked;
  });
  updateDeleteButtonState();
}

async function deleteSelectedOcorrencias() {
  const selectedIds = Array.from(document.querySelectorAll('#report-table-body .report-item-checkbox:checked')).map(cb => cb.value);
  if (selectedIds.length === 0) {
    alert("Nenhuma ocorr√™ncia selecionada.");
    return;
  }
  if (!confirm(`Tem certeza que deseja excluir ${selectedIds.length} ocorr√™ncia(s)? Esta a√ß√£o n√£o pode ser desfeita.`)) {
    return;
  }
  const btn = document.getElementById('btn-delete-report');
  if (btn) btn.disabled = true;
  try {
    if (window.db) {
      const batch = db.batch();
      selectedIds.forEach(id => {
        batch.delete(db.collection(OCORRENCIA_COLLECTION).doc(id));
      });
      await batch.commit();
    } else {
      allOcurrencesLog = allOcurrencesLog.filter(log => !selectedIds.includes(log.id));
      localStorage.setItem('sim_ocorrencias', JSON.stringify(allOcurrencesLog));
      renderReport();
    }
  } catch (e) {
    alert("Erro ao excluir ocorr√™ncias: " + e.message);
    if (btn) btn.disabled = false;
  }
}

// exportOFTasksCSV - COM CORRE√á√ÉO DE PAUSAS
function exportOFTasksCSV(ofId){
  const tasks = Object.values(allTasks).filter(t => t.id_of === ofId);
  const rows = [
    ["OF","CHICOTE","ATIVIDADE","SETOR","STATUS", "TIPO_TAREFA",
     "PECAS_OK", "PECAS_NOK",
     "ESPERADO_P50(min)", "CONFI√ÅVEL_P95(min)",
     "REAL(min)","DESVIO(vs_P95)(min)", "FADIGA(%)",
     "TEMPO_PAUSA_TOTAL(min)", "MOTIVOS_PAUSA", // NOVAS COLUNAS
     "MEDIA_CICLO(min)", "DESVIO_CICLO(min)", "MEDIA_SETUP(min)", "DESVIO_SETUP(min)"
    ]
  ];
  
  tasks.forEach(t => {
    // Busca todos os logs de pausa para esta tarefa espec√≠fica
    const logsPausa = allOcurrencesLog.filter(l => 
        l.OF === t.id_of && 
        l.ATIVIDADE === t.nome_atividade && 
        l.TIPO === 'PAUSA'
    );

    // Soma o tempo de pausa (dos logs) - ou usa o da tarefa se preferir
    // Vamos usar a soma dos logs para bater com os motivos listados
    const tempoPausaLogs = logsPausa.reduce((acc, l) => acc + (l.TEMPO_PAUSA || 0), 0);
    
    // Concatena os motivos
    const motivosPausa = logsPausa.map(l => l.MOTIVO_PAUSA).filter(Boolean).join('; ');

    rows.push([
      t.id_of, t.nome_atividade, t.setor, t.status, (t.is_setup_task ? "SETUP" : "PRODUCAO"),
      t.pecas_concluidas_ok || 0, t.pecas_concluidas_nok || 0,
      Number(t.tempo_planejado_p50_min).toFixed(2), 
      Number(t.tempo_planejado_p95_min).toFixed(2), 
      calculateTempoRealMinutes(t).toFixed(2), 
      calculateDesvio(t).toFixed(2),
      (t.fator_fadiga_perc || 0),
      tempoPausaLogs.toFixed(2),  // NOVA COLUNA
      motivosPausa,               // NOVA COLUNA
      (t.media_ciclo_min || 0).toFixed(4),
      (t.desvio_ciclo_min || 0).toFixed(4),
      (t.media_setup_min || 0).toFixed(2),
      (t.desvio_setup_min || 0).toFixed(2)
    ]);
  });
  
  downloadCSV(rows, `of_${ofId}_tasks_${new Date().toISOString().slice(0,10)}.csv`);
}

function downloadCSV(rows, filename){
  const csvContent = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(';')).join('\n');
  const blob = new Blob(['\uFEFF' + csvContent], {type:'text/csv;charset=utf-8;'});
  
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

/* ============================
  ROTEIROS (Renderiza na tela Admin - Hier√°rquico)
  ============================ */
// renderRoteiros com Hierarquia e Fix
function renderRoteiros(){
  const list = document.getElementById('roteiro-list-admin'); 
  if (!list) return;
  
  // FIX: Filtra entradas nulas, indefinidas ou corrompidas do localStorage
  let roteiros = Object.values(allRoteiros).filter(r => r && typeof r === 'object' && r.chicote_nome);
  
  // --- L√ìGICA DE FILTRO ---
  if (roteiroSearchTerm) {
      roteiros = roteiros.filter(r => 
          (r.roteiro_id_base || r.chicote_nome || '').toUpperCase().includes(roteiroSearchTerm)
      );
  }
  // --- FIM L√ìGICA DE FILTRO ---

  // 1. Agrupa as etapas por ID Base
  const groupedByIdBase = roteiros.reduce((acc, r) => {
      const idBase = r.roteiro_id_base || r.chicote_nome || 'N√ÉO_DEFINIDO';
      if (!acc[idBase]) {
          acc[idBase] = [];
      }
      acc[idBase].push(r);
      return acc;
  }, {});

  let items = '';
  
  // Ordena os IDs Base
  const sortedIdsBase = Object.keys(groupedByIdBase).sort();

  // 2. Itera sobre cada ID Base (Produto Mestre)
  sortedIdsBase.forEach(idBase => {
      let roteirosBase = groupedByIdBase[idBase];
      
      // Encontra a maior revis√£o
      const maxRevision = roteirosBase.reduce((max, r) => Math.max(max, r.revisao_number || 0), 0);
      let latestRoteiros = roteirosBase.filter(r => (r.revisao_number || 0) === maxRevision);
      
      // Conting√™ncia para dados legados (sem revisao_number)
      if (latestRoteiros.length === 0) {
          latestRoteiros = roteirosBase.filter(r => !r.revisao_number && maxRevision === 0);
      }
      
      if (latestRoteiros.length === 0) return; // Se ainda estiver vazio, pula

      const latestChicoteName = latestRoteiros[0]?.chicote_nome || idBase;

      // 2.1. Agrupamento por Setor DENTRO do Chicote
      const groupedBySector = latestRoteiros.reduce((acc, r) => {
          const setor = r.setor || 'Outros Setores';
          if (!acc[setor]) acc[setor] = [];
          acc[setor].push(r);
          return acc;
      }, {});

      // 2.2. Ordena os Setores para exibi√ß√£o
      const sortedSectors = getSortedSectors(Object.keys(groupedBySector));

      // 3. Renderiza os detalhes das etapas por Setor
      let setoresHtml = '';
      sortedSectors.forEach(setor => {
          const setorRoteiros = groupedBySector[setor];
          
          setorRoteiros.sort((a, b) => (a.ordem || 0) - (b.ordem || 0));

          setoresHtml += `
              <div class="mt-4 first:mt-0">
                  <h4 class="text-sm font-bold text-indigo-700 bg-indigo-50 p-2 rounded-t-lg border-b border-indigo-200">
                      <i data-lucide="layers-2" class="w-4 h-4 inline-block mr-1"></i> ${setor} (${setorRoteiros.length} Etapa${setorRoteiros.length > 1 ? 's' : ''})
                  </h4>
                  ${setorRoteiros.map(r => `
                      <div class="bg-white p-3 border-b flex justify-between items-center text-xs">
                          <div>
                              <p class="font-semibold text-gray-700">${r.ordem || '-'}. ${r.nome_atividade} 
                                  ${r.is_setup_task ? '<span class="text-xs font-semibold text-indigo-600 bg-indigo-100 px-2 py-0.5 rounded-full ml-1">SETUP</span>' : ''}
                              </p>
                              <p class="text-gray-500 mt-0.5">Fadiga: ${r.fator_fadiga_perc || 0}%</p>
                              <p class="text-gray-500">Ciclo: ${formatMinutes(r.media_ciclo_min)} / Setup: ${formatMinutes(r.media_setup_min)}</p>
                          </div>
                          <button class="px-2 py-1 text-xs bg-red-600 text-white rounded-lg hover:bg-red-700 mt-1" onclick="event.stopPropagation(); deleteRoteiroActivity('${r.id}')">Excluir</button>
                      </div>
                  `).join('')}
              </div>
          `;
      });
      
      // 4. Cria o Card Mestre Colaps√°vel
      const totalEtapas = latestRoteiros.length;
      const collapseId = `roteiro-collapse-${idBase.replace(/[^a-zA-Z0-9]/g, '_')}`;
      items += `
          <div class="bg-white border rounded-lg shadow-sm">
              <div class="p-4 cursor-pointer flex justify-between items-center" 
                   onclick="document.getElementById('${collapseId}').classList.toggle('hidden'); lucide.createIcons();">
                  
                  <h3 class="text-base font-bold text-gray-800">
                      <i data-lucide="package" class="w-4 h-4 inline-block mr-2 text-indigo-600"></i>
                      ${idBase} <span class="text-sm font-medium text-red-600">(REV ${maxRevision || 'Legado'})</span>
                  </h3>
                  <span class="text-sm text-gray-600">${latestChicoteName} | ${totalEtapas} Etapa${totalEtapas > 1 ? 's' : ''}</span>
              </div>
              
              <div id="${collapseId}" class="hidden p-4 border-t">
                  ${setoresHtml}
              </div>
          </div>
      `;
  });

  list.innerHTML = items || '<div class="p-4 text-center text-gray-500 bg-white rounded-lg">Nenhum roteiro cadastrado.</div>';
  lucide.createIcons();
}
// FIM renderRoteiros


/* ============================
  BOOTSTRAP
  ============================ */
document.addEventListener('DOMContentLoaded', () => {
  initializeApp();
  lucide.createIcons();
});
// Exposi√ß√£o global
window.startTask = startTask;
window.pauseTask = pauseTask;
window.finishTask = finishTask;
window.reportProduction = reportProduction; 
window.handleConfirmedAction = handleConfirmedAction;
window.handleReportProduction = handleReportProduction; 
window.openOFDetails = openOFDetails;
window.openInstructionModal = openInstructionModal;
window.openModal = openModal;
window.closeModal = closeModal;
window.createOF = createOF;
// Exposi√ß√£o Rascunho/Revis√£o
window.addEtapaToDraft = addEtapaToDraft;
window.clearDraft = clearDraft;
window.saveRoteiroFromDraft = saveRoteiroFromDraft;
window.updateDraftInfo = updateDraftInfo;
window.removeDraftTask = removeDraftTask;
// Exposi√ß√£o Gr√°fico
window.openChartModal = openChartModal;

window.deleteRoteiroActivity = deleteRoteiroActivity;
window.deleteOF = deleteOF;
window.exportReportCSV = exportReportCSV;
window.exportOFTasksCSV = exportOFTasksCSV;
window.openUserModal = openUserModal;
window.confirmUser = confirmUser;
window.updateSectorFilter = updateSectorFilter;

window.deleteSelectedOcorrencias = deleteSelectedOcorrencias;
window.toggleSelectAllOcorrencias = toggleSelectAllOcorrencias;
window.updateDeleteButtonState = updateDeleteButtonState;
window.renderHistory = renderHistory;
</script>
</body>
</html>

