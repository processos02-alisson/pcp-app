<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema PCP: Controle de Produ√ß√£o e Roteiros (Firebase Edition)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap");
    :root { color-scheme: light dark; }
    body { font-family: "Inter", sans-serif; }
    .bg-gradient-header { background: linear-gradient(90deg, #1e40af 0%, #3b82f6 100%); }
    .modal-fixed { position: fixed; inset: 0; }
    #instruction-modal-content a { color: #3b82f6; text-decoration: underline; font-weight: 600; }
    .highlight-red { color: #dc2626; font-weight: 600; }

    /* ---------- Mobile tweaks ---------- */
    /* Deixa os modais em fullscreen no mobile, mantendo max-width no desktop */
    .modal-panel { max-height: calc(100dvh - 2rem); }
    @media (max-width: 640px) {
      .modal-panel {
        width: 100vw !important; max-width: 100vw !important;
        height: 100dvh !important; max-height: 100dvh !important;
        border-radius: 0 !important; margin: 0 !important;
        display: flex; flex-direction: column;
      }
      .modal-body-scroll {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      .sticky-footer {
        position: sticky;
        bottom: 0;
        background: white;
        padding-top: .5rem;
      }
      .card-tap-big { padding: 1rem; }
    }

    /* Safe areas (notch iOS) */
    body {
      padding-left: max(env(safe-area-inset-left), 0px);
      padding-right: max(env(safe-area-inset-right), 0px);
    }
  </style>
</head>
<body class="min-h-screen bg-gray-100 antialiased">

  <header id="header-container" class="bg-gradient-header shadow-lg p-3 sm:p-4 sticky top-0 z-10">
    <div class="max-w-7xl mx-auto flex justify-between items-center gap-2">
      <h1 class="text-2xl sm:text-3xl font-extrabold text-white flex items-center">
        <i data-lucide="factory" class="w-7 h-7 sm:w-8 sm:h-8 mr-2"></i>
        Controle de Produ√ß√£o e Processos
      </h1>
      <div class="flex gap-2 items-center">
        <button id="btn-profile"
                class="text-white bg-blue-800 hover:bg-blue-700 font-semibold py-2 px-3 rounded-lg shadow-md transition hidden"
                onclick="openUserModal()">
          <i data-lucide="user-cog" class="w-5 h-5 inline-block mr-1"></i>
          <span class="hidden sm:inline">Perfil</span>
        </button>

        <select id="user-view-select"
                onchange="updateView(this.value)"
                class="bg-blue-800 text-white text-xs sm:text-sm font-semibold py-2 px-2 rounded-lg transition hover:bg-blue-700 focus:ring-2 focus:ring-blue-300">
          <option value="PCP">Vis√£o: PCP (Gerencial)</option>
          <option value="Operador">Vis√£o: Operador</option>
          <option value="Relatorio">Vis√£o: Relat√≥rio</option>
        </select>

        <button onclick="openModal('create-of-modal')" id="btn-create-of"
                class="text-white bg-green-600 hover:bg-green-700 font-semibold py-2 px-3 rounded-lg shadow-md transition hidden">
          <i data-lucide="plus" class="w-5 h-5 inline-block mr-1"></i>
          <span class="hidden sm:inline">Criar OF</span>
        </button>
        <button onclick="openModal('setup-roteiro-modal')" id="btn-setup-roteiro"
                class="text-white bg-yellow-600 hover:bg-yellow-700 font-semibold py-2 px-3 rounded-lg shadow-md transition hidden">
          <i data-lucide="settings" class="w-5 h-5 inline-block mr-1"></i>
          <span class="hidden sm:inline">Setup Roteiro</span>
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-3 sm:p-6 lg:p-8">
    <div id="loading-indicator" class="flex flex-col items-center justify-center p-6 sm:p-12 bg-white rounded-xl shadow-xl">
      <i data-lucide="loader-circle" class="w-8 h-8 sm:w-10 sm:h-10 text-blue-500 animate-spin"></i>
      <p class="mt-3 sm:mt-4 text-gray-600 font-semibold text-sm sm:text-base">Carregando dados e autenticando...</p>
    </div>

    <div id="pcp-view" class="space-y-4 sm:space-y-6 hidden">
      <h2 class="text-xl sm:text-2xl font-bold text-gray-800 border-b pb-2 mb-2 sm:mb-4 flex items-center">
        <i data-lucide="bar-chart-3" class="w-5 h-5 sm:w-6 sm:h-6 mr-2"></i>
        Painel PCP: Acompanhamento de OFs
      </h2>
      <div id="kpis-container" class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-4"></div>
      <div id="ofs-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-6"></div>
    </div>

    <div id="operator-view" class="space-y-4 sm:space-y-6 hidden">
      <div class="bg-white p-3 sm:p-4 rounded-xl shadow-lg mb-4 sm:mb-6 flex flex-col sm:flex-row items-center justify-between gap-3">
        <h2 class="text-lg sm:text-xl font-bold text-gray-800 flex items-center">
          <i data-lucide="clipboard-list" class="w-5 h-5 sm:w-6 sm:h-6 mr-2 text-blue-600"></i>
          Minhas Tarefas
        </h2>
        <div class="flex items-center gap-2 w-full sm:w-auto">
          <label for="sector-filter" class="text-xs sm:text-sm font-semibold text-gray-700 flex-shrink-0">Setor:</label>
          <select id="sector-filter" onchange="updateSectorFilter(this.value)"
                  class="p-2 border border-blue-300 rounded-lg bg-blue-50 focus:ring-blue-500 focus:border-blue-500 w-full sm:w-48"></select>
        </div>
      </div>
      <div id="tasks-list-container" class="space-y-3 sm:space-y-4"></div>
    </div>

    <div id="report-view" class="space-y-4 sm:space-y-6 hidden">
      <h2 class="text-xl sm:text-2xl font-bold text-gray-800 border-b pb-2 mb-2 sm:mb-4 flex items-center">
        <i data-lucide="file-text" class="w-5 h-5 sm:w-6 sm:h-6 mr-2 text-purple-600"></i>
        Relat√≥rio Detalhado de Pausas e Atrasos
      </h2>
      <div class="bg-white p-3 sm:p-4 rounded-xl shadow-lg">
        <div class="flex justify-between items-center mb-3 sm:mb-4">
          <h3 class="text-base sm:text-xl font-semibold text-gray-700">Ocorr√™ncias Registradas (Desvios)</h3>
          <button id="btn-export-report" onclick="exportReportCSV()"
                  class="px-3 sm:px-4 py-2 bg-purple-600 text-white text-sm sm:text-base font-semibold rounded-lg hover:bg-purple-700 transition">
            <i data-lucide="download" class="w-4 h-4 sm:w-5 sm:h-5 inline-block mr-1"></i> Exportar (CSV)
          </button>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 text-xs sm:text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">OF</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">CHICOTE</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">ATIVIDADE</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">MOTIVO PAUSA</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">MOTIVO ATRASO</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">T. PAUSA (min)</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">T. ATRASO (min)</th>
              </tr>
            </thead>
            <tbody id="report-table-body" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <div id="action-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal()">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-md modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <h3 id="modal-title" class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2"></h3>
      <div class="modal-body-scroll">
        <p id="modal-message" class="text-gray-600 mb-3 sm:mb-4"></p>
        <div id="modal-content">
          <div id="justification-area" class="space-y-3 sm:space-y-4">
            <label for="justification-select" class="block text-sm font-medium text-gray-700">Selecione o Motivo Principal:</label>
            <select id="justification-select" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500 transition">
              <option value="">-- Selecione uma op√ß√£o --</option>
            </select>
            <label for="justification-text" class="block text-sm font-medium text-gray-700">Detalhes Adicionais (Opcional):</label>
            <textarea id="justification-text" rows="2" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500 transition" placeholder=""></textarea>
            <p id="justification-required-text" class="text-sm text-red-500 hidden font-semibold">üö® Campo obrigat√≥rio devido ao desvio de tempo!</p>
          </div>
        </div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end gap-2 sm:gap-3 sticky-footer">
        <button onclick="closeModal()" class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition">Cancelar</button>
        <button id="modal-confirm-button" class="px-3 sm:px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition" onclick="handleConfirmedAction()">Confirmar</button>
      </div>
    </div>
  </div>

  <div id="instruction-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal()">
    <div class="bg-white rounded-xl shadow-2xl p-5 sm:p-8 w-full max-w-2xl modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2 flex items-center">
        <i data-lucide="book-open-text" class="w-5 h-5 sm:w-6 sm:h-6 mr-2 text-indigo-600"></i> Instru√ß√£o de Trabalho
      </h3>
      <div class="max-h-[65vh] sm:max-h-[70vh] overflow-y-auto pr-1 sm:pr-2 modal-body-scroll">
        <p class="text-sm font-semibold text-gray-700 mb-2" id="instruction-modal-header"></p>
        <div id="instruction-modal-content" class="text-gray-700 space-y-3"></div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end">
        <button onclick="closeModal('instruction-modal')" class="px-3 sm:px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition">Fechar</button>
      </div>
    </div>
  </div>

  <div id="create-of-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal()">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-lg modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">Criar Nova Ordem de Fabrica√ß√£o (OF)</h3>
      <div class="space-y-3 sm:space-y-4 modal-body-scroll">
        <div>
          <label for="of-id" class="block text-sm font-medium text-gray-700">C√≥digo da OF:</label>
          <input type="text" id="of-id" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: OF-003">
        </div>
        <div>
          <label for="of-quantity" class="block text-sm font-medium text-gray-700">Quantidade de Pe√ßas:</label>
          <input type="number" id="of-quantity" min="1" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: 50">
        </div>
        <div>
          <label for="of-chicote" class="block text-sm font-medium text-gray-700">Modelo do Chicote (Roteiro Mestre):</label>
          <select id="of-chicote" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-blue-500 focus:border-blue-500">
            <option value="">Carregando roteiros...</option>
          </select>
        </div>
        <div id="of-creation-message" class="text-sm text-red-500 hidden"></div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end gap-2 sm:gap-3 sticky-footer">
        <button onclick="closeModal('create-of-modal')" class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition">Cancelar</button>
        <button onclick="createOF()" class="px-3 sm:px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">
          <i data-lucide="factory" class="w-5 h-5 inline-block mr-1"></i> Gerar OF
        </button>
      </div>
    </div>
  </div>

  <div id="setup-roteiro-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal()">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-2xl modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">Setup: Cadastro de Roteiros Mestres</h3>
      <div id="roteiro-list" class="space-y-4 h-[50vh] sm:h-64 overflow-y-auto mb-4 p-2 border rounded-lg bg-gray-50 modal-body-scroll"></div>
      <div class="border-t pt-4 space-y-4">
        <h4 class="text-base sm:text-lg font-semibold text-gray-700">Nova Etapa para Roteiro:</h4>
        <div class="flex flex-col gap-3">
          <div class="flex flex-col sm:flex-row gap-3">
            <input type="text" id="roteiro-chicote-name" class="w-full sm:w-1/2 border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Nome do Chicote (Ex: CHICOTE-A)">
            <select id="roteiro-setor" class="w-full sm:w-1/2 border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500"></select>
          </div>
          <input type="text" id="roteiro-activity-name" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Nome da Atividade (Ex: Pr√© Conex√£o)">
          <div class="flex flex-col sm:flex-row gap-3">
            <input type="number" id="roteiro-setup-time" min="0" step="0.1" class="w-full sm:w-1/2 border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Setup (min)">
            <input type="number" id="roteiro-cycle-time" min="0" step="0.1" class="w-full sm:w-1/2 border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ciclo (min/p√ß)">
          </div>
          <div>
            <label for="roteiro-instruction-text" class="block text-sm font-medium text-gray-700 mb-1">Instru√ß√£o de Trabalho (HTML permitido):</label>
            <textarea id="roteiro-instruction-text" rows="4" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: <b>1. Prepara√ß√£o:</b> ..."></textarea>
          </div>
          <button onclick="addRoteiroActivity()" class="p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
            <i data-lucide="plus" class="w-5 h-5 inline-block mr-1"></i> Adicionar Etapa
          </button>
        </div>
        <div id="roteiro-message" class="text-sm text-red-500"></div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end">
        <button onclick="closeModal('setup-roteiro-modal')" class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition">Fechar</button>
      </div>
    </div>
  </div>

  <div id="of-details-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal('of-details-modal')">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-3xl modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-2">
        <h3 id="of-details-title" class="text-xl sm:text-2xl font-bold text-gray-800"></h3>
        <button class="p-2 rounded-lg hover:bg-gray-100" onclick="closeModal('of-details-modal')">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>
      <div id="of-details-summary" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3 sm:mb-4"></div>
      <div class="w-full bg-gray-200 rounded-full h-2 mb-3 sm:mb-4">
        <div id="of-details-progress" class="h-2 rounded-full bg-blue-500" style="width:0%"></div>
      </div>
      <div id="of-details-content" class="max-h-[60vh] overflow-y-auto space-y-3 sm:space-y-4 modal-body-scroll"></div>
      <div class="mt-4 sm:mt-5 flex justify-between gap-3 sticky-footer">
        <button id="btn-delete-of" class="px-3 sm:px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition hidden" onclick="deleteOF(window.__ofDetailsOpenId)">
          <i data-lucide="trash-2" class="w-4 h-4 sm:w-5 sm:h-5 inline-block mr-1"></i> Excluir OF
        </button>
        <div class="flex gap-2 sm:gap-3">
          <button id="btn-export-of" class="px-3 sm:px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition" onclick="exportOFTasksCSV(window.__ofDetailsOpenId)">Exportar CSV</button>
          <button class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition" onclick="closeModal('of-details-modal')">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <div id="user-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="event.stopPropagation()">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-md modal-panel mx-0 sm:mx-4">
      <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">Acesso</h3>
      <div class="space-y-3 sm:space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Perfil</label>
          <select id="user-role" class="w-full border border-gray-300 rounded-lg p-2 mt-1">
            <option value="OPERADOR">Operador</option>
            <option value="MASTER">Master</option>
          </select>
        </div>
        <div id="user-sector-wrap">
          <label class="block text-sm font-medium text-gray-700">Setor do Operador</label>
          <select id="user-sector" class="w-full border border-gray-300 rounded-lg p-2 mt-1"></select>
        </div>
        <div id="user-pin-wrap" class="hidden">
          <label class="block text-sm font-medium text-gray-700">PIN do Master</label>
          <input type="password" id="user-pin" class="w-full border border-gray-300 rounded-lg p-2 mt-1" placeholder="****">
          <p class="text-xs text-gray-500 mt-1">PIN padr√£o: 7889</p>
        </div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end gap-2 sm:gap-3">
        <button class="px-3 sm:px-4 py-2 bg-gray-200 rounded-lg font-semibold hover:bg-gray-300" onclick="closeModal('user-modal')">Cancelar</button>
        <button class="px-3 sm:px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700" onclick="confirmUser()">Entrar</button>
      </div>
    </div>
  </div>

  <script>
    // =================================================================================================
    // CONFIGURA√á√ÉO FIREBASE: 
    // =================================================================================================
    const firebaseConfig = {
  apiKey: "AIzaSyDIJJIe4WIVj5OKYTtR-HQscrxIzxNK9eY",
  authDomain: "pcp-app-24c56.firebaseapp.com",
  projectId: "pcp-app-24c56",
  storageBucket: "pcp-app-24c56.firebasestorage.app",
  messagingSenderId: "675295958467",
  appId: "1:675295958467:web:9d79700af6fc1c28db5976",
  measurementId: "G-DH06WDCKJY"
};
    
    // Inicializa√ß√£o do Firebase (se a config n√£o estiver vazia)
    if (Object.keys(firebaseConfig).length > 0 && firebaseConfig.projectId) {
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // Cole√ß√µes
        const OF_COLLECTION = 'ofs';
        const TASK_COLLECTION = 'tasks';
        const ROTEIRO_COLLECTION = 'roteiros';
        const OCORRENCIA_COLLECTION = 'ocorrencias';

        window.db = db;
        window.OF_COLLECTION = OF_COLLECTION;
        window.TASK_COLLECTION = TASK_COLLECTION;
        window.ROTEIRO_COLLECTION = ROTEIRO_COLLECTION;
        window.OCORRENCIA_COLLECTION = OCORRENCIA_COLLECTION;
    } else {
        // Se as configura√ß√µes n√£o forem fornecidas, o c√≥digo usar√° a vers√£o Simula√ß√£o/Default.
        alert("AVISO: Configura√ß√µes do Firebase ausentes. O sistema usar√° dados iniciais e n√£o salvar√° no banco de dados.");
        window.db = null;
    }
    // =================================================================================================


    // ==========================
    //  VARI√ÅVEIS E DADOS GLOBAIS
    // ==========================
    const MASTER_PIN = "7889";
    const SECTORS = [
      'Corte','Corte de Revestimentos','Pr√©-Montagem','Prepara√ß√£o','Pr√© Conex√£o',
      'Conex√£o','Pr√© Grampea√ß√£o','Grampea√ß√£o','Acabamento','Embalagem','Montagem','Cabo de Bateria 1','Cabo de Bateria 2'
    ];
    const PAUSE_REASONS = [
      "Falta de material na bancada","Manuten√ß√£o/Ajuste de m√°quina","Instru√ß√£o de trabalho confusa/ausente",
      "Necessidade de assist√™ncia t√©cnica","Troca de turno/intervalo programado","Outro (Detalhar abaixo)"
    ];
    const DELAY_REASONS = [
      "Complexidade inesperada da pe√ßa","Problema de qualidade na etapa anterior","Falta de treinamento/experi√™ncia",
      "Tempo padr√£o calculado incorretamente","Quebra/defeito de ferramenta","Outro (Detalhar abaixo)"
    ];

    // Dados que ser√£o preenchidos pelos listeners do Firebase
    let allOFs = {};
    let allTasks = {};
    let allRoteiros = {};
    let allOcurrencesLog = [];
    let currentAction = {}; // Armazena a a√ß√£o pendente do modal
    let currentSectorFilter = SECTORS[0];
    let currentUser = null;

    // Roteiro / Task Counters (para simula√ß√£o ou inicializa√ß√£o)
    let taskCounter = 1;
    let roteiroCounter = 7; 

    // ==========================
    //  ROTEIROS PR√â-CARREGADOS (Fallback para inicializa√ß√£o ou Simula√ß√£o)
    // ==========================
    const DEFAULT_ROTEIROS = {
      "r1": { id:"r1", chicote_nome:"CHICOTE-001", setor:"Corte", nome_atividade:"Corte dos Fios", tempo_setup:5, tempo_ciclo:0.2,
        instrucao_trabalho:"<b>1. Prepara√ß√£o:</b> Verifique se a faca est√° calibrada para o fio 1.0mm.<br><b>2. Medi√ß√£o:</b> Corte 50 pe√ßas com 150mm cada.<br><b>3. Confer√™ncia:</b> Fa√ßa uma confer√™ncia visual. <a href='https://upload.wikimedia.org/wikipedia/commons/4/4e/Sample_cut.png' target='_blank'>**Ver Imagem de Padr√£o**</a>."
      },
      "r2": { id:"r2", chicote_nome:"CHICOTE-001", setor:"Pr√©-Montagem", nome_atividade:"Crimpagem de Terminais", tempo_setup:8, tempo_ciclo:0.5,
        instrucao_trabalho:"<b>1. Fio Preto:</b> ...<br><b>2. Fio Vermelho:</b> ...<br><b>3. Teste:</b> > 10Kgf. <a href='https://www.youtube.com/watch?v=dQw4w9WgXcQ' target='_blank'>**Assistir V√≠deo**</a>"
      },
      "r3": { id:"r3", chicote_nome:"CHICOTE-001", setor:"Montagem Final", nome_atividade:"Montagem de Conectores", tempo_setup:15, tempo_ciclo:1.0,
        instrucao_trabalho:"<b>Aten√ß√£o:</b> Conectar posi√ß√µes 35 e 33. Proibido for√ßar."
      },
      "r4": { id:"r4", chicote_nome:"CHICOTE-001", setor:"Qualidade", nome_atividade:"Teste de Continuidade", tempo_setup:3, tempo_ciclo:0.1,
        instrucao_trabalho:"Usar jig JIG-10B. 100% devem passar."
      },
      "r5": { id:"r5", chicote_nome:"CHICOTE-B", setor:"Corte", nome_atividade:"Corte Fios Refor√ßados", tempo_setup:10, tempo_ciclo:0.3, instrucao_trabalho:"Instru√ß√£o b√°sica B."},
      "r6": { id:"r6", chicote_nome:"CHICOTE-B", setor:"Montagem Final", nome_atividade:"Montagem Simples", tempo_setup:5, tempo_ciclo:0.8, instrucao_trabalho:"Conectar 4 vias."},
    };


    // ==========================
    //  ELEMENTOS UI
    // ==========================
    const pcpView = document.getElementById("pcp-view");
    const operatorView = document.getElementById("operator-view");
    const reportView = document.getElementById("report-view");
    const loadingIndicator = document.getElementById("loading-indicator");
    const ofsListContainer = document.getElementById("ofs-list-container");
    const tasksListContainer = document.getElementById("tasks-list-container");
    const userViewSelect = document.getElementById("user-view-select");
    const btnCreateOF = document.getElementById("btn-create-of");
    const btnSetupRoteiro = document.getElementById("btn-setup-roteiro");
    const btnProfile = document.getElementById("btn-profile");
    const btnExportReport = document.getElementById("btn-export-report");
    const btnDeleteOF = document.getElementById("btn-delete-of");

    // ==========================
    //  HELPERS & PERMISS√ïES
    // ==========================
    function msToMinutes(ms){ 
      if (typeof ms !== 'number' || ms < 0) return 0;
      return parseFloat((ms / (1000*60)).toFixed(2));
    }
    function formatMinutes(v){ return `${Number(v||0).toFixed(2)} min`; }
    
    function setUser(u){ 
      currentUser = u; 
      // Manter a sess√£o do usu√°rio no localStorage (comportamento original)
      localStorage.setItem("pcp_current_user", JSON.stringify(u)); 
    }
    
    function getUser(){ 
      try{ 
        return JSON.parse(localStorage.getItem("pcp_current_user")||"null"); 
      }catch(e){ 
        return null; 
      } 
    }
    
    function isMaster(){ return currentUser && currentUser.role === "MASTER"; }
    function isOperador(){ return currentUser && currentUser.role === "OPERADOR"; }

    function getDBTimestamp(timestampField) {
        if (!timestampField) return null;
        // Verifica se √© um objeto Timestamp do Firebase (pode ser um Date se vier do mock)
        if (typeof timestampField.toDate === 'function') {
            return timestampField.toDate().getTime();
        }
        // Se for um n√∫mero (milliseconds) ou um Date object
        if (timestampField instanceof Date) {
             return timestampField.getTime();
        }
        return timestampField; // Assume que j√° √© o n√∫mero de milissegundos
    }

    // ==========================
    //  C√ÅLCULOS DE TEMPO
    // ==========================
    function calculateTempoReal(task){
      let tempoReal = task.tempo_real_acumulado || 0;
      const now = Date.now();

      if (task.status === 'Em Processo' && task.timestamp_inicio){
        let inicioMs = getDBTimestamp(task.timestamp_inicio);
        if (inicioMs) {
            let tempoTrabalhadoDesdeInicio = msToMinutes(now - inicioMs);
            tempoReal += tempoTrabalhadoDesdeInicio;
        }
      }
      return parseFloat(tempoReal.toFixed(2));
    }

    function calculateDesvio(task){
      const tempoReal = calculateTempoReal(task);
      // Desvio = Tempo Planejado - Tempo Real (Negativo = Atraso)
      const desvio = (task.tempo_planejado||0) - tempoReal; 
      return parseFloat(desvio.toFixed(2));
    }
    
    function calculateTotalPauseMinutes(task){
      let totalMs = task.total_pause_time_ms || 0;
      
      if (task.status === 'Pausada' && task.pause_start_timestamp){
        let pauseStartMs = getDBTimestamp(task.pause_start_timestamp);
        if (pauseStartMs) {
            totalMs += Date.now() - pauseStartMs;
        }
      }
      return msToMinutes(totalMs);
    }
    
    function calculateTotalPauseMinutesFinal(task){
       // Usado para o relat√≥rio, n√£o considera a pausa em andamento
       return msToMinutes(task.total_pause_time_ms || 0);
    }

    // ==========================
    //  INICIALIZA√á√ÉO & DADOS
    // ==========================
    function setupSectorDropdowns(){
      const roteiroSetorSelect = document.getElementById('roteiro-setor');
      const sectorFilterSelect = document.getElementById('sector-filter');
      const userSectorSelect = document.getElementById('user-sector');

      // Limpa todos
      [roteiroSetorSelect, sectorFilterSelect, userSectorSelect].forEach(sel => {
        if (sel) sel.innerHTML = '';
      });

      // 1. Dropdown de Setup Roteiro e User Sector
      SECTORS.forEach(sector=>{
          const o1 = document.createElement('option'); o1.value=sector; o1.textContent=sector; 
          const o2 = o1.cloneNode(true);
          if (roteiroSetorSelect) roteiroSetorSelect.appendChild(o1);
          if (userSectorSelect) userSectorSelect.appendChild(o2);
      });
      // 2. Dropdown de Filtro do Operador
      if (sectorFilterSelect){
        if (isOperador()){
          const o = document.createElement('option');
          o.value=currentUser.sector; o.textContent=currentUser.sector; sectorFilterSelect.appendChild(o);
          sectorFilterSelect.value=currentUser.sector;
          sectorFilterSelect.disabled = true;
          currentSectorFilter = currentUser.sector;
        }else{
          SECTORS.forEach(sector=>{
            const o2 = document.createElement('option'); o2.value=sector; o2.textContent=sector; sectorFilterSelect.appendChild(o2);
          });
          currentSectorFilter = SECTORS[0];
          sectorFilterSelect.value = SECTORS[0];
          sectorFilterSelect.disabled = false;
        }
      }
    }

    function updateSectorFilter(sector){
        currentSectorFilter = sector;
        renderTasks(); // Renderiza tarefas do novo setor
    }
    
    function loadRoteiroDropdowns() {
      const select = document.getElementById('of-chicote');
      if (!select) return;
      
      const roteiros = Object.values(allRoteiros);
      const chicotes = [...new Set(roteiros.map(r => r.chicote_nome))];
      
      select.innerHTML = '<option value="">-- Selecione um Modelo --</option>';
      chicotes.forEach(chicote => {
          const option = document.createElement('option');
          option.value = chicote;
          option.textContent = chicote;
          select.appendChild(option);
      });
      
      if (chicotes.length === 0) {
           select.innerHTML = '<option value="">Nenhum roteiro mestre cadastrado.</option>';
      }
    }

    async function initializeApp(){
      loadingIndicator.classList.remove('hidden');
      
      // 1. Tenta carregar usu√°rio
      const savedUser = getUser();
      if (savedUser){ setUser(savedUser); }

      // 2. Setup Firebase Listeners ou Fallback (Simula√ß√£o)
      if (window.db) {
          setupFirebaseListeners();
      } else {
          // MODO SIMULA√á√ÉO
          document.getElementById('loading-indicator').innerHTML = `
            <div class="p-3 sm:p-4 bg-yellow-100 border border-yellow-400 text-yellow-700 rounded-lg shadow-md" role="alert">
              <p class="font-bold">Aviso: Modo de Simula√ß√£o (Sem Firebase)</p>
              <p class="text-xs sm:text-sm">Os dados ser√£o vol√°teis e n√£o persistir√£o entre sess√µes. Use a configura√ß√£o do Firebase para persist√™ncia.</p>
            </div>`;
          
          allRoteiros = { ...DEFAULT_ROTEIROS };
          // Na simula√ß√£o, precisamos inicializar os dados de OFs e Tasks
          // Esta parte seria removida com o Firebase real.
          if (!localStorage.getItem('sim_data_initialized')) {
            const of1 = await createOF('OF-001', 10, 'CHICOTE-001', true);
            const of2 = await createOF('OF-002', 20, 'CHICOTE-B', true);
            localStorage.setItem('sim_data_initialized', 'true');
          } else {
            // Se j√° inicializado, tenta carregar do localStorage (comportamento original)
            const storedOFs = JSON.parse(localStorage.getItem('sim_ofs') || '{}');
            const storedTasks = JSON.parse(localStorage.getItem('sim_tasks') || '{}');
            const storedOcorrencias = JSON.parse(localStorage.getItem('sim_ocorrencias') || '[]');
            allOFs = storedOFs;
            allTasks = storedTasks;
            allOcurrencesLog = storedOcorrencias;
          }

          // Atraso simulado para UI
          setTimeout(()=>{
            loadingIndicator.classList.add('hidden');
            openUserModal(savedUser ? null : undefined);
            setupUIRefresh(); // Inicia o timer de refresh
            loadRoteiroDropdowns();
          }, 300);
      }

      setupSectorDropdowns();
      // Se n√£o houver usu√°rio salvo, abre o modal de login
      if (!savedUser) { openUserModal(); } 
      else { updateView(userViewSelect.value); }
    }

    // ==========================
    //  FIREBASE LISTENERS
    // ==========================
    function setupFirebaseListeners() {
        if (!window.db) return;

        // Listener de OFs
        db.collection(OF_COLLECTION).onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                const ofData = { id: change.doc.id, ...change.doc.data() };
                if (change.type === 'removed') {
                    delete allOFs[ofData.id];
                } else {
                    allOFs[ofData.id] = ofData;
                }
            });
            updateView(userViewSelect.value);
            loadRoteiroDropdowns();
        });

        // Listener de Tasks
        db.collection(TASK_COLLECTION).onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                const taskData = { id: change.doc.id, ...change.doc.data() };
                if (change.type === 'removed') {
                    delete allTasks[taskData.id];
                } else {
                    allTasks[taskData.id] = taskData;
                }
            });
            updateView(userViewSelect.value);
        });
        
        // Listener de Roteiros
        db.collection(ROTEIRO_COLLECTION).onSnapshot(snapshot => {
            allRoteiros = {};
            snapshot.forEach(doc => {
                const roteiroData = { id: doc.id, ...doc.data() };
                allRoteiros[roteiroData.id] = roteiroData;
            });
            loadRoteiroDropdowns();
            renderRoteiros(); // Atualiza modal de setup
        });

        // Listener de Ocorr√™ncias
        db.collection(OCORRENCIA_COLLECTION).onSnapshot(snapshot => {
            allOcurrencesLog = [];
            snapshot.forEach(doc => {
                allOcurrencesLog.push({ id: doc.id, ...doc.data() });
            });
            allOcurrencesLog.sort((a,b) => getDBTimestamp(b.timestamp) - getDBTimestamp(a.timestamp));
            updateView(userViewSelect.value);
            loadingIndicator.classList.add('hidden');
        });
    }


    // ==========================
    //  CRUD OPERATIONS
    // ==========================

    async function addRoteiroActivity(){
      const chicote_name = document.getElementById('roteiro-chicote-name').value.trim().toUpperCase();
      const setor = document.getElementById('roteiro-setor').value;
      const activity_name = document.getElementById('roteiro-activity-name').value.trim();
      const setup_time = parseFloat(document.getElementById('roteiro-setup-time').value);
      const cycle_time = parseFloat(document.getElementById('roteiro-cycle-time').value);
      const instruction_text = document.getElementById('roteiro-instruction-text').value.trim();
      const messageEl = document.getElementById('roteiro-message');
      messageEl.textContent = '';
      
      if (!chicote_name || !activity_name || isNaN(setup_time) || isNaN(cycle_time) || !setor){
        messageEl.textContent = "Preencha todos os campos obrigat√≥rios e use n√∫meros para tempo.";
        return;
      }

      if (window.db) {
          try {
             // O ID do roteiro √© o ID gerado pelo Firebase
             const newRoteiro = {
                chicote_nome: chicote_name,
                setor: setor,
                nome_atividade: activity_name,
                tempo_setup: setup_time,
                tempo_ciclo: cycle_time,
                instrucao_trabalho: instruction_text,
                created_at: firebase.firestore.FieldValue.serverTimestamp()
             };
             await db.collection(ROTEIRO_COLLECTION).add(newRoteiro);
             messageEl.textContent = `Etapa "${activity_name}" adicionada ao roteiro mestre ${chicote_name}.`;
             messageEl.classList.remove('text-red-500');
             messageEl.classList.add('text-green-600');
          } catch(e) {
             messageEl.textContent = "Erro ao salvar no Firebase: " + e.message;
             messageEl.classList.add('text-red-500');
          }
      } else {
          // Simula√ß√£o
          const newId = `r${roteiroCounter++}`;
          allRoteiros[newId] = {
            id: newId, chicote_nome: chicote_name, setor, 
            nome_atividade: activity_name, tempo_setup: setup_time, tempo_ciclo: cycle_time, 
            instrucao_trabalho: instruction_text
          };
          messageEl.textContent = `Etapa "${activity_name}" adicionada ao roteiro mestre ${chicote_name} (Simula√ß√£o).`;
          messageEl.classList.remove('text-red-500');
          messageEl.classList.add('text-green-600');
          renderRoteiros();
          loadRoteiroDropdowns();
      }
      
      // Limpa os campos ap√≥s sucesso
      document.getElementById('roteiro-activity-name').value = '';
      document.getElementById('roteiro-setup-time').value = '';
      document.getElementById('roteiro-cycle-time').value = '';
      document.getElementById('roteiro-instruction-text').value = '';
    }

    async function createOF(ofIdOverride, quantityOverride, chicoteOverride, isSimulated = false){
      const of_id = ofIdOverride || document.getElementById('of-id').value.trim().toUpperCase();
      const quantity = quantityOverride || parseInt(document.getElementById('of-quantity').value);
      const chicote_name = chicoteOverride || document.getElementById('of-chicote').value;
      const messageEl = document.getElementById('of-creation-message');
      messageEl.textContent = '';
      messageEl.classList.add('hidden');

      if (!of_id || isNaN(quantity) || quantity <= 0 || !chicote_name){
        messageEl.textContent = "Preencha todos os campos corretamente. A quantidade deve ser um n√∫mero positivo.";
        messageEl.classList.remove('hidden');
        return;
      }
      if (Object.values(allOFs).find(of => of.id === of_id)) {
          messageEl.textContent = `OF "${of_id}" j√° existe.`;
          messageEl.classList.remove('hidden');
          return;
      }
      
      const roteiroEtapas = Object.values(allRoteiros).filter(r => r.chicote_nome === chicote_name);
      if (roteiroEtapas.length === 0){
        messageEl.textContent = `Nenhuma etapa encontrada para o chicote "${chicote_name}". Cadastre o roteiro mestre primeiro.`;
        messageEl.classList.remove('hidden');
        return;
      }

      // 1. Criar a OF
      const newOF = {
        id: of_id,
        chicote: chicote_name,
        quantidade: quantity,
        status: 'Pendente',
        data_criacao: window.db ? firebase.firestore.FieldValue.serverTimestamp() : new Date(),
        task_count: roteiroEtapas.length,
        concluded_tasks: 0,
      };

      try {
        if (window.db) {
            await db.collection(OF_COLLECTION).doc(of_id).set(newOF);
        } else {
             allOFs[of_id] = newOF;
        }

        // 2. Criar as Tasks
        const batch = window.db ? db.batch() : null;
        let order = 1;
        
        for (const etapa of roteiroEtapas) {
          const tempo_planejado = etapa.tempo_setup + (etapa.tempo_ciclo * quantity);

          const newTask = {
            id_of: of_id,
            id_roteiro: etapa.id,
            chicote: chicote_name,
            nome_atividade: etapa.nome_atividade,
            setor: etapa.setor,
            tempo_setup: etapa.tempo_setup,
            tempo_ciclo: etapa.tempo_ciclo,
            tempo_planejado: parseFloat(tempo_planejado.toFixed(2)),
            instrucao_trabalho: etapa.instrucao_trabalho,
            quantidade_pecas: quantity,
            status: order === 1 ? 'Em Espera' : 'Bloqueada',
            ordem: order++,
            timestamp_inicio: null,
            timestamp_fim: null,
            tempo_real_acumulado: 0,
            total_pause_time_ms: 0,
            pause_start_timestamp: null,
            // Adiciona um campo de √≠ndice para facilitar a query no Firebase
            search_index: of_id.toLowerCase() + '-' + etapa.nome_atividade.toLowerCase() + '-' + etapa.setor.toLowerCase()
          };
          
          if (window.db) {
            // Usa um ID √∫nico para cada Task
            const newTaskDocRef = db.collection(TASK_COLLECTION).doc(); 
            batch.set(newTaskDocRef, newTask);
          } else {
            // Simula√ß√£o
            const simTaskId = `t${taskCounter++}`;
            newTask.id = simTaskId;
            allTasks[simTaskId] = newTask;
          }
        }

        if (batch) await batch.commit();
        
        if (!isSimulated) {
            closeModal('create-of-modal');
            alert(`OF ${of_id} criada com sucesso!`);
            if (!window.db) {
                // Simula√ß√£o: Salvar estado no localStorage para persistir (apenas mock)
                localStorage.setItem('sim_ofs', JSON.stringify(allOFs));
                localStorage.setItem('sim_tasks', JSON.stringify(allTasks));
            }
        }
      } catch(e) {
          messageEl.textContent = "Erro ao criar OF: " + (e.message || e);
          messageEl.classList.remove('hidden');
          console.error("Erro na cria√ß√£o da OF:", e);
      }
    }

    async function updateTaskStatus(taskId, newStatus, logType = null, justification = null, justificationText = null) {
      const task = allTasks[taskId];
      if (!task) return;

      const updateData = { status: newStatus };
      const now = window.db ? firebase.firestore.FieldValue.serverTimestamp() : new Date();

      // Transi√ß√£o de STATUS
      if (newStatus === 'Em Processo') {
        // Se a tarefa estava Pausada, calcula o tempo de pausa e limpa o timer de pausa
        if (task.status === 'Pausada' && task.pause_start_timestamp) {
          const pauseStartMs = getDBTimestamp(task.pause_start_timestamp);
          const currentPauseTimeMs = Date.now() - pauseStartMs;
          updateData.total_pause_time_ms = (task.total_pause_time_ms || 0) + currentPauseTimeMs;
          updateData.pause_start_timestamp = null;
        }
        // Se a tarefa estava em Espera ou Bloqueada, este √© o primeiro START
        if (task.status === 'Em Espera' || task.status === 'Bloqueada') {
          updateData.timestamp_inicio = now;
        }
      } 
      
      else if (newStatus === 'Pausada') {
        // Pausando: Salva o tempo real acumulado e inicia o timer de pausa
        const currentTempoReal = calculateTempoReal(task);
        updateData.tempo_real_acumulado = currentTempoReal;
        updateData.pause_start_timestamp = now;

        // Se o logType √© PAUSA, cria um log de ocorr√™ncia com o motivo
        if (logType === 'PAUSA' && (justification || justificationText)) {
            await createOcorrenciaLog(task, 'PAUSA', justification, justificationText);
        }
      } 
      
      else if (newStatus === 'Conclu√≠do') {
        // Finalizando: Salva o tempo final
        const finalTempoReal = calculateTempoReal(task);
        const desvio = calculateDesvio(task);
        
        updateData.tempo_real_acumulado = finalTempoReal;
        updateData.timestamp_fim = now;
        updateData.pause_start_timestamp = null; // Garante que a pausa √© limpa

        // Se a tarefa est√° atrasada (desvio < 0), cria um log de atraso/desvio
        if (desvio < 0 || logType === 'FIM_ATRASO') {
             await createOcorrenciaLog(task, 'FIM_ATRASO', justification, justificationText);
        }

        // 3. Atualizar a OF e liberar a pr√≥xima Task
        const nextTask = Object.values(allTasks)
          .filter(t => t.id_of === task.id_of && t.ordem === task.ordem + 1)
          .sort((a,b) => a.ordem - b.ordem)[0];
          
        const ofRef = window.db ? db.collection(OF_COLLECTION).doc(task.id_of) : null;
        const taskRefNext = window.db ? db.collection(TASK_COLLECTION).doc(nextTask.id) : null;

        if (window.db) {
             const batch = db.batch();
             
             // A. Atualiza a task atual
             batch.update(db.collection(TASK_COLLECTION).doc(taskId), updateData);

             // B. Atualiza o contador da OF
             batch.update(ofRef, {
                 concluded_tasks: firebase.firestore.FieldValue.increment(1),
                 status: nextTask ? 'Em Andamento' : 'Conclu√≠do'
             });
             
             // C. Libera a pr√≥xima task (se existir)
             if (nextTask) {
                batch.update(taskRefNext, { status: 'Em Espera' });
             }

             await batch.commit();

        } else {
             // Simula√ß√£o
             const of = allOFs[task.id_of];
             of.concluded_tasks = (of.concluded_tasks || 0) + 1;
             if (!nextTask) {
                of.status = 'Conclu√≠do';
             } else {
                nextTask.status = 'Em Espera';
             }
             
             // Aplica o update na task atual (Simula√ß√£o)
             Object.assign(task, updateData);
             
             // Simula√ß√£o: Salvar estado no localStorage para persistir (apenas mock)
             localStorage.setItem('sim_ofs', JSON.stringify(allOFs));
             localStorage.setItem('sim_tasks', JSON.stringify(allTasks));
        }

        return; // Retorna pois o update da task foi feito no batch/simula√ß√£o
      }
      
      // Aplicar o update simples (Start/Continue)
      if (window.db) {
          await db.collection(TASK_COLLECTION).doc(taskId).update(updateData);
      } else {
          // Simula√ß√£o
          Object.assign(task, updateData);
          localStorage.setItem('sim_tasks', JSON.stringify(allTasks));
      }
      
      renderTasks();
    }
    
    // Fun√ß√£o Auxiliar para Criar Log de Ocorr√™ncia
    async function createOcorrenciaLog(task, type, justification, justificationText) {
        const logData = {
            ID_TASK: task.id,
            OF: task.id_of,
            CHICOTE: task.chicote,
            ATIVIDADE: task.nome_atividade,
            OPERADOR: currentUser.name || currentUser.sector,
            SECTOR: task.setor,
            MOTIVO_PRINCIPAL: justification,
            MOTIVO_DETALHES: justificationText,
            timestamp: window.db ? firebase.firestore.FieldValue.serverTimestamp() : new Date()
        };
        
        if (type === 'PAUSA') {
            const pauseTimeMs = Date.now() - getDBTimestamp(task.pause_start_timestamp);
            logData.TIPO = 'PAUSA';
            logData.TEMPO_PAUSA = msToMinutes(pauseTimeMs);
            logData.TEMPO_ATRASO = 0;
            logData.MOTIVO_PAUSA = justification;
            logData.MOTIVO_ATRASO = null;
        } else if (type === 'FIM_ATRASO') {
            const desvio = calculateDesvio(task);
            logData.TIPO = 'ATRASO';
            logData.TEMPO_PAUSA = calculateTotalPauseMinutesFinal(task);
            // Salva o atraso como valor absoluto (negativo do desvio)
            logData.TEMPO_ATRASO = parseFloat(Math.abs(desvio).toFixed(2)); 
            logData.MOTIVO_PAUSA = null;
            logData.MOTIVO_ATRASO = justification;
        }

        if (window.db) {
            await db.collection(OCORRENCIA_COLLECTION).add(logData);
        } else {
            // Simula√ß√£o
            logData.id = `log${allOcurrencesLog.length + 1}`;
            allOcurrencesLog.push(logData);
            localStorage.setItem('sim_ocorrencias', JSON.stringify(allOcurrencesLog));
        }
    }
    
    // ==========================
    // A√á√ïES DE BOT√ÉO
    // ==========================
    function startTask(taskId) {
      updateTaskStatus(taskId, 'Em Processo');
    }
    
    function finishTask(taskId) {
      showActionModal(taskId, 'Finalizar', DELAY_REASONS);
    }
    
    function pauseTask(taskId) {
      showActionModal(taskId, 'Pausar', PAUSE_REASONS);
    }

    async function deleteRoteiroActivity(roteiroId) {
        if (!confirm("Tem certeza que deseja EXCLUIR esta etapa de roteiro?")) return;
        
        if (window.db) {
            try {
                await db.collection(ROTEIRO_COLLECTION).doc(roteiroId).delete();
                alert("Etapa de roteiro exclu√≠da.");
            } catch(e) {
                alert("Erro ao excluir etapa: " + e.message);
            }
        } else {
            // Simula√ß√£o: remover do array e atualizar a UI
            delete allRoteiros[roteiroId];
            renderRoteiros();
            loadRoteiroDropdowns();
            alert("Etapa de roteiro exclu√≠da (Simula√ß√£o).");
        }
    }
    
    async function deleteOF(ofId) {
        if (!isMaster() || !ofId) return;

        if (!confirm(`Tem certeza que deseja EXCLUIR a OF ${ofId} e TODAS as suas tarefas e logs? Esta a√ß√£o √© irrevers√≠vel.`)) return;

        try {
            if (window.db) {
                const batch = db.batch();
                
                // 1. Deleta a OF
                const ofRef = db.collection(OF_COLLECTION).doc(ofId);
                batch.delete(ofRef);

                // 2. Deleta todas as Tasks relacionadas (devemos buscar primeiro)
                const tasksSnapshot = await db.collection(TASK_COLLECTION).where('id_of', '==', ofId).get();
                tasksSnapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                // 3. Deleta todas as Ocorr√™ncias relacionadas (opcional, mas bom para limpeza)
                const ocorrenciasSnapshot = await db.collection(OCORRENCIA_COLLECTION).where('OF', '==', ofId).get();
                 ocorrenciasSnapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });


                await batch.commit();

            } else {
                // Simula√ß√£o: remover do array e atualizar a UI
                delete allOFs[ofId];
                Object.keys(allTasks).forEach(taskId => {
                    if (allTasks[taskId].id_of === ofId) {
                        delete allTasks[taskId];
                    }
                });
                 
                allOcurrencesLog = allOcurrencesLog.filter(log => log.OF !== ofId);

                // Salvar estado no localStorage para persistir (apenas mock)
                localStorage.setItem('sim_ofs', JSON.stringify(allOFs));
                localStorage.setItem('sim_tasks', JSON.stringify(allTasks));
                localStorage.setItem('sim_ocorrencias', JSON.stringify(allOcurrencesLog));
            }
            
            closeModal('of-details-modal');
            alert(`OF ${ofId} exclu√≠da com sucesso.`);
            renderOFs();

        } catch(e) {
            alert("Erro ao excluir OF: " + (e.message || e));
            console.error(e);
        }
    }


    // ==========================
    //  MODAL LOGIC
    // ==========================
    function openModal(id){
      const modal = document.getElementById(id);
      if(modal) modal.style.display = 'flex';
      if(id === 'setup-roteiro-modal') renderRoteiros();
    }
    
    function closeModal(id){
      const modalId = id || 'action-modal';
      const modal = document.getElementById(modalId);
      if(modal) {
        modal.style.display = 'none';
        if (modalId === 'action-modal') {
           // Limpa o estado da a√ß√£o
           currentAction = {};
           document.getElementById('justification-select').value = '';
           document.getElementById('justification-text').value = '';
           document.getElementById('justification-required-text').classList.add('hidden');
        }
      }
    }
    
    function showActionModal(taskId, type, reasons){
      const task = allTasks[taskId];
      if (!task) return;
      
      currentAction = { taskId, type };
      const modal = document.getElementById('action-modal');
      const title = document.getElementById('modal-title');
      const message = document.getElementById('modal-message');
      const justificationSelect = document.getElementById('justification-select');
      const justificationRequired = document.getElementById('justification-required-text');

      title.textContent = `${type} Atividade: ${task.nome_atividade}`;
      message.textContent = `OF ${task.id_of} - Chicote ${task.chicote}`;
      
      justificationSelect.innerHTML = '<option value="">-- Selecione uma op√ß√£o --</option>';
      reasons.forEach(reason => {
        const option = document.createElement('option');
        option.value = reason;
        option.textContent = reason;
        justificationSelect.appendChild(option);
      });
      
      let isRequired = false;
      if (type === 'Finalizar') {
        const desvio = calculateDesvio(task);
        // Desvio negativo = Atraso. Se atraso > 0, justificativa √© obrigat√≥ria
        if (desvio < 0) {
          justificationRequired.textContent = `üö® Justificativa obrigat√≥ria devido ao ATRASO de ${formatMinutes(Math.abs(desvio))}!`;
          isRequired = true;
        } else {
          justificationRequired.textContent = `Justificativa opcional. Tempo restante: ${formatMinutes(desvio)}.`;
          // Mant√©m como obrigat√≥rio se o desvio for muito pequeno ou positivo (se for MASTER)
          if (isMaster() && desvio < 1) { isRequired = true; } 
        }
      } else if (type === 'Pausar') {
         // Pausa: N√£o √© obrigat√≥rio (regra de neg√≥cio), mas incentiva-se o preenchimento.
         justificationRequired.textContent = `Motivo da pausa √© altamente recomendado.`;
      }
      
      justificationRequired.classList.toggle('hidden', !isRequired && type !== 'Pausar');
      currentAction.isRequired = isRequired;

      modal.style.display = 'flex';
    }
    
    async function handleConfirmedAction(){
      const { taskId, type, isRequired } = currentAction;
      const justificationSelect = document.getElementById('justification-select');
      const justificationText = document.getElementById('justification-text').value.trim();
      const justification = justificationSelect.value;
      const justificationRequired = document.getElementById('justification-required-text');
      
      if (isRequired && !justification) {
        justificationRequired.textContent = "üö® Voc√™ deve selecionar um motivo principal!";
        justificationRequired.classList.remove('hidden');
        return;
      }
      
      justificationRequired.classList.add('hidden'); // Esconde a mensagem de erro se a valida√ß√£o passar

      if (type === 'Finalizar') {
        await updateTaskStatus(taskId, 'Conclu√≠do', 'FIM_ATRASO', justification, justificationText);
        updateView(userViewSelect.value);
      } else if (type === 'Pausar') {
        await updateTaskStatus(taskId, 'Pausada', 'PAUSA', justification, justificationText);
      }
      
      closeModal();
    }
    
    function openInstructionModal(taskId) {
        const task = allTasks[taskId];
        if (!task) return;
        
        document.getElementById('instruction-modal-header').textContent = `OF ${task.id_of} - Chicote ${task.chicote} - Setor: ${task.setor}`;
        document.getElementById('instruction-modal-content').innerHTML = task.instrucao_trabalho || 'Nenhuma instru√ß√£o de trabalho cadastrada para esta etapa.';
        openModal('instruction-modal');
        lucide.createIcons(); // Recria √≠cones dentro do modal, caso haja algum link.
    }

    // ==========================
    //  RENDERIZA√á√ÉO
    // ==========================
    function reloadActiveFilter(){ /* placeholder para l√≥gica de filtro futura */ }

    function renderKPIs(){
      const kpisContainer = document.getElementById('kpis-container');
      if (!kpisContainer) return;

      const totalOFs = Object.keys(allOFs).filter(k=> allOFs[k]?.status !== 'Conclu√≠do').length;
      const concludedTasks = Object.values(allTasks).filter(t=>t.status==='Conclu√≠do').length;
      const totalTasks = Object.values(allTasks).length;
      
      // Filtra logs de atraso
      const logsAtraso = allOcurrencesLog.filter(l => l.TIPO === 'ATRASO');
      const totalPause = allOcurrencesLog.reduce((s,l)=> s + (l.TEMPO_PAUSA||0), 0);
      const totalAtraso = logsAtraso.reduce((s,l)=> s + (l.TEMPO_ATRASO||0), 0);

      const kpiData = [
        { title:"OFs Ativas", value: totalOFs, icon:"package", color:"bg-blue-600" },
        { title:"Tarefas Conclu√≠das", value: `${concludedTasks} / ${totalTasks}`, icon:"check-circle", color:"bg-green-600" },
        { title:"Pausas Totais (min)", value: totalPause.toFixed(1), icon:"pause-circle", color:"bg-yellow-600" },
        { title:"Atraso Total (min)", value: totalAtraso.toFixed(1), icon:"alert-triangle", color:"bg-red-600" },
      ];

      kpisContainer.innerHTML = kpiData.map(k=>`
        <div class="${k.color} text-white p-3 sm:p-4 rounded-xl shadow-md flex items-center justify-between">
          <div>
            <p class="text-xs sm:text-sm font-medium opacity-80">${k.title}</p>
            <p class="text-2xl sm:text-3xl font-bold">${k.value}</p>
          </div>
          <i data-lucide="${k.icon}" class="w-7 h-7 sm:w-8 sm:h-8 opacity-70"></i>
        </div>`).join('');
      lucide.createIcons();
    }
    
    function updateView(view){
      if (isOperador() && view !== 'Operador'){ view = 'Operador'; }
      
      const isPCP = view === 'PCP';
      const isReport = view === 'Relatorio';
      
      pcpView.classList.toggle('hidden', !isPCP);
      operatorView.classList.toggle('hidden', (isPCP || isReport));
      reportView.classList.toggle('hidden', !isReport);
      userViewSelect.value = view;
      
      btnCreateOF.classList.toggle('hidden', !isMaster());
      btnSetupRoteiro.classList.toggle('hidden', !isMaster());
      btnProfile.classList.remove('hidden');
      userViewSelect.disabled = isOperador();
      if (btnExportReport) btnExportReport.classList.toggle('hidden', !isMaster());

      if (isPCP){ 
        renderKPIs(); 
        renderOFs(); 
        reloadActiveFilter();
      } else if (view === 'Operador'){
        renderTasks(); 
      } else if (isReport){ 
        renderReport(); 
      }
      lucide.createIcons();
    }
    window.updateView = updateView;

    function renderReport(){
      const body = document.getElementById('report-table-body');
      if (allOcurrencesLog.length === 0){
        body.innerHTML = `<tr><td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">Nenhuma ocorr√™ncia registrada.</td></tr>`;
        return;
      }

      const html = allOcurrencesLog.map(log=>{
        const atrasoClass = (log.TEMPO_ATRASO||0) > 0 ? 'highlight-red' : 'text-gray-600';
        const pausaClass = (log.TEMPO_PAUSA||0) > 0 ? 'text-yellow-700 font-semibold' : 'text-gray-600';
        
        return `
          <tr>
            <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${log.OF}</td>
            <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-sm text-gray-600">${log.CHICOTE}</td>
            <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-sm text-gray-600">${log.ATIVIDADE}</td>
            <td class="px-3 sm:px-6 py-2 text-sm text-gray-700">${log.MOTIVO_PAUSA || '-'}</td>
            <td class="px-3 sm:px-6 py-2 text-sm text-gray-700">${log.MOTIVO_ATRASO || '-'}</td>
            <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-sm ${pausaClass}">${(log.TEMPO_PAUSA||0).toFixed(2)}</td>
            <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-sm ${atrasoClass}">${(log.TEMPO_ATRASO||0).toFixed(2)}</td>
          </tr>`;
      }).join('');
      body.innerHTML = html;
    }

    function renderOFs(){
      if (!pcpView.classList.contains('hidden')) {
        const ofs = Object.values(allOFs).filter(of=> of.status !== 'Conclu√≠do');
        
        const ofsHtml = ofs.map(of=>{
          const tasks = Object.values(allTasks).filter(t=> t.id_of === of.id);
          const completed = of.concluded_tasks || 0;
          const nextTask = tasks.find(t=> t.status === 'Em Espera');
          
          let statusColor = 'bg-gray-100 border-gray-300';
          let progress = 0;
          
          if (tasks.length > 0){
            progress = Math.floor((completed / tasks.length) * 100);
            
            if (progress === 0) statusColor = 'bg-gray-200 border-gray-400';
            else if (progress < 100) statusColor = 'bg-blue-100 border-blue-400';
            
            // Check for delays in any active or concluded task
            const anyTaskDelayed = tasks.some(t => calculateDesvio(t) < -5); 
            if (anyTaskDelayed) statusColor = 'bg-red-100 border-red-500';
            
          }
          
          return `
            <div class="${statusColor} p-4 rounded-xl shadow-lg border-l-4 ${statusColor.replace('bg-', 'border-')}" 
                 onclick="openOFDetails('${of.id}')">
              <h3 class="text-lg font-bold text-gray-800 mb-1 flex justify-between items-center">
                ${of.id}
                ${of.status === 'Conclu√≠do' ? '<i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>' : (nextTask ? '<i data-lucide="play-circle" class="w-5 h-5 text-blue-600"></i>' : '<i data-lucide="pause-circle" class="w-5 h-5 text-yellow-600"></i>')}
              </h3>
              <p class="text-sm text-gray-600 mb-3">${of.chicote} | Qtd: ${of.quantidade}</p>
              
              <div class="flex justify-between items-center mb-1">
                <span class="text-xs font-semibold text-gray-600">${progress}% Conclu√≠do</span>
                <span class="text-xs font-medium text-gray-500">${completed} / ${tasks.length} etapas</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-1.5">
                <div class="h-1.5 rounded-full bg-blue-500" style="width:${progress}%"></div>
              </div>
              <p class="text-xs mt-2 text-gray-700 font-medium">Pr√≥xima Etapa: ${nextTask ? nextTask.nome_atividade : (of.status === 'Conclu√≠do' ? 'Finalizada' : 'N/A')}</p>
            </div>
          `;
        }).join('');
        
        ofsListContainer.innerHTML = ofsHtml.length > 0 ? ofsHtml : '<div class="col-span-3 p-6 text-center text-gray-500 bg-white rounded-xl shadow-lg">Nenhuma OF ativa.</div>';
        lucide.createIcons();
      }
    }
    
    function renderTasks(){
      if (!operatorView.classList.contains('hidden')) {
        const tasks = Object.values(allTasks)
          .filter(t => t.setor === currentSectorFilter && (t.status === 'Em Espera' || t.status === 'Em Processo' || t.status === 'Pausada'))
          .sort((a,b) => (a.status === 'Em Processo' ? -1 : 1) || a.ordem - b.ordem);
        
        const tasksHtml = tasks.map(task=>{
          const tempoReal = calculateTempoReal(task);
          const desvio = calculateDesvio(task);
          const totalPauseMinutes = calculateTotalPauseMinutes(task);
          
          let statusColor = 'bg-gray-100 border-gray-300';
          let statusText = task.status;
          let actionButton = '';
          let timerClass = 'text-gray-700';

          if (task.status === 'Em Espera'){
            statusColor = 'bg-green-100 border-green-500';
            statusText = 'Aguardando In√≠cio';
            actionButton = `<button onclick="startTask('${task.id}')" class="px-3 py-1 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700">INICIAR</button>`;
          } else if (task.status === 'Em Processo'){
            statusColor = 'bg-blue-100 border-blue-500';
            statusText = 'Em Andamento';
            actionButton = `
              <button onclick="pauseTask('${task.id}')" class="px-3 py-1 bg-yellow-600 text-white rounded-lg font-semibold hover:bg-yellow-700 mr-2">PAUSAR</button>
              <button onclick="finishTask('${task.id}')" class="px-3 py-1 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">FINALIZAR</button>
            `;
            timerClass = desvio < 0 ? 'highlight-red' : 'text-green-600';
          } else if (task.status === 'Pausada'){
            statusColor = 'bg-yellow-100 border-yellow-500';
            statusText = `Pausada (${formatMinutes(totalPauseMinutes)})`;
            actionButton = `
              <button onclick="startTask('${task.id}')" class="px-3 py-1 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 mr-2">RETOMAR</button>
              <button onclick="finishTask('${task.id}')" class="px-3 py-1 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">FINALIZAR</button>
            `;
          } else if (task.status === 'Bloqueada'){
            statusColor = 'bg-red-100 border-red-500';
            statusText = 'Bloqueada (Aguardando Etapa Anterior)';
            actionButton = '';
          }
          
          const tempoPlanejadoFormatted = formatMinutes(task.tempo_planejado);
          const tempoRealFormatted = formatMinutes(tempoReal);
          const desvioFormatted = formatMinutes(Math.abs(desvio));

          return `
            <div class="${statusColor} p-4 rounded-xl shadow-lg border-l-4 ${statusColor.replace('bg-', 'border-')} card-tap-big">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <h3 class="text-lg font-bold text-gray-800">${task.nome_atividade} <span class="text-sm font-medium text-gray-500">(${task.ordem}¬™ Etapa)</span></h3>
                  <p class="text-sm text-gray-600">OF: ${task.id_of} | Chicote: ${task.chicote}</p>
                </div>
                <span class="px-2 py-0.5 text-xs font-semibold rounded-full ${statusColor.replace('100', '300').replace('border-', 'bg-')} text-gray-800">${statusText}</span>
              </div>
              
              <div class="grid grid-cols-2 gap-y-1 mb-3 text-sm">
                <p class="text-gray-500">Pe√ßas:</p><p class="font-semibold text-gray-700">${task.quantidade_pecas}</p>
                <p class="text-gray-500">T. Planejado:</p><p class="font-semibold text-gray-700">${tempoPlanejadoFormatted}</p>
                <p class="text-gray-500">T. Real Atual:</p><p class="font-bold ${timerClass}">${tempoRealFormatted}</p>
                <p class="text-gray-500">Desvio:</p><p class="font-bold ${timerClass}">${desvio > 0 ? 'üëç ' : 'üëé '}${desvioFormatted}</p>
              </div>
              
              <div class="flex justify-between items-center border-t pt-3">
                <button onclick="openInstructionModal('${task.id}')" class="text-xs font-semibold text-indigo-600 hover:text-indigo-800 flex items-center">
                  <i data-lucide="book-open-text" class="w-4 h-4 mr-1"></i> Instru√ß√£o de Trabalho
                </button>
                <div class="flex items-center">
                  ${actionButton}
                </div>
              </div>
            </div>
          `;
        }).join('');
        
        tasksListContainer.innerHTML = tasksHtml.length > 0 ? tasksHtml : '<div class="p-6 text-center text-gray-500 bg-white rounded-xl shadow-lg">Nenhuma tarefa ativa no setor **' + currentSectorFilter + '** ou o setor est√° bloqueado.</div>';
        lucide.createIcons();
      }
    }
    
    function openOFDetails(ofId){
      const of = allOFs[ofId];
      if (!of) return;

      window.__ofDetailsOpenId = ofId;
      const tasks = Object.values(allTasks).filter(t=> t.id_of === ofId).sort((a,b) => a.ordem - b.ordem);
      const completedTasks = tasks.filter(t=> t.status === 'Conclu√≠do').length;
      const progress = tasks.length > 0 ? Math.floor((completedTasks / tasks.length) * 100) : 0;
      
      const totalTempoPlanejado = tasks.reduce((sum, t) => sum + (t.tempo_planejado || 0), 0);
      const totalTempoReal = tasks.reduce((sum, t) => sum + (t.status === 'Conclu√≠do' ? t.tempo_real_acumulado : calculateTempoReal(t)), 0);
      const totalDesvio = totalTempoPlanejado - totalTempoReal;
      const desvioClass = totalDesvio < 0 ? 'highlight-red' : 'text-green-600';
      
      document.getElementById('of-details-title').textContent = `Detalhes da OF: ${of.id}`;
      document.getElementById('of-details-progress').style.width = `${progress}%`;
      
      const summaryHtml = `
        <div class="bg-gray-50 p-3 rounded-lg"><p class="text-xs text-gray-500">Chicote</p><p class="font-semibold text-gray-800">${of.chicote}</p></div>
        <div class="bg-gray-50 p-3 rounded-lg"><p class="text-xs text-gray-500">Qtd.</p><p class="font-semibold text-gray-800">${of.quantidade}</p></div>
        <div class="bg-gray-50 p-3 rounded-lg"><p class="text-xs text-gray-500">T. Planejado</p><p class="font-semibold text-gray-800">${formatMinutes(totalTempoPlanejado)}</p></div>
        <div class="bg-gray-50 p-3 rounded-lg"><p class="text-xs text-gray-500">Desvio Total</p><p class="font-bold ${desvioClass}">${totalDesvio > 0 ? 'üëç ' : 'üëé '}${formatMinutes(Math.abs(totalDesvio))}</p></div>
      `;
      document.getElementById('of-details-summary').innerHTML = summaryHtml;
      
      const contentHtml = tasks.map(task => {
          const finalTempoReal = task.status === 'Conclu√≠do' ? task.tempo_real_acumulado : calculateTempoReal(task);
          const desvio = (task.tempo_planejado||0) - finalTempoReal;
          const statusClass = task.status === 'Conclu√≠do' ? 'text-green-600' : (task.status === 'Em Processo' ? 'text-blue-600' : 'text-gray-500');
          const desvioClass = desvio < 0 ? 'highlight-red' : 'text-green-600';
          const icon = task.status === 'Conclu√≠do' ? 'check-circle' : (task.status === 'Em Processo' ? 'play-circle' : 'circle');

          return `
              <div class="p-3 border rounded-lg shadow-sm flex items-center justify-between">
                  <div class="flex items-center gap-3">
                      <i data-lucide="${icon}" class="w-5 h-5 ${statusClass}"></i>
                      <div>
                          <p class="font-semibold text-gray-800">${task.ordem} - ${task.nome_atividade} (${task.setor})</p>
                          <p class="text-xs text-gray-500">${task.status === 'Conclu√≠do' ? 'Conclu√≠do' : task.status} ${task.timestamp_fim ? new Date(getDBTimestamp(task.timestamp_fim)).toLocaleDateString() : ''}</p>
                      </div>
                  </div>
                  <div class="text-right">
                      <p class="text-sm text-gray-700">T. Real: ${formatMinutes(finalTempoReal)}</p>
                      <p class="text-xs ${desvioClass}">Desvio: ${formatMinutes(Math.abs(desvio))}</p>
                  </div>
              </div>
          `;
      }).join('');
      document.getElementById('of-details-content').innerHTML = contentHtml;
      
      // Mostrar bot√£o de exclus√£o apenas para Master
      btnDeleteOF.classList.toggle('hidden', !isMaster());

      openModal('of-details-modal');
      lucide.createIcons();
    }
    
    function renderRoteiros(){
      const listContainer = document.getElementById('roteiro-list');
      if (!listContainer) return;

      const roteiros = Object.values(allRoteiros).sort((a, b) => {
        if (a.chicote_nome < b.chicote_nome) return -1;
        if (a.chicote_nome > b.chicote_nome) return 1;
        // N√£o h√° ordem, ent√£o ordena por nome da atividade
        return a.nome_atividade.localeCompare(b.nome_atividade);
      });
      
      if (roteiros.length === 0){
        listContainer.innerHTML = '<p class="text-center text-gray-500 p-4">Nenhum roteiro mestre cadastrado.</p>';
        return;
      }
      
      let currentChicote = '';
      let html = '';

      roteiros.forEach(roteiro => {
        if (roteiro.chicote_nome !== currentChicote) {
          if (currentChicote !== '') html += '</div>'; // Fecha o grupo anterior
          currentChicote = roteiro.chicote_nome;
          html += `<h4 class="text-md font-bold text-gray-800 mt-4 mb-2 border-b pb-1">${currentChicote}</h4><div class="space-y-2">`;
        }

        html += `
          <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border border-gray-100">
            <div>
              <p class="text-sm font-medium text-gray-700">${roteiro.nome_atividade} (${roteiro.setor})</p>
              <p class="text-xs text-gray-500">Setup: ${formatMinutes(roteiro.tempo_setup)} | Ciclo: ${formatMinutes(roteiro.tempo_ciclo)}/p√ß</p>
            </div>
            <button onclick="deleteRoteiroActivity('${roteiro.id}')" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-50 transition" title="Excluir Etapa">
               <i data-lucide="x" class="w-5 h-5"></i>
            </button>
          </div>
        `;
      });
      
      if (currentChicote !== '') html += '</div>';
      listContainer.innerHTML = html;
      lucide.createIcons();
    }
    
    // ==========================
    //  CSV EXPORT
    // ==========================
    function convertToCSV(dataArray, filename) {
        if (!dataArray || dataArray.length === 0) {
            alert("Nenhum dado para exportar.");
            return;
        }

        const headers = Object.keys(dataArray[0]);
        const csvRows = [];
        
        // Headers
        csvRows.push(headers.join(';'));
        
        // Rows
        for (const row of dataArray) {
            const values = headers.map(header => {
                const value = row[header];
                if (value && typeof value.toDate === 'function') {
                    // Formata Timestamps do Firebase
                    return `"${value.toDate().toLocaleString('pt-BR')}"`;
                }
                const stringValue = String(value || '');
                // Escape v√≠rgulas e aspas
                return `"${stringValue.replace(/"/g, '""')}"`;
            });
            csvRows.push(values.join(';'));
        }

        const csvString = csvRows.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        
        link.href = URL.createObjectURL(blob);
        link.setAttribute('download', filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    function exportReportCSV() {
        const reportData = allOcurrencesLog.map(log => {
            const timestamp = log.timestamp && typeof log.timestamp.toDate === 'function' ? log.timestamp.toDate() : log.timestamp;
            return {
                TIMESTAMP: timestamp ? new Date(timestamp).toLocaleString('pt-BR') : '',
                TIPO: log.TIPO,
                OF: log.OF,
                CHICOTE: log.CHICOTE,
                ATIVIDADE: log.ATIVIDADE,
                SECTOR: log.SECTOR,
                OPERADOR: log.OPERADOR,
                MOTIVO_PAUSA: log.MOTIVO_PAUSA || '-',
                MOTIVO_ATRASO: log.MOTIVO_ATRASO || '-',
                TEMPO_PAUSA_MIN: (log.TEMPO_PAUSA || 0).toFixed(2),
                TEMPO_ATRASO_MIN: (log.TEMPO_ATRASO || 0).toFixed(2),
                MOTIVO_DETALHES: log.MOTIVO_DETALHES || '-',
            };
        });
        convertToCSV(reportData, 'relatorio_ocorrencias.csv');
    }

    function exportOFTasksCSV(ofId) {
        if (!ofId) return;

        const tasks = Object.values(allTasks)
          .filter(t => t.id_of === ofId)
          .sort((a,b) => a.ordem - b.ordem);
        
        const tasksData = tasks.map(t => {
            const finalTempoReal = t.status === 'Conclu√≠do' ? t.tempo_real_acumulado : calculateTempoReal(t);
            const desvio = (t.tempo_planejado || 0) - finalTempoReal;
            const tempoPauseFinal = calculateTotalPauseMinutesFinal(t);
            
            const inicio = t.timestamp_inicio && typeof t.timestamp_inicio.toDate === 'function' ? t.timestamp_inicio.toDate() : t.timestamp_inicio;
            const fim = t.timestamp_fim && typeof t.timestamp_fim.toDate === 'function' ? t.timestamp_fim.toDate() : t.timestamp_fim;

            return {
                OF: t.id_of,
                ORDEM: t.ordem,
                ATIVIDADE: t.nome_atividade,
                CHICOTE: t.chicote,
                SETOR: t.setor,
                STATUS: t.status,
                QUANTIDADE: t.quantidade_pecas,
                TEMPO_SETUP_MIN: t.tempo_setup,
                TEMPO_CICLO_MIN: t.tempo_ciclo,
                TEMPO_PLANEJADO_MIN: t.tempo_planejado,
                TEMPO_REAL_MIN: finalTempoReal.toFixed(2),
                TEMPO_PAUSA_MIN: tempoPauseFinal.toFixed(2),
                DESVIO_MIN: desvio.toFixed(2),
                INICIO: inicio ? new Date(inicio).toLocaleString('pt-BR') : '-',
                FIM: fim ? new Date(fim).toLocaleString('pt-BR') : '-',
            };
        });
        convertToCSV(tasksData, `tarefas_${ofId}.csv`);
    }

    // ==========================
    //  USER / LOGIN
    // ==========================
    function openUserModal(initUser = null){
      const modal = document.getElementById('user-modal');
      const roleSel = document.getElementById('user-role');
      const sectorSel = document.getElementById('user-sector');
      const pinWrap = document.getElementById('user-pin-wrap');
      const sectorWrap = document.getElementById('user-sector-wrap');
      
      // Preenche setores no modal de login
      setupSectorDropdowns();

      const currentUser = initUser || getUser();
      
      roleSel.value = (currentUser?.role || 'OPERADOR');
      if (currentUser?.sector) sectorSel.value = currentUser.sector;

      // L√≥gica de toggle PIN/Setor
      roleSel.onchange = () => {
        const isM = roleSel.value === 'MASTER';
        pinWrap.classList.toggle('hidden', !isM);
        sectorWrap.classList.toggle('hidden', isM);
      };
      roleSel.onchange(); 
      modal.style.display='flex';
    }
    
    function confirmUser(){
      const role = document.getElementById('user-role').value;
      const sector = document.getElementById('user-sector').value;
      const pin = document.getElementById('user-pin').value;

      if (role==='MASTER'){
        if (pin !== MASTER_PIN){ 
            alert('PIN incorreto.'); 
            return; 
        }
        setUser({ role:'MASTER', name:'Master' });
        closeModal('user-modal');
        setupSectorDropdowns();
        updateView('PCP');
      } else {
        if (!sector){ 
            alert('Selecione um setor.'); 
            return; 
        }
        setUser({ role:'OPERADOR', sector, name:'Operador' });
        closeModal('user-modal');
        setupSectorDropdowns();
        updateView('Operador');
      }
    }
    
    // ==========================
    //  REFRESH E IN√çCIO
    // ==========================
    function setupUIRefresh(){
        // Atualiza a visualiza√ß√£o a cada 10 segundos (para atualizar tempo real e desvio)
        setInterval(() => {
            const currentView = userViewSelect.value;
            if (currentView === 'PCP') {
                renderOFs();
                renderKPIs();
            } else if (currentView === 'Operador') {
                renderTasks();
            }
        }, 10000); 
    }

    // Chamada inicial
    document.addEventListener('DOMContentLoaded', initializeApp);

    // Exp√µe fun√ß√µes para o HTML
    window.startTask = startTask;
    window.pauseTask = pauseTask;
    window.finishTask = finishTask;
    window.openOFDetails = openOFDetails;
    window.openInstructionModal = openInstructionModal;
    window.handleConfirmedAction = handleConfirmedAction;
    window.openModal = openModal;
    window.closeModal = closeModal;
    window.createOF = createOF;
    window.addRoteiroActivity = addRoteiroActivity;
    window.deleteRoteiroActivity = deleteRoteiroActivity;
    window.deleteOF = deleteOF;
    window.exportReportCSV = exportReportCSV;
    window.exportOFTasksCSV = exportOFTasksCSV;
    window.openUserModal = openUserModal;
    window.confirmUser = confirmUser;
    window.updateSectorFilter = updateSectorFilter;

  </script>
</body>
</html>
