<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema PCP: Controle de Produ√ß√£o e Roteiros (Firebase Edition)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap");
    :root { color-scheme: light dark; }
    body { font-family: "Inter", sans-serif; }
    .bg-gradient-header { background: linear-gradient(90deg, #1e40af 0%, #3b82f6 100%); }
    .modal-fixed { position: fixed; inset: 0; }
    #instruction-modal-content a { color: #3b82f6; text-decoration: underline; font-weight: 600; }
    .highlight-red { color: #dc2626; font-weight: 600; }

    /* ---------- Mobile tweaks ---------- */
    /* Deixa os modais em fullscreen no mobile, mantendo max-width no desktop */
    .modal-panel { max-height: calc(100dvh - 2rem); }
    @media (max-width: 640px) {
      .modal-panel {
        width: 100vw !important;
        max-width: 100vw !important;
        height: 100dvh !important;
        max-height: 100dvh !important;
        border-radius: 0 !important;
        margin: 0 !important;
        display: flex;
        flex-direction: column;
      }
      .modal-body-scroll {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      .sticky-footer {
        position: sticky;
        bottom: 0;
        background: white;
        padding-top: .5rem;
      }
      .card-tap-big { padding: 1rem; }
    }

    /* Safe areas (notch iOS) */
    body {
      padding-left: max(env(safe-area-inset-left), 0px);
      padding-right: max(env(safe-area-inset-right), 0px);
    }
  </style>
</head>
<body class="min-h-screen bg-gray-100 antialiased">

  <header id="header-container" class="bg-gradient-header shadow-lg p-3 sm:p-4 sticky top-0 z-10">
    <div class="max-w-7xl mx-auto flex justify-between items-center gap-2">
      <h1 class="text-2xl sm:text-3xl font-extrabold text-white flex items-center">
        <i data-lucide="factory" class="w-7 h-7 sm:w-8 sm:h-8 mr-2"></i>
        Controle de Produ√ß√£o e Processos
      </h1>
      <div class="flex gap-2 items-center">
        <button id="btn-profile"
              class="text-white bg-blue-800 hover:bg-blue-700 font-semibold py-2 px-3 rounded-lg shadow-md transition hidden"
                onclick="openUserModal()">
          <i data-lucide="user-cog" class="w-5 h-5 inline-block mr-1"></i>
          <span class="hidden sm:inline">Perfil</span>
        </button>

        <select id="user-view-select"
                onchange="updateView(this.value)"
              class="bg-blue-800 text-white text-xs sm:text-sm font-semibold py-2 px-2 rounded-lg transition hover:bg-blue-700 focus:ring-2 focus:ring-blue-300">
          <option value="PCP">Vis√£o: PCP (Gerencial)</option>
          <option value="Operador">Vis√£o: Operador</option>
          <option value="Relatorio">Vis√£o: Relat√≥rio</option>
        </select>

        <button onclick="openModal('create-of-modal')" id="btn-create-of"
                class="text-white bg-green-600 hover:bg-green-700 font-semibold py-2 px-3 rounded-lg shadow-md transition hidden">
          <i data-lucide="plus" class="w-5 h-5 inline-block mr-1"></i>
          <span class="hidden sm:inline">Criar OF</span>
        </button>
        <button onclick="openModal('setup-roteiro-modal')" id="btn-setup-roteiro"
                class="text-white bg-yellow-600 hover:bg-yellow-700 font-semibold py-2 px-3 rounded-lg shadow-md transition hidden">
          <i data-lucide="settings" class="w-5 h-5 inline-block mr-1"></i>
          <span class="hidden sm:inline">Setup Roteiro</span>
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-3 sm:p-6 lg:p-8">
    <div id="loading-indicator" class="flex flex-col items-center justify-center p-6 sm:p-12 bg-white rounded-xl shadow-xl">
      <i data-lucide="loader-circle" class="w-8 h-8 sm:w-10 sm:h-10 text-blue-500 animate-spin"></i>
      <p class="mt-3 sm:mt-4 text-gray-600 font-semibold text-sm sm:text-base">Carregando dados e autenticando...</p>
    </div>

    <div id="pcp-view" class="space-y-4 sm:space-y-6 hidden">
      <h2 class="text-xl sm:text-2xl font-bold text-gray-800 border-b pb-2 mb-2 sm:mb-4 flex items-center">
        <i data-lucide="bar-chart-3" class="w-5 h-5 sm:w-6 sm:h-6 mr-2"></i>
        Painel PCP: Acompanhamento de OFs
      </h2>
      <div id="kpis-container" class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-4"></div>
      <div id="ofs-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-6"></div>
    </div>

    <div id="operator-view" class="space-y-4 sm:space-y-6 hidden">
      <div class="bg-white p-3 sm:p-4 rounded-xl shadow-lg mb-4 sm:mb-6 flex flex-col sm:flex-row items-center justify-between gap-3">
        <h2 class="text-lg sm:text-xl font-bold text-gray-800 flex items-center">
          <i data-lucide="clipboard-list" class="w-5 h-5 sm:w-6 sm:h-6 mr-2 text-blue-600"></i>
          Minhas Tarefas
        </h2>
        <div class="flex items-center gap-2 w-full sm:w-auto">
          <input type="text" id="of-search-filter" oninput="updateOFCFilter(this.value)"
                 class="p-2 border border-gray-300 rounded-lg bg-white focus:ring-blue-500 focus:border-blue-500 w-full sm:w-48"
                 placeholder="Buscar por OF (Ex: OF-001)">
          <label for="sector-filter" class="text-xs sm:text-sm font-semibold text-gray-700 flex-shrink-0">Setor:</label>
          <select id="sector-filter" onchange="updateSectorFilter(this.value)"
                  class="p-2 border border-blue-300 rounded-lg bg-blue-50 focus:ring-blue-500 focus:border-blue-500 w-full sm:w-48"></select>
        </div>
      </div>
      <div id="tasks-list-container" class="space-y-3 sm:space-y-4"></div>
    </div>

    <div id="report-view" class="space-y-4 sm:space-y-6 hidden">
      <h2 class="text-xl sm:text-2xl font-bold text-gray-800 border-b pb-2 mb-2 sm:mb-4 flex items-center">
        <i data-lucide="file-text" class="w-5 h-5 sm:w-6 sm:h-6 mr-2 text-purple-600"></i>
        Relat√≥rio Detalhado de Pausas e Atrasos
      </h2>
      <div class="bg-white p-3 sm:p-4 rounded-xl shadow-lg">
        <div class="flex justify-between items-center mb-3 sm:mb-4">
          <h3 class="text-base sm:text-xl font-semibold text-gray-700">Ocorr√™ncias Registradas (Desvios)</h3>
          <button id="btn-export-report" onclick="exportReportCSV()"
                  class="px-3 sm:px-4 py-2 bg-purple-600 text-white text-sm sm:text-base font-semibold rounded-lg hover:bg-purple-700 transition">
            <i data-lucide="download" class="w-4 h-4 sm:w-5 sm:h-5 inline-block mr-1"></i> Exportar (CSV)
          </button>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 text-xs sm:text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">OF</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">CHICOTE</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">ATIVIDADE</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">MOTIVO PAUSA</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">MOTIVO ATRASO</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">T. PAUSA (min)</th>
                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">T. ATRASO (min)</th>
              </tr>
            </thead>
            <tbody id="report-table-body" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <div id="action-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal()">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-md modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <h3 id="modal-title" class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2"></h3>
      <div class="modal-body-scroll">
        <p id="modal-message" class="text-gray-600 mb-3 sm:mb-4"></p>
        <div id="modal-content">
          <div id="justification-area" class="space-y-3 sm:space-y-4">
            <label for="justification-select" class="block text-sm font-medium text-gray-700">Selecione o Motivo Principal:</label>
            <select id="justification-select" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500 transition">
              <option value="">-- Selecione uma op√ß√£o --</option>
            </select>
            <label for="justification-text" class="block text-sm font-medium text-gray-700">Detalhes Adicionais (Opcional):</label>
            <textarea id="justification-text" rows="2" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-blue-500 focus:border-blue-500 transition" placeholder=""></textarea>
            <p id="justification-required-text" class="text-sm text-red-500 hidden font-semibold">üö® Campo obrigat√≥rio devido ao desvio de tempo!</p>
          </div>
        </div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end gap-2 sm:gap-3 sticky-footer">
        <button onclick="closeModal()" class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition">Cancelar</button>
        <button id="modal-confirm-button" class="px-3 sm:px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition" onclick="handleConfirmedAction()">Confirmar</button>
      </div>
    </div>
  </div>

  <div id="instruction-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal()">
    <div class="bg-white rounded-xl shadow-2xl p-5 sm:p-8 w-full max-w-2xl modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2 flex items-center">
        <i data-lucide="book-open-text" class="w-5 h-5 sm:w-6 sm:h-6 mr-2 text-indigo-600"></i> Instru√ß√£o de Trabalho
      </h3>
      <div class="max-h-[65vh] sm:max-h-[70vh] overflow-y-auto pr-1 sm:pr-2 modal-body-scroll">
        <p class="text-sm font-semibold text-gray-700 mb-2" id="instruction-modal-header"></p>
        <div id="instruction-modal-content" class="text-gray-700 space-y-3"></div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end">
        <button onclick="closeModal('instruction-modal')" class="px-3 sm:px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition">Fechar</button>
      </div>
    </div>
  </div>

  <div id="create-of-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal()">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-lg modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">Criar Nova Ordem de Fabrica√ß√£o (OF)</h3>
      <div class="space-y-3 sm:space-y-4 modal-body-scroll">
        <div>
          <label for="of-id" class="block text-sm font-medium text-gray-700">C√≥digo da OF:</label>
          <input type="text" id="of-id" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: OF-003">
        </div>
        <div>
          <label for="of-quantity" class="block text-sm font-medium text-gray-700">Quantidade de Pe√ßas:</label>
          <input type="number" id="of-quantity" min="1" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: 50">
        </div>
        <div>
          <label for="of-chicote" class="block text-sm font-medium text-gray-700">Modelo do Chicote (Roteiro Mestre):</label>
          <select id="of-chicote" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-blue-500 focus:border-blue-500">
            <option value="">Carregando roteiros...</option>
          </select>
        </div>
        <div id="of-creation-message" class="text-sm text-red-500 hidden"></div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end gap-2 sm:gap-3 sticky-footer">
        <button onclick="closeModal('create-of-modal')" class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition">Cancelar</button>
        <button onclick="createOF()" class="px-3 sm:px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">
          <i data-lucide="factory" class="w-5 h-5 inline-block mr-1"></i> Gerar OF
        </button>
      </div>
    </div>
  </div>

  <div id="setup-roteiro-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal()">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-2xl modal-panel mx-0 sm:mx-4" 
    onclick="event.stopPropagation()">
      <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">Setup: Cadastro de Roteiros Mestres</h3>
      <div id="roteiro-list" class="space-y-4 h-[50vh] sm:h-64 overflow-y-auto mb-4 p-2 border rounded-lg bg-gray-50 modal-body-scroll"></div>
      <div class="border-t pt-4 space-y-4">
        <h4 class="text-base sm:text-lg font-semibold text-gray-700">Nova Etapa para Roteiro:</h4>
        <div class="flex flex-col gap-3">
          <div class="flex flex-col sm:flex-row gap-3">
            <input type="text" id="roteiro-chicote-name" class="w-full sm:w-1/2 border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Nome do Chicote (Ex: CHICOTE-A)">
            <select id="roteiro-setor" class="w-full sm:w-1/2 border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500"></select>
          </div>
          <input type="text" id="roteiro-activity-name" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Nome da Atividade (Ex: Pr√© Conex√£o)">
          <div class="flex flex-col sm:flex-row gap-3">
            <input type="number" id="roteiro-setup-time" min="0" step="0.1" class="w-full sm:w-1/2 border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Setup (min)">
            <input type="number" id="roteiro-cycle-time" min="0" step="0.1" class="w-full sm:w-1/2 border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ciclo (min/p√ß)">
          </div>
          <div>
            <label for="roteiro-instruction-text" class="block text-sm font-medium text-gray-700 mb-1">Instru√ß√£o de Trabalho (HTML permitido):</label>
            <textarea id="roteiro-instruction-text" rows="4" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: <b>1. Prepara√ß√£o:</b> ..."></textarea>
          </div>
          <button onclick="addRoteiroActivity()" class="p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
            <i data-lucide="plus" class="w-5 h-5 inline-block mr-1"></i> Adicionar Etapa
          </button>
        </div>
        <div id="roteiro-message" class="text-sm text-red-500"></div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end">
        <button onclick="closeModal('setup-roteiro-modal')" class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition">Fechar</button>
      </div>
    </div>
  </div>

  <div id="of-details-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal('of-details-modal')">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-3xl modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-2">
        <h3 id="of-details-title" class="text-xl sm:text-2xl font-bold text-gray-800"></h3>
        <button class="p-2 rounded-lg hover:bg-gray-100" onclick="closeModal('of-details-modal')">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>
      <div id="of-details-summary" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3 sm:mb-4"></div>
      <div class="w-full bg-gray-200 rounded-full h-2 mb-3 sm:mb-4">
        <div id="of-details-progress" class="h-2 rounded-full bg-blue-500" style="width:0%"></div>
      </div>
      <div id="of-details-content" class="max-h-[60vh] overflow-y-auto space-y-3 sm:space-y-4 modal-body-scroll"></div>
      <div class="mt-4 sm:mt-5 flex justify-between gap-3 sticky-footer">
        <button id="btn-delete-of" class="px-3 sm:px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition hidden" onclick="deleteOF(window.__ofDetailsOpenId)">
          <i data-lucide="trash-2" class="w-4 h-4 sm:w-5 sm:h-5 inline-block mr-1"></i> Excluir OF
        </button>
        <div class="flex gap-2 sm:gap-3">
          <button id="btn-export-of" class="px-3 sm:px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition" onclick="exportOFTasksCSV(window.__ofDetailsOpenId)">Exportar CSV</button>
          <button class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition" onclick="closeModal('of-details-modal')">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <div id="user-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="event.stopPropagation()">
    <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-md modal-panel mx-0 sm:mx-4">
      <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">Acesso</h3>
      <div class="space-y-3 sm:space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Perfil</label>
          <select id="user-role" class="w-full border border-gray-300 rounded-lg p-2 mt-1">
            <option value="OPERADOR">Operador</option>
            <option value="MASTER">Master</option>
          </select>
        </div>
        <div id="user-sector-wrap">
          <label class="block text-sm font-medium text-gray-700">Setor do Operador</label>
          <select id="user-sector" class="w-full border border-gray-300 rounded-lg p-2 mt-1"></select>
        </div>
        <div id="user-pin-wrap" class="hidden">
          <label class="block text-sm font-medium text-gray-700">PIN do Master</label>
          <input type="password" id="user-pin" class="w-full border border-gray-300 rounded-lg p-2 mt-1" placeholder="****">
          <p class="text-xs text-gray-500 mt-1">PIN padr√£o: 7889</p>
        </div>
      </div>
      <div class="mt-4 sm:mt-6 flex justify-end gap-2 sm:gap-3">
        <button class="px-3 sm:px-4 py-2 bg-gray-200 rounded-lg font-semibold hover:bg-gray-300" onclick="closeModal('user-modal')">Cancelar</button>
        <button class="px-3 sm:px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700" onclick="confirmUser()">Entrar</button>
      </div>
    </div>
  </div>

  <script>
    // =================================================================================================
    // CONFIGURA√á√ÉO FIREBASE: 
    // =================================================================================================
    const firebaseConfig = {
      apiKey: "AIzaSyDIJJIe4WIVj5OKYTtR-HQscrxIzxNK9eY",
      authDomain: "pcp-app-24c56.firebaseapp.com",
      projectId: "pcp-app-24c56",
      storageBucket: "pcp-app-24c56.firebasestorage.app",
      messagingSenderId: "675295958467",
      appId: "1:675295958467:web:9d79700af6fc1c28db5976",
      measurementId: "G-DH06WDCKJY"
    };
    // Inicializa√ß√£o do Firebase (se a config n√£o estiver vazia)
    if (Object.keys(firebaseConfig).length > 0 && firebaseConfig.projectId) {
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // Cole√ß√µes
        const OF_COLLECTION = 'ofs';
        const TASK_COLLECTION = 'tasks';
        const ROTEIRO_COLLECTION = 'roteiros';
        const OCORRENCIA_COLLECTION = 'ocorrencias';

        window.db = db;
        window.OF_COLLECTION = OF_COLLECTION;
        window.TASK_COLLECTION = TASK_COLLECTION;
        window.ROTEIRO_COLLECTION = ROTEIRO_COLLECTION;
        window.OCORRENCIA_COLLECTION = OCORRENCIA_COLLECTION;
    } else {
        // Se as configura√ß√µes n√£o forem fornecidas, o c√≥digo usar√° a vers√£o Simula√ß√£o/Default.
        alert("AVISO: Configura√ß√µes do Firebase ausentes. O sistema usar√° dados iniciais e n√£o salvar√° no banco de dados.");
        window.db = null;
    }
    // =================================================================================================


    // ==========================
    //  VARI√ÅVEIS E DADOS GLOBAIS
    // ==========================
    const MASTER_PIN = "7889";
    const SECTORS = [
      'Corte','Corte de Revestimentos','Pr√©-Montagem','Prepara√ß√£o','Pr√© Conex√£o',
      'Conex√£o','Pr√© Grampea√ß√£o','Grampea√ß√£o','Acabamento','Embalagem','Montagem','Cabo de Bateria 1','Cabo de Bateria 2'
    ];
    const PAUSE_REASONS = [
      "Falta de material na bancada","Manuten√ß√£o/Ajuste de m√°quina","Instru√ß√£o de trabalho confusa/ausente",
      "Necessidade de assist√™ncia t√©cnica","Troca de turno/intervalo programado","Outro (Detalhar abaixo)"
    ];
    const DELAY_REASONS = [
      "Complexidade inesperada da pe√ßa","Problema de qualidade na etapa anterior","Falta de treinamento/experi√™ncia",
      "Tempo padr√£o calculado incorretamente","Quebra/defeito de ferramenta","Outro (Detalhar abaixo)"
    ];
    // Dados que ser√£o preenchidos pelos listeners do Firebase
    let allOFs = {};
    let allTasks = {};
    let allRoteiros = {};
    let allOcurrencesLog = [];
    let currentAction = {};
    // Armazena a a√ß√£o pendente do modal
    let currentSectorFilter = SECTORS[0];
    let currentOFCFilter = ""; // VARI√ÅVEL GLOBAL PARA FILTRO DE OF
    let currentUser = null;
    // Roteiro / Task Counters (para simula√ß√£o ou inicializa√ß√£o)
    let taskCounter = 1;
    let roteiroCounter = 7;
    // ==========================
    //  ROTEIROS PR√â-CARREGADOS (Fallback para inicializa√ß√£o ou Simula√ß√£o)
    // ==========================
    const DEFAULT_ROTEIROS = {
      "r1": { id:"r1", chicote_nome:"CHICOTE-001", setor:"Corte", nome_atividade:"Corte dos Fios", tempo_setup:5, tempo_ciclo:0.2,
        instrucao_trabalho:"<b>1. Prepara√ß√£o:</b> Verifique se a faca est√° calibrada para o fio 1.0mm.<br><b>2. Medi√ß√£o:</b> Corte 50 pe√ßas com 150mm cada.<br><b>3. Confer√™ncia:</b> Fa√ßa uma confer√™ncia visual. <a href='https://upload.wikimedia.org/wikipedia/commons/4/4e/Sample_cut.png' target='_blank'>**Ver Imagem de Padr√£o**</a>."
      },
      "r2": { id:"r2", chicote_nome:"CHICOTE-001", setor:"Pr√©-Montagem", nome_atividade:"Crimpagem de Terminais", tempo_setup:8, tempo_ciclo:0.5,
        instrucao_trabalho:"<b>1. Fio Preto:</b> ...<br><b>2. Fio Vermelho:</b> ...<br><b>3. Teste:</b> > 10Kgf. <a href='https://www.youtube.com/watch?v=dQw4w9WgXcQ' target='_blank'>**Assistir V√≠deo**</a>"
      },
      "r3": { id:"r3", chicote_nome:"CHICOTE-001", setor:"Montagem Final", nome_atividade:"Montagem de Conectores", tempo_setup:15, tempo_ciclo:1.0,
        instrucao_trabalho:"<b>Aten√ß√£o:</b> Conectar posi√ß√µes 35 e 33. Proibido for√ßar."
      },
      "r4": { id:"r4", chicote_nome:"CHICOTE-001", setor:"Qualidade", nome_atividade:"Teste de Continuidade", tempo_setup:3, tempo_ciclo:0.1,
        instrucao_trabalho:"Usar jig JIG-10B. 100% devem passar."
      },
      "r5": { id:"r5", chicote_nome:"CHICOTE-B", setor:"Corte", nome_atividade:"Corte Fios Refor√ßados", tempo_setup:10, tempo_ciclo:0.3, instrucao_trabalho:"Instru√ß√£o b√°sica B."},
      "r6": { id:"r6", chicote_nome:"CHICOTE-B", setor:"Montagem Final", nome_atividade:"Montagem Simples", tempo_setup:5, tempo_ciclo:0.8, instrucao_trabalho:"Conectar 4 vias."},
    };
    // ==========================
    //  ELEMENTOS UI
    // ==========================
    const pcpView = document.getElementById("pcp-view");
    const operatorView = document.getElementById("operator-view");
    const reportView = document.getElementById("report-view");
    const loadingIndicator = document.getElementById("loading-indicator");
    const ofsListContainer = document.getElementById("ofs-list-container");
    const tasksListContainer = document.getElementById("tasks-list-container");
    const userViewSelect = document.getElementById("user-view-select");
    const btnCreateOF = document.getElementById("btn-create-of");
    const btnSetupRoteiro = document.getElementById("btn-setup-roteiro");
    const btnProfile = document.getElementById("btn-profile");
    const btnExportReport = document.getElementById("btn-export-report");
    const btnDeleteOF = document.getElementById("btn-delete-of");

    // ==========================
    //  HELPERS & PERMISS√ïES
    // ==========================
    function msToMinutes(ms){ 
      if (typeof ms !== 'number' || ms < 0) return 0;
      return parseFloat((ms / (1000*60)).toFixed(2));
    }
    function formatMinutes(v){ return `${Number(v||0).toFixed(2)} min`; }
    
    function setUser(u){ 
      currentUser = u;
      // Manter a sess√£o do usu√°rio no localStorage (comportamento original)
      localStorage.setItem("pcp_current_user", JSON.stringify(u));
    }
    
    function getUser(){ 
      try{ 
        return JSON.parse(localStorage.getItem("pcp_current_user")||"null");
      }catch(e){ 
        return null;
      } 
    }
    
    function isMaster(){ return currentUser && currentUser.role === "MASTER"; }
    function isOperador(){ return currentUser && currentUser.role === "OPERADOR"; }

    function getDBTimestamp(timestampField) {
        if (!timestampField) return null;
        // Verifica se √© um objeto Timestamp do Firebase (pode ser um Date se vier do mock)
        if (typeof timestampField.toDate === 'function') {
            return timestampField.toDate().getTime();
        }
        // Se for um n√∫mero (milliseconds) ou um Date object
        if (timestampField instanceof Date) {
             return timestampField.getTime();
        }
        return timestampField; // Assume que j√° √© o n√∫mero de milissegundos
    }

    // ==========================
    //  C√ÅLCULOS DE TEMPO
    // ==========================
    function calculateTempoReal(task){
      let tempoReal = task.tempo_real_acumulado || 0;
      const now = Date.now();

      if (task.status === 'Em Processo' && task.timestamp_inicio){
          let inicioMs = getDBTimestamp(task.timestamp_inicio);
          if (inicioMs) {
              let tempoTrabalhadoDesdeInicio = msToMinutes(now - inicioMs);
              tempoReal += tempoTrabalhadoDesdeInicio;
          }
      }
      return parseFloat(tempoReal.toFixed(2));
    }
    
    function calculateDesvio(task){
      const tempoReal = calculateTempoReal(task);
      // Desvio = Tempo Planejado - Tempo Real (Negativo = Atraso)
      const desvio = (task.tempo_planejado||0) - tempoReal;
      return parseFloat(desvio.toFixed(2));
    }

    function calculateTotalPauseMinutes(task){
      let totalMs = task.total_pause_time_ms || 0;
      if (task.status === 'Pausada' && task.pause_start_timestamp){
          let pauseStartMs = getDBTimestamp(task.pause_start_timestamp);
          if (pauseStartMs) {
              totalMs += Date.now() - pauseStartMs;
          }
      }
      return msToMinutes(totalMs);
    }

    function calculateTotalPauseMinutesFinal(task){
      // Usado para o relat√≥rio, n√£o considera a pausa em andamento
      return msToMinutes(task.total_pause_time_ms || 0);
    }

    // ==========================
    //  INICIALIZA√á√ÉO & DADOS
    // ==========================
    function setupSectorDropdowns(){
        const roteiroSetorSelect = document.getElementById('roteiro-setor');
        const sectorFilterSelect = document.getElementById('sector-filter');
        const userSectorSelect = document.getElementById('user-sector');

        // Limpa todos
        [roteiroSetorSelect, sectorFilterSelect, userSectorSelect].forEach(sel => {
            if (sel) sel.innerHTML = '';
        });

        // 1. Dropdown de Setup Roteiro e User Sector
        SECTORS.forEach(sector=>{
            const o1 = document.createElement('option');
            o1.value=sector;
            o1.textContent=sector;
            const o2 = o1.cloneNode(true);
            if (roteiroSetorSelect) roteiroSetorSelect.appendChild(o1);
            if (userSectorSelect) userSectorSelect.appendChild(o2);
        });

        // 2. Dropdown de Filtro do Operador
        if (sectorFilterSelect){
            if (isOperador()){
                const o = document.createElement('option');
                o.value=currentUser.sector;
                o.textContent=currentUser.sector;
                sectorFilterSelect.appendChild(o);
                sectorFilterSelect.value=currentUser.sector;
                sectorFilterSelect.disabled = true;
                currentSectorFilter = currentUser.sector;
            }else{
                SECTORS.forEach(sector=>{
                    const o2 = document.createElement('option');
                    o2.value=sector;
                    o2.textContent=sector;
                    sectorFilterSelect.appendChild(o2);
                });
                currentSectorFilter = SECTORS[0];
                sectorFilterSelect.value = SECTORS[0];
                sectorFilterSelect.disabled = false;
            }
        }
    }

    function updateSectorFilter(sector){
        currentSectorFilter = sector;
        renderTasks(); // Renderiza tarefas do novo setor
    }

    // NOVA FUN√á√ÉO PARA FILTRO DE OF
    function updateOFCFilter(ofc){
        currentOFCFilter = ofc.toUpperCase().trim();
        renderTasks();
    }
    // FIM NOVA FUN√á√ÉO

    function loadRoteiroDropdowns() {
        const select = document.getElementById('of-chicote');
        if (!select) return;

        const roteiros = Object.values(allRoteiros);
        const chicotes = [...new Set(roteiros.map(r => r.chicote_nome))];

        select.innerHTML = '<option value="">-- Selecione um Modelo --</option>';

        chicotes.forEach(chicote => {
            const option = document.createElement('option');
            option.value = chicote;
            option.textContent = chicote;
            select.appendChild(option);
        });
        if (chicotes.length === 0) {
            select.innerHTML = '<option value="">Nenhum roteiro mestre cadastrado.</option>';
        }
    }

    async function initializeApp(){
        loadingIndicator.classList.remove('hidden');

        // 1. Tenta carregar usu√°rio
        const savedUser = getUser();
        if (savedUser){
            setUser(savedUser);
        }

        // CORRE√á√ÉO: FOR√áAR LOGIN ANTES DE TUDO
        if (!currentUser) {
            loadingIndicator.classList.add('hidden'); // Esconde a tela de carregamento
            openUserModal(); // For√ßa a abertura do modal de login
            return; // P√°ra a inicializa√ß√£o. O confirmUser() continuar√° o processo.
        }
        // FIM CORRE√á√ÉO LOGIN FOR√áADO

        // 2. Setup Firebase Listeners ou Fallback (Simula√ß√£o)
        if (window.db) {
            setupFirebaseListeners();
            // No modo Firebase, o setupFirebaseListeners √© quem ir√° carregar e renderizar a view
        } else { // MODO SIMULA√á√ÉO
            document.getElementById('loading-indicator').innerHTML = `
                <div class="p-3 sm:p-4 bg-yellow-100 border border-yellow-400 text-yellow-700 rounded-lg shadow-md" role="alert">
                    <p class="font-bold">Aviso: Modo de Simula√ß√£o (Sem Firebase)</p>
                    <p class="text-xs sm:text-sm">Os dados ser√£o vol√°teis e n√£o persistir√£o entre sess√µes. Use a configura√ß√£o do Firebase para persist√™ncia.</p>
                </div>`;
            allRoteiros = { ...DEFAULT_ROTEIROS };

            // Na simula√ß√£o, precisamos inicializar os dados de OFs e Tasks
            if (!localStorage.getItem('sim_data_initialized')) {
                const of1 = await createOF('OF-001', 10, 'CHICOTE-001', true);
                const of2 = await createOF('OF-002', 20, 'CHICOTE-B', true);
                localStorage.setItem('sim_data_initialized', 'true');
            } else {
                // Se j√° inicializado, tenta carregar do localStorage (comportamento original)
                const storedOFs = JSON.parse(localStorage.getItem('sim_ofs') || '{}');
                const storedTasks = JSON.parse(localStorage.getItem('sim_tasks') || '{}');
                const storedOcorrencias = JSON.parse(localStorage.getItem('sim_ocorrencias') || '[]');
                allOFs = storedOFs;
                allTasks = storedTasks;
                allOcurrencesLog = storedOcorrencias;
            }

            // Atraso simulado para UI
            setTimeout(()=>{
                loadingIndicator.classList.add('hidden');
                setupUIRefresh(); // Inicia o timer de refresh
                loadRoteiroDropdowns();
                // Carrega a view para o usu√°rio logado
                updateView(currentUser.role === 'MASTER' ? 'PCP' : 'Operador');
            }, 300); // tempo para o carregamento simulado
        }
    }

    // ==========================
    //  RENDERIZA√á√ÉO
    // ==========================
    function updateView(view) {
        if (!currentUser) return; // Garante que a view s√≥ mude se houver usu√°rio

        // Esconde tudo
        [pcpView, operatorView, reportView].forEach(el => el.classList.add('hidden'));
        [btnCreateOF, btnSetupRoteiro, btnProfile].forEach(el => el.classList.add('hidden'));
        btnProfile.classList.remove('hidden'); // O bot√£o de perfil sempre fica vis√≠vel ap√≥s o login

        // Atualiza a visualiza√ß√£o selecionada
        userViewSelect.value = view;
        document.body.classList.remove('bg-gray-100', 'bg-white');

        if (view === 'PCP') {
            document.body.classList.add('bg-gray-100');
            pcpView.classList.remove('hidden');
            btnCreateOF.classList.remove('hidden');
            btnSetupRoteiro.classList.remove('hidden');
            renderKPIs();
            renderOFs();
        } else if (view === 'Operador') {
            document.body.classList.add('bg-gray-100');
            operatorView.classList.remove('hidden');
            setupSectorDropdowns(); // Re-seta o filtro de setor para o operador atual
            renderTasks();
        } else if (view === 'Relatorio') {
            document.body.classList.add('bg-white'); // Fundo branco para o relat√≥rio
            reportView.classList.remove('hidden');
            renderReport();
        }

        // Se for Master, habilita o seletor de vis√£o. Se for Operador, bloqueia a sele√ß√£o.
        userViewSelect.disabled = isOperador();
    }


    function renderKPIs(){
        const totalOFs = Object.keys(allOFs).length;
        const totalTasks = Object.keys(allTasks).length;
        const tasksCompleted = Object.values(allTasks).filter(t => t.status === 'Conclu√≠da').length;
        const tasksInProgress = Object.values(allTasks).filter(t => t.status === 'Em Processo').length;

        let html = `
            ${createKPICard('OFs Totais', totalOFs, 'bar-chart-2', 'bg-blue-500')}
            ${createKPICard('Tarefas Totais', totalTasks, 'clipboard-list', 'bg-indigo-500')}
            ${createKPICard('Tarefas em Andamento', tasksInProgress, 'loader', 'bg-yellow-500')}
            ${createKPICard('Tarefas Conclu√≠das', tasksCompleted, 'check-square', 'bg-green-500')}
        `;
        document.getElementById('kpis-container').innerHTML = html;
        lucide.createIcons();
    }

    function createKPICard(title, value, icon, colorClass){
        return `
            <div class="bg-white p-4 rounded-xl shadow-lg flex items-center justify-between transition hover:shadow-xl">
                <div>
                    <p class="text-sm font-semibold text-gray-500">${title}</p>
                    <p class="text-2xl font-bold text-gray-800">${value}</p>
                </div>
                <div class="${colorClass} p-3 rounded-full text-white">
                    <i data-lucide="${icon}" class="w-6 h-6"></i>
                </div>
            </div>
        `;
    }

    function renderOFs(){
        ofsListContainer.innerHTML = Object.values(allOFs).map(of => createOFCardHTML(of)).join('');
        lucide.createIcons();
    }

    function createOFCardHTML(of){
        const totalTasks = of.tasks.length;
        const completedTasks = of.tasks.filter(t => allTasks[t] && allTasks[t].status === 'Conclu√≠da').length;
        const progress = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
        const status = completedTasks === totalTasks ? 'Conclu√≠da' : (completedTasks > 0 ? 'Em Andamento' : 'Pendente');
        let statusColor = status === 'Conclu√≠da' ? 'bg-green-500' : (status === 'Em Andamento' ? 'bg-yellow-500' : 'bg-gray-500');

        return `
            <div class="bg-white rounded-xl shadow-lg p-5 border-t-4 border-blue-600 transition hover:shadow-xl cursor-pointer" onclick="openOFDetails('${of.id}')">
                <div class="flex justify-between items-start mb-3">
                    <h3 class="text-xl font-bold text-gray-800">${of.id}</h3>
                    <span class="text-xs font-semibold px-2 py-1 rounded-full text-white ${statusColor}">${status}</span>
                </div>
                <p class="text-sm text-gray-600 mb-3">Chicote: <strong>${of.chicote_id}</strong> | Qtd: <strong>${of.quantidade} p√ßs</strong></p>
                
                <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                    <div class="h-2 rounded-full bg-blue-500" style="width:${progress.toFixed(0)}%"></div>
                </div>
                <p class="text-xs text-gray-500 text-right">${completedTasks} de ${totalTasks} etapas (${progress.toFixed(0)}%)</p>
            </div>
        `;
    }

    function openOFDetails(ofId){
        const of = allOFs[ofId];
        if (!of) return;

        window.__ofDetailsOpenId = ofId; // Salva o ID para uso em outras fun√ß√µes do modal

        const totalTasks = of.tasks.length;
        const tasks = of.tasks.map(taskId => allTasks[taskId]).filter(t => t);
        const completedTasks = tasks.filter(t => t.status === 'Conclu√≠da').length;
        const progress = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;

        document.getElementById('of-details-title').textContent = `Detalhes da OF: ${of.id}`;
        document.getElementById('of-details-progress').style.width = `${progress.toFixed(0)}%`;

        let summaryHTML = formatOFSummary(of, tasks);
        document.getElementById('of-details-summary').innerHTML = summaryHTML;

        let contentHTML = tasks.map(task => formatTaskDetail(task, of.quantidade)).join('');
        document.getElementById('of-details-content').innerHTML = contentHTML;

        // Exibe o bot√£o de exclus√£o apenas para Master e se a OF n√£o estiver em andamento/conclu√≠da
        const isMasterUser = isMaster();
        const isInProgress = tasks.some(t => t.status === 'Em Processo');
        const isCompleted = completedTasks === totalTasks;

        if (isMasterUser && !isInProgress && !isCompleted){
            btnDeleteOF.classList.remove('hidden');
        } else {
            btnDeleteOF.classList.add('hidden');
        }

        openModal('of-details-modal');
        lucide.createIcons();
    }

    function formatOFSummary(of, tasks){
        const totalSetup = tasks.reduce((sum, t) => sum + (t.roteiro_tempo_setup || 0), 0);
        const totalCycle = tasks.reduce((sum, t) => sum + (t.roteiro_tempo_ciclo || 0), 0);
        const totalPlanejado = totalSetup + (totalCycle * of.quantidade);

        const totalReal = tasks.reduce((sum, t) => sum + calculateTempoReal(t), 0);
        const totalDesvio = totalPlanejado - totalReal;
        const totalPause = tasks.reduce((sum, t) => sum + calculateTotalPauseMinutes(t), 0);

        return `
            ${createSummaryItem('Qtd Pe√ßas', of.quantidade)}
            ${createSummaryItem('T. Planejado', formatMinutes(totalPlanejado))}
            ${createSummaryItem('T. Real', formatMinutes(totalReal))}
            ${createSummaryItem('Desvio', formatMinutes(totalDesvio), totalDesvio < -10 ? 'highlight-red' : '')}
            ${createSummaryItem('T. Pausa', formatMinutes(totalPause))}
            ${createSummaryItem('Chicote', of.chicote_id)}
            ${createSummaryItem('Cria√ß√£o', new Date(getDBTimestamp(of.timestamp_criacao)).toLocaleDateString())}
            ${createSummaryItem('Status', of.tasks.length === tasks.filter(t => t.status === 'Conclu√≠da').length ? 'Finalizada' : 'Em Andamento')}
        `;
    }

    function createSummaryItem(title, value, customClass=''){
        return `
            <div class="bg-gray-50 p-3 rounded-lg border">
                <p class="text-xs font-semibold text-gray-500">${title}</p>
                <p class="text-sm font-bold text-gray-800 ${customClass}">${value}</p>
            </div>
        `;
    }

    function formatTaskDetail(task, quantidade){
        const tempoPlanejado = (task.roteiro_tempo_setup || 0) + (task.roteiro_tempo_ciclo || 0) * quantidade;
        const tempoReal = calculateTempoReal(task);
        const desvio = tempoPlanejado - tempoReal;
        const desvioCor = desvio < -5 ? 'text-red-600 font-bold' : (desvio < 0 ? 'text-yellow-600' : 'text-green-600');
        const totalPause = calculateTotalPauseMinutes(task);

        let statusCor = 'bg-gray-200';
        let statusTexto = task.status;
        if (task.status === 'Em Processo') { statusCor = 'bg-blue-200'; statusTexto = 'Em Processo...'; }
        if (task.status === 'Conclu√≠da') { statusCor = 'bg-green-200'; statusTexto = 'Conclu√≠da'; }
        if (task.status === 'Pausada') { statusCor = 'bg-yellow-200'; statusTexto = 'Pausada'; }
        if (task.status === 'Em Espera') { statusCor = 'bg-gray-200'; statusTexto = 'Aguardando'; }


        let pauseLogHTML = '';
        if (task.pause_log && task.pause_log.length > 0){
            pauseLogHTML = task.pause_log.map(log => {
                const motive = log.motivo_pausa || log.motivo_atraso || 'Motivo n√£o especificado';
                const type = log.motivo_pausa ? 'PAUSA' : 'ATRASO';
                const time = log.tempo_pausa_min || log.tempo_atraso_min;
                return `
                    <li class="text-xs text-gray-600 pl-4 border-l-2 border-dashed border-red-300">
                        <strong>[${type}] ${formatMinutes(time)}:</strong> ${motive}
                        ${log.detalhes ? `(Detalhes: ${log.detalhes})` : ''}
                    </li>
                `;
            }).join('');
            pauseLogHTML = `<ul class="mt-2 space-y-1">${pauseLogHTML}</ul>`;
        }

        return `
            <div class="bg-white p-4 rounded-lg shadow-md border ${statusCor}">
                <div class="flex justify-between items-center">
                    <h5 class="text-base font-bold text-gray-800">${task.roteiro_activity_name}</h5>
                    <span class="text-xs font-semibold px-2 py-1 rounded-full ${statusCor.replace('200','500').replace('gray','blue')} text-white">${statusTexto}</span>
                </div>
                <p class="text-sm text-gray-600 mb-2">Setor: <strong>${task.setor}</strong> | Seq: <strong>${task.sequencia}</strong></p>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs mt-2 border-t pt-2">
                    <div>
                        <p class="text-gray-500">Planejado (min)</p>
                        <p class="font-semibold">${formatMinutes(tempoPlanejado)}</p>
                    </div>
                    <div>
                        <p class="text-gray-500">Real (min)</p>
                        <p class="font-semibold">${formatMinutes(tempoReal)}</p>
                    </div>
                    <div>
                        <p class="text-gray-500">Desvio (min)</p>
                        <p class="font-semibold ${desvioCor}">${formatMinutes(desvio)}</p>
                    </div>
                    <div>
                        <p class="text-gray-500">Pausa Total (min)</p>
                        <p class="font-semibold">${formatMinutes(totalPause)}</p>
                    </div>
                </div>
                ${pauseLogHTML}
                <button onclick="openInstructionModal('${task.id}')" class="text-blue-600 text-xs mt-2 hover:underline">
                    Ver Instru√ß√£o de Trabalho
                </button>
            </div>
        `;
    }

    // ==========================
    //  RENDERIZA√á√ÉO DE TASKS (OPERADOR)
    // ==========================
    function renderTasks(){
        if (!isOperador() && !isMaster()) return; // Requer pelo menos Master para ver a tela

        const tasksToRender = Object.values(allTasks).filter(task => {
            // Filtro 1: Apenas tasks para o setor atual
            if (task.setor !== currentSectorFilter) return false;

            // NOVO FILTRO DE OF: pesquisa por OF_ID
            if (currentOFCFilter && !task.of_id.toUpperCase().includes(currentOFCFilter)) return false;
            // FIM NOVO FILTRO

            // Filtro 2: Apenas tasks n√£o finalizadas ou que acabaram de finalizar
            // Permite ver tarefas conclu√≠das por 5 minutos
            if (task.status === 'Conclu√≠da' && Date.now() - getDBTimestamp(task.timestamp_fim) > (5*60*1000)) return false;

            return true;
        }).sort((a,b) => {
            // Prioriza "Em Processo" no topo
            if (a.status === 'Em Processo' && b.status !== 'Em Processo') return -1;
            if (a.status !== 'Em Processo' && b.status === 'Em Processo') return 1;
            // Depois, tarefas com maior desvio (negativo)
            return calculateDesvio(a) - calculateDesvio(b);
        });

        tasksListContainer.innerHTML = tasksToRender.map(task => createTaskCardHTML(task)).join('');
        lucide.createIcons();
    }

    function createTaskCardHTML(task){
        const of = allOFs[task.of_id] || { quantidade: 0, chicote_id: 'N/A' };
        const tempoPlanejado = (task.roteiro_tempo_setup || 0) + (task.roteiro_tempo_ciclo || 0) * of.quantidade;
        const tempoReal = calculateTempoReal(task);
        const desvio = calculateDesvio(task);
        const totalPause = calculateTotalPauseMinutes(task);
        const desvioCor = desvio < -5 ? 'text-red-600 font-bold' : (desvio < 0 ? 'text-yellow-600' : 'text-green-600');

        let statusClass = 'bg-gray-100 text-gray-700 border-gray-300';
        let actionButtonHTML = '';

        if (task.status === 'Em Processo') {
            statusClass = 'bg-blue-50 border-blue-500 shadow-md';
            actionButtonHTML = `
                <button onclick="pauseTask('${task.id}')" class="flex-1 px-3 py-2 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 transition">
                    <i data-lucide="pause" class="w-5 h-5 inline-block mr-1"></i> Pausar
                </button>
                <button onclick="finishTask('${task.id}')" class="flex-1 px-3 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">
                    <i data-lucide="check" class="w-5 h-5 inline-block mr-1"></i> Finalizar
                </button>
            `;
        } else if (task.status === 'Pausada') {
            statusClass = 'bg-yellow-50 border-yellow-500 shadow-md';
            actionButtonHTML = `
                <button onclick="startTask('${task.id}')" class="flex-1 px-3 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">
                    <i data-lucide="play" class="w-5 h-5 inline-block mr-1"></i> Continuar
                </button>
            `;
        } else if (task.status === 'Em Espera') {
            statusClass = 'bg-gray-100 border-gray-300';
            actionButtonHTML = `
                <button onclick="startTask('${task.id}')" class="w-full px-3 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">
                    <i data-lucide="play" class="w-5 h-5 inline-block mr-1"></i> Iniciar
                </button>
            `;
        } else if (task.status === 'Conclu√≠da') {
            statusClass = 'bg-green-100 border-green-500 opacity-80';
            actionButtonHTML = `
                <p class="text-green-700 text-sm font-bold flex items-center justify-center">
                    <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i> Conclu√≠da √†s ${new Date(getDBTimestamp(task.timestamp_fim)).toLocaleTimeString()}
                </p>
            `;
        }

        return `
            <div class="bg-white rounded-xl shadow-lg p-4 border-l-4 ${statusClass} card-tap-big">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">${task.roteiro_activity_name} (${task.of_id})</h3>
                        <p class="text-sm text-gray-600 mb-2">Chicote: ${of.chicote_id} | Qtd: ${of.quantidade} p√ßs</p>
                    </div>
                    <span class="text-xs font-semibold px-2 py-1 rounded-full bg-blue-600 text-white">${task.sequencia}¬™ Etapa</span>
                </div>
                
                <button onclick="openInstructionModal('${task.id}')" class="text-blue-600 text-xs hover:underline mb-3 block">
                    <i data-lucide="book-open-text" class="w-4 h-4 inline-block mr-1"></i> Ver Instru√ß√£o de Trabalho
                </button>

                <div class="grid grid-cols-2 gap-3 text-sm border-t pt-3 mb-4">
                    <div>
                        <p class="text-gray-500">T. Planejado</p>
                        <p class="font-semibold">${formatMinutes(tempoPlanejado)}</p>
                    </div>
                    <div>
                        <p class="text-gray-500">T. Real</p>
                        <p class="font-semibold">${formatMinutes(tempoReal)}</p>
                    </div>
                    <div>
                        <p class="text-gray-500">Desvio</p>
                        <p class="font-semibold ${desvioCor}">${formatMinutes(desvio)}</p>
                    </div>
                    <div>
                        <p class="text-gray-500">Pausa Total</p>
                        <p class="font-semibold">${formatMinutes(totalPause)}</p>
                    </div>
                </div>
                
                <div class="flex gap-2 sticky-footer">
                    ${actionButtonHTML}
                </div>
            </div>
        `;
    }

    function startTask(taskId){
        const task = allTasks[taskId];
        if (!task || (task.status !== 'Em Espera' && task.status !== 'Pausada')) return;
        
        const updates = {};
        if (task.status === 'Em Espera'){
            updates.status = 'Em Processo';
            updates.timestamp_inicio = window.db ? firebase.firestore.Timestamp.now() : new Date();
        } else if (task.status === 'Pausada'){
            updates.status = 'Em Processo';
            // Calcula o tempo total de pausa e adiciona
            const pauseTimeMs = Date.now() - getDBTimestamp(task.pause_start_timestamp);
            updates.total_pause_time_ms = (task.total_pause_time_ms || 0) + pauseTimeMs;
            updates.pause_start_timestamp = window.db ? firebase.firestore.FieldValue.delete() : null; // Remove o timestamp de pausa
            
            // Loga a pausa no hist√≥rico
            if (task.current_pause_log){
                const pauseLog = task.current_pause_log;
                pauseLog.tempo_pausa_min = msToMinutes(pauseTimeMs);
                updates.pause_log = [...(task.pause_log || []), pauseLog];
                updates.current_pause_log = window.db ? firebase.firestore.FieldValue.delete() : null;
            }
        }
        
        updateTaskInDB(taskId, updates);
    }

    function pauseTask(taskId){
        const task = allTasks[taskId];
        if (!task || task.status !== 'Em Processo') return;
        
        // 1. Calcula o tempo real acumulado
        const tempoTrabalhadoDesdeInicio = Date.now() - getDBTimestamp(task.timestamp_inicio);
        const tempoTrabalhadoMin = msToMinutes(tempoTrabalhadoDesdeInicio);

        // 2. Acumula o tempo real e reseta o timestamp de in√≠cio
        const updates = {
            tempo_real_acumulado: (task.tempo_real_acumulado || 0) + tempoTrabalhadoMin,
            timestamp_inicio: window.db ? firebase.firestore.FieldValue.delete() : null, // Remove o timestamp de in√≠cio
            status: 'Pausada',
            pause_start_timestamp: window.db ? firebase.firestore.Timestamp.now() : new Date(),
        };

        // 3. Abre o modal para justificar a pausa
        openJustificationModal(taskId, 'pause', updates);
    }

    function finishTask(taskId){
        const task = allTasks[taskId];
        if (!task || task.status !== 'Em Processo') return;

        // 1. Calcula o tempo real acumulado (tempo total)
        const tempoTrabalhadoDesdeInicio = Date.now() - getDBTimestamp(task.timestamp_inicio);
        const tempoTotalMin = (task.tempo_real_acumulado || 0) + msToMinutes(tempoTrabalhadoDesdeInicio);
        
        // 2. Calcula o desvio final
        const of = allOFs[task.of_id];
        const tempoPlanejado = (task.roteiro_tempo_setup || 0) + (task.roteiro_tempo_ciclo || 0) * (of?.quantidade || 0);
        const desvio = tempoPlanejado - tempoTotalMin; // Desvio negativo = Atraso

        const updates = {
            tempo_real_acumulado: tempoTotalMin,
            timestamp_inicio: window.db ? firebase.firestore.FieldValue.delete() : null,
            timestamp_fim: window.db ? firebase.firestore.Timestamp.now() : new Date(),
            status: 'Conclu√≠da',
        };

        // 3. Verifica se houve atraso significativo (Desvio < -10 minutos)
        if (desvio < -10){
            // Se houve atraso, for√ßa a justificar
            openJustificationModal(taskId, 'delay', updates, desvio);
        } else {
            // Se n√£o houve atraso, finaliza a tarefa
            updateTaskInDB(taskId, updates);
            unlockNextTask(task);
        }
    }
    
    // Fun√ß√£o que destrava a pr√≥xima tarefa no roteiro
    function unlockNextTask(currentTask){
        const of = allOFs[currentTask.of_id];
        if (!of) return;

        const nextSequence = currentTask.sequencia + 1;
        
        // Busca a pr√≥xima tarefa da OF que tenha a sequ√™ncia correta
        const nextTask = Object.values(allTasks).find(t => 
            t.of_id === currentTask.of_id && t.sequencia === nextSequence
        );

        if (nextTask){
             // IMPORTANTE: Se a tarefa √© destravada, o status volta a ser 'Em Espera', removendo o bloqueio.
            updateTaskInDB(nextTask.id, {
                status: 'Em Espera'
            });
        }
    }


    // ==========================
    //  MODAL DE A√á√ÉO (PAUSA / ATRASO)
    // ==========================
    function openJustificationModal(taskId, type, updates, desvio = 0){
        currentAction = { taskId, type, updates };
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const justificationSelect = document.getElementById('justification-select');
        const justificationText = document.getElementById('justification-text');
        const requiredText = document.getElementById('justification-required-text');

        justificationSelect.innerHTML = '';
        justificationText.value = '';
        requiredText.classList.add('hidden');
        
        if (type === 'pause'){
            modalTitle.textContent = 'Justificar Pausa de Tarefa';
            modalMessage.textContent = 'Selecione o motivo pelo qual voc√™ est√° pausando a atividade.';
            PAUSE_REASONS.forEach(reason => {
                const opt = document.createElement('option');
                opt.value = reason;
                opt.textContent = reason;
                justificationSelect.appendChild(opt);
            });
            justificationText.placeholder = 'Detalhes da pausa (Ex: "A m√°quina 3 precisa de √≥leo").';
        } else if (type === 'delay'){
            modalTitle.textContent = 'Justificar Atraso (> 10 min)';
            modalMessage.innerHTML = `Esta tarefa resultou em um atraso de <strong>${formatMinutes(Math.abs(desvio))}</strong>. Selecione o motivo principal.`;
            DELAY_REASONS.forEach(reason => {
                const opt = document.createElement('option');
                opt.value = reason;
                opt.textContent = reason;
                justificationSelect.appendChild(opt);
            });
            justificationText.placeholder = 'Detalhes do atraso (Ex: "Pe√ßas da etapa anterior vieram com rebarba").';
            requiredText.classList.remove('hidden');
        }
        
        openModal('action-modal');
    }

    function handleConfirmedAction(){
        const { taskId, type, updates } = currentAction;
        const justificationSelect = document.getElementById('justification-select');
        const justificationText = document.getElementById('justification-text').value;
        const selectedReason = justificationSelect.value;
        const task = allTasks[taskId];
        
        if (type === 'delay' && !selectedReason){
            alert('Por favor, selecione um motivo para o atraso (campo obrigat√≥rio).');
            return;
        }

        const log = {
            timestamp: window.db ? firebase.firestore.Timestamp.now() : new Date(),
            operador: currentUser.name || 'Operador',
            setor: currentUser.sector || task.setor,
            detalhes: justificationText,
        };

        if (type === 'pause'){
            log.motivo_pausa = selectedReason;
            updates.current_pause_log = log; // Salva o log temporariamente
            
            // O log ser√° finalizado em startTask()
            updateTaskInDB(taskId, updates);
            closeModal('action-modal');

        } else if (type === 'delay'){
            log.motivo_atraso = selectedReason;
            log.tempo_atraso_min = Math.abs(calculateDesvio(task));

            // Adiciona o log de atraso ao hist√≥rico de pausas
            updates.pause_log = [...(task.pause_log || []), log];
            
            // Finaliza a tarefa
            updateTaskInDB(taskId, updates);
            unlockNextTask(task);
            closeModal('action-modal');
        }
        
        // Loga a ocorr√™ncia no relat√≥rio geral (cole√ß√£o 'ocorrencias')
        logOcorrencia(task, log, type);
    }

    function logOcorrencia(task, log, type){
        const of = allOFs[task.of_id];
        if (!of) return;

        const ocorrenciaData = {
            of_id: task.of_id,
            chicote_id: of.chicote_id,
            atividade: task.roteiro_activity_name,
            sequencia: task.sequencia,
            setor: task.setor,
            timestamp: log.timestamp,
            operador: log.operador,
            detalhes: log.detalhes,
            motivo_pausa: type === 'pause' ? log.motivo_pausa : null,
            tempo_pausa_min: type === 'pause' ? (log.tempo_pausa_min || 0) : 0, // Ser√° atualizado em startTask()
            motivo_atraso: type === 'delay' ? log.motivo_atraso : null,
            tempo_atraso_min: type === 'delay' ? log.tempo_atraso_min : 0,
            tipo: type, // pause ou delay
        };

        if (window.db){
            window.db.collection(OCORRENCIA_COLLECTION).add(ocorrenciaData);
        } else {
            // Simula√ß√£o
            ocorrenciaData.id = `o${allOcurrencesLog.length + 1}`;
            allOcurrencesLog.push(ocorrenciaData);
            saveState();
        }
    }


    // ==========================
    //  CRUD DE OF (PCP)
    // ==========================
    function createOF(ofId = null, quantity = null, chicoteName = null, isSimulated = false){
        const id = ofId || document.getElementById('of-id').value.toUpperCase().trim();
        const quantidade = parseInt(quantity || document.getElementById('of-quantity').value);
        const chicote_id = chicoteName || document.getElementById('of-chicote').value;
        const messageEl = document.getElementById('of-creation-message');
        
        messageEl.classList.add('hidden');

        if (!id || isNaN(quantidade) || quantidade <= 0 || !chicote_id){
            messageEl.textContent = 'üö® Preencha todos os campos corretamente (Qtd > 0).';
            messageEl.classList.remove('hidden');
            return;
        }
        if (allOFs[id]){
            messageEl.textContent = `üö® A OF ${id} j√° existe.`;
            messageEl.classList.remove('hidden');
            return;
        }

        // 1. Obter roteiro completo
        const roteiroCompleto = Object.values(allRoteiros).filter(r => r.chicote_nome === chicote_id)
                                    .sort((a, b) => a.id.localeCompare(b.id)); // Ordena para garantir sequ√™ncia

        if (roteiroCompleto.length === 0){
            messageEl.textContent = 'üö® O roteiro selecionado n√£o possui etapas cadastradas.';
            messageEl.classList.remove('hidden');
            return;
        }

        const taskIds = [];
        const ofData = {
            id,
            chicote_id,
            quantidade,
            tasks: taskIds,
            timestamp_criacao: window.db ? firebase.firestore.Timestamp.now() : new Date(),
        };

        // 2. Criar as tarefas baseadas no roteiro
        roteiroCompleto.forEach((roteiro, index) => {
            const taskId = `${id}-${index + 1}`;
            const isFirstTask = index === 0;

            const taskData = {
                id: taskId,
                of_id: id,
                sequencia: index + 1,
                setor: roteiro.setor,
                roteiro_chicote_name: roteiro.chicote_nome,
                roteiro_activity_name: roteiro.nome_atividade,
                roteiro_tempo_setup: roteiro.tempo_setup,
                roteiro_tempo_ciclo: roteiro.tempo_ciclo,
                roteiro_instruction_text: roteiro.instrucao_trabalho,
                tempo_real_acumulado: 0,
                total_pause_time_ms: 0,
                // Status inicial: 'Em Espera' para a primeira tarefa, 'Bloqueada' para as demais.
                // CORRE√á√ÉO: Mantenha sempre 'Em Espera'. O operador s√≥ ver√° as tarefas do setor dele, e o sistema 
                // n√£o deve bloquear no in√≠cio. A regra de sequenciamento √© visual e de notifica√ß√£o.
                status: 'Em Espera', // Inicialmente todas em espera, o operador s√≥ inicia a sua vez.
                timestamp_criacao: ofData.timestamp_criacao,
            };
            
            taskIds.push(taskId);

            if (window.db){
                window.db.collection(TASK_COLLECTION).doc(taskId).set(taskData);
            } else {
                // Simula√ß√£o
                allTasks[taskId] = taskData;
                taskCounter++;
            }
        });

        // 3. Salvar a OF
        if (window.db){
            window.db.collection(OF_COLLECTION).doc(id).set(ofData);
        } else {
            // Simula√ß√£o
            allOFs[id] = ofData;
        }

        if (!isSimulated){
            saveState();
            closeModal('create-of-modal');
            renderOFs();
        }
        return ofData;
    }

    function deleteOF(ofId){
        if (!isMaster() || !ofId) return;
        if (!confirm(`Tem certeza que deseja EXCLUIR a OF ${ofId} e TODAS as suas tarefas? Esta a√ß√£o √© IRREVERS√çVEL!`)) return;

        const of = allOFs[ofId];
        if (!of) return;

        // Deleta as tarefas
        of.tasks.forEach(taskId => {
            if (window.db){
                window.db.collection(TASK_COLLECTION).doc(taskId).delete();
            } else {
                delete allTasks[taskId];
            }
        });

        // Deleta a OF
        if (window.db){
            window.db.collection(OF_COLLECTION).doc(ofId).delete();
        } else {
            delete allOFs[ofId];
        }

        saveState();
        closeModal('of-details-modal');
        renderOFs();
        alert(`OF ${ofId} e suas tarefas exclu√≠das com sucesso.`);
    }

    // ==========================
    //  CRUD DE ROTEIROS (PCP)
    // ==========================
    function renderRoteiros(){
        const roteiroListEl = document.getElementById('roteiro-list');
        roteiroListEl.innerHTML = '';
        
        const roteirosAgrupados = Object.values(allRoteiros).reduce((acc, r) => {
            acc[r.chicote_nome] = acc[r.chicote_nome] || [];
            acc[r.chicote_nome].push(r);
            return acc;
        }, {});
        
        Object.keys(roteirosAgrupados).sort().forEach(chicoteName => {
            const roteiros = roteirosAgrupados[chicoteName].sort((a,b) => a.id.localeCompare(b.id));
            
            let html = `<div class="p-3 bg-white rounded-lg shadow border-l-4 border-indigo-400 mb-3">
                            <h5 class="text-base font-bold text-gray-800 mb-2">Modelo: ${chicoteName}</h5>
                            <ul class="space-y-1 text-sm">`;
            
            roteiros.forEach(r => {
                html += `
                    <li class="flex justify-between items-center text-gray-700 border-t pt-1">
                        <span>
                            <strong class="text-indigo-600">Seq ${r.id.replace('r','')} - </strong>
                            ${r.nome_atividade} (${r.setor})
                            <span class="text-xs text-gray-500 ml-2">Setup: ${r.tempo_setup}m | Ciclo: ${r.tempo_ciclo}m/p√ß</span>
                        </span>
                        <button onclick="deleteRoteiroActivity('${r.id}')" class="text-red-500 hover:text-red-700 ml-4">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </li>
                `;
            });
            
            html += `</ul></div>`;
            roteiroListEl.innerHTML += html;
        });
        
        if (Object.keys(roteirosAgrupados).length === 0){
             roteiroListEl.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhum roteiro mestre cadastrado.</p>`;
        }

        lucide.createIcons();
    }


    // CORRIGIDO: O bot√£o de adicionar etapa foi restaurado.
    function addRoteiroActivity(){
        const chicoteName = document.getElementById('roteiro-chicote-name').value.toUpperCase().trim();
        const setor = document.getElementById('roteiro-setor').value;
        const activityName = document.getElementById('roteiro-activity-name').value.trim();
        const setupTime = parseFloat(document.getElementById('roteiro-setup-time').value);
        const cycleTime = parseFloat(document.getElementById('roteiro-cycle-time').value);
        const instructionText = document.getElementById('roteiro-instruction-text').value.trim();
        const messageEl = document.getElementById('roteiro-message');

        messageEl.textContent = '';

        if (!chicoteName || !setor || !activityName || isNaN(setupTime) || isNaN(cycleTime) || !instructionText) {
            messageEl.textContent = 'üö® Preencha todos os campos e use n√∫meros v√°lidos para Tempo de Setup e Ciclo.';
            return;
        }

        // Incrementa o contador e usa para gerar um ID
        roteiroCounter++;
        const roteiroId = `r${roteiroCounter}`;

        const roteiroData = {
            id: roteiroId,
            chicote_nome: chicoteName,
            setor: setor,
            nome_atividade: activityName,
            tempo_setup: setupTime,
            tempo_ciclo: cycleTime,
            instrucao_trabalho: instructionText
        };

        if (window.db){
            window.db.collection(ROTEIRO_COLLECTION).doc(roteiroId).set(roteiroData).then(() => {
                renderRoteiros();
                loadRoteiroDropdowns();
                messageEl.textContent = '‚úÖ Etapa de roteiro adicionada com sucesso!';
            });
        } else {
            // Simula√ß√£o
            allRoteiros[roteiroId] = roteiroData;
            saveState();
            renderRoteiros();
            loadRoteiroDropdowns();
            messageEl.textContent = '‚úÖ Etapa de roteiro adicionada com sucesso!';
        }

        // Limpa os campos da nova etapa
        document.getElementById('roteiro-activity-name').value = '';
        document.getElementById('roteiro-setup-time').value = '';
        document.getElementById('roteiro-cycle-time').value = '';
        document.getElementById('roteiro-instruction-text').value = '';
    }
    // FIM DA CORRE√á√ÉO DE addRoteiroActivity

    function deleteRoteiroActivity(roteiroId){
        if (!isMaster()) return;
        if (!confirm('Tem certeza que deseja EXCLUIR esta etapa do roteiro mestre?')) return;

        if (window.db){
            window.db.collection(ROTEIRO_COLLECTION).doc(roteiroId).delete().then(() => {
                renderRoteiros();
                loadRoteiroDropdowns();
            });
        } else {
            delete allRoteiros[roteiroId];
            saveState();
            renderRoteiros();
            loadRoteiroDropdowns();
        }
    }


    // ==========================
    //  MODAIS GEN√âRICOS
    // ==========================
    function openModal(modalId){
        const modal = document.getElementById(modalId);
        if (modalId === 'setup-roteiro-modal'){
            renderRoteiros();
        }
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closeModal(modalId = null){
        const modals = modalId ? [document.getElementById(modalId)] : document.querySelectorAll('.modal-fixed');
        modals.forEach(modal => {
            if (modal) modal.style.display = 'none';
        });
        document.body.style.overflow = '';
    }

    function openInstructionModal(taskId){
        const task = allTasks[taskId];
        if (!task) return;

        const modalHeader = document.getElementById('instruction-modal-header');
        const modalContent = document.getElementById('instruction-modal-content');

        modalHeader.textContent = `OF ${task.of_id} - Etapa ${task.sequencia}: ${task.roteiro_activity_name}`;
        modalContent.innerHTML = task.roteiro_instruction_text;

        openModal('instruction-modal');
        lucide.createIcons();
    }


    // ==========================
    //  PERSIST√äNCIA (SIMULA√á√ÉO)
    // ==========================
    function saveState(){
        if (window.db) return; // N√£o salva no localStorage se estiver usando Firebase
        
        localStorage.setItem('sim_ofs', JSON.stringify(allOFs));
        localStorage.setItem('sim_tasks', JSON.stringify(allTasks));
        localStorage.setItem('sim_roteiros', JSON.stringify(allRoteiros));
        localStorage.setItem('sim_ocorrencias', JSON.stringify(allOcurrencesLog));
        localStorage.setItem('sim_task_counter', taskCounter);
        localStorage.setItem('sim_roteiro_counter', roteiroCounter);
    }
    
    function updateTaskInDB(taskId, updates){
        if (window.db){
            window.db.collection(TASK_COLLECTION).doc(taskId).update(updates);
        } else {
            // Simula√ß√£o
            allTasks[taskId] = { ...allTasks[taskId], ...updates };
            // Limpa campos que foram deletados (Firestore FieldValue.delete)
            Object.keys(updates).forEach(key => {
                if (updates[key] === null || (typeof updates[key] === 'object' && updates[key] && updates[key].delete)){
                     delete allTasks[taskId][key];
                }
            });
            saveState();
            renderTasks();
            renderOFs(); // Para atualizar o progresso no painel PCP
        }
    }


    // ==========================
    //  FUN√á√ïES DO MODAL DE ACESSO
    // ==========================
    function openUserModal(initialRole = null){
        const modal = document.getElementById('user-modal');
        const roleSel = document.getElementById('user-role');
        const sectorSel = document.getElementById('user-sector');
        const pinWrap = document.getElementById('user-pin-wrap');
        const sectorWrap = document.getElementById('user-sector-wrap');
        
        setupSectorDropdowns(); // Popula o dropdown de setor

        roleSel.value = (currentUser?.role || 'OPERADOR');
        if (currentUser?.sector) sectorSel.value = currentUser.sector;

        roleSel.onchange = () => {
          const isM = roleSel.value === 'MASTER';
          pinWrap.classList.toggle('hidden', !isM);
          sectorWrap.classList.toggle('hidden', isM);
        };
        roleSel.onchange();
        modal.style.display='flex';
    }

    function confirmUser(){
        const role = document.getElementById('user-role').value;
        const sector = document.getElementById('user-sector').value;
        const pin = document.getElementById('user-pin').value;

        if (role==='MASTER'){
            if (pin !== MASTER_PIN){ alert('PIN incorreto.'); return; }
            setUser({ role:'MASTER', name:'Master' });
            saveState();
            closeModal('user-modal');
            setupSectorDropdowns();
            // Recome√ßa a inicializa√ß√£o ap√≥s o login for√ßado
            initializeApp(); 
        } else {
            if (!sector){ alert('Selecione um setor.'); return; }
            setUser({ role:'OPERADOR', sector, name:'Operador' });
            saveState();
            closeModal('user-modal');
            setupSectorDropdowns();
            // Recome√ßa a inicializa√ß√£o ap√≥s o login for√ßado
            initializeApp();
        }
    }

    window.openUserModal = openUserModal;
    window.confirmUser = confirmUser;


    // ==========================
    //  FIREBASE LISTENERS
    // ==========================
    function setupFirebaseListeners() {
        if (!window.db) return;

        // Listener para Roteiros
        window.db.collection(ROTEIRO_COLLECTION).onSnapshot(snapshot => {
            allRoteiros = {};
            snapshot.forEach(doc => {
                allRoteiros[doc.id] = doc.data();
            });
            loadRoteiroDropdowns();
            // Se estiver no modal de setup, renderiza novamente
            if (document.getElementById('setup-roteiro-modal').style.display === 'flex') {
                renderRoteiros();
            }
        }, error => console.error("Erro ao carregar roteiros:", error));

        // Listener para OFs
        window.db.collection(OF_COLLECTION).onSnapshot(snapshot => {
            allOFs = {};
            snapshot.forEach(doc => {
                allOFs[doc.id] = doc.data();
            });
            if (userViewSelect.value === 'PCP') {
                renderOFs();
                renderKPIs();
            }
        }, error => console.error("Erro ao carregar OFs:", error));

        // Listener para Tasks
        window.db.collection(TASK_COLLECTION).onSnapshot(snapshot => {
            allTasks = {};
            snapshot.forEach(doc => {
                allTasks[doc.id] = doc.data();
            });
            if (userViewSelect.value === 'Operador') {
                renderTasks();
            }
            if (userViewSelect.value === 'PCP') {
                renderOFs(); // For√ßa a atualiza√ß√£o do progresso no PCP
            }
        }, error => console.error("Erro ao carregar Tasks:", error));
        
         // Listener para Ocorr√™ncias
        window.db.collection(OCORRENCIA_COLLECTION).onSnapshot(snapshot => {
            allOcurrencesLog = [];
            snapshot.forEach(doc => {
                allOcurrencesLog.push(doc.data());
            });
            if (userViewSelect.value === 'Relatorio') {
                renderReport();
            }
        }, error => console.error("Erro ao carregar Ocorr√™ncias:", error));


        // Ap√≥s configurar todos os listeners, escondemos o loading e iniciamos o refresh.
        // Isso s√≥ ocorre se o usu√°rio estiver logado (passou pelo check de login for√ßado)
        loadingIndicator.classList.add('hidden');
        setupUIRefresh();
        updateView(currentUser.role === 'MASTER' ? 'PCP' : 'Operador');
    }

    // ==========================
    //  RELAT√ìRIO
    // ==========================
    function renderReport(){
        const tbody = document.getElementById('report-table-body');
        if (!tbody) return;
        
        // Filtra e prepara os dados
        const reportData = allOcurrencesLog.filter(o => o.tipo === 'delay' || o.tipo === 'pause')
            .sort((a, b) => getDBTimestamp(b.timestamp) - getDBTimestamp(a.timestamp)); // Mais recentes primeiro
            
        tbody.innerHTML = reportData.map(o => {
            return `
                <tr class="hover:bg-gray-100">
                    <td class="px-3 sm:px-6 py-2 whitespace-nowrap">${o.of_id}</td>
                    <td class="px-3 sm:px-6 py-2 whitespace-nowrap">${o.chicote_id}</td>
                    <td class="px-3 sm:px-6 py-2 whitespace-nowrap">${o.atividade}</td>
                    <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-red-700 font-semibold">${o.motivo_pausa || 'N/A'}</td>
                    <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-red-700 font-semibold">${o.motivo_atraso || 'N/A'}</td>
                    <td class="px-3 sm:px-6 py-2 whitespace-nowrap">${formatMinutes(o.tempo_pausa_min)}</td>
                    <td class="px-3 sm:px-6 py-2 whitespace-nowrap">${formatMinutes(o.tempo_atraso_min)}</td>
                </tr>
            `;
        }).join('');
    }

    // ==========================
    //  EXPORTA√á√ÉO DE DADOS (CSV)
    // ==========================
    function downloadCSV(data, filename){
        const blob = new Blob([data], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }

    function exportReportCSV(){
        const header = ["OF","CHICOTE","ATIVIDADE","SETOR","OPERADOR","DATA","TIPO","MOTIVO_PAUSA","TEMPO_PAUSA_MIN","MOTIVO_ATRASO","TEMPO_ATRASO_MIN","DETALHES"];
        let csv = header.join(";") + "\n";
        
        allOcurrencesLog.sort((a, b) => getDBTimestamp(b.timestamp) - getDBTimestamp(a.timestamp)).forEach(o => {
            const row = [
                o.of_id,
                o.chicote_id,
                o.atividade,
                o.setor,
                o.operador,
                new Date(getDBTimestamp(o.timestamp)).toLocaleString(),
                o.tipo,
                o.motivo_pausa || "",
                formatMinutes(o.tempo_pausa_min).replace(' min', '').replace('.',','),
                o.motivo_atraso || "",
                formatMinutes(o.tempo_atraso_min).replace(' min', '').replace('.',','),
                (o.detalhes || "").replace(/;/g, ","),
            ];
            csv += row.map(item => `"${item}"`).join(";") + "\n";
        });
        
        downloadCSV(csv, `relatorio_ocorrencias_${new Date().toISOString().slice(0,10)}.csv`);
    }

    function exportOFTasksCSV(ofId){
        const of = allOFs[ofId];
        if (!of) return;

        const tasks = of.tasks.map(taskId => allTasks[taskId]).filter(t => t);
        const header = ["OF","CHICOTE","ATIVIDADE","SEQUENCIA","SETOR","TEMPO_PLANEJADO_MIN","TEMPO_REAL_MIN","DESVIO_MIN","STATUS","DATA_FIM","PAUSAS_REGISTRADAS"];
        let csv = header.join(";") + "\n";

        tasks.forEach(task => {
            const tempoPlanejado = (task.roteiro_tempo_setup || 0) + (task.roteiro_tempo_ciclo || 0) * of.quantidade;
            const tempoReal = task.tempo_real_acumulado || 0;
            const desvio = tempoPlanejado - tempoReal;
            
            const pauseDetails = (task.pause_log || []).map(log => {
                const motive = log.motivo_pausa || log.motivo_atraso;
                const time = log.tempo_pausa_min || log.tempo_atraso_min;
                const details = log.detalhes;
                return `[${motive} - ${formatMinutes(time).replace(' min','')}m ${details ? `(${details})` : ''}]`;
            }).join('; ').replace(/;/g,','); // Substitui ponto-e-v√≠rgula nos detalhes por v√≠rgula para n√£o quebrar o CSV

            const row = [
                task.of_id,
                of.chicote_id,
                task.roteiro_activity_name,
                task.sequencia,
                task.setor,
                formatMinutes(tempoPlanejado).replace(' min', '').replace('.',','),
                formatMinutes(tempoReal).replace(' min', '').replace('.',','),
                formatMinutes(desvio).replace(' min', '').replace('.',','),
                task.status,
                task.timestamp_fim ? new Date(getDBTimestamp(task.timestamp_fim)).toLocaleString() : "",
                pauseDetails
            ];
            csv += row.map(item => `"${item}"`).join(";") + "\n";
        });

        downloadCSV(csv, `tarefas_${of.id}_${new Date().toISOString().slice(0,10)}.csv`);
    }

    // =========================
    //  REFRESH E IN√çCIO
    // =========================
    function setupUIRefresh(){
        // Atualiza a visualiza√ß√£o a cada 10 segundos (para atualizar tempo real e desvio)
        setInterval(() => {
            const currentView = userViewSelect.value;
            if (currentView === 'PCP') {
                renderOFs();
                renderKPIs();
            } else if (currentView === 'Operador') {
                renderTasks();
            }
        }, 10000); 
    }

    // Chamada inicial
    document.addEventListener('DOMContentLoaded', initializeApp);

    // Exp√µe fun√ß√µes para o HTML
    window.updateView = updateView; // Permite o uso no seletor do header
    window.updateSectorFilter = updateSectorFilter; // Permite o uso no seletor de setor
    window.updateOFCFilter = updateOFCFilter; // Permite o uso no novo filtro de OF
    window.startTask = startTask;
    window.pauseTask = pauseTask;
    window.finishTask = finishTask;
    window.openOFDetails = openOFDetails;
    window.openInstructionModal = openInstructionModal;
    window.handleConfirmedAction = handleConfirmedAction;
    window.openModal = openModal;
    window.closeModal = closeModal;
    window.createOF = createOF;
    window.addRoteiroActivity = addRoteiroActivity;
    window.deleteRoteiroActivity = deleteRoteiroActivity;
    window.deleteOF = deleteOF;
    window.exportReportCSV = exportReportCSV;
    window.exportOFTasksCSV = exportOFTasksCSV;

  </script>
</body>
</html>
