<!DOCTYPE html>
<html lang="pt-BR">
<head>
Â  <meta charset="UTF-8"/>
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
Â  <title>PCP â€“ Controle de ProduÃ§Ã£o (v. Monte Carlo)</title> Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <script src="https://unpkg.com/lucide@latest"></script>
Â Â 
Â  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
Â Â 
Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

Â  <style>
Â  Â  @import url("https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap");
Â  Â  :root {
Â  Â  Â  color-scheme: light dark;
Â  Â  Â  --app-bg-color: #f3f4f6;
Â  Â  Â  --app-bg-image: none;
Â  Â  Â Â 
Â  Â  Â  /* Cores de Prioridade (Mantidas) */
Â  Â  Â  --cor-perigo: #dc2626; /* Vermelho */
Â  Â  Â  --cor-neutra: #3b82f6; /* Azul */
Â  Â  }
Â  Â  body {
Â  Â  Â  font-family: "Inter", sans-serif;
Â  Â  Â  background: var(--app-bg-color) fixed no-repeat center/cover;
Â  Â  Â  background-image: var(--app-bg-image);

Â  Â  Â  padding-left: max(env(safe-area-inset-left), 0px);
Â  Â  Â  padding-right: max(env(safe-area-inset-right), 0px);
Â  Â  }

Â  Â  /* CLASSES DE PRIORIDADE VISUAL (Operador) */
Â  Â  .priority-high {
Â  Â  Â  border-left-width: 6px;
Â  Â  Â  border-left-color: var(--cor-perigo);
Â  Â  Â  background-color: #fef2f2; /* Fundo Vermelho Claro */
Â  Â  }
Â  Â  .priority-medium {
Â  Â  Â  border-left-width: 6px;
Â  Â  Â  border-left-color: var(--cor-neutra);
Â  Â  Â  background-color: #eff6ff; /* Fundo Azul Claro */
Â  Â  }
Â  Â  .priority-low {
Â  Â  Â  border-left-width: 6px;
Â  Â  Â  border-left-color: #d1d5db; /* Cinza */
Â  Â  }
Â  Â Â 
Â  Â  /* Cor de fundo para OFs ConcluÃ­das no HistÃ³rico */
Â  Â  .of-concluida-card {
Â  Â  Â  Â  background-color: #f0fdf4; /* Verde bem clarinho */
Â  Â  Â  Â  border-left-color: #10b981; /* Verde esmeralda */
Â  Â  }

Â  Â  /* Estilo do Modal de IT (Melhoria Visual) */
Â  Â  #instruction-modal .modal-panel {
Â  Â  Â  Â  border-top: 8px solid #4f46e5; /* Ãndigo */
Â  Â  }

Â  Â  .modal-fixed { position: fixed; inset: 0; }
Â  Â  .modal-panel { max-height: calc(100dvh - 2rem); }
Â  Â  .modal-body-scroll { overflow-y: auto; -webkit-overflow-scrolling: touch; }
Â  Â  .sticky-footer { position: sticky; bottom: 0; background: white; padding-top: .5rem; }
Â  Â  .highlight-red { color: #dc2626; font-weight: 600; }
Â  Â Â 
Â  Â  /* NOVO: CSS para o Log de Auditoria */
Â  Â  #audit-log-toggle {
Â  Â  Â  Â  color: #4f46e5; /* Ãndigo */
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  text-decoration: underline;
Â  Â  Â  Â  font-size: 0.875rem;
Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  display: inline-block;
Â  Â  }
Â  Â  #audit-log-content {
Â  Â  Â  Â  background-color: #f9fafb; /* Cinza bem claro */
Â  Â  Â  Â  border: 1px solid #e5e7eb;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  padding: 12px 16px;
Â  Â  Â  Â  margin-top: 8px;
Â  Â  Â  Â  font-family: monospace;
Â  Â  Â  Â  font-size: 0.875rem;
Â  Â  Â  Â  line-height: 1.6;
Â  Â  Â  Â  white-space: pre-wrap; /* MantÃ©m a formataÃ§Ã£o do log */
Â  Â  }
Â  Â Â 
Â  Â  @media (max-width: 640px){
Â  Â  Â  .modal-panel{ width:100vw!important; max-width:100vw!important; height:100dvh!important; max-height:100dvh!important; border-radius:0!important; margin:0!important; display:flex; flex-direction:column; }
Â  Â  Â  .card-tap-big{ padding:1rem; }
Â  Â  }
Â  </style>
</head>
<body class="min-h-screen bg-gray-100 antialiased">

Â  <header class="bg-gray-800 shadow-md p-3 sm:p-4 sticky top-0 z-10">
Â  Â  <div class="max-w-7xl mx-auto flex justify-between items-center gap-2">
Â  Â  Â  <h1 class="text-2xl sm:text-3xl font-extrabold text-white flex items-center">
Â  Â  Â  Â  <i data-lucide="factory" class="w-7 h-7 sm:w-8 sm:h-8 mr-2"></i>
Â  Â  Â  Â  Controle de ProduÃ§Ã£o
Â  Â  Â  </h1>
Â  Â  Â  <div class="flex gap-2 items-center">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <button id="btn-profile"
Â  Â  Â  Â  Â  Â  Â  Â  class="text-white bg-gray-700 hover:bg-gray-600 font-semibold py-2 px-3 rounded-lg shadow-md transition hidden"
Â  Â  Â  Â  Â  Â  Â  Â  onclick="openUserModal()">
Â  Â  Â  Â  Â  <i data-lucide="user-cog" class="w-5 h-5 inline-block mr-1"></i>
Â  Â  Â  Â  Â  <span class="hidden sm:inline">Perfil</span>
Â  Â  Â  Â  </button>

Â  Â  Â  Â  <select id="user-view-select" onchange="updateView(this.value)"
Â  Â  Â  Â  Â  Â  Â  Â  class="bg-gray-700 text-white text-xs sm:text-sm font-semibold py-2 px-2 rounded-lg transition hover:bg-gray-600 focus:ring-2 focus:ring-indigo-300">
Â  Â  Â  Â  Â  <option value="PCP">VisÃ£o: PCP</option>
Â  Â  Â  Â  Â  <option value="Operador">VisÃ£o: Operador</option>
Â  Â  Â  Â  Â  <option value="Relatorio">VisÃ£o: RelatÃ³rio</option>
Â  Â  Â  Â  Â  </select>

Â  Â  Â  Â  <button onclick="openModal('create-of-modal')" id="btn-create-of"
Â  Â  Â  Â  Â  Â  Â  Â  class="text-white bg-emerald-600 hover:bg-emerald-700 font-semibold py-2 px-3 rounded-lg shadow-md transition hidden">
Â  Â  Â  Â  Â  <i data-lucide="plus" class="w-5 h-5 inline-block mr-1"></i>
Â  Â  Â  Â  Â  <span class="hidden sm:inline">Criar OF</span>
Â  Â  Â  Â  </button>
Â  Â  Â  Â Â 
Â  Â  Â  </div>
Â  Â  </div>
Â  </header>

Â  <main class="max-w-7xl mx-auto p-3 sm:p-6 lg:p-8">
Â  Â  <div id="loading-indicator" class="flex flex-col items-center justify-center p-6 sm:p-12 bg-white rounded-xl border border-gray-300">
Â  Â  Â  <i data-lucide="loader-circle" class="w-8 h-8 sm:w-10 sm:h-10 text-gray-500 animate-spin"></i>
Â  Â  Â  <p class="mt-3 sm:mt-4 text-gray-600 font-semibold text-sm sm:text-base">Carregando dados e autenticando...</p>
Â  Â  </div>

Â  Â  <div id="pcp-view" class="space-y-4 sm:space-y-6 hidden">
Â  Â  Â  <h2 class="text-xl sm:text-2xl font-bold text-gray-800 border-b pb-2 mb-2 sm:mb-4 flex items-center">
Â  Â  Â  Â  <i data-lucide="bar-chart-3" class="w-5 h-5 sm:w-6 sm:h-6 mr-2"></i>
Â  Â  Â  Â  Painel PCP
Â  Â  Â  </h2>
Â  Â  Â  <div id="pcp-of-search-wrap" class="mb-2 hidden">
Â  Â  Â  Â  <input id="pcp-of-search" type="text" placeholder="Pesquisar OF Ativa..."
Â  Â  Â  Â  Â  Â  Â  Â class="w-full sm:w-64 border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500">
Â  Â  Â  </div>
Â  Â  Â Â 
Â  Â  Â  <div id="kpis-container" class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-4"></div>

Â  Â  Â  <div id="workload-chart-container" class="bg-white p-4 sm:p-6 rounded-xl border border-gray-300 mb-4">
Â  Â  Â  Â  Â  <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
Â  Â  Â  Â  Â  Â  Â  <i data-lucide="gauge" class="w-5 h-5 mr-2 text-indigo-600"></i> Carga de Trabalho por Setor (Minutos Esperados Restantes - P50) Â  Â  Â  Â  Â  </h3>
Â  Â  Â  Â  Â  <div class="h-64 sm:h-80 relative">
Â  Â  Â  Â  Â  Â  <canvas id="workload-chart"></canvas>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div id="ofs-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-6"></div>
Â  Â  </div>

Â  Â  <div id="operator-view" class="space-y-4 sm:space-y-6 hidden">
Â  Â  Â  <div class="bg-white p-3 sm:p-4 rounded-xl border border-gray-300 mb-4 sm:mb-6 flex flex-col sm:flex-row items-center justify-between gap-3">
Â  Â  Â  Â  <h2 class="text-lg sm:text-xl font-bold text-gray-800 flex items-center">
Â  Â  Â  Â  Â  <i data-lucide="clipboard-list" class="w-5 h-5 sm:w-6 sm:h-6 mr-2 text-gray-600"></i>
Â  Â  Â  Â  Â  Minhas Tarefas
Â  Â  Â  Â  </h2>
Â  Â  Â  Â  <div class="flex items-center gap-2 w-full sm:w-auto">
Â  Â  Â  Â  Â  <label for="sector-filter" class="text-xs sm:text-sm font-semibold text-gray-700 flex-shrink-0">Setor:</label>
Â  Â  Â  Â  Â  <select id="sector-filter" onchange="updateSectorFilter(this.value)"
Â  Â  Â  Â  Â  Â  Â  Â  Â  class="p-2 border border-gray-300 rounded-lg bg-gray-50 focus:ring-indigo-500 focus:border-indigo-500 w-full sm:w-48"></select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="operator-of-search-wrap" class="flex items-center gap-2 w-full sm:w-auto hidden">
Â  Â  Â  Â  Â  <label class="text-xs sm:text-sm font-semibold text-gray-700 flex-shrink-0">OF:</label>
Â  Â  Â  Â  Â  <input id="operator-of-search" type="text" placeholder="Filtrar por OF..."
Â  Â  Â  Â  Â  Â  Â  Â  Â class="p-2 border border-gray-300 rounded-lg bg-gray-50 focus:ring-indigo-500 focus:border-indigo-500 w-full sm:w-48">
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div id="tasks-list-container" class="space-y-3 sm:space-y-4"></div>
Â  Â  </div>

Â  Â  <div id="report-view" class="space-y-4 sm:space-y-6 hidden">
Â  Â  Â  <h2 class="text-xl sm:text-2xl font-bold text-gray-800 border-b pb-2 mb-2 sm:mb-4 flex items-center">
Â  Â  Â  Â  <i data-lucide="file-text" class="w-5 h-5 sm:w-6 sm:h-6 mr-2 text-purple-600"></i>
Â  Â  Â  Â  RelatÃ³rio de OcorrÃªncias (OFS Ativas)
Â  Â  Â  </h2>
Â  Â  Â  <div class="bg-white p-3 sm:p-4 rounded-xl border border-gray-300">
Â  Â  Â  Â  <div class="flex justify-between items-center mb-3 sm:mb-4">
Â  Â  Â  Â  Â  <h3 class="text-base sm:text-xl font-semibold text-gray-700">Pausas & Atrasos</h3>
Â  Â  Â  Â  Â  <div class="flex gap-2">
Â  Â  Â  Â  Â  Â  <button id="btn-delete-report" onclick="deleteSelectedOcorrencias()"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="px-3 sm:px-4 py-2 bg-red-600 text-white text-sm sm:text-base font-semibold rounded-lg hover:bg-red-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  disabled>Â 
Â  Â  Â  Â  Â  Â  Â  <i data-lucide="trash-2" class="w-4 h-4 sm:w-5 sm:h-5 inline-block mr-1"></i>Â 
Â  Â  Â  Â  Â  Â  Â  <span class="hidden sm:inline">Excluir Selecionados</span>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  <button id="btn-export-report" onclick="exportReportCSV()"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="px-3 sm:px-4 py-2 bg-indigo-600 text-white text-sm sm:text-base font-semibold rounded-lg hover:bg-indigo-700 transition">
Â  Â  Â  Â  Â  Â  Â  <i data-lucide="download" class="w-4 h-4 sm:w-5 sm:h-5 inline-block mr-1"></i> Exportar (CSV)
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="overflow-x-auto">
Â  Â  Â  Â  Â  <table class="min-w-full divide-y divide-gray-200 text-xs sm:text-sm">
Â  Â  Â  Â  Â  Â  <thead class="bg-gray-50">
Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-2 sm:px-4 py-2 sm:py-3 text-center w-12">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <input type="checkbox" id="report-select-all"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â onclick="toggleSelectAllOcorrencias(this)"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
Â  Â  Â  Â  Â  Â  Â  Â  </th>
Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">OF</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">CHICOTE</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">ATIVIDADE</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">MOTIVO PAUSA</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">MOTIVO ATRASO</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">T. PAUSA (min)</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-medium text-gray-500 uppercase tracking-wider">T. ATRASO (min)</th>
Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody id="report-table-body" class="bg-white divide-y divide-gray-200"></tbody>
Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="historico-view" class="space-y-4 sm:space-y-6 hidden">
Â  Â  Â  Â  <h2 class="text-xl sm:text-2xl font-bold text-gray-800 border-b pb-2 mb-2 sm:mb-4 flex items-center">
Â  Â  Â  Â  Â  Â  <i data-lucide="archive" class="w-5 h-5 sm:w-6 sm:h-6 mr-2 text-green-600"></i>
Â  Â  Â  Â  Â  Â  HistÃ³rico de Ordens de FabricaÃ§Ã£o ConcluÃ­das
Â  Â  Â  Â  </h2>
Â  Â  Â  Â  <div id="historico-search-wrap" class="mb-2 hidden">
Â  Â  Â  Â  Â  Â  <input id="historico-of-search" type="text" placeholder="Pesquisar OF ConcluÃ­da..."
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â class="w-full sm:w-64 border border-gray-300 rounded-lg p-2 focus:ring-green-500 focus:border-green-500">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="historico-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-6">
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="admin-view" class="space-y-4 sm:space-y-6 hidden">
Â  Â  Â  <h2 class="text-xl sm:text-2xl font-bold text-gray-800 border-b pb-2 mb-2 sm:mb-4 flex items-center">
Â  Â  Â  Â  <i data-lucide="shield-check" class="w-5 h-5 sm:w-6 sm:h-6 mr-2"></i>
Â  Â  Â  Â  Painel de AdministraÃ§Ã£o (Master)
Â  Â  Â  </h2>

Â  Â  Â  <div class="bg-white p-4 sm:p-6 rounded-xl border border-gray-300">
Â  Â  Â  Â  <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">Setup: Cadastro de Roteiros Mestres</h3>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="flex flex-col lg:flex-row gap-4">
Â  Â  Â  Â  Â  <div id="roteiro-list-admin" class="space-y-4 h-[60vh] lg:h-[70vh] overflow-y-auto mb-4 p-2 border rounded-lg bg-gray-50 modal-body-scroll lg:w-1/2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  <div class="border-t lg:border-t-0 lg:border-l lg:pl-4 pt-4 lg:pt-0 space-y-4 lg:w-1/2">
Â  Â  Â  Â  Â  Â  <h4 class="text-base sm:text-lg font-semibold text-gray-700">Nova Etapa para Roteiro:</h4>
Â  Â  Â  Â  Â  Â  <div class="flex flex-col gap-3">
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="flex flex-col sm:flex-row gap-3">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="roteiro-chicote-name-admin" class="w-full sm:w-1/2 border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Nome do Chicote (Ex: CHICOTE-A)">
Â  Â  Â  Â  Â  Â  Â  Â  <select id="roteiro-setor-admin" class="w-full sm:w-1/2 border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500"></select>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <input type="text" id="roteiro-activity-name-admin" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Nome da Atividade (Ex: PrÃ© ConexÃ£o)">
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  <p class="text-sm font-medium text-gray-700 -mb-2">ParÃ¢metros de Tempo (em Minutos):</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-2 gap-3">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="roteiro-media-ciclo-admin" min="0" step="0.01" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="MÃ©dia Ciclo (min/pÃ§)">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="roteiro-desvio-ciclo-admin" min="0" step="0.01" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Desvio Ciclo (min/pÃ§)">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="roteiro-media-setup-admin" min="0" step="0.1" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="MÃ©dia Setup (min)">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="roteiro-desvio-setup-admin" min="0" step="0.1" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Desvio Setup (min)">
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <label for="roteiro-instruction-text-admin" class="block text-sm font-medium text-gray-700 mb-1">InstruÃ§Ã£o de Trabalho (HTML, links de imagem/YouTube):</label>
Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="roteiro-instruction-text-admin" rows="4" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: <b>1. PreparaÃ§Ã£o:</b> ... https://link.para/imagem.jpg"></textarea>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <button onclick="addRoteiroActivity()" class="p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="plus" class="w-5 h-5 inline-block mr-1"></i> Adicionar Etapa
Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="roteiro-message-admin" class="text-sm text-red-500"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â Â 
Â  Â  Â  <div id="user-management-container" class="bg-white p-4 sm:p-6 rounded-xl border border-gray-300 hidden">
Â  Â  Â  Â  Â <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">Gerenciamento de UsuÃ¡rios (Fase 2)</h3>
Â  Â  Â  Â  Â <p>A interface de criaÃ§Ã£o de usuÃ¡rios (Firebase Auth) aparecerÃ¡ aqui.</p>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  </main>

Â  <div id="action-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal()">
Â  Â  <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-md modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
Â  Â  Â  <h3 id="modal-title" class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2"></h3>
Â  Â  Â  <div class="modal-body-scroll">
Â  Â  Â  Â  <p id="modal-message" class="text-gray-600 mb-3 sm:mb-4"></p>
Â  Â  Â  Â  <div id="modal-content">
Â  Â  Â  Â  Â  <div id="justification-area" class="space-y-3 sm:space-y-4">
Â  Â  Â  Â  Â  Â  <label for="justification-select" class="block text-sm font-medium text-gray-700">Selecione o Motivo Principal:</label>
Â  Â  Â  Â  Â  Â  <select id="justification-select" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-indigo-500 focus:border-indigo-500 transition">
Â  Â  Â  Â  Â  Â  Â  <option value="">-- Selecione uma opÃ§Ã£o --</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  <label for="justification-text" class="block text-sm font-medium text-gray-700">Detalhes Adicionais (Opcional):</label>
Â  Â  Â  Â  Â  Â  <textarea id="justification-text" rows="2" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder=""></textarea>
Â  Â  Â  Â  Â  Â  <p id="justification-required-text" class="text-sm text-red-500 hidden font-semibold">ğŸš¨ Campo obrigatÃ³rio devido ao desvio de tempo!</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="mt-4 sm:mt-6 flex justify-end gap-2 sm:gap-3 sticky-footer">
Â  Â  Â  Â  <button onclick="closeModal()" class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition">Cancelar</button>
Â  Â  Â  Â  <button id="modal-confirm-button" class="px-3 sm:px-4 py-2 bg-gray-700 text-white font-semibold rounded-lg hover:bg-gray-600 transition" onclick="handleConfirmedAction()">Confirmar</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div id="instruction-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal('instruction-modal')">
Â  Â  <div class="bg-white rounded-xl shadow-2xl p-5 sm:p-8 w-full max-w-2xl modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
Â  Â  Â  <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2 flex items-center">
Â  Â  Â  Â  <i data-lucide="book-open-text" class="w-5 h-5 sm:w-6 sm:h-6 mr-2 text-indigo-600"></i> InstruÃ§Ã£o de Trabalho
Â  Â  Â  </h3>
Â  Â  Â  <div class="max-h-[65vh] sm:max-h-[70vh] overflow-y-auto pr-1 sm:pr-2 modal-body-scroll">
Â  Â  Â  Â  <p class="text-sm font-semibold text-gray-700 mb-2" id="instruction-modal-header"></p>
Â  Â  Â  Â  <div id="instruction-modal-content" class="text-gray-700 space-y-3"></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="mt-4 sm:mt-6 flex justify-end">
Â  Â  Â  Â  <button onclick="closeModal('instruction-modal')" class="px-3 sm:px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition">Fechar</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div id="create-of-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal()">
Â  Â  <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-lg modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
Â  Â  Â  <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">Criar Nova Ordem de FabricaÃ§Ã£o (OF)</h3>
Â  Â  Â  <div class="space-y-3 sm:space-y-4 modal-body-scroll">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <label for="of-id" class="block text-sm font-medium text-gray-700">CÃ³digo da OF:</label>
Â  Â  Â  Â  Â  <input type="text" id="of-id" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: OF-003">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <label for="of-quantity" class="block text-sm font-medium text-gray-700">Quantidade de PeÃ§as:</label>
Â  Â  Â  Â  Â  <input type="number" id="of-quantity" min="1" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: 50">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <label for="of-chicote" class="block text-sm font-medium text-gray-700">Modelo do Chicote (Roteiro Mestre):</label>
Â  Â  Â  Â  Â  <select id="of-chicote" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-indigo-500 focus:border-indigo-500">
Â  Â  Â  Â  Â  Â  <option value="">Carregando roteiros...</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <label for="of-priority" class="block text-sm font-medium text-gray-700">Prioridade:</label>
Â  Â  Â  Â  Â  <select id="of-priority" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-indigo-500 focus:border-indigo-500">
Â  Â  Â  Â  Â  Â  <option value="Media">MÃ©dia (PadrÃ£o)</option>
Â  Â  Â  Â  Â  Â  <option value="Alta">Alta (Urgente)</option>
Â  Â  Â  Â  Â  Â  <option value="Baixa">Baixa</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="of-creation-message" class="text-sm text-red-500 hidden"></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="mt-4 sm:mt-6 flex justify-end gap-2 sm:gap-3 sticky-footer">
Â  Â  Â  Â  <button onclick="closeModal('create-of-modal')" class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition">Cancelar</button>
Â  Â  Â  Â  <button onclick="createOF()" class="px-3 sm:px-4 py-2 bg-emerald-600 text-white font-semibold rounded-lg hover:bg-emerald-700">
Â  Â  Â  Â  Â  <i data-lucide="factory" class="w-5 h-5 inline-block mr-1"></i> Gerar OF
Â  Â  Â  Â  </button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  Â  Â  <div id="of-details-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="closeModal('of-details-modal')">
Â  Â  <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-3xl modal-panel mx-0 sm:mx-4" onclick="event.stopPropagation()">
Â  Â  Â  <div class="flex items-center justify-between mb-2">
Â  Â  Â  Â  <h3 id="of-details-title" class="text-xl sm:text-2xl font-bold text-gray-800"></h3>
Â  Â  Â  Â  <button class="p-2 rounded-lg hover:bg-gray-100" onclick="closeModal('of-details-modal')"><i data-lucide="x" class="w-6 h-6"></i></button>
Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="of-details-summary" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3 sm:mb-4">
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  <div class="w-full bg-gray-200 rounded-full h-2 mb-3 sm:mb-4"><div id="of-details-progress" class="h-2 rounded-full bg-blue-500" style="width:0%"></div></div>
Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div id="of-details-content" class="max-h-[60vh] overflow-y-auto space-y-3 sm:space-y-4 modal-body-scroll">
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <a id="audit-log-toggle" class="hidden" onclick="toggleAuditLog()">[Ver Detalhes do CÃ¡lculo]</a>
Â  Â  Â  <div id="audit-log-content" class="hidden modal-body-scroll max-h-[200px]">
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â Â 
Â  Â  Â  <div class="mt-4 sm:mt-5 flex justify-between gap-3 sticky-footer">
Â  Â  Â  Â  <button id="btn-delete-of" class="px-3 sm:px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition hidden" onclick="deleteOF(window.__ofDetailsOpenId)">
Â  Â  Â  Â  Â  <i data-lucide="trash-2" class="w-4 h-4 sm:w-5 sm:h-5 inline-block mr-1"></i> Excluir OF
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <div class="flex gap-2 sm:gap-3">
Â  Â  Â  Â  Â  <button id="btn-export-of" class="px-3 sm:px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition" onclick="exportOFTasksCSV(window.__ofDetailsOpenId)">Exportar CSV</button>
Â  Â  Â  Â  Â  <button class="px-3 sm:px-4 py-2 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition" onclick="closeModal('of-details-modal')">Fechar</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
Â  Â  Â  Â  <div id="user-modal" class="modal-fixed bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden" onclick="event.stopPropagation()">
Â  Â  <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full max-w-md modal-panel mx-0 sm:mx-4">
Â  Â  Â  <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 border-b pb-2">Acesso</h3>
Â  Â  Â  <div class="space-y-3 sm:space-y-4">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <label class="block text-sm font-medium text-gray-700">Perfil</label>
Â  Â  Â  Â  Â  <select id="user-role" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-indigo-500 focus:border-indigo-500">
Â  Â  Â  Â  Â  Â  <option value="OPERADOR">Operador</option>
Â  Â  Â  Â  Â  Â  <option value="MASTER">Master</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="user-sector-wrap">
Â  Â  Â  Â  Â  <label class="block text-sm font-medium text-gray-700">Setor do Operador</label>
Â  Â  Â  Â  Â  <select id="user-sector" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:ring-indigo-500 focus:border-indigo-500"></select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="user-pin-wrap" class="hidden">
Â  Â  Â  Â  Â  <label class="block text-sm font-medium text-gray-700">PIN do Master</label>
Â  Â  Â  Â  Â  <input type="password" id="user-pin" class="w-full border border-gray-300 rounded-lg p-2 mt-1" placeholder="****">
Â  Â  Â  Â  Â  <p class="text-xs text-gray-500 mt-1">Apenas numeros</p>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="mt-4 sm:mt-6 flex justify-end gap-2 sm:gap-3">
Â  Â  Â  Â  <button class="px-3 sm:px-4 py-2 bg-gray-200 rounded-lg font-semibold hover:bg-gray-300" onclick="closeModal('user-modal')">Cancelar</button>
Â  Â  Â  Â  <button class="px-3 sm:px-4 py-2 bg-gray-700 text-white rounded-lg font-semibold hover:bg-gray-600" onclick="confirmUser()">Entrar</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

<script>
/* ============================
Â  Â FIREBASE CONFIG
Â  Â ============================ */
const firebaseConfig = {
Â  apiKey: "AIzaSyDIJJIe4WIVj5OKYTtR-HQscrxIzxNK9eY",
Â  authDomain: "pcp-app-24c56.firebaseapp.com",
Â  projectId: "pcp-app-24c56",
Â  storageBucket: "pcp-app-24c56.firebasestorage.app",
Â  messagingSenderId: "675295958467",
Â  appId: "1:675295958467:web:9d79700af6fc1c28db5976",
Â  measurementId: "G-DH06WDCKJY"
};
// InicializaÃ§Ã£o Firebase
if (firebaseConfig && firebaseConfig.projectId && firebaseConfig.projectId !== "SEU_PROJECT_ID") {
Â  firebase.initializeApp(firebaseConfig);
Â  const db = firebase.firestore();
Â  const storage = firebase.storage();
Â  window.db = db;
Â  window.storage = storage;

Â  // ColeÃ§Ãµes
Â  const OF_COLLECTION = 'ofs';
Â  const TASK_COLLECTION = 'tasks';
Â  const ROTEIRO_COLLECTION = 'roteiros';
Â  const OCORRENCIA_COLLECTION = 'ocorrencias';
Â  window.OF_COLLECTION = OF_COLLECTION;
Â  window.TASK_COLLECTION = TASK_COLLECTION;
Â  window.ROTEIRO_COLLECTION = ROTEIRO_COLLECTION;
Â  window.OCORRENCIA_COLLECTION = OCORRENCIA_COLLECTION;
} else {
Â  console.warn("Firebase nÃ£o configurado â€” rodando em modo simulado.");
Â  window.db = null;
Â  window.storage = null;
}

/* ============================
Â  Â CONSTANTES & ESTADO
Â  Â ============================ */
const MASTER_PIN = "7889";
const SECTORS = [
Â  'Corte','Corte de Revestimentos','PrÃ©-Montagem','PreparaÃ§Ã£o','PrÃ© ConexÃ£o',
Â  'ConexÃ£o','PrÃ© GrampeaÃ§Ã£o','GrampeaÃ§Ã£o','Acabamento','Embalagem','Montagem','Cabo de Bateria 1','Cabo de Bateria 2'
];
const PAUSE_REASONS = [
Â  "Falta de material na bancada","ManutenÃ§Ã£o/Ajuste de mÃ¡quina","InstruÃ§Ã£o de trabalho confusa/ausente",
Â  "Necessidade de assistÃªncia tÃ©cnica","Troca de turno/intervalo programado","Outro (Detalhar abaixo)"
];
const DELAY_REASONS = [
Â  "Complexidade inesperada da peÃ§a","Problema de qualidade na etapa anterior","Falta de treinamento/experiÃªncia",
Â  "Tempo padrÃ£o calculado incorretamente","Quebra/defeito de ferramenta","Outro (Detalhar abaixo)"
];
let allOFs = {};
let allTasks = {};
let allRoteiros = {};
let allOcurrencesLog = [];
let currentAction = {};
let currentSectorFilter = SECTORS[0];
let currentUser = null;

// ReferÃªncia do GrÃ¡fico
let workloadChart = null;

// Busca por OF nas telas
let pcpSearchOF = "";
let operatorSearchOF = "";
let historicoSearchOF = "";

// SimulaÃ§Ã£o
let taskCounter = 1;
let roteiroCounter = 7;
// ####################################################################
// # Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  INÃCIO DAS MUDANÃ‡AS Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  #
// ####################################################################
// DADOS DE SIMULAÃ‡ÃƒO ATUALIZADOS com MÃ©dia e Desvio PadrÃ£o (20% do valor da mÃ©dia por padrÃ£o)
const DEFAULT_ROTEIROS = {
Â  "r1": { id:"r1", chicote_nome:"CHICOTE-001", setor:"Corte", nome_atividade:"Corte dos Fios",
Â  Â  media_setup_min: 5, desvio_setup_min: 1, Â // 20% de 5
Â  Â  media_ciclo_min: 0.2, desvio_ciclo_min: 0.04, // 20% de 0.2
Â  Â  instrucao_trabalho:"<b>1. PreparaÃ§Ã£o:</b> Verifique a faca...<br><b>2. MediÃ§Ã£o:</b> Corte 50 peÃ§as de 150mm.<br><b>3. ConferÃªncia:</b> Visual."
Â  },
Â  "r2": { id:"r2", chicote_nome:"CHICOTE-001", setor:"PrÃ©-Montagem", nome_atividade:"Crimpagem de Terminais",
Â  Â  media_setup_min: 8, desvio_setup_min: 1.6,
Â  Â  media_ciclo_min: 0.5, desvio_ciclo_min: 0.1,
Â  Â  instrucao_trabalho:"<b>Fio Preto:</b> ...<br><b>Fio Vermelho:</b> ...<br><b>Teste:</b> > 10Kgf."
Â  },
Â  "r3": { id:"r3", chicote_nome:"CHICOTE-001", setor:"Montagem Final", nome_atividade:"Montagem de Conectores",
Â  Â  media_setup_min: 15, desvio_setup_min: 3,
Â  Â  media_ciclo_min: 1.0, desvio_ciclo_min: 0.2,
Â  Â  instrucao_trabalho:"Conectar posiÃ§Ãµes 35 e 33. Proibido forÃ§ar."
Â  },
Â  "r4": { id:"r4", chicote_nome:"CHICOTE-001", setor:"Qualidade", nome_atividade:"Teste de Continuidade",
Â  Â  media_setup_min: 3, desvio_setup_min: 0.6,
Â  Â  media_ciclo_min: 0.1, desvio_ciclo_min: 0.02,
Â  Â  instrucao_trabalho:"Usar jig JIG-10B. 100% devem passar."
Â  },
Â  "r5": { id:"r5", chicote_nome:"CHICOTE-B", setor:"Corte", nome_atividade:"Corte ReforÃ§ado",
Â  Â  media_setup_min: 10, desvio_setup_min: 2,
Â  Â  media_ciclo_min: 0.3, desvio_ciclo_min: 0.06,
Â  Â  instrucao_trabalho:"InstruÃ§Ã£o bÃ¡sica B."
Â  },
Â  "r6": { id:"r6", chicote_nome:"CHICOTE-B", setor:"Montagem Final", nome_atividade:"Montagem Simples",
Â  Â  media_setup_min: 5, desvio_setup_min: 1,
Â  Â  media_ciclo_min: 0.8, desvio_ciclo_min: 0.16,
Â  Â  instrucao_trabalho:"Conectar 4 vias."
Â  },
};
// ####################################################################
// # Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  FIM DAS MUDANÃ‡AS Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  #
// ####################################################################

/* ============================
Â  Â ELEMENTOS UI
Â  Â ============================ */
const pcpView = document.getElementById("pcp-view");
const operatorView = document.getElementById("operator-view");
const reportView = document.getElementById("report-view");
const adminView = document.getElementById("admin-view");Â 
const historicoView = document.getElementById("historico-view");
const loadingIndicator = document.getElementById("loading-indicator");
const ofsListContainer = document.getElementById("ofs-list-container");
const tasksListContainer = document.getElementById("tasks-list-container");
const userViewSelect = document.getElementById("user-view-select");
const btnCreateOF = document.getElementById("btn-create-of");
const btnProfile = document.getElementById("btn-profile");
const btnExportReport = document.getElementById("btn-export-report");
const btnDeleteOF = document.getElementById("btn-delete-of");

// ####################################################################
// # Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  INÃCIO DAS MUDANÃ‡AS Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  #
// ####################################################################
/* ============================
Â  Â FUNÃ‡Ã•ES MONTE CARLO & HELPERS
Â  Â ============================ */

/**
Â * Gerador de nÃºmeros aleatÃ³rios Gaussianos (DistribuiÃ§Ã£o Normal)
Â * Usa a transformaÃ§Ã£o Box-Muller.
Â */
let __z1 = null;
let __useLast = false;
function gaussianRandom() {
Â  if (__useLast) {
Â  Â  __useLast = false;
Â  Â  return __z1;
Â  }
Â  let u = 0, v = 0;
Â  while (u === 0) u = Math.random(); // (0,1]
Â  while (v === 0) v = Math.random(); // (0,1]
Â  const z0 = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
Â  __z1 = Math.sqrt(-2.0 * Math.log(u)) * Math.sin(2.0 * Math.PI * v);
Â  __useLast = true;
Â  return z0;
}

/**
Â * Roda uma simulaÃ§Ã£o de Monte Carlo.
Â * @param {number} media - A mÃ©dia da distribuiÃ§Ã£o (Ex: MÃ©dia total do lote).
Â * @param {number} desvio - O desvio padrÃ£o da distribuiÃ§Ã£o (Ex: Desvio total do lote).
Â * @param {number} nSimulacoes - NÃºmero de iteraÃ§Ãµes (ex: 100000).
Â * @param {number} percentil - O percentil desejado (ex: 0.95 para P95).
Â * @returns {number} O valor no percentil solicitado.
Â */
function runSimulation(media, desvio, nSimulacoes, percentil) {
Â  if (desvio === 0 || isNaN(desvio)) {
Â  Â  return media; // Se nÃ£o hÃ¡ variabilidade, o resultado Ã© a prÃ³pria mÃ©dia.
Â  }
Â  const resultadosSimulacao = new Array(nSimulacoes);
Â  for (let i = 0; i < nSimulacoes; i++) {
Â  Â  const tempoSimulado = (gaussianRandom() * desvio) + media;
Â  Â  resultadosSimulacao[i] = Math.max(0.0, tempoSimulado); // Garante que nÃ£o seja negativo
Â  }
Â  // Ordena a lista para encontrar o percentil
Â  resultadosSimulacao.sort((a, b) => a - b);
Â  // Calcula o Ã­ndice
Â  const indice = Math.ceil(percentil * nSimulacoes) - 1;
Â  return resultadosSimulacao[indice];
}

/**
Â * Converte minutos totais (ex: 115.33) para formato HH:MM:SS
Â * @param {number} totalMinutos O nÃºmero total de minutos.
Â * @returns {string} O tempo formatado.
Â */
function formatarMinutosParaHMS(totalMinutos) {
Â  if (isNaN(totalMinutos) || totalMinutos === null) return "00:00:00";
Â  const totalSegundos = totalMinutos * 60;
Â Â 
Â  const horas = Math.floor(totalSegundos / 3600);
Â  const restoHoras = totalSegundos % 3600;
Â  const minutos = Math.floor(restoHoras / 60);
Â  const segundos = Math.floor(restoHoras % 60); // Arredonda segundos

Â  const hFormat = String(horas).padStart(2, '0');
Â  const mFormat = String(minutos).padStart(2, '0');
Â  const sFormat = String(segundos).padStart(2, '0');
Â Â 
Â  return `${hFormat}:${mFormat}:${sFormat}`;
}

/**
Â * Alterna a visibilidade do log de auditoria no modal de detalhes da OF.
Â */
function toggleAuditLog() {
Â  const div = document.getElementById('audit-log-content');
Â  const link = document.getElementById('audit-log-toggle');
Â  if (div.classList.contains('hidden')) {
Â  Â  div.classList.remove('hidden');
Â  Â  link.textContent = "[Ocultar Detalhes do CÃ¡lculo]";
Â  } else {
Â  Â  div.classList.add('hidden');
Â  Â  link.textContent = "[Ver Detalhes do CÃ¡lculo]";
Â  }
}
// ####################################################################
// # Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  FIM DAS MUDANÃ‡AS Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  #
// ####################################################################


/* ============================
Â  Â HELPERS & PERMISSÃ•ES
Â  Â ============================ */
function msToMinutes(ms){ if (typeof ms !== 'number' || ms < 0) return 0;
return parseFloat((ms / (1000*60)).toFixed(2)); }
function formatMinutes(v){ return `${Number(v||0).toFixed(2)} min`; }
function formatDate(d) {
Â  Â  if (!d) return '-';
Â  Â  const date = d instanceof Date ? d : new Date(getDBTimestamp(d));
Â  Â  return date.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
}

function setUser(u){
Â  currentUser = u;
Â  try { sessionStorage.setItem("pcp_current_user", JSON.stringify(u));
Â  } catch(_){}
}
function getUser(){
Â  try { return JSON.parse(sessionStorage.getItem("pcp_current_user") || "null");
Â  }
Â  catch(e){ return null; }
}
function clearUser(){ try{ sessionStorage.removeItem("pcp_current_user");
}catch(_){} currentUser=null; }

function isMaster(){ return currentUser && currentUser.role === "MASTER";
}
function isOperador(){ return currentUser && currentUser.role === "OPERADOR";
}

function getDBTimestamp(ts) {
Â  if (!ts) return null;
Â  if (typeof ts.toDate === 'function') return ts.toDate().getTime();
Â  if (ts instanceof Date) return ts.getTime();
Â  return ts;
}

/* Helper visual de Prioridade */
function getPriorityClass(priority) {
Â  if (priority === 'Alta') return 'priority-high';
Â  if (priority === 'Baixa') return 'priority-low';
Â  return 'priority-medium'; // PadrÃ£o Ã© MÃ©dia
}


/* ============================
Â  Â THEME (Simplificado)
Â  Â ============================ */
function listenTheme(){
Â  if (!window.db) return;
Â  db.collection('settings').doc('ui').onSnapshot(doc=>{
Â  Â  const s = doc.exists ? doc.data() : null;
Â  Â  applyTheme(s);
Â  });
}
function applyTheme(s){
Â  const r = document.documentElement.style;
Â  // Default Ã© o Fundo Cinza PadrÃ£o
Â  const defaultColor = '#f3f4f6';Â 
Â  if (!s || s.mode === 'color'){
Â  Â  r.setProperty('--app-bg-color', s?.color || defaultColor);
Â  Â  r.setProperty('--app-bg-image', 'none');
Â  } else {
Â  Â  r.setProperty('--app-bg-color', '#000000');
Â  Â  r.setProperty('--app-bg-image', `url("${s.imageUrl}")`);
Â  }
}


/* ============================
Â  Â CÃLCULOS DE TEMPOÂ 
Â  Â ============================ */
Â  Â 
// FunÃ§Ã£o para obter o valor acumulado em milissegundos
function calculateTempoRealMs(task){
Â  if (task.status === 'ConcluÃ­do' || task.status === 'Bloqueada' || task.status === 'Em Espera') {
Â  Â  return task.tempo_real_acumulado_ms || 0;
Â  }
Â Â 
Â  const now = Date.now();
Â  let tempoAcumulado = task.tempo_real_acumulado_ms || 0;Â 
Â  let ultimaAtividade = getDBTimestamp(task.timestamp_inicio);

Â  if (!ultimaAtividade) return tempoAcumulado;
Â  if (task.status === 'Em Processo'){
Â  Â  tempoAcumulado += (now - ultimaAtividade);
Â  }
Â Â 
Â  return tempoAcumulado;
}

// FunÃ§Ãµes que retornam minutos
function calculateTempoRealMinutes(task){
Â  if (task.status === 'ConcluÃ­do') {
Â  Â  Â  return msToMinutes(task.tempo_real_acumulado_ms || 0);
Â  }
Â  return msToMinutes(calculateTempoRealMs(task));
}

function calculateDesvio(task){
Â  const realMinutes = calculateTempoRealMinutes(task);Â 
Â  const planned = task.tempo_planejado || 0; // tempo_planejado agora Ã© o P50 (MÃ©dia)
Â Â 
Â  return parseFloat((planned - realMinutes).toFixed(2));
}

function calculateTotalPauseMinutes(task){
Â  let totalMs = task.total_pause_time_ms || 0;
Â  if (task.status === 'Pausada' && task.pause_start_timestamp){
Â  Â  totalMs += (Date.now() - getDBTimestamp(task.pause_start_timestamp));
Â  }
Â  return msToMinutes(totalMs);
}

function calculateTotalPauseMinutesFinal(task){Â 
Â  return msToMinutes(task.total_pause_time_ms || 0);
}


/* ============================
Â  Â INICIALIZAÃ‡ÃƒO & LISTENERS
Â  Â ============================ */
function setupSectorDropdowns(){
Â  const roteiroSetorSelect = document.getElementById('roteiro-setor-admin');
Â  const userSectorSelect = document.getElementById('user-sector');
Â  const sectorFilterSelect = document.getElementById('sector-filter');
Â Â 
Â  [roteiroSetorSelect, sectorFilterSelect, userSectorSelect].forEach(sel => { if (sel) sel.innerHTML = ''; });
Â Â 
Â  SECTORS.forEach(sector=>{
Â  Â  const o1 = document.createElement('option'); o1.value=sector; o1.textContent=sector;
Â  Â  const o2 = o1.cloneNode(true);
Â  Â  const o3 = o1.cloneNode(true);
Â  Â  if (roteiroSetorSelect) roteiroSetorSelect.appendChild(o1);
Â  Â  if (userSectorSelect) userSectorSelect.appendChild(o2);
Â  });
Â Â 
Â  if (sectorFilterSelect){
Â  Â  if (isOperador()){
Â  Â  Â  const o = document.createElement('option');
Â  Â  Â  o.value=currentUser.sector; o.textContent=currentUser.sector; sectorFilterSelect.appendChild(o);
Â  Â  Â  sectorFilterSelect.value=currentUser.sector;
Â  Â  Â  sectorFilterSelect.disabled = true;
Â  Â  Â  currentSectorFilter = currentUser.sector;
Â  Â  } else {
Â  Â  Â  SECTORS.forEach(sector=>{
Â  Â  Â  Â  const o2 = document.createElement('option'); o2.value=sector; o2.textContent=sector; sectorFilterSelect.appendChild(o2);
Â  Â  Â  });
Â  Â  Â  currentSectorFilter = SECTORS[0];
Â  Â  Â  sectorFilterSelect.value = SECTORS[0];
Â  Â  Â  sectorFilterSelect.disabled = false;
Â  Â  }
Â  }
}
function updateSectorFilter(sector){ currentSectorFilter = sector; renderTasks();
}

function loadRoteiroDropdowns() {
Â  const select = document.getElementById('of-chicote');
Â  if (!select) return;
Â  const roteiros = Object.values(allRoteiros);
Â  const chicotes = [...new Set(roteiros.map(r => r.chicote_nome))];
Â  select.innerHTML = '<option value="">-- Selecione um Modelo --</option>';
Â  chicotes.forEach(chicote => {
Â  Â  const option = document.createElement('option');
Â  Â  option.value = chicote;
Â  Â  option.textContent = chicote;
Â  Â  select.appendChild(option);
Â  });
Â  if (chicotes.length === 0) {
Â  Â  select.innerHTML = '<option value="">Nenhum roteiro mestre cadastrado.</option>';
Â  }
}

async function initializeApp(){
Â  loadingIndicator.classList.remove('hidden');
Â  pcpView.classList.add('hidden');
Â  operatorView.classList.add('hidden');
Â  reportView.classList.add('hidden');
Â  adminView.classList.add('hidden');Â 
Â  historicoView.classList.add('hidden');

Â  listenTheme();
Â  const savedUser = getUser();
Â  if (savedUser){ setUser(savedUser);
Â  }

Â  if (window.db) {
Â  Â  setupFirebaseListeners();
Â  } else {
Â  Â  // SIMULAÃ‡ÃƒO
Â  Â  allRoteiros = { ...DEFAULT_ROTEIROS };
Â  Â  if (!localStorage.getItem('sim_data_initialized')) {
Â  Â  Â  await createOF('OF-001', 10, 'CHICOTE-001', 'Media', true);
Â  Â  Â  await createOF('OF-002', 20, 'CHICOTE-B', 'Alta', true);
Â  Â  Â  localStorage.setItem('sim_data_initialized', 'true');
Â  Â  } else {
Â  Â  Â  allOFs = JSON.parse(localStorage.getItem('sim_ofs') || '{}');
Â  Â  Â  allTasks = JSON.parse(localStorage.getItem('sim_tasks') || '{}');
Â  Â  Â  allOcurrencesLog = JSON.parse(localStorage.getItem('sim_ocorrencias') || '[]');
Â  Â  }
Â  Â  setTimeout(()=>{
Â  Â  Â  if (!savedUser) {
Â  Â  Â  Â  openUserModal();
Â  Â  Â  } else {
Â  Â  Â  Â  if (isOperador()) { updateView('Operador'); }
Â  Â  Â  Â  else { updateView('PCP'); }
Â  Â  Â  }
Â  Â  Â  loadingIndicator.classList.add('hidden');
Â  Â  Â  setupUIRefresh();
Â  Â  Â  loadRoteiroDropdowns();
Â  Â  Â  injectSearchInputs();
Â  Â  Â  renderRoteiros();
Â  Â  }, 300);
Â  }

Â  setupSectorDropdowns();
Â  if (!savedUser) {
Â  Â  setTimeout(openUserModal, 100);
Â  } else {
Â  Â  if (isOperador()) {
Â  Â  Â  updateView('Operador');
Â  Â  } else {
Â  Â  Â  updateView('PCP');
Â  Â  }
Â  Â  injectSearchInputs();
Â  }
}

function setupFirebaseListeners() {
Â  if (!window.db) return;

Â  let collectionsLoaded = { ofs: false, tasks: false, roteiros: false, ocorrencias: false };
Â Â 
Â  const forceUpdateView = () => {
Â  Â  Â if (!loadingIndicator.classList.contains('hidden')) return;
Â  Â  Â updateView(userViewSelect.value);
Â  }
Â Â 
Â  const checkAllLoaded = () => {
Â  Â  if (Object.values(collectionsLoaded).every(Boolean)) {
Â  Â  Â  if (!loadingIndicator.classList.contains('hidden')){
Â  Â  Â  Â  loadingIndicator.classList.add('hidden');
Â  Â  Â  Â  if (!currentUser) { openUserModal(); }
Â  Â  Â  }
Â  Â  Â  updateView(userViewSelect.value || (isMaster() ? 'PCP' : 'Operador'));
Â  Â  Â  injectSearchInputs();
Â  Â  }
Â  };


Â  db.collection(OF_COLLECTION).onSnapshot(snapshot => {
Â  Â  snapshot.docChanges().forEach(change => {
Â  Â  Â  const ofData = { id: change.doc.id, ...change.doc.data() };
Â  Â  Â  if (change.type === 'removed') delete allOFs[ofData.id];
Â  Â  Â  else allOFs[ofData.id] = ofData;
Â  Â  });
Â  Â  collectionsLoaded.ofs = true;
Â  Â  checkAllLoaded();
Â  Â  forceUpdateView();Â 
Â  });
Â Â 
Â  db.collection(TASK_COLLECTION).onSnapshot(snapshot => {
Â  Â  snapshot.docChanges().forEach(change => {
Â  Â  Â  const taskData = { id: change.doc.id, ...change.doc.data() };
Â  Â  Â  if (change.type === 'removed') delete allTasks[taskData.id];
Â  Â  Â  else allTasks[taskData.id] = taskData;
Â  Â  });
Â  Â  collectionsLoaded.tasks = true;
Â  Â  checkAllLoaded();
Â  Â  forceUpdateView();Â 
Â  });
Â Â 
Â  db.collection(ROTEIRO_COLLECTION).onSnapshot(snapshot => {
Â  Â  allRoteiros = {};
Â  Â  snapshot.forEach(doc => {
Â  Â  Â  const roteiroData = { id: doc.id, ...doc.data() };
Â  Â  Â  allRoteiros[roteiroData.id] = roteiroData;
Â  Â  });
Â  Â  loadRoteiroDropdowns();
Â  Â  renderRoteiros();Â 
Â  Â  collectionsLoaded.roteiros = true;
Â  Â  checkAllLoaded();
Â  });
Â Â 
Â  db.collection(OCORRENCIA_COLLECTION).onSnapshot(snapshot => {
Â  Â  allOcurrencesLog = [];
Â  Â  snapshot.forEach(doc => { allOcurrencesLog.push({ id: doc.id, ...doc.data() }); });
Â  Â  allOcurrencesLog.sort((a,b) => getDBTimestamp(b.timestamp) - getDBTimestamp(a.timestamp));
Â  Â  collectionsLoaded.ocorrencias = true;
Â  Â  checkAllLoaded();
Â  Â  forceUpdateView();
Â  });
}

/* ============================
Â  Â CRUD
Â  Â ============================ */
// ####################################################################
// # Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  INÃCIO DAS MUDANÃ‡AS Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  #
// ####################################################################
async function addRoteiroActivity(){
Â  const chicote_name = document.getElementById('roteiro-chicote-name-admin').value.trim().toUpperCase();
Â  const setor = document.getElementById('roteiro-setor-admin').value;
Â  const activity_name = document.getElementById('roteiro-activity-name-admin').value.trim();
Â Â 
Â  // NOVOS CAMPOS
Â  const media_setup = parseFloat(document.getElementById('roteiro-media-setup-admin').value);
Â  const desvio_setup = parseFloat(document.getElementById('roteiro-desvio-setup-admin').value);
Â  const media_ciclo = parseFloat(document.getElementById('roteiro-media-ciclo-admin').value);
Â  const desvio_ciclo = parseFloat(document.getElementById('roteiro-desvio-ciclo-admin').value);
Â Â 
Â  const instruction_text = document.getElementById('roteiro-instruction-text-admin').value.trim();
Â  const messageEl = document.getElementById('roteiro-message-admin');
Â Â 
Â  messageEl.textContent = '';
Â  // ValidaÃ§Ã£o atualizada
Â  if (!chicote_name || !activity_name || !setor ||
Â  Â  Â  isNaN(media_setup) || isNaN(desvio_setup) ||
Â  Â  Â  isNaN(media_ciclo) || isNaN(desvio_ciclo)) {
Â  Â  messageEl.textContent = "Preencha todos os campos. MÃ©dia e Desvio (Ciclo e Setup) sÃ£o obrigatÃ³rios e devem ser nÃºmeros.";
Â  Â  return;
Â  }
Â Â 
Â  if (window.db) {
Â  Â  try {
Â  Â  Â  // Novo objeto Roteiro
Â  Â  Â  const newRoteiro = {
Â  Â  Â  Â  chicote_nome: chicote_name,
Â  Â  Â  Â  setor: setor,
Â  Â  Â  Â  nome_atividade: activity_name,
Â  Â  Â  Â  media_setup_min: media_setup,
Â  Â  Â  Â  desvio_setup_min: desvio_setup,
Â  Â  Â  Â  media_ciclo_min: media_ciclo,
Â  Â  Â  Â  desvio_ciclo_min: desvio_ciclo,
Â  Â  Â  Â  instrucao_trabalho: instruction_text,
Â  Â  Â  Â  created_at: firebase.firestore.FieldValue.serverTimestamp()
Â  Â  Â  };
Â  Â  Â  await db.collection(ROTEIRO_COLLECTION).add(newRoteiro);
Â  Â  Â  messageEl.textContent = `Etapa "${activity_name}" adicionada ao roteiro mestre ${chicote_name}.`;
Â  Â  Â  messageEl.classList.remove('text-red-500');
Â  Â  Â  messageEl.classList.add('text-green-600');
Â  Â  } catch(e) {
Â  Â  Â  messageEl.textContent = "Erro ao salvar no Firebase: " + e.message;
Â  Â  Â  messageEl.classList.add('text-red-500');
Â  T Â }
Â  } else {
Â  Â  const newId = `r${roteiroCounter++}`;
Â  Â  allRoteiros[newId] = {
Â  Â  Â  id: newId, chicote_nome: chicote_name, setor,
Â  Â  Â  nome_atividade: activity_name,
Â  Â  Â  media_setup_min: media_setup, desvio_setup_min: desvio_setup,
Â  Â  Â  media_ciclo_min: media_ciclo, desvio_ciclo_min: desvio_ciclo,
Â  Â  Â  instrucao_trabalho: instruction_text
Â  Â  };
Â  Â  messageEl.textContent = `Etapa "${activity_name}" adicionada (SimulaÃ§Ã£o).`;
Â  Â  messageEl.classList.remove('text-red-500');
Â  Â  messageEl.classList.add('text-green-600');
Â  Â  renderRoteiros();
Â  Â  loadRoteiroDropdowns();
Â  }
Â  // Limpa os 4 campos de tempo
Â  document.getElementById('roteiro-activity-name-admin').value = '';
Â  document.getElementById('roteiro-media-setup-admin').value = '';
Â  document.getElementById('roteiro-desvio-setup-admin').value = '';
Â  document.getElementById('roteiro-media-ciclo-admin').value = '';
Â  document.getElementById('roteiro-desvio-ciclo-admin').value = '';
Â  document.getElementById('roteiro-instruction-text-admin').value = '';
}
// ####################################################################
// # Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  FIM DAS MUDANÃ‡AS Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  #
// ####################################################################

// ####################################################################
// # Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  INÃCIO DAS MUDANÃ‡AS Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  #
// ####################################################################
async function createOF(ofIdOverride, quantityOverride, chicoteOverride, priorityOverride, isSimulated = false){
Â  const of_id = ofIdOverride || document.getElementById('of-id').value.trim().toUpperCase();
Â  const quantity = quantityOverride || parseInt(document.getElementById('of-quantity').value);
Â  const chicote_name = chicoteOverride || document.getElementById('of-chicote').value;
Â  const priority = priorityOverride || document.getElementById('of-priority').value || 'Media';
Â Â 
Â  const messageEl = document.getElementById('of-creation-message');
Â  messageEl.textContent = '';
Â  messageEl.classList.add('hidden');

Â  if (!of_id || isNaN(quantity) || quantity <= 0 || !chicote_name){
Â  Â  messageEl.textContent = "Preencha todos os campos corretamente.";
Â  Â  messageEl.classList.remove('hidden');
Â  Â  return;
Â  }
Â  if (Object.values(allOFs).find(of => of.id === of_id)) {
Â  Â  messageEl.textContent = `OF "${of_id}" jÃ¡ existe.`;
Â  Â  messageEl.classList.remove('hidden');
Â  Â  return;
Â  }

Â  const roteiroEtapas = Object.values(allRoteiros).filter(r => r.chicote_nome === chicote_name);
Â  if (roteiroEtapas.length === 0){
Â  Â  messageEl.textContent = `Nenhuma etapa encontrada para "${chicote_name}".`;
Â  Â  messageEl.classList.remove('hidden');
Â  Â  return;
Â  }

Â  // --- INÃCIO DA LÃ“GICA MONTE CARLO ---
Â  const N = quantity;
Â  const P_LEVEL = 0.95; // NÃ­vel de ConfianÃ§a (P95)
Â  const N_SIMULACOES = 100000; // NÃºmero de iteraÃ§Ãµes
Â Â 
Â  let totalMediaOF = 0;
Â  let totalVarianciaOF = 0;
Â  let auditLog = `Auditoria de CÃ¡lculo (PCP Monte Carlo)\n`;
Â  auditLog += `OF: ${of_id} | PeÃ§as: ${N} | ConfianÃ§a: ${P_LEVEL * 100}%\n`;
Â  auditLog += `----------------------------------------\n`;
Â  auditLog += `1. ConsolidaÃ§Ã£o de ParÃ¢metros por Etapa (em Minutos):\n\n`;

Â  const taskParameters = [];

Â  for (const etapa of roteiroEtapas) {
Â  Â  // Garante que os valores existam, tratando dados antigos (default 0)
Â  Â  const media_ciclo = etapa.media_ciclo_min || 0;
Â  Â  const desvio_ciclo = etapa.desvio_ciclo_min || 0;
Â  Â  const media_setup = etapa.media_setup_min || 0;
Â  Â  const desvio_setup = etapa.desvio_setup_min || 0;

Â  Â  // Calcula MÃ©dia (P50) e VariÃ¢ncia para o LOTE desta etapa
Â  Â  const media_lote_etapa = (media_ciclo * N) + media_setup;
Â  Â  const variancia_lote_etapa = (Math.pow(desvio_ciclo, 2) * N) + Math.pow(desvio_setup, 2);
Â Â 
Â  Â  // Acumula os totais da OF
Â  Â  totalMediaOF += media_lote_etapa;
Â  Â  totalVarianciaOF += variancia_lote_etapa;
Â Â 
Â  Â  // Adiciona ao Log de Auditoria
Â  Â  auditLog += `Etapa: ${etapa.nome_atividade} (${etapa.setor})\n`;
Â  Â  auditLog += `  MÃ©dia Lote (P50) = (${media_ciclo.toFixed(4)} * ${N}) + ${media_setup.toFixed(2)} = ${media_lote_etapa.toFixed(4)}\n`;
Â  Â  auditLog += `  VariÃ¢ncia Lote = (${desvio_ciclo.toFixed(4)}Â² * ${N}) + ${desvio_setup.toFixed(2)}Â² = ${variancia_lote_etapa.toFixed(4)}\n\n`;
Â  Â Â 
Â  Â  // Salva parÃ¢metros para criar a Task depois
Â  Â  taskParameters.push({
Â  Â  Â  etapa: etapa,
Â  Â  Â  tempo_planejado_p50: media_lote_etapa,
Â  Â  Â  // Salva os valores de mÃ©dia para exibiÃ§Ã£o (compatibilidade)
Â  Â  Â  tempo_setup_compat: media_setup,
Â  Â  Â  tempo_ciclo_compat: media_ciclo,
Â  Â  Â  // Salva os desvios para uso futuro
Â  Â  Â  desvio_setup: desvio_setup,
Â  Â  Â  desvio_ciclo: desvio_ciclo
Â  Â  });
Â  }

Â  // Consolida e Roda a SimulaÃ§Ã£o Final para a OF
Â  const desvioPadraoOF = Math.sqrt(totalVarianciaOF);
Â  const tempoConfiavelOF = runSimulation(totalMediaOF, desvioPadraoOF, N_SIMULACOES, P_LEVEL);

Â  auditLog += `----------------------------------------\n`;
Â  auditLog += `2. ParÃ¢metros Totais da OF ${of_id}:\n`;
Â  auditLog += `  MÃ©dia Total (P50) = Î£ MÃ©dias Lote = ${totalMediaOF.toFixed(4)} min\n`;
Â  auditLog += `  VariÃ¢ncia Total = Î£ VariÃ¢ncias Lote = ${totalVarianciaOF.toFixed(4)}\n`;
Â  auditLog += `  Desvio PadrÃ£o Total = sqrt(VariÃ¢ncia) = ${desvioPadraoOF.toFixed(4)} min\n\n`;
Â  auditLog += `3. Resultado da SimulaÃ§Ã£o (P${P_LEVEL * 100}):\n`;
Â  auditLog += `  (Simulado ${N_SIMULACOES}x usando MÃ©dia=${totalMediaOF.toFixed(4)} e Desvio=${desvioPadraoOF.toFixed(4)})\n`;
Â  auditLog += `  Tempo ConfiÃ¡vel (P95) = ${tempoConfiavelOF.toFixed(4)} min\n\n`;
Â  auditLog += `  Formatado (HH:MM:SS):\n`;
Â  auditLog += `  Tempo Esperado (P50) = ${formatarMinutosParaHMS(totalMediaOF)}\n`;
Â  auditLog += `  Tempo ConfiÃ¡vel (P95) = ${formatarMinutosParaHMS(tempoConfiavelOF)}\n`;
Â  // --- FIM DA LÃ“GICA MONTE CARLO ---


Â  const newOF = {
Â  Â  id: of_id, chicote: chicote_name, quantidade: quantity,
Â  Â  status: 'Pendente',
Â  Â  priority: priority,Â 
Â  Â  data_criacao: window.db ? firebase.firestore.FieldValue.serverTimestamp() : new Date(),
Â  Â  task_count: roteiroEtapas.length,
Â  Â  concluded_tasks: 0,
Â  Â  // NOVOS CAMPOS MONTE CARLO
Â  Â  tempo_esperado_total_min: parseFloat(totalMediaOF.toFixed(4)),
Â  Â  tempo_confiavel_total_min: parseFloat(tempoConfiavelOF.toFixed(4)),
Â  Â  calculo_audit_log: auditLog
Â  };
Â Â 
Â  try {
Â  Â  if (window.db) { await db.collection(OF_COLLECTION).doc(of_id).set(newOF); }
Â  Â  else { allOFs[of_id] = newOF;
Â  Â  }

Â  Â  const batch = window.db ? db.batch() : null;
Â  Â  let order = 1;
Â  Â  // Loop usando os parÃ¢metros jÃ¡ calculados
Â  Â  for (const params of taskParameters) {
Â  Â  Â  const etapa = params.etapa;
Â  Â  Â  const newTask = {
Â  Â  Â  Â  id_of: of_id, id_roteiro: etapa.id, chicote: chicote_name,
Â  Â  Â  Â  nome_atividade: etapa.nome_atividade, setor: etapa.setor,
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Salva o P50 (MÃ©dia) como o tempo planejado da task
Â  Â  Â  Â  tempo_planejado: parseFloat(params.tempo_planejado_p50.toFixed(2)),
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Salva os valores de mÃ©dia para exibiÃ§Ã£o (compatibilidade)
Â  Â  Â  Â  tempo_setup: params.tempo_setup_compat,
Â  Â  Â  Â  tempo_ciclo: params.tempo_ciclo_compat,
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Salva os desvios para uso futuro
Â  Â  Â  Â  desvio_setup_min: params.desvio_setup,
Â  Â  Â  Â  desvio_ciclo_min: params.desvio_ciclo,
Â  Â  Â  Â Â 
Â  Â  Â  Â  instrucao_trabalho: etapa.instrucao_trabalho,
Â  Â  Â  Â  quantidade_pecas: quantity,
Â  Â  Â  Â  status: 'Em Espera',
Â  Â  Â  Â  ordem: order++,
Â  Â  Â  Â  priority: priority,Â 
Â  Â Â 
Â  Â  Â  Â  timestamp_inicio: null, timestamp_fim: null,
Â  Â  Â  Â  tempo_real_acumulado_ms: 0,Â 
Â  Â  Â  Â  total_pause_time_ms: 0,Â  Â  Â 
Â  Â  Â  Â  pause_start_timestamp: null,
Â  Â  Â  Â  search_index: of_id.toLowerCase()+'-'+etapa.nome_atividade.toLowerCase()+'-'+etapa.setor.toLowerCase()
Â  Â  Â  };
Â  Â  Â  if (window.db) {
Â  Â  Â  Â  const newTaskRef = db.collection(TASK_COLLECTION).doc();
Â  Â  Â  Â  batch.set(newTaskRef, newTask);
Â  Â  Â  } else {
Â  Â  Â  Â  const simTaskId = `t${taskCounter++}`;
Â  Â  Â  Â  newTask.id = simTaskId;
Â  Â  Â  Â  allTasks[simTaskId] = newTask;
Â  Â  Â  }
Â  Â  }
Â  Â  if (batch) await batch.commit();
Â  Â  if (!isSimulated) {
Â  Â  Â  closeModal('create-of-modal');
Â  Â  Â  alert(`OF ${of_id} criada com sucesso!\nTempo Esperado (P50): ${formatarMinutosParaHMS(totalMediaOF)}\nTempo ConfiÃ¡vel (P95): ${formatarMinutosParaHMS(tempoConfiavelOF)}`);
Â  Â  Â  if (!window.db) {
Â  Â  Â  Â  localStorage.setItem('sim_ofs', JSON.stringify(allOFs));
Â  Â  Â  Â  localStorage.setItem('sim_tasks', JSON.stringify(allTasks));
Â  Â  Â  }
Â  Â  }
Â  } catch(e) {
Â  Â  messageEl.textContent = "Erro ao criar OF: " + (e.message || e);
Â  Â  messageEl.classList.remove('hidden');
Â  Â  console.error("Erro em createOF:", e);
Â  }
}
// ####################################################################
// # Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  FIM DAS MUDANÃ‡AS Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  #
// ####################################################################


async function updateTaskStatus(taskId, newStatus, logType = null, justification = null, justificationText = null) {
Â  const task = allTasks[taskId];
Â  if (!task) return;

Â  const updateData = { status: newStatus };
Â  const now = window.db ? firebase.firestore.FieldValue.serverTimestamp() : new Date();
Â Â 
Â  const currentTempoRealMs = calculateTempoRealMs(task);Â 

Â  if (newStatus === 'Em Processo') {
Â  Â  if (task.status === 'Pausada' && task.pause_start_timestamp) {
Â  Â  Â  const pauseStartMs = getDBTimestamp(task.pause_start_timestamp);
Â  Â  Â  const currentPauseTimeMs = Date.now() - pauseStartMs;
Â  Â  Â  updateData.total_pause_time_ms = (task.total_pause_time_ms || 0) + currentPauseTimeMs;
Â  Â  Â  updateData.pause_start_timestamp = null;
Â  Â  }
Â  Â  if (task.status === 'Em Espera') updateData.timestamp_inicio = now;
Â  }Â 
Â  else if (newStatus === 'Pausada') {
Â  Â  updateData.tempo_real_acumulado_ms = currentTempoRealMs;
Â  Â  updateData.pause_start_timestamp = now;
Â  Â  if (logType === 'PAUSA' && (justification || justificationText)) {
Â  Â  Â  await createOcorrenciaLog(task, 'PAUSA', justification, justificationText);
Â  Â  }
Â  }Â 
Â  else if (newStatus === 'ConcluÃ­do') {
Â  Â  const desvio = calculateDesvio(task);
Â  Â  updateData.tempo_real_acumulado_ms = currentTempoRealMs;
Â  Â  updateData.timestamp_fim = now;
Â  Â  updateData.pause_start_timestamp = null;
Â  Â  if (desvio < 0 || logType === 'FIM_ATRASO') {
Â  Â  Â  await createOcorrenciaLog(task, 'FIM_ATRASO', justification, justificationText);
Â  Â  }

Â  Â  if (window.db) {
Â  Â  Â  const ofRef = db.collection(OF_COLLECTION).doc(task.id_of);
Â  Â  Â  const tasksDaOF = Object.values(allTasks).filter(t => t.id_of === task.id_of);
Â  Â  Â  const totalConcluidas = tasksDaOF.filter(t => (t.id === taskId) ? true : t.status === 'ConcluÃ­do').length;
Â  Â  Â  const ofConcluida = totalConcluidas >= tasksDaOF.length;

Â  Â  Â  const batch = db.batch();
Â  Â  Â  batch.update(db.collection(TASK_COLLECTION).doc(taskId), updateData);
Â  Â  Â  batch.update(ofRef, {
Â  Â  Â  Â  concluded_tasks: firebase.firestore.FieldValue.increment(1),
Â  Â  Â  Â  status: ofConcluida ? 'ConcluÃ­do' : 'Em Andamento'
Â  Â  Â  });
Â  Â  Â  await batch.commit();
Â  Â  } else {
Â  Â  Â  const of = allOFs[task.id_of];
Â  Â  Â  of.concluded_tasks = (of.concluded_tasks || 0) + 1;
Â  Â  Â  Object.assign(task, updateData);
Â  Â  Â  const tasksDaOF = Object.values(allTasks).filter(t => t.id_of === task.id_of);
Â  Â  Â  const totalConcluidas = tasksDaOF.filter(t => t.status === 'ConcluÃ­do').length;
Â  Â  Â  of.status = (totalConcluidas >= tasksDaOF.length) ? 'ConcluÃ­do' : 'Em Andamento';
Â  Â  Â  localStorage.setItem('sim_ofs', JSON.stringify(allOFs));
Â  Â  Â  localStorage.setItem('sim_tasks', JSON.stringify(allTasks));
Â  Â  }
Â  Â  renderTasks();
Â  Â  return;
Â  }

Â  if (window.db) {
Â  Â  await db.collection(TASK_COLLECTION).doc(taskId).update(updateData);
Â  } else {
Â  Â  Object.assign(task, updateData);
Â  Â  localStorage.setItem('sim_tasks', JSON.stringify(allTasks));
Â  }
Â  renderTasks();
}


async function createOcorrenciaLog(task, type, justification, justificationText) {
Â  const logData = {
Â  Â  ID_TASK: task.id, OF: task.id_of, CHICOTE: task.chicote, ATIVIDADE: task.nome_atividade,
Â  Â  OPERADOR: currentUser?.name || currentUser?.sector || '', SECTOR: task.setor,
Â  Â  MOTIVO_PRINCIPAL: justification, MOTIVO_DETALLES: justificationText,
Â  Â  timestamp: window.db ? firebase.firestore.FieldValue.serverTimestamp() : new Date()
Â  };

Â  if (type === 'PAUSA') {
Â  Â  logData.TIPO = 'PAUSA';
Â  Â  logData.TEMPO_PAUSA = 0;Â 
Â  Â  logData.TEMPO_ATRASO = 0;
Â  Â  logData.MOTIVO_PAUSA = justification;
Â  Â  logData.MOTIVO_ATRASO = null;
Â  } else if (type === 'FIM_ATRASO') {
Â  Â  const desvio = calculateDesvio(task);
Â  Â  logData.TIPO = 'ATRASO';
Â  Â  logData.TEMPO_PAUSA = calculateTotalPauseMinutesFinal(task);Â 
Â  Â  logData.TEMPO_ATRASO = parseFloat(Math.abs(desvio).toFixed(2));
Â  Â  logData.MOTIVO_PAUSA = null;
Â  Â  logData.MOTIVO_ATRASO = justification;
Â  }

Â  if (window.db) await db.collection(OCORRENCIA_COLLECTION).add(logData);
Â  else {
Â  Â  logData.id = `log${allOcurrencesLog.length + 1}`;
Â  Â  allOcurrencesLog.push(logData);
Â  Â  localStorage.setItem('sim_ocorrencias', JSON.stringify(allOcurrencesLog));
Â  }
}


/* ============================
Â  Â AÃ‡Ã•ES
Â  Â ============================ */
function startTask(taskId){ updateTaskStatus(taskId, 'Em Processo'); }
function finishTask(taskId){ showActionModal(taskId, 'Finalizar', DELAY_REASONS);
}
function pauseTask(taskId){ showActionModal(taskId, 'Pausar', PAUSE_REASONS); }

async function deleteRoteiroActivity(roteiroId) {
Â  if (!isMaster() || !confirm("Excluir esta etapa de roteiro?")) return;
Â  if (window.db) {
Â  Â  try { await db.collection(ROTEIRO_COLLECTION).doc(roteiroId).delete(); alert("Etapa excluÃ­da.");
Â  Â  }
Â  Â  catch(e) { alert("Erro ao excluir: " + e.message);
Â  Â  }
Â  } else {
Â  Â  delete allRoteiros[roteiroId];
Â  Â  renderRoteiros();
Â  Â  loadRoteiroDropdowns();
Â  }
}

async function deleteOF(ofId) {
Â  if (!isMaster() || !ofId) return;
Â  if (!confirm(`Excluir OF ${ofId} e TODAS as suas tarefas e logs? Esta aÃ§Ã£o Ã© IRREVERSÃVEL.`)) return;
Â  try {
Â  Â  if (window.db) {
Â  Â  Â  const batch = db.batch();
Â  Â  Â  batch.delete(db.collection(OF_COLLECTION).doc(ofId));
Â  Â  Â  const tasksSnapshot = await db.collection(TASK_COLLECTION).where('id_of', '==', ofId).get();
Â  Â  Â  tasksSnapshot.docs.forEach(doc => batch.delete(doc.ref));
Â  Â  Â  const ocorrenciasSnapshot = await db.collection(OCORRENCIA_COLLECTION).where('OF', '==', ofId).get();
Â  Â  Â  ocorrenciasSnapshot.docs.forEach(doc => batch.delete(doc.ref));
Â  Â  Â  await batch.commit();
Â  Â  } else {
Â  Â  Â  delete allOFs[ofId];
Â  Â  Â  Object.keys(allTasks).forEach(id => { if (allTasks[id].id_of === ofId) delete allTasks[id]; });
Â  Â  Â  allOcurrencesLog = allOcurrencesLog.filter(l => l.OF !== ofId);
Â  Â  Â  localStorage.setItem('sim_ofs', JSON.stringify(allOFs));
Â  Â  Â  localStorage.setItem('sim_tasks', JSON.stringify(allTasks));
Â  Â  Â  localStorage.setItem('sim_ocorrencias', JSON.stringify(allOcurrencesLog));
Â  Â  }
Â  Â  closeModal('of-details-modal');
Â  Â  alert(`OF ${ofId} excluÃ­da.`);
Â  Â  updateView(userViewSelect.value);
Â  } catch(e) {
Â  Â  alert("Erro ao excluir OF: " + (e.message || e));
Â  }
}

/* ============================
Â  Â MODAIS
Â  Â ============================ */
function openModal(id){
Â  const modal = document.getElementById(id);
Â  if(modal) modal.style.display = 'flex';
}
function closeModal(id){
Â  const modalId = id || 'action-modal';
Â  const modal = document.getElementById(modalId);
Â  if(modal) {
Â  Â  modal.style.display = 'none';
Â  Â  if (modalId === 'action-modal') {
Â  Â  Â  currentAction = {};
Â  Â  Â  const jsSel = document.getElementById('justification-select');
Â  Â  Â  const jsTxt = document.getElementById('justification-text');
Â  Â  Â  const jsReq = document.getElementById('justification-required-text');
Â  Â  Â  if (jsSel) jsSel.value = '';
Â  Â  Â  if (jsTxt) jsTxt.value = '';
Â  Â  Â  if (jsReq) jsReq.classList.add('hidden');
Â  Â  }
Â  Â  // NOVO: Reseta o log de auditoria ao fechar o modal de detalhes
Â  Â  if (modalId === 'of-details-modal') {
Â  Â  Â  document.getElementById('audit-log-content').classList.add('hidden');
Â  Â  Â  document.getElementById('audit-log-toggle').textContent = "[Ver Detalhes do CÃ¡lculo]";
Â  Â  }
Â  }
}
function showActionModal(taskId, type, reasons){
Â  const task = allTasks[taskId];
Â  if (!task) return;
Â  currentAction = { taskId, type };
Â  const title = document.getElementById('modal-title');
Â  const message = document.getElementById('modal-message');
Â  const justificationSelect = document.getElementById('justification-select');
Â  const justificationRequired = document.getElementById('justification-required-text');

Â  title.textContent = `${type} Atividade: ${task.nome_atividade}`;
Â  message.textContent = `OF ${task.id_of} - Chicote ${task.chicote}`;
Â  justificationSelect.innerHTML = '<option value="">-- Selecione uma opÃ§Ã£o --</option>';
Â  reasons.forEach(reason => {
Â  Â  const option = document.createElement('option');
Â  Â  option.value = reason;
Â  Â  option.textContent = reason;
Â  Â  justificationSelect.appendChild(option);
Â  });
Â  let isRequired = false;
Â  if (type === 'Finalizar') {
Â  Â  const desvio = calculateDesvio(task);
Â  Â  if (desvio < 0) {
Â  Â  Â  // ATUALIZADO: Agora compara com o P50
Â  Â  Â  justificationRequired.textContent = `ğŸš¨ Justificativa obrigatÃ³ria devido ao ATRASO de ${formatMinutes(Math.abs(desvio))} (vs. tempo esperado P50)!`;
Â  Â  Â  isRequired = true;
Â  Â  } else {
Â  Â  Â  justificationRequired.textContent = `âœ… ConcluÃ­do dentro/antes do tempo esperado (P50). Nenhuma justificativa necessÃ¡ria.`;
Â  Â  Â  isRequired = false;
Â  Â  }
Â  } else if (type === 'Pausar') {
Â  Â  justificationRequired.textContent = `Motivo da pausa Ã© altamente recomendado.`;
Â  }
Â  justificationRequired.classList.toggle('hidden', !isRequired && type !== 'Pausar');
Â  currentAction.isRequired = isRequired;

Â  openModal('action-modal');
}
async function handleConfirmedAction(){
Â  const { taskId, type, isRequired } = currentAction;
Â  const justificationSelect = document.getElementById('justification-select');
Â  const justificationText = document.getElementById('justification-text').value.trim();
Â  const justification = justificationSelect.value;
Â  const justificationRequired = document.getElementById('justification-required-text');
Â  if (isRequired && !justification) {
Â  Â  justificationRequired.textContent = "ğŸš¨ VocÃª deve selecionar um motivo principal!";
Â  Â  justificationRequired.classList.remove('hidden');
Â  Â  return;
Â  }
Â  justificationRequired.classList.add('hidden');

Â  if (type === 'Finalizar') {
Â  Â  await updateTaskStatus(taskId, 'ConcluÃ­do', null, justification, justificationText);
Â  Â  updateView(userViewSelect.value);
Â  } else if (type === 'Pausar') {
Â  Â  await updateTaskStatus(taskId, 'Pausada', 'PAUSA', justification, justificationText);
Â  }
Â  closeModal();
}

function renderInstructionContent(rawContent) {
Â  Â  if (!rawContent || rawContent.trim() === '') {
Â  Â  Â  Â  return '<p class="text-gray-500 italic">Nenhuma instruÃ§Ã£o de trabalho cadastrada para esta etapa.</p>';
Â  Â  }
Â  Â  let htmlContent = rawContent.replace(/\n/g, '<br>');
Â  Â  const urlRegex = /(https?:\/\/[^\s<]+)/g;
Â  Â Â 
Â  Â  let processedContent = htmlContent.replace(urlRegex, (url) => {
Â  Â  Â  Â  return `<a href="${url}" target="_blank" class="text-indigo-600 hover:text-indigo-800 font-medium underline">${url}</a>`;
Â  Â  });
Â  Â  processedContent = processedContent.replace(/<a [^>]*href="([^"]*)"[^>]*>[\s\S]*<a [^>]*href="([^"]*)"[^>]*>([\s\S]*)<\/a>[\s\S]*<\/a>/gi,Â 
Â  Â  Â  Â  (match, p1, p2, p3) => {
Â  Â  Â  Â  Â  Â  if(p1 === p2) return `<a href="${p1}" target="_blank" class="text-indigo-600 hover:text-indigo-800 font-medium underline">${p3}</a>`;
Â  Â  Â  Â  Â  Â  return match;
Â  Â  Â  Â  }
Â  Â  );
Â  Â  return processedContent;
}

function openInstructionModal(taskId) {
Â  const task = allTasks[taskId];
Â  if (!task) return;
Â  document.getElementById('instruction-modal-header').textContent =
Â  Â  `OF ${task.id_of} - Chicote ${task.chicote} - Setor: ${task.setor}`;
Â Â 
Â  const contentEl = document.getElementById('instruction-modal-content');
Â  contentEl.innerHTML = renderInstructionContent(task.instrucao_trabalho);
Â Â 
Â  openModal('instruction-modal');
Â  lucide.createIcons();
}

function openUserModal() {
Â  const modal = document.getElementById('user-modal');
Â  if(modal) modal.style.display = 'flex';
Â  setTimeout(()=>{
Â  Â  const roleSel = document.getElementById('user-role');
Â  Â  const pinWrap = document.getElementById('user-pin-wrap');
Â  Â  const sectorWrap = document.getElementById('user-sector-wrap');
Â  Â  roleSel.onchange = () => {
Â  Â  Â  const isM = roleSel.value === 'MASTER';
Â  Â  Â  pinWrap.classList.toggle('hidden', !isM);
Â  Â  Â  sectorWrap.classList.toggle('hidden', isM);
Â  Â  };
Â  Â  roleSel.dispatchEvent(new Event('change'));
Â  }, 50);
}
function confirmUser(){
Â  const role = document.getElementById('user-role').value;
Â  const sector = document.getElementById('user-sector').value;
Â  if (role === 'MASTER') {
Â  Â  const pin = document.getElementById('user-pin').value;
Â  Â  if (pin !== MASTER_PIN) { alert("PIN incorreto."); return;
Â  Â  }
Â  Â  setUser({ role: 'MASTER', name: 'Master' });
Â  } else {
Â  Â  if (!sector) { alert("Selecione o setor."); return;
Â  Â  }
Â  Â  setUser({ role: 'OPERADOR', sector, name: 'Operador' });
Â  }
Â  document.getElementById('user-modal').style.display = 'none';
Â  loadingIndicator.classList.add('hidden');
Â  setupSectorDropdowns();
Â  updateView(isMaster() ? 'PCP' : 'Operador');
Â  injectSearchInputs();
}

/* ============================
Â  Â RENDERIZAÃ‡ÃƒO
Â  Â ============================ */
function setupUIRefresh(){
Â  // Timer removido.
}
function injectSearchInputs(){
Â  // PCP search
Â  const pcpWrap = document.getElementById('pcp-of-search-wrap');
Â  if (pcpWrap && !pcpWrap.dataset.ready){
Â  Â  pcpWrap.classList.remove('hidden');
Â  Â  pcpWrap.dataset.ready = "1";
Â  Â  const input = document.getElementById('pcp-of-search');
Â  Â  if (input) input.addEventListener('input', (e)=>{ pcpSearchOF = (e.target.value||"").trim().toUpperCase(); renderOFs(); });
Â  }
Â  // Operator search
Â  const opWrap = document.getElementById('operator-of-search-wrap');
Â  if (opWrap && !opWrap.dataset.ready){
Â  Â  opWrap.classList.remove('hidden');
Â  Â  opWrap.dataset.ready = "1";
Â  Â  const input = document.getElementById('operator-of-search');
Â  Â  if (input) input.addEventListener('input', (e)=>{ operatorSearchOF = (e.target.value||"").trim().toUpperCase(); renderTasks(); });
Â  }
Â  // HistÃ³rico search
Â  const histWrap = document.getElementById('historico-search-wrap');
Â  if (histWrap && !histWrap.dataset.ready){
Â  Â  histWrap.classList.remove('hidden');
Â  Â  histWrap.dataset.ready = "1";
Â  Â  const input = document.getElementById('historico-of-search');
Â  Â  if (input) input.addEventListener('input', (e)=>{ historicoSearchOF = (e.target.value||"").trim().toUpperCase(); renderHistory(); });
Â  }
}

function renderKPIs(){
Â  const kpisContainer = document.getElementById('kpis-container');
Â  if (!kpisContainer) return;
Â Â 
Â  const activeOFIds = Object.keys(allOFs).filter(k => allOFs[k]?.status !== 'ConcluÃ­do');
Â  const activeTasks = Object.values(allTasks).filter(t => activeOFIds.includes(t.id_of));
Â Â 
Â  const totalOFs = activeOFIds.length;
Â  const concludedTasks = activeTasks.filter(t=>t.status==='ConcluÃ­do').length;
Â  const totalTasks = activeTasks.length;Â 

Â  const activeLogs = allOcurrencesLog.filter(l => activeOFIds.includes(l.OF));
Â Â 
Â  const logsAtraso = activeLogs.filter(l => l.TIPO === 'ATRASO');
Â  const totalPause = activeLogs.reduce((s,l)=> s + (l.TEMPO_PAUSA||0), 0);
Â  const totalAtraso = logsAtraso.reduce((s,l)=> s + (l.TEMPO_ATRASO||0), 0);
Â Â 
Â  // ============================
Â  // KPIs
Â  // ============================
Â  const kpiData = [
Â  Â  { title:"OFs Ativas", value: totalOFs, icon:"package", color:"bg-blue-600" },
Â  Â  { title:"Tarefas ConcluÃ­das", value: `${concludedTasks} / ${totalTasks}`, icon:"check-circle", color:"bg-green-600" },
Â  Â  { title:"Pausas Totais (min)", value: totalPause.toFixed(1), icon:"pause-circle", color:"bg-yellow-600" },
Â  Â  { title:"Atraso Total (min)", value: totalAtraso.toFixed(1), icon:"alert-triangle", color:"bg-red-600" },
Â  ];

Â  kpisContainer.innerHTML = kpiData.map(k=>`
Â  Â  <div class="${k.color} text-white p-3 sm:p-4 rounded-xl shadow-md flex items-center justify-between">
Â  Â  Â  <div>
Â  Â  Â  Â  <p class="text-xs sm:text-sm font-medium opacity-80">${k.title}</p>
Â  Â  Â  Â  <p class="text-2xl sm:text-3xl font-bold">${k.value}</p>
Â  Â  Â  </div>
Â  Â  Â  <i data-lucide="${k.icon}" class="w-7 h-7 sm:w-8 sm:h-8 opacity-70"></i>
Â  Â  </div>`).join('');
Â  lucide.createIcons();
}

function renderWorkloadChart() {
Â  const ctxEl = document.getElementById('workload-chart');
Â  if (!ctxEl) return;

Â  const tasksNaoConcluidas = Object.values(allTasks).filter(t => t.status !== 'ConcluÃ­do');
Â  const cargaPorSetor = {};Â 

Â  SECTORS.forEach(setor => { cargaPorSetor[setor] = 0; });
Â Â 
Â  tasksNaoConcluidas.forEach(task => {
Â  Â  if (allOFs[task.id_of]?.status !== 'ConcluÃ­do' && cargaPorSetor.hasOwnProperty(task.setor)) {
Â  Â  Â  // ATUALIZADO: O grÃ¡fico agora usa o tempo_planejado (P50)
Â  Â  Â  cargaPorSetor[task.setor] += task.tempo_planejado || 0;
Â  Â  }
Â  });
Â Â 
Â  const labels = Object.keys(cargaPorSetor).filter(setor => cargaPorSetor[setor] > 0);
Â  const data = labels.map(setor => cargaPorSetor[setor]);

Â  if (workloadChart) {
Â  Â  workloadChart.destroy();
Â  }

Â  workloadChart = new Chart(ctxEl, {
Â  Â  type: 'bar',Â 
Â  Â  data: {
Â  Â  Â  labels: labels,
Â  Â  Â  datasets: [{
Â  Â  Â  Â  label: 'Minutos Esperados Restantes (P50)', // ATUALIZADO
Â  Â  Â  Â  data: data,
Â  Â  Â  Â  backgroundColor: 'rgba(37, 99, 235, 0.6)', // Azul (SAP Like)
Â  Â  Â  Â  borderColor: 'rgba(37, 99, 235, 1)',Â 
Â  Â  Â  Â  borderWidth: 1
Â  Â  Â  }]
Â  Â  },
Â  Â  options: {
Â  Â  Â  responsive: true,
Â  Â  Â  maintainAspectRatio: false,
Â  Â  Â  indexAxis: 'y',Â 
Â  Â  Â  scales: {
Â  Â  Â  Â  x: {
Â  Â  Â  Â  Â  beginAtZero: true,
Â  Â  Â  Â  Â  title: {
Â  Â  Â  Â  Â  Â  display: true,
Â  Â  Â  Â  Â  Â  text: 'Minutos'
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  },
Â  Â  Â  Â  y: {
Â  Â  Â  Â  Â  grid: {
Â  Â  Â  Â  Â  Â  display: false
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  plugins: {
Â  Â  Â  Â  legend: {
Â  Â  Â  Â  Â  Â display: falseÂ 
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }
Â  });
}


function updateView(view){
Â  if (!currentUser) {
Â  Â  pcpView.classList.add('hidden');
Â  Â  operatorView.classList.add('hidden');Â 
Â  Â  reportView.classList.add('hidden');
Â  Â  adminView.classList.add('hidden');Â 
Â  Â  historicoView.classList.add('hidden');
Â  Â  openUserModal();
Â  Â  return;
Â  }

Â  if (isOperador() && view !== 'Operador'){Â 
Â  Â  view = 'Operador';
Â  }
Â Â 
Â  const adminOption = userViewSelect.querySelector('option[value="Admin"]');
Â  const histOption = userViewSelect.querySelector('option[value="Historico"]');
Â Â 
Â  if (isMaster()) {
Â  Â  if (!adminOption) {
Â  Â  Â  userViewSelect.innerHTML += '<option value="Admin">VisÃ£o: AdministraÃ§Ã£o</option>';
Â  Â  }
Â  Â  if (!histOption) {
Â  Â  Â  const adminOptEl = userViewSelect.querySelector('option[value="Admin"]');
Â  Â  Â  const newHistOpt = document.createElement('option');
Â  Â  Â  newHistOpt.value = 'Historico';
Â  Â  Â  newHistOpt.textContent = 'VisÃ£o: HistÃ³rico';
Â  Â  Â  if (adminOptEl) {
Â  Â  Â  Â  userViewSelect.insertBefore(newHistOpt, adminOptEl);
Â  Â  Â  } else {
Â  Â  Â  Â  Â userViewSelect.appendChild(newHistOpt);
Â  Â  Â  }
Â  Â  }
Â  } else {
Â  Â  if (adminOption) adminOption.remove();
Â  Â  if (histOption) histOption.remove();
Â  }

Â  const isPCP = view === 'PCP';
Â  const isOperadorView = view === 'Operador';
Â  const isReport = view === 'Relatorio';
Â  const isAdmin = view === 'Admin';Â 
Â  const isHistorico = view === 'Historico';

Â  pcpView.classList.toggle('hidden', !isPCP);
Â  operatorView.classList.toggle('hidden', !isOperadorView);
Â  reportView.classList.toggle('hidden', !isReport);
Â  adminView.classList.toggle('hidden', !isAdmin);Â 
Â  historicoView.classList.toggle('hidden', !isHistorico);
Â Â 
Â  userViewSelect.value = view;
Â  userViewSelect.disabled = isOperador();Â 
Â Â 
Â  btnCreateOF.classList.toggle('hidden', !isMaster());
Â  btnProfile.classList.remove('hidden');

Â  const btnExport = document.getElementById('btn-export-report');
Â  const btnDelete = document.getElementById('btn-delete-report');
Â  if(btnExport) btnExport.classList.toggle('hidden', !isMaster());
Â  if(btnDelete) btnDelete.classList.toggle('hidden', !isMaster());

Â  if (isPCP){Â 
Â  Â  renderKPIs();Â 
Â  Â  renderOFs();Â 
Â  Â  renderWorkloadChart();
Â  }
Â  else if (isOperadorView){Â 
Â  Â  renderTasks();
Â  }
Â  else if (isReport){Â 
Â  Â  renderReport();
Â  }
Â  else if (isAdmin) {
Â  Â  renderRoteiros();
Â  }
Â  else if (isHistorico) {
Â  Â  renderHistory();
Â  }

Â  injectSearchInputs();
Â  lucide.createIcons();
}
window.updateView = updateView;

function renderReport(){
Â  const body = document.getElementById('report-table-body');
Â  if (!body) return;
Â Â 
Â  const activeOFIds = Object.keys(allOFs).filter(k => allOFs[k]?.status !== 'ConcluÃ­do');
Â  const activeLogs = allOcurrencesLog.filter(log => activeOFIds.includes(log.OF));

Â  if (activeLogs.length === 0){
Â  Â  body.innerHTML = `<tr><td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500">Nenhuma ocorrÃªncia registrada em OFs ativas.</td></tr>`;
Â  Â  const selectAllCheckbox = document.getElementById('report-select-all');
Â  Â  if (selectAllCheckbox) selectAllCheckbox.checked = false;
Â  Â  updateDeleteButtonState();
Â  Â  return;
Â  }
Â Â 
Â  const html = activeLogs.map(log=>{
Â  Â  const atrasoClass = (log.TEMPO_ATRASO||0) > 0 ? 'highlight-red' : 'text-gray-600';
Â  Â  const pausaClass = (log.TEMPO_PAUSA||0) > 0 ? 'text-yellow-700 font-semibold' : 'text-gray-600';
Â  Â Â 
Â  Â  return `
Â  Â  Â  <tr class="hover:bg-gray-50">
Â  Â  Â  Â  <td class="px-2 sm:px-4 py-2 text-center">
Â  Â  Â  Â  Â  <input type="checkbox" name="report_checkbox" value="${log.id}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â onclick="updateDeleteButtonState()"
Â  Â  Â  Â  Â  Â  Â  Â  Â class="report-item-checkbox rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
Â  Â  Â  Â  </td>
Â  Â  Â  Â  <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${log.OF}</td>
Â  Â  Â  Â  <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-sm text-gray-600">${log.CHICOTE}</td>
Â  Â  Â  Â  <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-sm text-gray-600">${log.ATIVIDADE}</td>
Â  Â  Â  Â  <td class="px-3 sm:px-6 py-2 text-sm text-gray-700">${log.MOTIVO_PAUSA || '-'}</td>
Â  Â  Â  Â  <td class="px-3 sm:px-6 py-2 text-sm text-gray-700">${log.MOTIVO_ATRASO || '-'}</td>
Â  Â  Â  Â  <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-sm ${pausaClass}">${(log.TEMPO_PAUSA||0).toFixed(2)}</td>
Â  Â  Â  Â  <td class="px-3 sm:px-6 py-2 whitespace-nowrap text-sm ${atrasoClass}">${(log.TEMPO_ATRASO||0).toFixed(2)}</td>
Â  Â  Â  </tr>`;
Â  }).join('');
Â  body.innerHTML = html;

Â  const selectAllCheckbox = document.getElementById('report-select-all');
Â  if (selectAllCheckbox) selectAllCheckbox.checked = false;
Â  updateDeleteButtonState();
}

function renderOFs(){
Â  if (pcpView.classList.contains('hidden')) return;
Â Â 
Â  let ofs = Object.values(allOFs).filter(of => of.status !== 'ConcluÃ­do');
Â  if (pcpSearchOF) ofs = ofs.filter(of => (of.id || "").toUpperCase().includes(pcpSearchOF));
Â Â 
Â  const ofsHtml = ofs.map(of=>{
Â  Â  const tasks = Object.values(allTasks).filter(t=> t.id_of === of.id);
Â  Â  const completed = tasks.filter(t => t.status === 'ConcluÃ­do').length;
Â  Â  const nextTask = tasks.find(t=> t.status === 'Em Espera' || t.status === 'Em Processo' || t.status === 'Pausada');

Â  Â  let statusColor = 'bg-gray-100 border-gray-300';
Â  Â  let progress = 0;

Â  Â  if (tasks.length > 0){
Â  Â  Â  progress = Math.floor((completed / tasks.length) * 100);
Â Â 
Â  Â  Â  if (progress === 0) statusColor = 'bg-gray-200 border-gray-400';
Â  Â  Â  else if (progress < 100) statusColor = 'bg-blue-100 border-blue-400';
Â  Â  Â Â 
Â  Â  Â  if (of.priority === 'Alta') {
Â  Â  Â  Â  statusColor = 'bg-red-100 border-red-500';
Â  Â  Â  } else {
Â  Â  Â  Â  Â const anyTaskDelayed = tasks.some(t => calculateDesvio(t) < -5);
Â  Â  Â  Â  Â if (anyTaskDelayed) statusColor = 'bg-yellow-100 border-yellow-500';
Â  Â  Â  }
Â  Â  }

Â  Â  // ============================
Â  Â  // OF CARD
Â  Â  // ============================
Â  Â  return `
Â  Â  Â  <div class="${statusColor} p-4 rounded-xl border border-gray-300 ${statusColor.replace('bg-', 'border-')}"
Â  Â  Â  Â  Â  Â onclick="openOFDetails('${of.id}')">
Â  Â  Â  Â  <h3 class="text-lg font-bold text-gray-800 mb-1 flex justify-between items-center">
Â  Â  Â  Â  Â  ${of.id}
Â  Â  Â  Â  Â  ${of.status === 'ConcluÃ­do' ? '<i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>' : (nextTask ? '<i data-lucide="play-circle" class="w-5 h-5 text-blue-600"></i>' : '<i data-lucide="pause-circle" class="w-5 h-5 text-yellow-600"></i>')}
Â  Â  Â  Â  </h3>
Â  Â  Â  Â  <p class="text-sm text-gray-600 mb-3">${of.chicote} | Qtd: ${of.quantidade}</p>

Â  Â  Â  Â  <div class="flex justify-between items-center mb-1">
Â  Â  Â  Â  Â  <span class="text-xs font-semibold text-gray-600">${progress}% ConcluÃ­do</span>
Â  Â  Â  Â  Â  <span class="text-xs font-medium text-gray-500">${completed} / ${tasks.length} etapas</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="w-full bg-gray-200 rounded-full h-1.5">
Â  Â  Â  Â  Â  <div class="h-1.5 rounded-full bg-blue-500" style="width:${progress}%"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <p class="text-xs mt-2 text-gray-700 font-medium">PrÃ³xima Etapa: ${nextTask ? nextTask.nome_atividade : (of.status === 'ConcluÃ­do' ? 'Finalizada' : 'N/A')}</p>
Â  Â  Â  </div>
Â  Â  `;
Â  }).join('');

Â  ofsListContainer.innerHTML = ofsHtml.length > 0 ? ofsHtml : '<div class="col-span-3 p-6 text-center text-gray-500 bg-white rounded-xl border border-gray-300">Nenhuma OF ativa.</div>';
Â  lucide.createIcons();
}

function renderTasks(){
Â  if (operatorView.classList.contains('hidden')) return;

Â  const tasks = Object.values(allTasks)
Â  Â  .filter(t =>
Â  Â  Â  t.setor === currentSectorFilter &&
Â  Â  Â  (t.status === 'Em Espera' || t.status === 'Em Processo' || t.status === 'Pausada') &&
Â  Â  Â  (!operatorSearchOF || (t.id_of || "").toUpperCase().includes(operatorSearchOF))
Â  Â  )
Â  Â  .sort((a,b) => {
Â  Â  Â  const priorityA = a.priority === 'Alta' ? 1 : (a.priority === 'Media' ? 2 : 3);
Â  Â  Â  const priorityB = b.priority === 'Alta' ? 1 : (b.priority === 'Media' ? 2 : 3);
Â  Â  Â  if (priorityA !== priorityB) return priorityA - priorityB;
Â  Â  Â  if (a.status === 'Em Processo') return -1;
Â  Â  Â  if (b.status === 'Em Processo') return 1;
Â  Â  Â  return a.ordem - b.ordem;
Â  Â  });
Â  Â Â 
Â  const tasksHtml = tasks.map(task=>{
Â  Â  const tempoReal = calculateTempoRealMinutes(task);Â 
Â  Â  const desvio = calculateDesvio(task);
Â  Â  const totalPauseMinutes = calculateTotalPauseMinutes(task);

Â  Â  let statusText = task.status;
Â  Â  let actions = '';
Â  Â Â 
Â  Â  // ============================
Â  Â  // TASK BUTTONS
Â  Â  // ============================
Â  Â  if (task.status === 'Em Espera'){
Â  Â  Â  statusText = 'Aguardando InÃ­cio';
Â  Â  Â  actions = `<button onclick="startTask('${task.id}')" class="px-3 py-1.5 text-sm bg-gray-700 text-white rounded-lg hover:bg-gray-600">Iniciar</button>`;
Â  Â  } else if (task.status === 'Em Processo'){
Â  Â  Â  statusText = 'Em Processo';
Â  Â  Â  actions = `
Â  Â  Â  Â  <button onclick="pauseTask('${task.id}')" class="px-3 py-1.5 text-sm bg-amber-500 text-white rounded-lg hover:bg-amber-600">Pausar</button>
Â  Â  Â  Â  <button onclick="finishTask('${task.id}')" class="px-3 py-1.5 text-sm bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">Concluir</button>`;
Â  Â  } else if (task.status === 'Pausada'){
Â  Â  Â  statusText = 'Pausada';
Â  Â  Â  actions = `
Â  Â  Â  Â  <button onclick="startTask('${task.id}')" class="px-3 py-1.5 text-sm bg-gray-700 text-white rounded-lg hover:bg-gray-600">Retomar</button>
Â  Â  Â  Â  <button onclick="finishTask('${task.id}')" class="px-3 py-1.5 text-sm bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">Concluir</button>`;
Â  Â  }

Â  Â  const priorityClass = getPriorityClass(task.priority);
Â  Â Â 
Â  Â  // ============================
Â  Â  // TASK CARD
Â  Â  // ============================
Â  Â  return `
Â  Â  Â  <div class="${priorityClass} border border-gray-300 p-3 sm:p-4 rounded-xl">
Â  Â  Â  Â  <div class="flex justify-between items-center mb-2">
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <p class="text-sm font-bold text-gray-800">${task.nome_atividade}</p>
Â  Â  Â  Â  Â  Â  <p class="text-xs text-gray-600">OF <span class="font-semibold">${task.id_of}</span> â€¢ Setor ${task.setor}</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <button class="p-2 rounded-lg hover:bg-gray-100" title="InstruÃ§Ã£o de Trabalho" onclick="openInstructionModal('${task.id}')">
Â  Â  Â  Â  Â  Â  <i data-lucide="book" class="w-5 h-5"></i>
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs sm:text-sm">
Â  Â  Â  Â  Â  <div><span class="text-gray-500">Setup:</span> <span class="font-semibold">${formatMinutes(task.tempo_setup)}</span></div>
Â  Â  Â  Â  Â  <div><span class="text-gray-500">Ciclo (min/pÃ§):</span> <span class="font-semibold">${Number(task.tempo_ciclo).toFixed(2)}</span></div>
Â  Â  Â  Â  Â  <div><span class="text-gray-500">Esperado (P50):</span> <span class="font-semibold">${formatMinutes(task.tempo_planejado)}</span></div>
Â  Â  Â  Â  Â  <div><span class="text-gray-500">Pausa:</span> <span class="font-semibold">${formatMinutes(totalPauseMinutes)}</span></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="mt-2 flex justify-between items-center">
Â  Â  Â  Â  Â  <span class="text-xs font-semibold ${desvio < 0 ? 'text-red-600' : 'text-gray-700'}">Desvio (vs P50): ${desvio < 0 ? '-' : ''}${formatMinutes(Math.abs(desvio))}</span>
Â  Â  Â  Â  Â  <span class="text-xs font-medium text-gray-600">${statusText}</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="mt-3 flex gap-2">${actions}</div>
Â  Â  Â  </div>
Â  Â  `;
Â  }).join('');

Â  tasksListContainer.innerHTML = tasksHtml.length > 0 ? tasksHtml : '<div class="p-6 text-center text-gray-500 bg-white rounded-xl border border-gray-300">Sem tarefas para este setor/OF.</div>';
Â  lucide.createIcons();
}

function renderHistory() {
Â  Â  if (historicoView.classList.contains('hidden')) return;

Â  Â  let historyOFs = Object.values(allOFs).filter(of => of.status === 'ConcluÃ­do');
Â  Â Â 
Â  Â  if (historicoSearchOF) historyOFs = historyOFs.filter(of => (of.id || "").toUpperCase().includes(historicoSearchOF));
Â  Â Â 
Â  Â  historyOFs.sort((a, b) => {
Â  Â  Â  Â  const dateA = getDBTimestamp(a.data_criacao);Â 
Â  Â  Â  Â  const dateB = getDBTimestamp(b.data_criacao);
Â  Â  Â  Â  return dateB - dateA;
Â  Â  });

Â  Â  // ============================
Â  Â  // HISTORY CARD
Â  Â  // ============================
Â  Â  const historyHtml = historyOFs.map(of => {
Â  Â  Â  Â  const tasks = Object.values(allTasks).filter(t => t.id_of === of.id);
Â  Â  Â  Â  const totalTempoReal = tasks.reduce((sum, t) => sum + calculateTempoRealMinutes(t), 0);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ATUALIZADO: Usa os tempos P50 e P95 salvos na OF
Â  Â  Â  Â  const totalTempoEsperado = of.tempo_esperado_total_min || tasks.reduce((sum, t) => sum + (t.tempo_planejado || 0), 0); // Fallback para OFs antigas
Â  Â  Â  Â  const totalTempoConfiavel = of.tempo_confiavel_total_min || 0;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const desvioVsEsperado = totalTempoEsperado - totalTempoReal;
Â  Â  Â  Â  const desvioClass = desvioVsEsperado < 0 ? 'text-red-600' : 'text-green-600';
Â  Â  Â  Â  const desvioText = desvioVsEsperado < 0 ? `-${formatMinutes(Math.abs(desvioVsEsperado))}` : `+${formatMinutes(desvioVsEsperado)}`;

Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  <div class="of-concluida-card p-4 rounded-xl border border-gray-300"
Â  Â  Â  Â  Â  Â  Â  Â  Â onclick="openOFDetails('${of.id}', true)">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-bold text-gray-800 mb-1 flex justify-between items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${of.id}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
Â  Â  Â  Â  Â  Â  Â  Â  </h3>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-600 mb-2">${of.chicote} | Qtd: ${of.quantidade}</p>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-1 text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-700">Criado em: <span class="font-semibold">${formatDate(of.data_criacao)}</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-700">Tempo Real: <span class="font-semibold">${formatMinutes(totalTempoReal)}</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-700">T. Esperado (P50): <span class="font-semibold">${formatMinutes(totalTempoEsperado)}</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-700">T. ConfiÃ¡vel (P95): <span class="font-semibold">${totalTempoConfiavel > 0 ? formatMinutes(totalTempoConfiavel) : 'N/A'}</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold ${desvioClass}">Desvio (vs P50): ${desvioText}</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  }).join('');

Â  Â  const container = document.getElementById('historico-list-container');
Â  Â  container.innerHTML = historyHtml.length >
