<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>PCP – Controle de Produção (Chicotes)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Estilização personalizada para o background e sombra */
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
            border-radius: 0.75rem; /* rounded-xl */
        }
        .animated-entry {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cores de status aprimoradas */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.875rem;
        }
        .status-badge-pending { background-color: #e0f2fe; color: #0284c7; } /* Blue Light (Pendente/Aguardando) */
        .status-badge-progress { background-color: #fef3c7; color: #d97706; } /* Yellow/Orange (Em Progresso) */
        .status-badge-complete { background-color: #d1fae5; color: #059669; } /* Green (Concluído) */
        
        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
        }

    </style>
</head>
<body class="min-h-screen bg-gray-50 antialiased font-sans">
    
    <!-- Header (Controles ocultos por padrão, visíveis após login) -->
    <header class="bg-white border-b sticky top-0 z-30 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
            <h1 class="text-xl sm:text-3xl font-extrabold text-gray-800 tracking-tight">PCP – <span class="text-blue-700">Chicotes</span></h1>
            
            <!-- Controles do Header - Ocultos até o login -->
            <div id="header-controls" class="ml-auto flex items-center gap-3 hidden transition duration-300">
                <select id="user-view-select" class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm bg-gray-50 shadow-inner focus:ring-blue-500 focus:border-blue-500">
                    <option value="PCP">Visão PCP</option>
                    <option value="Operador">Visão Operador</option>
                    <option value="Relatórios">Relatórios</option>
                </select>
                <div id="user-profile" class="flex items-center gap-2 bg-blue-50 p-2 rounded-full cursor-pointer hover:bg-blue-100 transition">
                    <button id="btn-profile" class="text-blue-700 w-8 h-8 flex items-center justify-center bg-blue-200 rounded-full">
                        <i data-lucide="user" class="w-5 h-5"></i>
                    </button>
                    <span id="user-id-display" class="text-sm font-medium text-blue-800 truncate max-w-[120px]">Carregando...</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">

        <!-- Indicador de Carregamento -->
        <div id="loading-indicator" class="fixed inset-0 bg-gray-50/90 backdrop-blur-sm z-50 flex flex-col items-center justify-center">
            <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="mt-3 text-lg font-medium text-gray-700">Iniciando sistema e autenticando...</span>
        </div>

        <!-- Tela de Login (Aparece após a autenticação inicial do Firebase) -->
        <div id="login-view" class="hidden flex flex-col items-center justify-center min-h-[70vh] animated-entry">
            <div class="bg-white p-8 sm:p-10 card-shadow max-w-lg w-full text-center border-t-4 border-blue-600">
                <i data-lucide="shield-check" class="w-12 h-12 mx-auto mb-4 text-blue-600"></i>
                <h2 class="text-3xl font-extrabold text-gray-800 mb-2">Entrar no Sistema PCP</h2>
                <p class="text-sm text-gray-600 mb-6">ID de Sessão: <span id="auth-id-display" class="font-mono bg-gray-100 text-gray-800 px-2 py-0.5 rounded text-xs break-all">...</span></p>

                <div id="login-message" class="hidden text-left mb-4"></div>

                <div class="space-y-6">
                    <!-- Seletor de Perfil Aprimorado -->
                    <div class="flex space-x-4 bg-gray-100 p-2 rounded-xl">
                        <label class="flex-1">
                            <input type="radio" name="role-select" value="PCP" checked class="hidden" id="radio-pcp">
                            <div class="py-2 px-4 rounded-lg cursor-pointer text-center font-semibold text-gray-700 transition hover:bg-white border-2 border-transparent" id="label-pcp-master">
                                <i data-lucide="monitor" class="w-5 h-5 inline-block mr-2"></i> PCP Master
                            </div>
                        </label>
                        <label class="flex-1">
                            <input type="radio" name="role-select" value="Operador" class="hidden" id="radio-operator">
                            <div class="py-2 px-4 rounded-lg cursor-pointer text-center font-semibold text-gray-700 transition hover:bg-white border-2 border-transparent" id="label-operator">
                                <i data-lucide="plug-zap" class="w-5 h-5 inline-block mr-2"></i> Operador
                            </div>
                        </label>
                    </div>

                    <!-- Formulário de Login (Conteúdo Dinâmico) -->
                    <div id="login-form-pcp" class="space-y-4 text-left">
                        <p class="text-sm text-gray-500">Acesso total ao Painel de Controle. (Senha: **admin123**)</p>
                        <input type="password" id="pcp-password-input" placeholder="Digite a Senha Master" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <button id="btn-login" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition transform hover:scale-[1.005] shadow-lg shadow-blue-500/50">
                            <i data-lucide="lock" class="w-5 h-5 inline-block mr-2"></i> Entrar como PCP
                        </button>
                    </div>

                    <div id="login-form-operator" class="space-y-4 text-left hidden">
                        <p class="text-sm text-gray-500">Visualização de tarefas de produção e registro de tempo.</p>
                        <select id="operator-sector-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 bg-white">
                            <option value="">-- Selecione o Setor --</option>
                            <option value="Corte">Corte e Descasque</option>
                            <option value="Montagem">Montagem e Prensagem</option>
                            <option value="Teste">Teste e Acabamento</option>
                            <option value="Embalagem">Embalagem</option>
                        </select>
                        <button id="btn-login-operator-start" class="w-full bg-yellow-500 text-gray-900 font-bold py-3 rounded-xl hover:bg-yellow-600 transition transform hover:scale-[1.005] shadow-lg shadow-yellow-500/50">
                            <i data-lucide="wrench" class="w-5 h-5 inline-block mr-2"></i> Iniciar Produção
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conteúdo Principal do Aplicativo (Oculto no início) -->
        <div id="app-content" class="hidden">
            <!-- Visão PCP -->
            <div id="pcp-view" class="space-y-8 animated-entry">
                <div class="flex flex-wrap gap-4 justify-between items-start">
                    <h2 class="text-3xl font-bold text-gray-800">Painel de Controle da Produção</h2>
                    <div class="flex gap-3">
                        <button id="btn-export-report" class="bg-gray-100 text-gray-700 hover:bg-gray-200 transition px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 border border-gray-300">
                            <i data-lucide="file-text" class="w-4 h-4"></i> Exportar Relatório
                        </button>
                        <button id="btn-setup-roteiro" class="bg-blue-50 text-blue-700 hover:bg-blue-100 transition px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 border border-blue-300">
                            <i data-lucide="settings" class="w-4 h-4"></i> Configurar Roteiro
                        </button>
                        <button id="btn-create-of" class="bg-blue-600 text-white hover:bg-blue-700 transition px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 shadow-md shadow-blue-500/50">
                            <i data-lucide="plus" class="w-4 h-4"></i> Criar OF
                        </button>
                    </div>
                </div>

                <!-- KPIs -->
                <div id="kpis-container" class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    <!-- KPI Total de OFs -->
                    <div class="bg-white p-6 card-shadow border-l-4 border-blue-600">
                        <p class="text-sm font-medium text-gray-500">Total de OFs</p>
                        <p id="kpi-total-ofs" class="mt-1 text-4xl font-extrabold text-gray-900">0</p>
                    </div>
                    <!-- KPI Em Progresso -->
                    <div class="bg-white p-6 card-shadow border-l-4 border-yellow-500">
                        <p class="text-sm font-medium text-gray-500">Em Progresso</p>
                        <p id="kpi-in-progress" class="mt-1 text-4xl font-extrabold text-yellow-600">0</p>
                    </div>
                    <!-- KPI Concluídas (Hoje) -->
                    <div class="bg-white p-6 card-shadow border-l-4 border-green-600">
                        <p class="text-sm font-medium text-gray-500">Concluídas (Hoje)</p>
                        <p id="kpi-completed-today" class="mt-1 text-4xl font-extrabold text-green-600">0</p>
                    </div>
                </div>

                <!-- Lista de Ordens de Fabricação (OFs) -->
                <div class="space-y-4">
                    <h3 class="text-2xl font-semibold text-gray-800 border-b pb-2">Ordens de Fabricação (OFs)</h3>
                    <div id="ofs-list-container" class="space-y-3">
                        <div class="p-6 text-center text-sm text-gray-500 bg-white card-shadow">Carregando dados...</div>
                    </div>
                </div>
            </div>

            <!-- Visão Operador -->
            <div id="operator-view" class="hidden space-y-6 animated-entry">
                <h2 class="text-3xl font-bold text-gray-800">Minhas Tarefas de Produção</h2>
                <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-300">
                    <p class="text-gray-700">Setor Ativo: <span id="operator-sector-display" class="font-mono bg-yellow-200 text-yellow-800 px-2 py-0.5 rounded text-sm font-semibold">N/A</span>. Visualizando tarefas para o ID: <span id="operator-user-id" class="font-mono bg-gray-200 text-gray-800 px-2 py-0.5 rounded text-sm"></span></p>
                </div>

                <div class="space-y-4">
                    <h3 class="text-2xl font-semibold text-gray-800 border-b pb-2">Tarefas Atuais</h3>
                    <div id="tasks-list-container" class="space-y-3">
                        <div class="p-6 text-center text-sm text-gray-500 bg-white card-shadow">Buscando tarefas para o operador...</div>
                    </div>
                </div>
            </div>

            <!-- Visão Relatórios -->
            <div id="reports-view" class="hidden space-y-6 animated-entry">
                <h2 class="text-3xl font-bold text-gray-800">Relatórios e Análise de Produção</h2>
                <div class="bg-white p-6 rounded-xl shadow border-l-4 border-gray-400">
                    <p class="text-gray-600">Aqui você pode gerar relatórios detalhados de produção, eficiência e utilização de recursos.</p>
                    <p class="mt-2 text-sm text-gray-500">Funcionalidade pendente de implementação.</p>
                </div>
            </div>
        </div>

    </main>
    
    <!-- Modais -->

    <!-- Modal Base (Global) - Para Alertas/Confirmações (Substitui alert/confirm) -->
    <div id="global-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4" onclick="if(event.target.id === 'global-modal') hideModal('global-modal')">
        <div id="modal-content-container" class="bg-white p-6 rounded-xl card-shadow max-w-lg w-full transform transition-all duration-300 scale-100">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-900 border-b pb-2"></h3>
            <p id="modal-body" class="text-gray-600 mb-6"></p>
            <div id="modal-footer" class="flex justify-end space-x-3 mt-4">
                <button type="button" id="modal-btn-cancel" class="bg-gray-300 text-gray-800 hover:bg-gray-400 font-semibold px-4 py-2 rounded-lg transition">Cancelar</button>
                <button type="button" id="modal-btn-confirm" class="bg-blue-600 text-white hover:bg-blue-700 font-semibold px-4 py-2 rounded-lg transition">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Configuração de Roteiro Padrão -->
    <div id="setup-roteiro-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4" onclick="if(event.target.id === 'setup-roteiro-modal') hideModal('setup-roteiro-modal')">
        <div class="bg-white p-6 rounded-xl card-shadow max-w-xl w-full">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center gap-2">
                <i data-lucide="settings" class="w-6 h-6 text-blue-600"></i> Configurar Roteiro Padrão
            </h3>
            
            <p class="text-sm text-gray-600 mb-4">Defina a sequência padrão de etapas para a fabricação dos chicotes.</p>

            <div id="roteiro-steps-container" class="space-y-3 p-4 bg-gray-50 rounded-lg border">
                <!-- Etapas do roteiro serão injetadas/manipuladas via JS -->
            </div>
            
            <button id="btn-add-step" class="mt-4 bg-gray-200 text-gray-700 hover:bg-gray-300 transition px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                <i data-lucide="plus" class="w-4 h-4"></i> Adicionar Etapa
            </button>

            <div id="roteiro-message" class="mt-4 text-sm hidden"></div>

            <div class="flex justify-end gap-3 mt-6">
                <button type="button" onclick="hideModal('setup-roteiro-modal')" class="bg-gray-300 text-gray-800 hover:bg-gray-400 font-semibold px-4 py-2 rounded-lg transition">Cancelar</button>
                <button type="button" id="btn-save-roteiro" class="bg-blue-600 text-white hover:bg-blue-700 font-semibold px-4 py-2 rounded-lg transition">Salvar Roteiro</button>
            </div>
        </div>
    </div>

    <!-- Modal de Criação de OF (Ordem de Fabricação) -->
    <div id="create-of-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4" onclick="if(event.target.id === 'create-of-modal') hideModal('create-of-modal')">
        <div class="bg-white p-6 rounded-xl card-shadow max-w-xl w-full">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center gap-2">
                <i data-lucide="file-plus" class="w-6 h-6 text-green-600"></i> Criar Nova Ordem de Fabricação (OF)
            </h3>
            <form id="form-create-of" class="space-y-4">
                <div>
                    <label for="of-product-code" class="block text-sm font-medium text-gray-700">Código do Produto / Projeto</label>
                    <input type="text" id="of-product-code" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="of-product-name" class="block text-sm font-medium text-gray-700">Nome / Descrição do Produto</label>
                    <input type="text" id="of-product-name" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="of-quantity" class="block text-sm font-medium text-gray-700">Quantidade</label>
                        <input type="number" id="of-quantity" required min="1" value="1" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="of-priority" class="block text-sm font-medium text-gray-700">Prioridade</label>
                        <select id="of-priority" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white">
                            <option value="Média">Média</option>
                            <option value="Alta">Alta</option>
                            <option value="Baixa">Baixa</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="of-roteiro-select" class="block text-sm font-medium text-gray-700">Roteiro de Produção</label>
                    <select id="of-roteiro-select" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white">
                        <option value="default">Padrão</option>
                        <!-- Opções dinâmicas do roteiro seriam carregadas aqui se houvesse múltiplos roteiros -->
                    </select>
                    <p id="roteiro-steps-summary" class="text-xs text-gray-500 mt-1">Etapas: Corte e Descasque, Montagem, Teste e Acabamento.</p>
                </div>
                
                <div id="of-message" class="text-sm hidden"></div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="hideModal('create-of-modal')" class="bg-gray-300 text-gray-800 hover:bg-gray-400 font-semibold px-4 py-2 rounded-lg transition">Cancelar</button>
                    <button type="submit" class="bg-green-600 text-white hover:bg-green-700 font-bold px-4 py-2 rounded-lg transition flex items-center gap-2">
                        <i data-lucide="send" class="w-5 h-5"></i> Gerar OF
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // --- 1. IMPORTAÇÕES FIREBASE (v11.6.1) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            onSnapshot, 
            query, 
            setLogLevel,
            where,
            doc,
            getDoc,
            setDoc,
            addDoc,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 2. VARIÁVEIS GLOBAIS ---
        let app, db, auth;
        let userId = '';
        let userRole = '';
        let userSector = ''; 
        let isAuthReady = false; 
        
        // Roteiro Padrão Inicial (Será carregado do Firestore)
        let defaultRoteiro = [
            { sector: "Corte", name: "Corte e Descasque" },
            { sector: "Montagem", name: "Montagem e Prensagem" },
            { sector: "Teste", name: "Teste e Acabamento" }
        ];

        // Variável de Ambiente (simplesmente para demonstração e teste de restrição)
        const PCP_MASTER_PASSWORD = "admin123"; 

        // Elementos DOM (Usados para evitar múltiplas buscas)
        let loginView, appContent, pcpView, operatorView, reportsView, loadingIndicator, ofsListContainer, tasksListContainer, userViewSelect, btnCreateOF, btnSetupRoteiro, btnProfile, userIdDisplay, operatorUserId, authIdDisplay, headerControls, operatorSectorSelect, pcpPasswordInput, btnLoginPCP, btnLoginOperatorStart, loginMessage, operatorSectorDisplay;
        let radioPCP, radioOperator, loginFormPCP, loginFormOperator, labelPCPMaster, labelOperator;
        let roteiroStepsContainer, btnAddStep, btnSaveRoteiro, roteiroMessage, roteiroStepsSummary;
        let formCreateOF, ofMessage;
        let modalGlobal, modalTitle, modalBody, modalFooter, modalBtnCancel, modalBtnConfirm;

        // Variáveis Globais de Ambiente (MANDATÓRIO usar)
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';


        // --- 3. FUNÇÕES DE UI E MODAIS ---
        
        function showMessage(element, message, type = 'info') {
            element.textContent = message;
            element.className = `p-3 rounded-lg text-sm mt-2 transition duration-300 animated-entry ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            element.classList.remove('hidden');
        }

        function hideMessage(element) {
            element.classList.add('hidden');
        }
        
        // Modal genérico para substituir alert/confirm
        function customAlert(title, message, type = 'info', onConfirm = null) {
            modalTitle.textContent = title;
            modalBody.textContent = message;
            
            modalBtnCancel.classList.add('hidden');
            modalBtnConfirm.textContent = 'Ok';
            modalBtnConfirm.onclick = () => hideModal('global-modal');
            
            if (onConfirm) {
                modalBtnCancel.classList.remove('hidden');
                modalBtnConfirm.textContent = 'Confirmar';
                modalBtnConfirm.onclick = () => { onConfirm(); hideModal('global-modal'); };
            }

            modalGlobal.classList.remove('hidden');
            modalGlobal.classList.add('flex');
            lucide.createIcons();
        }

        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
            // Reset message elements
            if (roteiroMessage) hideMessage(roteiroMessage);
            if (ofMessage) hideMessage(ofMessage);
        }

        function toggleLoginForm() {
            const isPCP = radioPCP.checked;
            
            loginFormPCP.classList.toggle('hidden', !isPCP);
            loginFormOperator.classList.toggle('hidden', isPCP);

            // Estilos do seletor
            labelPCPMaster.classList.toggle('bg-white', isPCP);
            labelPCPMaster.classList.toggle('shadow-md', isPCP);
            labelPCPMaster.classList.toggle('border-blue-500', isPCP);
            labelPCPMaster.classList.toggle('text-blue-700', isPCP);
            
            labelOperator.classList.toggle('bg-white', !isPCP);
            labelOperator.classList.toggle('shadow-md', !isPCP);
            labelOperator.classList.toggle('border-yellow-500', !isPCP);
            labelOperator.classList.toggle('text-yellow-700', !isPCP);
            
            // Reset messages/inputs on form switch
            hideMessage(loginMessage);
            pcpPasswordInput.value = '';
            lucide.createIcons();
        }


        // --- 4. CONFIGURAÇÃO E AUTENTICAÇÃO FIREBASE ---

        async function initializeFirebase() {
            console.log("Iniciando Firebase...");
            loadingIndicator.classList.remove('hidden');

            try {
                // Inicializa App, Auth e Firestore
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug'); 

                // Tenta autenticar com token customizado (Canvas) ou Anonimamente
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // Listener para o estado de autenticação
                onAuthStateChanged(auth, (user) => {
                    loadingIndicator.classList.add('hidden'); 

                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId.substring(0, 8) + '...';
                        authIdDisplay.textContent = userId;
                    } else {
                        // Deve sempre haver um user (anônimo ou token)
                        userId = crypto.randomUUID(); 
                        userIdDisplay.textContent = 'Anônimo';
                        authIdDisplay.textContent = userId;
                    }

                    isAuthReady = true;
                    // Mostra a tela de login para escolha de função
                    loginView.classList.remove('hidden');
                    console.log("Firebase e Autenticação prontos. ID:", userId);
                    loadRoteiroConfig(); // Carrega roteiro padrão para o modal de criação de OF
                });
                
            } catch (error) {
                console.error("Erro fatal durante a inicialização/autenticação do Firebase:", error);
                customAlert('Erro Fatal', `Não foi possível conectar ao Firebase. Verifique as credenciais. Erro: ${error.message}`, 'error');
                loadingIndicator.classList.add('hidden');
            }
        }
        
        // --- 5. LÓGICA DE LOGIN E NAVEGAÇÃO PRINCIPAL ---
        
        function handleLogin() {
            const isPCP = radioPCP.checked;

            if (isPCP) {
                const password = pcpPasswordInput.value;
                if (password === PCP_MASTER_PASSWORD) {
                    userRole = 'PCP';
                    userSector = '';
                    proceedToApp('PCP');
                    showMessage(loginMessage, 'Login PCP Master realizado com sucesso!', 'success');
                } else {
                    showMessage(loginMessage, 'Senha Master incorreta. (Dica: admin123)', 'error');
                }
            } else { // Operador
                const sector = operatorSectorSelect.value;
                if (sector && sector !== '') {
                    userRole = 'Operador';
                    userSector = sector;
                    operatorSectorDisplay.textContent = userSector;
                    proceedToApp('Operador');
                    showMessage(loginMessage, `Login Operador no Setor ${userSector} realizado com sucesso!`, 'success');
                } else {
                    showMessage(loginMessage, 'Selecione um Setor para continuar.', 'error');
                }
            }
        }

        function proceedToApp(view) {
            loginView.classList.add('hidden');
            appContent.classList.remove('hidden');
            headerControls.classList.remove('hidden');
            userViewSelect.value = view; 
            updateView(view);
        }

        function updateView(view) {
            pcpView.classList.add('hidden');
            operatorView.classList.add('hidden');
            reportsView.classList.add('hidden');

            // Garante que o usuário tem permissão para a view (simples checagem)
            if (view === 'Operador' && userRole === 'PCP') view = 'PCP';
            if (view === 'Relatórios' && userRole === 'Operador') view = 'Operador';
            
            switch (view) {
                case 'PCP':
                    pcpView.classList.remove('hidden');
                    if (isAuthReady) {
                        renderOFs(); 
                        renderKPIs();
                    }
                    break;
                case 'Operador':
                    operatorView.classList.remove('hidden');
                    if (isAuthReady) {
                        renderTasks(); 
                    }
                    break;
                case 'Relatórios':
                    reportsView.classList.remove('hidden');
                    break;
            }
            lucide.createIcons();
        }
        
        // --- 6. LÓGICA DE DADOS (FIRESTORE) ---

        // Função de Ação: Edição/Gerenciamento de OF
        window.editOF = function(ofId) { 
            customAlert('Gerenciar OF', `Abrindo painel para gerenciar as etapas da OF #${ofId.substring(0, 8)}. Funcionalidade em desenvolvimento.`, 'info'); 
            console.log('Editar OF:', ofId); 
        }

        // Função de Ação: Iniciar/Pausar Tarefa
        window.startTask = function(ofId, stepId) { 
            customAlert('Controle de Tempo', `Iniciando/Pausando Tarefa ${stepId} da OF #${ofId.substring(0, 8)}. Lógica de cronometragem deve ser implementada no Firestore.`, 'info');
            console.log('Iniciar/Pausar Tarefa:', ofId, stepId); 
        }

        // --- Roteiro ---

        function renderRoteiroSteps(steps = defaultRoteiro) {
            roteiroStepsContainer.innerHTML = '';
            steps.forEach((step, index) => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-3 bg-white p-3 rounded-lg border border-blue-200 shadow-sm";
                div.innerHTML = `
                    <span class="font-bold text-blue-600">${index + 1}</span>
                    <input type="text" value="${step.name}" placeholder="Nome da Etapa" class="flex-1 p-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500" data-index="${index}" data-type="name" required>
                    <select class="w-28 p-2 border rounded-lg bg-gray-50 text-sm" data-index="${index}" data-type="sector">
                        <option value="Corte" ${step.sector === 'Corte' ? 'selected' : ''}>Corte</option>
                        <option value="Montagem" ${step.sector === 'Montagem' ? 'selected' : ''}>Montagem</option>
                        <option value="Teste" ${step.sector === 'Teste' ? 'selected' : ''}>Teste</option>
                        <option value="Embalagem" ${step.sector === 'Embalagem' ? 'selected' : ''}>Embalagem</option>
                        <option value="Outro" ${!['Corte', 'Montagem', 'Teste', 'Embalagem'].includes(step.sector) ? 'selected' : ''}>Outro</option>
                    </select>
                    <button type="button" class="text-red-500 hover:text-red-700 p-1" onclick="removeRoteiroStep(this)">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                `;
                roteiroStepsContainer.appendChild(div);
            });
            lucide.createIcons();
            // Atualiza o resumo do roteiro na criação de OF
            const stepNames = steps.map(s => s.name);
            roteiroStepsSummary.textContent = `Etapas: ${stepNames.join(', ')}.`;
        }
        
        window.removeRoteiroStep = function(button) {
            button.closest('div').remove();
            // Recria a lista de roteiro para reindexar e renderizar
            const currentSteps = Array.from(roteiroStepsContainer.querySelectorAll('input[data-type="name"]')).map((input, index) => ({
                sector: roteiroStepsContainer.querySelector(`select[data-index="${index}"]`).value,
                name: input.value
            }));
            renderRoteiroSteps(currentSteps);
        }

        function addRoteiroStep() {
            const steps = Array.from(roteiroStepsContainer.querySelectorAll('input[data-type="name"]')).map((input, index) => ({
                sector: roteiroStepsContainer.querySelector(`select[data-index="${index}"]`).value,
                name: input.value
            }));
            
            steps.push({ sector: "Outro", name: `Nova Etapa ${steps.length + 1}` });
            renderRoteiroSteps(steps);
        }

        async function loadRoteiroConfig() {
            if (!isAuthReady || !db) return;

            const docRef = doc(db, `artifacts/${appId}/public/data/config`, 'roteiro_padrao');
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    defaultRoteiro = docSnap.data().steps || defaultRoteiro;
                }
                renderRoteiroSteps(defaultRoteiro);
            } catch (e) {
                console.error("Erro ao carregar roteiro padrão:", e);
                renderRoteiroSteps(defaultRoteiro); 
            }
        }
        
        async function saveRoteiro(e) {
            e.preventDefault();
            const inputs = roteiroStepsContainer.querySelectorAll('input[data-type="name"]');
            const selects = roteiroStepsContainer.querySelectorAll('select[data-type="sector"]');
            const newRoteiro = [];
            
            inputs.forEach((input, index) => {
                newRoteiro.push({
                    sector: selects[index].value || 'Outro',
                    name: input.value.trim()
                });
            });

            if (newRoteiro.some(step => step.name === '')) {
                showMessage(roteiroMessage, 'Todas as etapas devem ter um nome.', 'error');
                return;
            }

            const docRef = doc(db, `artifacts/${appId}/public/data/config`, 'roteiro_padrao');
            try {
                await setDoc(docRef, { steps: newRoteiro, lastUpdated: new Date().toISOString() });
                defaultRoteiro = newRoteiro; // Atualiza variável local
                showMessage(roteiroMessage, 'Roteiro padrão salvo com sucesso!', 'success');
                setTimeout(() => hideModal('setup-roteiro-modal'), 1500);

            } catch (e) {
                console.error("Erro ao salvar roteiro:", e);
                showMessage(roteiroMessage, 'Erro ao salvar roteiro no Firestore.', 'error');
            }
        }

        // --- Criação de OF ---

        async function createOFInFirestore(e) {
            e.preventDefault();
            
            const productCode = document.getElementById('of-product-code').value.trim();
            const productName = document.getElementById('of-product-name').value.trim();
            const quantity = parseInt(document.getElementById('of-quantity').value, 10);
            const priority = document.getElementById('of-priority').value;
            
            if (!productCode || !productName || quantity < 1) {
                showMessage(ofMessage, 'Preencha todos os campos obrigatórios.', 'error');
                return;
            }

            // Cria as tarefas iniciais baseadas no roteiro Padrão
            const initialTasks = defaultRoteiro.map((step, index) => ({
                stepId: index + 1,
                stepName: step.name,
                sector: step.sector,
                status: index === 0 ? 'Pendente' : 'Aguardando', 
                timeElapsed: 0,
                currentOperatorId: '',
                startTime: null,
                endTime: null,
                isActive: false
            }));

            const newOF = {
                productCode,
                productName,
                quantity,
                priority,
                status: 'Pendente', 
                currentStepIndex: 0, // Índice da tarefa atual no array tasks
                creationDate: new Date().toISOString(),
                tasks: initialTasks, 
                creationUserId: userId
            };

            const ofsColRef = collection(db, `artifacts/${appId}/public/data/ofs`);
            
            try {
                const docRef = await addDoc(ofsColRef, newOF);
                showMessage(ofMessage, `OF #${docRef.id.substring(0, 8)} criada com sucesso!`, 'success');
                formCreateOF.reset();
                setTimeout(() => hideModal('create-of-modal'), 1500);

            } catch (error) {
                console.error("Erro ao criar OF:", error);
                showMessage(ofMessage, 'Erro ao salvar OF no Firestore.', 'error');
            }
        }


        // --- Renderização de Dados (Lógica de Apresentação) ---

        function renderStatusBadge(status) {
            let className, text;
            switch(status) {
                case 'Em Progresso':
                case 'Em Execução':
                    className = 'status-badge-progress';
                    text = status;
                    break;
                case 'Concluído':
                    className = 'status-badge-complete';
                    text = status;
                    break;
                case 'Pendente':
                case 'Aguardando':
                default:
                    className = 'status-badge-pending';
                    text = status || 'Pendente';
            }
            return `<span class="status-badge ${className}">${text}</span>`;
        }

        function renderKPIs(totalOfs = 0, inProgress = 0, completedToday = 0) {
            document.getElementById('kpi-total-ofs').textContent = totalOfs.toString();
            document.getElementById('kpi-in-progress').textContent = inProgress.toString();
            document.getElementById('kpi-completed-today').textContent = completedToday.toString();
        }


        function renderOFs() {
            if (!isAuthReady || !db) return;

            const ofsCollectionPath = `artifacts/${appId}/public/data/ofs`;
            const ofsColRef = collection(db, ofsCollectionPath);
            const q = query(ofsColRef); // Sem orderBy para evitar erro de índice

            ofsListContainer.innerHTML = `<div class="p-6 text-center text-sm text-gray-500 bg-white card-shadow">Carregando Ordens de Fabricação (Firestore)...</div>`;

            onSnapshot(q, (snapshot) => {
                let ofsHTML = '';
                let totalOfs = 0;
                let inProgress = 0;
                let completedToday = 0;
                const today = new Date().toDateString();

                if (snapshot.empty) {
                    ofsListContainer.innerHTML = `<div class="p-6 text-center text-sm text-gray-500 bg-white card-shadow">Nenhuma Ordem de Fabricação encontrada.</div>`;
                    renderKPIs(0, 0, 0); 
                    return;
                }

                snapshot.forEach(doc => {
                    const of = doc.data();
                    of.id = doc.id;
                    totalOfs++;

                    const currentTask = of.tasks[of.currentStepIndex] || null;
                    const status = of.status || 'Pendente';

                    if (status === 'Em Progresso') {
                        inProgress++;
                    }
                    if (status === 'Concluído' && of.completionDate && new Date(of.completionDate).toDateString() === today) {
                        completedToday++;
                    }
                    
                    const currentStepName = currentTask ? `${currentTask.stepName} (${currentTask.sector})` : 'Completa';
                    const listBorderColor = status === 'Concluído' ? 'border-green-500' : status === 'Em Progresso' ? 'border-yellow-500' : 'border-blue-500';

                    ofsHTML += `
                        <div class="bg-white p-4 rounded-xl shadow border-l-4 ${listBorderColor} flex flex-col sm:flex-row justify-between items-start sm:items-center hover:shadow-lg transition">
                            <div class="space-y-1 mb-2 sm:mb-0">
                                <p class="font-bold text-lg text-gray-800">OF #${of.id.substring(0, 8)}</p>
                                <p class="text-sm text-gray-600">${of.productCode || 'N/A'} - ${of.productName || 'Sem descrição'}</p>
                                <p class="text-xs text-gray-500">Etapa Atual: <span class="font-semibold text-blue-600">${currentStepName}</span> | Qtd: ${of.quantity || '0'}</p>
                            </div>
                            <div class="flex items-center gap-3">
                                ${renderStatusBadge(status)}
                                <button onclick="editOF('${of.id}')" class="text-blue-500 hover:text-blue-700 p-2 rounded-full hover:bg-blue-50 transition">
                                    <i data-lucide="edit" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                ofsListContainer.innerHTML = ofsHTML;
                lucide.createIcons();
                renderKPIs(totalOfs, inProgress, completedToday);

            }, (error) => {
                console.error("Erro ao carregar OFs (Firestore):", error);
                ofsListContainer.innerHTML = `<div class="p-6 text-center text-red-700 text-sm bg-red-100 rounded-xl card-shadow">Erro ao carregar Ordens de Fabricação.</div>`;
            });
        }
        
        function renderTasks() {
            if (!isAuthReady || !db || !userSector) return;
            
            // Exibe ID do usuário no painel do operador
            document.getElementById('operator-id-display').textContent = userId.substring(0, 8) + '...';

            const ofsCollectionPath = `artifacts/${appId}/public/data/ofs`;
            const ofsColRef = collection(db, ofsCollectionPath);
            // Query para buscar OFs que não estejam Concluídas
            const q = query(ofsColRef, where("status", "!=", "Concluído"));
            
            tasksListContainer.innerHTML = `<div class="p-6 text-center text-sm text-gray-500 bg-white card-shadow">Buscando tarefas no setor ${userSector}...</div>`;
            
            onSnapshot(q, (snapshot) => {
                let tasksHTML = '';
                let tasksFound = false;

                snapshot.forEach(doc => {
                    const of = doc.data();
                    of.id = doc.id;
                    
                    // Encontrar a tarefa (etapa) que está Pendente ou Em Execução e pertence ao setor do operador
                    const task = of.tasks.find(t => 
                        t.sector === userSector && 
                        (t.status === 'Pendente' || t.status === 'Em Execução')
                    );
                    
                    if (task) {
                        tasksFound = true;
                        
                        // Lógica de status da tarefa em relação ao operador atual
                        const isExecuting = task.status === 'Em Execução' && task.currentOperatorId === userId;
                        const isBlocked = task.status === 'Em Execução' && task.currentOperatorId !== userId;
                        
                        const buttonText = isExecuting ? 'Pausar' : isBlocked ? 'Bloqueado' : 'Iniciar';
                        const buttonIcon = isExecuting ? 'pause' : isBlocked ? 'lock' : 'play';
                        const buttonColor = isExecuting ? 'bg-red-600 hover:bg-red-700' : isBlocked ? 'bg-gray-500 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700';

                        tasksHTML += `
                            <div class="bg-white p-4 rounded-xl shadow border-l-4 ${isExecuting ? 'border-red-500' : 'border-blue-500'} flex flex-col sm:flex-row justify-between items-start sm:items-center hover:shadow-lg transition">
                                <div class="space-y-1 mb-2 sm:mb-0">
                                    <p class="font-bold text-lg text-gray-800">OF #${of.id.substring(0, 8)} - <span class="text-blue-600">${task.stepName}</span></p>
                                    <p class="text-sm text-gray-600">Produto: ${of.productCode} | Qtd: ${of.quantity}</p>
                                    <p class="text-xs text-gray-500">
                                        Status: ${renderStatusBadge(task.status)} 
                                        | Tempo Registrado: <span class="font-semibold">${(task.timeElapsed / 60).toFixed(1)} min</span>
                                        ${isBlocked ? `| Em uso por: ${task.currentOperatorId.substring(0, 8)}...` : ''}
                                    </p>
                                </div>
                                <button onclick="${isBlocked ? '' : `startTask('${of.id}', ${task.stepId})`}" ${isBlocked ? 'disabled' : ''} class="${buttonColor} text-white transition px-4 py-2 rounded-lg text-sm font-bold shadow-md flex items-center gap-1">
                                    <i data-lucide="${buttonIcon}" class="w-4 h-4"></i>
                                    ${buttonText}
                                </button>
                            </div>
                        `;
                    }
                });

                if (!tasksFound) {
                    tasksListContainer.innerHTML = `<div class="p-6 text-center text-sm text-gray-500 bg-white card-shadow">Nenhuma tarefa ativa encontrada para o setor ${userSector}.</div>`;
                } else {
                    tasksListContainer.innerHTML = tasksHTML;
                }
                lucide.createIcons();
            }, (error) => {
                console.error("Erro ao carregar Tarefas (Firestore):", error);
                tasksListContainer.innerHTML = `<div class="p-6 text-center text-red-700 text-sm bg-red-100 rounded-xl card-shadow">Erro ao carregar Tarefas.</div>`;
            });
        }
        
        // --- 7. FUNÇÃO DE SETUP E INICIALIZAÇÃO ---

        function setupDomAndStart() {
            // 1. Recupera elementos DOM dos Modais (Global)
            modalGlobal = document.getElementById('global-modal');
            modalTitle = document.getElementById('modal-title');
            modalBody = document.getElementById('modal-body');
            modalFooter = document.getElementById('modal-footer');
            modalBtnCancel = document.getElementById('modal-btn-cancel');
            modalBtnConfirm = document.getElementById('modal-btn-confirm');

            // 2. Recupera outros elementos DOM
            pcpView = document.getElementById('pcp-view');
            operatorView = document.getElementById('operator-view');
            reportsView = document.getElementById('reports-view');
            loadingIndicator = document.getElementById('loading-indicator');
            ofsListContainer = document.getElementById('ofs-list-container');
            tasksListContainer = document.getElementById('tasks-list-container');
            userViewSelect = document.getElementById('user-view-select');
            btnCreateOF = document.getElementById('btn-create-of');
            btnSetupRoteiro = document.getElementById('btn-setup-roteiro');
            btnProfile = document.getElementById('btn-profile');
            userIdDisplay = document.getElementById('user-id-display');
            operatorUserId = document.getElementById('operator-user-id');
            headerControls = document.getElementById('header-controls');
            appContent = document.getElementById('app-content');
            loginView = document.getElementById('login-view');
            authIdDisplay = document.getElementById('auth-id-display');
            operatorSectorSelect = document.getElementById('operator-sector-select');
            pcpPasswordInput = document.getElementById('pcp-password-input');
            btnLoginPCP = document.getElementById('btn-login');
            btnLoginOperatorStart = document.getElementById('btn-login-operator-start');
            loginMessage = document.getElementById('login-message');
            operatorSectorDisplay = document.getElementById('operator-sector-display');

            radioPCP = document.getElementById('radio-pcp');
            radioOperator = document.getElementById('radio-operator');
            loginFormPCP = document.getElementById('login-form-pcp');
            loginFormOperator = document.getElementById('login-form-operator');
            labelPCPMaster = document.getElementById('label-pcp-master');
            labelOperator = document.getElementById('label-operator');
            
            // Elementos dos Modais de Ação
            roteiroStepsContainer = document.getElementById('roteiro-steps-container');
            btnAddStep = document.getElementById('btn-add-step');
            btnSaveRoteiro = document.getElementById('btn-save-roteiro');
            roteiroMessage = document.getElementById('roteiro-message');
            formCreateOF = document.getElementById('form-create-of');
            ofMessage = document.getElementById('of-message');
            roteiroStepsSummary = document.getElementById('roteiro-steps-summary');


            // 3. Event Listeners de UI
            userViewSelect.addEventListener('change', (e) => updateView(e.target.value));
            
            // Login events
            radioPCP.addEventListener('change', toggleLoginForm);
            radioOperator.addEventListener('change', toggleLoginForm);
            btnLoginPCP.addEventListener('click', handleLogin);
            btnLoginOperatorStart.addEventListener('click', handleLogin);

            // Botões do Painel (Agora abrem Modais)
            btnCreateOF.addEventListener('click', () => showModal('create-of-modal'));
            btnSetupRoteiro.addEventListener('click', () => showModal('setup-roteiro-modal'));
            
            // Botões e Forms dos Modais de Ação
            btnAddStep.addEventListener('click', addRoteiroStep);
            btnSaveRoteiro.addEventListener('click', saveRoteiro);
            formCreateOF.addEventListener('submit', createOFInFirestore);


            // Stubs de Mensagens Rápidas
            btnProfile.addEventListener('click', () => customAlert('Configurações de Perfil', `ID de Usuário: ${userId}`, 'info'));
            document.getElementById('btn-export-report').addEventListener('click', () => customAlert('Exportar Relatório', 'Funcionalidade de Exportação de Relatório em desenvolvimento.', 'info'));


            // 4. Inicializa visual do Login Form
            toggleLoginForm();

            // 5. Inicia o processo de autenticação e carga de dados
            initializeFirebase();
        }

        // Inicia a aplicação quando o DOM estiver completamente carregado
        document.addEventListener('DOMContentLoaded', setupDomAndStart);
        
        // Expondo funções para o escopo global (para onclick no HTML)
        window.hideModal = hideModal;

    </script>
</body>
</html>
